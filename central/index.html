<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NJTC Central Team Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      /* Brand */
      --navy:      #0a1628;
      --blue:      #003087;
      --blue-mid:  #0050c8;
      --blue-lite: #1a7aff;
      --gold:      #f0a500;
      --gold-lite: #ffd166;
      /* Dept colors */
      --hr:        #e63946;
      --finance:   #2a9d8f;
      --prog:      #457b9d;
      --data:      #7b2d8b;
      --training:  #e76f51;
      --lead:      #f0a500;
      /* Neutrals */
      --text:      #0d1b2a;
      --text-2:    #3d5166;
      --muted:     #7d8fa1;
      --border:    #dde3ec;
      --border-2:  #eef1f6;
      --surface:   #ffffff;
      --surface-2: #f6f8fc;
      --surface-3: #eef1f7;
      --bg:        #f0f4fa;
      /* Status */
      --met:       #0d6e3a;
      --met-bg:    #e6f5ed;
      --progress:  #0050c8;
      --prog-bg:   #e6efff;
      --partial:   #c05c00;
      --part-bg:   #fff0e0;
      --pipeline:  #6b21a8;
      --pipe-bg:   #f3e8ff;
      --notmet:    #b91c1c;
      --notm-bg:   #fee2e2;
      /* UI */
      --radius:    14px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(10,22,40,.06), 0 1px 2px rgba(10,22,40,.04);
      --shadow:    0 4px 16px rgba(10,22,40,.08), 0 1px 4px rgba(10,22,40,.04);
      --shadow-lg: 0 20px 60px rgba(10,22,40,.14), 0 4px 16px rgba(10,22,40,.06);
      --transition: all .22s cubic-bezier(.4,0,.2,1);
    }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 15px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOP NAV
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ct-nav {
      background: var(--navy);
      color: #fff;
      padding: 0 1.75rem;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 200;
      box-shadow: 0 2px 24px rgba(0,0,0,.25);
    }
    .nav-brand {
      display: flex; align-items: center; gap: .875rem;
    }
    .nav-logo {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, var(--blue-mid), var(--blue-lite));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'DM Serif Display', serif;
      font-size: 1.0625rem; font-weight: 400; color: #fff;
      letter-spacing: -.5px; flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0,80,200,.4);
    }
    .nav-title {
      font-size: .9375rem; font-weight: 600; color: #fff;
      letter-spacing: -.01em;
    }
    .nav-subtitle {
      font-size: .6875rem; color: rgba(255,255,255,.45);
      font-weight: 400; margin-top: 1px;
    }
    .nav-center {
      display: flex; align-items: center; gap: 1.5rem;
    }
    .nav-date {
      font-size: .75rem; color: rgba(255,255,255,.45);
      font-family: 'JetBrains Mono', monospace;
    }
    .nav-right {
      display: flex; align-items: center; gap: .875rem;
    }
    .dept-pill {
      background: linear-gradient(135deg, var(--blue-mid), var(--blue-lite));
      border-radius: 20px;
      padding: .3rem 1rem;
      font-size: .6875rem; font-weight: 700;
      letter-spacing: .06em; text-transform: uppercase;
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,80,200,.35);
    }
    .session-badge {
      font-size: .6875rem; color: rgba(255,255,255,.4);
      font-family: 'JetBrains Mono', monospace;
      padding: .25rem .625rem;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 6px;
    }
    .btn-signout {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.85); border-radius: 8px;
      padding: .4rem .875rem; font-size: .8125rem;
      font-family: inherit; font-weight: 500;
      cursor: pointer; transition: var(--transition);
    }
    .btn-signout:hover {
      background: rgba(255,255,255,.15);
      color: #fff;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LAYOUT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ct-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 64px);
      align-items: start;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ct-sidebar {
      background: var(--navy);
      position: sticky;
      top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      padding: 1.5rem 0 2rem;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.12) transparent;
    }
    .ct-sidebar::-webkit-scrollbar { width: 4px; }
    .ct-sidebar::-webkit-scrollbar-track { background: transparent; }
    .ct-sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,.12); border-radius: 4px; }

    .sidebar-dept-card {
      margin: 0 1rem 1.75rem;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 1rem 1.125rem;
    }
    .sdc-label { font-size: .625rem; text-transform: uppercase; letter-spacing: .1em; color: rgba(255,255,255,.35); margin-bottom: .375rem; }
    .sdc-dept { font-size: 1rem; font-weight: 700; color: #fff; }
    .sdc-tagline { font-size: .75rem; color: rgba(255,255,255,.45); margin-top: .25rem; line-height: 1.4; }
    .sdc-bar { height: 2px; background: rgba(255,255,255,.1); border-radius: 1px; margin-top: .875rem; overflow: hidden; }
    .sdc-bar-fill { height: 100%; border-radius: 1px; background: linear-gradient(90deg, var(--blue-lite), var(--gold)); animation: barSlide .8s ease forwards; }
    @keyframes barSlide { from { width: 0 } to { width: var(--pct, 72%) } }

    .sidebar-group { margin-bottom: .25rem; }
    .sidebar-group-label {
      font-size: .625rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .1em; color: rgba(255,255,255,.28);
      padding: .875rem 1.25rem .375rem;
    }
    .sidebar-link {
      display: flex; align-items: center; gap: .75rem;
      padding: .625rem 1.25rem;
      font-size: .875rem; font-weight: 500;
      color: rgba(255,255,255,.55);
      cursor: pointer; transition: var(--transition);
      border: none; background: none; width: 100%; text-align: left;
      border-left: 2px solid transparent;
      position: relative;
    }
    .sidebar-link:hover {
      color: rgba(255,255,255,.9);
      background: rgba(255,255,255,.05);
    }
    .sidebar-link.active {
      color: #fff;
      background: rgba(255,255,255,.08);
      border-left-color: var(--blue-lite);
    }
    .sidebar-link.active .sl-icon { opacity: 1; }
    .sl-icon { font-size: .9375rem; width: 18px; text-align: center; flex-shrink: 0; opacity: .6; }
    .sl-badge {
      margin-left: auto;
      font-size: .625rem; font-weight: 700;
      background: var(--blue-lite); color: #fff;
      padding: .125rem .4rem; border-radius: 10px;
      min-width: 18px; text-align: center;
    }
    .sl-badge.gold { background: var(--gold); color: var(--navy); }
    .sidebar-divider {
      height: 1px; background: rgba(255,255,255,.07);
      margin: .875rem 1.25rem;
    }

    /* Dept connections section */
    .dept-connections {
      margin: 0 1rem;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 10px;
      padding: .875rem 1rem;
      margin-bottom: 1rem;
    }
    .dc-title {
      font-size: .625rem; text-transform: uppercase; letter-spacing: .1em;
      color: rgba(255,255,255,.3); margin-bottom: .75rem;
      display: flex; align-items: center; gap: .375rem;
    }
    .dc-item {
      display: flex; align-items: flex-start; gap: .5rem;
      padding: .375rem 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
      cursor: pointer; transition: var(--transition);
    }
    .dc-item:last-child { border-bottom: none; }
    .dc-item:hover { opacity: .85; }
    .dc-dot {
      width: 7px; height: 7px; border-radius: 50%;
      flex-shrink: 0; margin-top: 5px;
    }
    .dc-text { font-size: .75rem; color: rgba(255,255,255,.55); line-height: 1.4; }
    .dc-text strong { color: rgba(255,255,255,.8); font-weight: 600; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ct-main {
      padding: 2rem;
      max-width: 1200px;
    }

    .panel { display: none; animation: fadeIn .25s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* Page header */
    .page-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      gap: 1rem; flex-wrap: wrap;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    .ph-text {}
    .ph-eyebrow {
      font-size: .6875rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .08em; color: var(--blue-mid);
      margin-bottom: .375rem;
    }
    .ph-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.75rem; color: var(--navy);
      line-height: 1.2; letter-spacing: -.02em;
    }
    .ph-subtitle {
      font-size: .9375rem; color: var(--text-2);
      margin-top: .375rem; max-width: 600px;
    }
    .ph-actions {
      display: flex; align-items: center; gap: .75rem; flex-shrink: 0;
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .625rem 1.25rem; border-radius: 10px;
      font-size: .875rem; font-weight: 600; font-family: inherit;
      cursor: pointer; transition: var(--transition); border: none;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--blue), var(--blue-mid));
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,48,135,.3);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--blue-mid), var(--blue-lite));
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,80,200,.35);
    }
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover {
      border-color: var(--blue-mid);
      color: var(--blue-mid);
      background: var(--surface-2);
    }
    .btn-gold {
      background: linear-gradient(135deg, #d4890a, var(--gold));
      color: var(--navy); font-weight: 700;
      box-shadow: 0 4px 12px rgba(240,165,0,.35);
    }
    .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(240,165,0,.4); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAT TILES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .stats-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.375rem;
      box-shadow: var(--shadow-sm);
      position: relative; overflow: hidden;
      transition: var(--transition);
    }
    .stat-tile:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
    .stat-tile::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: var(--accent-color, var(--blue-mid));
    }
    .st-icon { font-size: 1.25rem; margin-bottom: .625rem; }
    .st-value {
      font-family: 'DM Serif Display', serif;
      font-size: 2rem; color: var(--navy);
      line-height: 1; letter-spacing: -.03em;
    }
    .st-label { font-size: .75rem; font-weight: 600; color: var(--muted); margin-top: .375rem; text-transform: uppercase; letter-spacing: .04em; }
    .st-sub { font-size: .75rem; color: var(--text-2); margin-top: .25rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUICK LINK CARDS (Home)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ql-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.25rem;
    }
    .ql-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      position: relative; overflow: hidden;
    }
    .ql-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow);
      border-color: var(--blue-mid);
    }
    .ql-card::after {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(0,80,200,.03), transparent);
      opacity: 0; transition: var(--transition);
    }
    .ql-card:hover::after { opacity: 1; }
    .ql-icon-wrap {
      width: 44px; height: 44px;
      background: var(--icon-bg, var(--prog-bg));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.25rem; margin-bottom: 1rem;
    }
    .ql-title { font-size: 1rem; font-weight: 700; color: var(--navy); margin-bottom: .375rem; }
    .ql-desc { font-size: .8125rem; color: var(--text-2); line-height: 1.5; }
    .ql-arrow {
      display: inline-flex; align-items: center; gap: .25rem;
      font-size: .8125rem; font-weight: 600; color: var(--blue-mid);
      margin-top: .875rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KPI TABLE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .kpi-filters {
      display: flex; gap: .75rem; flex-wrap: wrap;
      margin-bottom: 1.25rem; align-items: center;
    }
    .filter-select, .filter-input {
      padding: .5625rem .875rem;
      font-size: .875rem; font-family: inherit;
      border: 1.5px solid var(--border); border-radius: 10px;
      outline: none; background: var(--surface);
      color: var(--text); transition: var(--transition);
    }
    .filter-select:focus, .filter-input:focus {
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 3px rgba(0,80,200,.1);
    }
    .kpi-summary-strip {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: .75rem; margin-bottom: 1.5rem;
    }
    .kss-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: .875rem 1rem;
      text-align: center;
      cursor: pointer; transition: var(--transition);
    }
    .kss-tile:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .kss-tile.active { border-color: var(--blue-mid); background: var(--prog-bg); }
    .kss-num { font-family: 'DM Serif Display', serif; font-size: 1.75rem; line-height: 1; letter-spacing: -.03em; }
    .kss-label { font-size: .6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; margin-top: .25rem; color: var(--muted); }
    .kpi-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .kpi-table { width: 100%; border-collapse: collapse; font-size: .875rem; }
    .kpi-table thead tr { background: var(--navy); }
    .kpi-table th {
      padding: .875rem 1.125rem;
      text-align: left;
      font-size: .6875rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: .07em;
      color: rgba(255,255,255,.7);
      white-space: nowrap;
    }
    .kpi-table th:first-child { color: rgba(255,255,255,.9); }
    .kpi-table td {
      padding: .875rem 1.125rem;
      border-bottom: 1px solid var(--border-2);
      vertical-align: middle;
    }
    .kpi-table tbody tr:last-child td { border-bottom: none; }
    .kpi-table tbody tr:hover td { background: var(--surface-2); }
    .goal-group-cell {
      font-size: .6875rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .06em; color: var(--blue-mid);
      display: flex; align-items: center; gap: .375rem;
    }
    .kpi-status {
      display: inline-flex; align-items: center; gap: .375rem;
      font-size: .6875rem; font-weight: 700; padding: .3rem .75rem;
      border-radius: 20px; white-space: nowrap; letter-spacing: .02em;
    }
    .s-met       { background: var(--met-bg);  color: var(--met); }
    .s-progress  { background: var(--prog-bg); color: var(--progress); }
    .s-partial   { background: var(--part-bg); color: var(--partial); }
    .s-pipeline  { background: var(--pipe-bg); color: var(--pipeline); }
    .s-notmet    { background: var(--notm-bg); color: var(--notmet); }
    .goal-group-header td {
      background: var(--surface-3) !important;
      font-size: .6875rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: .07em;
      color: var(--blue); padding: .625rem 1.125rem;
      border-bottom: 2px solid var(--border) !important;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       POLICIES LIBRARY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .policy-toolbar {
      display: flex; gap: .75rem; flex-wrap: wrap;
      align-items: center; margin-bottom: 1.5rem;
    }
    .policy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.25rem;
    }
    .policy-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.375rem;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      display: flex; flex-direction: column;
      position: relative; overflow: hidden;
    }
    .policy-card:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
      border-color: rgba(0,80,200,.25);
    }
    .policy-card-top {
      display: flex; justify-content: space-between;
      align-items: flex-start; gap: .75rem; margin-bottom: .875rem;
    }
    .policy-dept-dot {
      width: 10px; height: 10px; border-radius: 50%;
      flex-shrink: 0; margin-top: 4px;
    }
    .policy-tag-group { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
    .policy-tag {
      font-size: .6rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .06em; padding: .2rem .5rem;
      border-radius: 5px;
    }
    .policy-modified {
      font-size: .6875rem; color: var(--muted);
      display: flex; align-items: center; gap: .3rem;
    }
    .policy-title { font-size: .9375rem; font-weight: 700; color: var(--navy); margin-bottom: .375rem; flex: 1; }
    .policy-desc { font-size: .8125rem; color: var(--text-2); line-height: 1.55; flex: 1; }
    .policy-footer {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: 1rem; padding-top: .875rem;
      border-top: 1px solid var(--border-2);
    }
    .policy-date { font-size: .75rem; color: var(--muted); }
    /* â”€â”€ Drive Addition tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .drive-addition-tag {
      display: inline-flex; align-items: center; gap: .3rem;
      font-size: .625rem; font-weight: 700; letter-spacing: .07em;
      text-transform: uppercase;
      background: #e8f4fd; color: #0969da;
      border: 1px solid #b6d9f7;
      padding: .175rem .5rem; border-radius: 20px;
      white-space: nowrap; flex-shrink: 0;
    }
    .drive-addition-tag svg { flex-shrink: 0; }
    .policy-card.drive-addition {
      border-left: 3px solid #0969da;
      background: linear-gradient(to right, #f0f7ff 0%, #fff 60%);
    }
    .policy-card.drive-addition:hover {
      border-left-color: #0550ae;
    }
    .drive-upload-meta {
      font-size: .75rem; color: #0969da; margin-top: .375rem;
      display: flex; align-items: center; gap: .35rem;
    }
    .policy-changes-badge {
      font-size: .6875rem; font-weight: 600;
      background: rgba(240,165,0,.12); color: #7a4c00;
      padding: .2rem .5rem; border-radius: 5px;
      display: flex; align-items: center; gap: .25rem;
    }
    .policy-link {
      font-size: .8125rem; font-weight: 600;
      color: var(--blue-mid); text-decoration: none;
      display: inline-flex; align-items: center; gap: .3rem;
      transition: var(--transition);
    }
    .policy-link:hover { color: var(--blue-lite); }
    .policy-link-disabled { font-size: .8125rem; color: var(--muted); font-style: italic; }
    /* Tooltip */
    .has-tooltip { position: relative; }
    .tooltip-box {
      position: absolute; bottom: calc(100% + 8px); left: 50%;
      transform: translateX(-50%);
      background: var(--navy); color: #fff;
      font-size: .75rem; line-height: 1.5;
      padding: .625rem .875rem; border-radius: 8px;
      width: 260px; max-width: 90vw;
      box-shadow: var(--shadow-lg);
      opacity: 0; pointer-events: none; transition: var(--transition);
      z-index: 300;
    }
    .tooltip-box::after {
      content: ''; position: absolute; top: 100%; left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--navy);
    }
    .has-tooltip:hover .tooltip-box { opacity: 1; pointer-events: auto; }

    /* Drive sync indicator */
    .drive-sync-bar {
      display: flex; align-items: center; gap: .75rem;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: .75rem 1.125rem;
      margin-bottom: 1.5rem; font-size: .8125rem;
    }
    .sync-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--met); flex-shrink: 0;
      box-shadow: 0 0 0 2px rgba(13,110,58,.2);
      animation: pulse 2s infinite;
    }
    .sync-dot.loading { background: var(--gold); animation: none; }
    .sync-dot.error { background: var(--notmet); animation: none; }
    .kpi-table th { transition: opacity .2s; }
    .kpi-table td:nth-child(3), .kpi-table td:nth-child(4) { white-space: nowrap; }
    @keyframes pulse { 0%,100%{ box-shadow:0 0 0 2px rgba(13,110,58,.2); } 50%{ box-shadow:0 0 0 5px rgba(13,110,58,.08); } }
    .sync-text { color: var(--text-2); }
    .sync-text strong { color: var(--text); }
    .sync-btn {
      margin-left: auto; font-size: .75rem; font-weight: 600;
      color: var(--blue-mid); background: none; border: none;
      cursor: pointer; font-family: inherit; padding: .25rem .5rem;
      border-radius: 6px; transition: var(--transition);
    }
    .sync-btn:hover { background: var(--prog-bg); }

    /* Dept section header in policies */
    .dept-section-header {
      display: flex; align-items: center; gap: .75rem;
      margin-top: 2rem; margin-bottom: 1rem;
      padding-bottom: .75rem;
      border-bottom: 2px solid var(--border);
    }
    .dept-section-header:first-of-type { margin-top: 0; }
    .dsh-icon {
      width: 32px; height: 32px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; flex-shrink: 0;
    }
    .dsh-title { font-size: 1rem; font-weight: 700; color: var(--navy); }
    .dsh-count { font-size: .75rem; color: var(--muted); margin-left: auto; }

    /* Annual goal alignment callout */
    .goal-alignment-card {
      background: linear-gradient(135deg, var(--navy) 0%, #1a3a6b 100%);
      border-radius: var(--radius);
      padding: 1.5rem 1.75rem;
      color: #fff;
      margin-bottom: 2rem;
      position: relative; overflow: hidden;
    }
    .goal-alignment-card::before {
      content: '';
      position: absolute; top: -30px; right: -30px;
      width: 150px; height: 150px;
      background: radial-gradient(circle, rgba(255,255,255,.06), transparent);
      border-radius: 50%;
    }
    .gac-label { font-size: .625rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--gold); margin-bottom: .5rem; }
    .gac-title { font-family: 'DM Serif Display', serif; font-size: 1.25rem; margin-bottom: .375rem; }
    .gac-sub { font-size: .8125rem; color: rgba(255,255,255,.6); line-height: 1.5; }
    .gac-goals { display: flex; flex-wrap: wrap; gap: .5rem; margin-top: 1rem; }
    .gac-goal-tag {
      font-size: .75rem; font-weight: 500;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.85);
      padding: .3rem .75rem; border-radius: 20px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONCERN FORM - PREMIUM
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .form-wrapper {
      max-width: 780px;
    }
    /* Step progress */
    .step-progress {
      display: flex; align-items: center;
      margin-bottom: 2.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      gap: .5rem;
      box-shadow: var(--shadow-sm);
    }
    .sp-step {
      display: flex; align-items: center; gap: .625rem;
      flex: 1; position: relative;
    }
    .sp-step:not(:last-child)::after {
      content: '';
      position: absolute; left: calc(28px + .625rem); right: 0; top: 50%;
      height: 2px; background: var(--border-2);
      z-index: 0;
    }
    .sp-step.completed::after { background: var(--blue-mid); }
    .sp-num {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: .75rem; font-weight: 700;
      background: var(--surface-3); color: var(--muted);
      border: 2px solid var(--border);
      flex-shrink: 0; z-index: 1; position: relative;
      transition: var(--transition);
    }
    .sp-step.active .sp-num {
      background: var(--blue-mid); color: #fff; border-color: var(--blue-mid);
      box-shadow: 0 0 0 4px rgba(0,80,200,.15);
    }
    .sp-step.completed .sp-num {
      background: var(--met); color: #fff; border-color: var(--met);
    }
    .sp-label {
      font-size: .75rem; font-weight: 600; color: var(--muted);
      display: none;
    }
    @media (min-width: 600px) { .sp-label { display: block; } }
    .sp-step.active .sp-label { color: var(--blue-mid); }
    .sp-step.completed .sp-label { color: var(--met); }

    /* Form sections */
    .form-section { display: none; }
    .form-section.active { display: block; animation: fadeIn .2s ease; }
    .form-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      margin-bottom: 1.5rem;
    }
    .form-card-header {
      padding: 1.125rem 1.5rem;
      background: linear-gradient(135deg, var(--navy), #1a3a6b);
      color: #fff;
    }
    .fch-title { font-size: .9375rem; font-weight: 700; }
    .fch-sub { font-size: .8125rem; opacity: .65; margin-top: .2rem; }
    .form-card-body { padding: 1.5rem; }
    .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
    @media (max-width: 640px) { .form-row-2 { grid-template-columns: 1fr; } }
    .form-group { margin-bottom: 1.25rem; }
    .form-group:last-child { margin-bottom: 0; }
    .form-lbl {
      display: block; font-size: .8125rem; font-weight: 600;
      color: var(--text); margin-bottom: .5rem;
    }
    .form-lbl.req::after { content: ' *'; color: var(--notmet); }
    .form-hint { font-size: .75rem; color: var(--muted); margin-bottom: .5rem; }
    .form-ctrl {
      width: 100%; padding: .75rem 1rem;
      font-size: .9375rem; font-family: inherit;
      border: 1.5px solid var(--border); border-radius: 10px;
      outline: none; background: var(--surface);
      color: var(--text); transition: var(--transition);
    }
    .form-ctrl:focus {
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 3px rgba(0,80,200,.1);
    }
    textarea.form-ctrl { resize: vertical; min-height: 120px; }
    /* Radio chips */
    .radio-chips { display: flex; flex-wrap: wrap; gap: .625rem; }
    .radio-chips.vertical { flex-direction: column; gap: .5rem; }
    .radio-chip {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .5rem .875rem;
      border: 1.5px solid var(--border); border-radius: 8px;
      font-size: .875rem; cursor: pointer;
      background: var(--surface); transition: var(--transition);
    }
    .radio-chip:has(input:checked) {
      border-color: var(--blue-mid);
      background: var(--prog-bg); color: var(--blue);
    }
    .radio-chip input[type="radio"] { accent-color: var(--blue-mid); }
    /* Form actions */
    .form-actions {
      display: flex; justify-content: space-between; align-items: center;
      gap: 1rem; padding: 1.25rem 1.5rem;
      background: var(--surface-2);
      border-top: 1px solid var(--border);
    }
    .btn-back-form {
      background: none; border: 1.5px solid var(--border);
      color: var(--text-2); border-radius: 10px;
      padding: .625rem 1.25rem; font-size: .875rem; font-weight: 600;
      font-family: inherit; cursor: pointer; transition: var(--transition);
    }
    .btn-back-form:hover { border-color: var(--blue-mid); color: var(--blue-mid); }
    .btn-next-form {
      background: linear-gradient(135deg, var(--blue), var(--blue-mid));
      color: #fff; border: none; border-radius: 10px;
      padding: .625rem 1.5rem; font-size: .875rem; font-weight: 700;
      font-family: inherit; cursor: pointer; transition: var(--transition);
      box-shadow: 0 4px 12px rgba(0,48,135,.3);
    }
    .btn-next-form:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,80,200,.35); }
    .btn-submit-form {
      background: linear-gradient(135deg, #0a6e3a, #16a34a);
      color: #fff; border: none; border-radius: 10px;
      padding: .625rem 1.75rem; font-size: .875rem; font-weight: 700;
      font-family: inherit; cursor: pointer; transition: var(--transition);
      display: inline-flex; align-items: center; gap: .5rem;
      box-shadow: 0 4px 12px rgba(13,110,58,.3);
    }
    .btn-submit-form:hover { transform: translateY(-1px); }
    .btn-submit-form:disabled { opacity: .6; cursor: not-allowed; transform: none; }
    .btn-spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin .6s linear infinite; display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Confirm box */
    .confirm-box {
      display: flex; align-items: flex-start; gap: .875rem;
      background: rgba(13,110,58,.06); border: 1px solid rgba(13,110,58,.2);
      border-radius: 10px; padding: 1rem 1.25rem;
      font-size: .875rem; color: #0a4427; line-height: 1.55;
    }
    .confirm-icon { font-size: 1.25rem; flex-shrink: 0; }
    /* Error */
    .form-error {
      background: rgba(185,28,28,.07); border: 1px solid rgba(185,28,28,.2);
      border-radius: 8px; padding: .75rem 1rem;
      font-size: .875rem; color: var(--notmet);
      margin-bottom: 1rem; display: none;
    }
    /* Success */
    .form-success-screen {
      display: none; text-align: center;
      padding: 4rem 2rem;
    }
    .fss-icon { font-size: 4rem; margin-bottom: 1rem; }
    .fss-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.75rem; color: var(--navy);
      margin-bottom: .75rem;
    }
    .fss-sub { font-size: .9375rem; color: var(--text-2); line-height: 1.6; max-width: 400px; margin: 0 auto 2rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UPLOAD / DRIVE CENTER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .drive-hero {
      background: linear-gradient(135deg, var(--navy), #1a3a6b);
      border-radius: var(--radius);
      padding: 2rem 2.5rem;
      color: #fff;
      margin-bottom: 1.5rem;
      display: flex; align-items: center; gap: 2rem;
      position: relative; overflow: hidden;
    }
    .drive-hero::after {
      content: 'ğŸ“';
      position: absolute; right: 2rem; top: 50%;
      transform: translateY(-50%);
      font-size: 5rem; opacity: .07;
      pointer-events: none;
    }
    .dh-icon-wrap {
      width: 56px; height: 56px;
      background: rgba(255,255,255,.12);
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.75rem; flex-shrink: 0;
    }
    .dh-label { font-size: .625rem; text-transform: uppercase; letter-spacing: .1em; color: var(--gold); margin-bottom: .375rem; }
    .dh-title { font-family: 'DM Serif Display', serif; font-size: 1.375rem; }
    .dh-sub { font-size: .875rem; opacity: .65; margin-top: .375rem; }
    .drive-steps-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem; margin-bottom: 2rem;
    }
    .drive-step {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1.25rem;
      box-shadow: var(--shadow-sm); transition: var(--transition);
    }
    .drive-step:hover { box-shadow: var(--shadow); }
    .ds-num {
      font-family: 'DM Serif Display', serif; font-size: 1.75rem;
      color: var(--blue-mid); opacity: .3; line-height: 1; margin-bottom: .625rem;
    }
    .ds-title { font-size: .9375rem; font-weight: 700; color: var(--navy); margin-bottom: .375rem; }
    .ds-desc { font-size: .8125rem; color: var(--text-2); line-height: 1.5; }
    .auto-detect-card {
      background: linear-gradient(135deg, rgba(0,80,200,.06), rgba(0,80,200,.02));
      border: 1px solid rgba(0,80,200,.15);
      border-radius: var(--radius);
      padding: 1.375rem 1.5rem;
      display: flex; gap: 1rem; align-items: flex-start;
    }
    .adc-icon { font-size: 1.75rem; flex-shrink: 0; }
    .adc-title { font-size: .9375rem; font-weight: 700; color: var(--navy); margin-bottom: .375rem; }
    .adc-desc { font-size: .8125rem; color: var(--text-2); line-height: 1.55; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DEPT CONNECTIONS MODAL / TOOLTIP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(10,22,40,.5);
      backdrop-filter: blur(4px); z-index: 500;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: var(--transition);
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-box {
      background: var(--surface); border-radius: 20px;
      width: 90%; max-width: 680px;
      max-height: 85vh; overflow-y: auto;
      box-shadow: var(--shadow-lg);
      transform: scale(.96); transition: var(--transition);
    }
    .modal-overlay.open .modal-box { transform: scale(1); }
    .modal-header {
      padding: 1.5rem 1.75rem;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;
      position: sticky; top: 0; background: var(--surface); z-index: 1;
    }
    .modal-title { font-family: 'DM Serif Display', serif; font-size: 1.375rem; color: var(--navy); }
    .modal-sub { font-size: .875rem; color: var(--text-2); margin-top: .25rem; }
    .modal-close {
      width: 32px; height: 32px; border-radius: 8px;
      border: 1.5px solid var(--border); background: var(--surface);
      cursor: pointer; font-size: 1rem; color: var(--muted);
      display: flex; align-items: center; justify-content: center;
      transition: var(--transition); flex-shrink: 0;
    }
    .modal-close:hover { border-color: var(--notmet); color: var(--notmet); }
    .modal-body { padding: 1.5rem 1.75rem 2rem; }
    .connection-card {
      display: flex; gap: 1rem;
      padding: 1.125rem 1.25rem;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: .875rem;
      transition: var(--transition);
    }
    .connection-card:hover { border-color: rgba(0,80,200,.25); background: var(--prog-bg); }
    .cc-dot {
      width: 40px; height: 40px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.125rem; flex-shrink: 0;
    }
    .cc-dept { font-size: .75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); margin-bottom: .25rem; }
    .cc-how { font-size: .9375rem; font-weight: 600; color: var(--navy); margin-bottom: .375rem; }
    .cc-why { font-size: .8125rem; color: var(--text-2); line-height: 1.5; }
    .cc-goals { display: flex; flex-wrap: wrap; gap: .375rem; margin-top: .625rem; }
    .cc-goal-tag {
      font-size: .6875rem; font-weight: 600;
      background: rgba(0,80,200,.08); color: var(--blue-mid);
      padding: .2rem .5rem; border-radius: 5px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ALERT BOXES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .alert {
      border-radius: 10px; padding: .875rem 1.125rem;
      font-size: .875rem; margin-bottom: 1.25rem;
      display: flex; align-items: flex-start; gap: .625rem;
    }
    .alert-info { background: var(--prog-bg); border: 1px solid rgba(0,80,200,.2); color: var(--blue); }
    .alert-warn { background: var(--part-bg); border: 1px solid rgba(192,92,0,.2); color: var(--partial); }
    .alert-success { background: var(--met-bg); border: 1px solid rgba(13,110,58,.2); color: var(--met); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 900px) {
      .ct-layout { grid-template-columns: 1fr; }
      .ct-sidebar { position: static; height: auto; flex-direction: row; flex-wrap: wrap; padding: .75rem; gap: .25rem; }
      .sidebar-group-label, .sidebar-divider, .sidebar-dept-card, .dept-connections { display: none; }
      .sidebar-link { width: auto; padding: .5rem .75rem; }
    }
    @media (max-width: 600px) {
      .ct-main { padding: 1.25rem; }
      .kpi-summary-strip { grid-template-columns: repeat(3, 1fr); }
      .form-row-2 { grid-template-columns: 1fr; }
      .step-progress { padding: .875rem 1rem; gap: .25rem; }
    }
  
    /* â”€â”€ Policy Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .policy-detail-overlay .modal-box { max-width: 860px; width: 95vw; max-height: 90vh; display: flex; flex-direction: column; }
    .policy-detail-box { padding: 0; overflow: hidden; }
    .policy-detail-header { padding: 1.25rem 1.5rem; background: var(--navy); color: #fff; border-radius: var(--radius) var(--radius) 0 0; gap: 1rem; }
    .policy-detail-header .modal-title { color: #fff; font-size: 1.2rem; }
    .policy-detail-header .modal-sub { color: rgba(255,255,255,.65); font-size: .8125rem; margin-top: .2rem; }
    .policy-modal-dept { font-size: .6875rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--gold); margin-bottom: .25rem; }
    .policy-modal-sync { display: flex; align-items: center; gap: .5rem; padding: .625rem 1.5rem; background: var(--surface); border-bottom: 1px solid var(--border); font-size: .8rem; color: var(--muted); }
    .policy-section-tabs { display: flex; gap: .25rem; padding: .75rem 1.5rem .5rem; background: var(--surface); border-bottom: 1px solid var(--border); flex-wrap: wrap; overflow-x: auto; }
    .pst-tab { font-size: .75rem; font-weight: 600; padding: .35rem .75rem; border-radius: 20px; border: 1.5px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; transition: all .15s; white-space: nowrap; }
    .pst-tab:hover { border-color: var(--blue-mid); color: var(--blue-mid); }
    .pst-tab.active { background: var(--navy); border-color: var(--navy); color: #fff; }
    .policy-modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; min-height: 0; }
    .policy-loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; padding: 3rem; color: var(--muted); font-size: .9375rem; }
    .policy-loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--navy); border-radius: 50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .policy-section-content { animation: fadeIn .2s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .psc-title { font-size: 1.0625rem; font-weight: 700; color: var(--navy); margin: 0 0 1rem; padding-bottom: .625rem; border-bottom: 2px solid var(--gold); display: flex; align-items: center; gap: .5rem; }
    .psc-body { font-size: .9rem; line-height: 1.75; color: var(--text); }
    .psc-body h1, .psc-body h2 { font-size: 1rem; font-weight: 700; color: var(--navy); margin: 1.25rem 0 .5rem; }
    .psc-body h3 { font-size: .9375rem; font-weight: 700; color: var(--blue-mid); margin: 1rem 0 .375rem; }
    .psc-body p { margin: 0 0 .875rem; }
    .psc-body ul, .psc-body ol { margin: 0 0 .875rem 1.25rem; }
    .psc-body li { margin-bottom: .375rem; }
    .psc-body a { color: var(--blue-mid); text-decoration: underline; }
    .psc-body a:hover { color: var(--navy); }
    .psc-body strong { font-weight: 700; color: var(--navy); }
    .psc-body code { background: #f0f4ff; padding: .1em .35em; border-radius: 4px; font-family: "JetBrains Mono", monospace; font-size: .8em; }
    .psc-body table { width: 100%; border-collapse: collapse; margin: .875rem 0; font-size: .85rem; }
    .psc-body table th { background: var(--navy); color: #fff; padding: .5rem .75rem; text-align: left; font-weight: 600; }
    .psc-body table td { padding: .4375rem .75rem; border-bottom: 1px solid var(--border); }
    .psc-body table tr:nth-child(even) td { background: var(--surface); }
    /* Key highlights */
    .key-highlight-card { background: linear-gradient(135deg,#f0f7ff 0%,#e8f0fe 100%); border: 1px solid #c7d7f5; border-radius: 10px; padding: .75rem 1rem; margin-bottom: .625rem; display: flex; gap: .625rem; align-items: flex-start; }
    .khc-icon { font-size: 1.25rem; flex-shrink: 0; line-height: 1; margin-top: .1rem; }
    .khc-text { font-size: .875rem; color: var(--text); line-height: 1.5; }
    .khc-text strong { color: var(--navy); }
    .policy-modal-footer { padding: 1rem 1.5rem; background: var(--surface); border-top: 1px solid var(--border); max-height: 220px; overflow-y: auto; }
    .pmf-label { font-size: .6875rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--muted); margin-bottom: .625rem; }
    /* Live update badge */
    .live-badge { display: inline-flex; align-items: center; gap: .3rem; font-size: .6875rem; font-weight: 700; color: #0d6e3a; background: #d1fae5; padding: .2rem .55rem; border-radius: 20px; letter-spacing: .04em; }
    .live-badge::before { content: ""; width: 6px; height: 6px; background: #0d6e3a; border-radius: 50%; animation: pulse 2s infinite; }
    /* Policy card open button */
    .policy-card { cursor: pointer; transition: transform .15s, box-shadow .15s; }
    .policy-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.1); }
    .policy-open-btn { display: inline-flex; align-items: center; gap: .35rem; font-size: .8125rem; font-weight: 600; color: var(--navy); background: transparent; border: 1.5px solid var(--navy); border-radius: 6px; padding: .35rem .75rem; cursor: pointer; transition: all .15s; text-decoration: none; }
    .policy-open-btn:hover { background: var(--navy); color: #fff; }
    .policy-link { font-size: .8125rem; font-weight: 600; color: var(--blue-mid); cursor: pointer; text-decoration: none; transition: color .15s; }
    .policy-link:hover { color: var(--navy); text-decoration: underline; }
    /* No more "disabled" link style needed */

  
    /* â”€â”€ Talent Analytics Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ta-grid { display: grid; gap: 1rem; }
    .ta-grid-4 { grid-template-columns: repeat(4,1fr); }
    .ta-grid-3 { grid-template-columns: repeat(3,1fr); }
    .ta-grid-2 { grid-template-columns: repeat(2,1fr); }
    @media(max-width:900px){ .ta-grid-4{grid-template-columns:repeat(2,1fr);} .ta-grid-3{grid-template-columns:repeat(2,1fr);} }
    @media(max-width:600px){ .ta-grid-4,.ta-grid-3,.ta-grid-2{grid-template-columns:1fr;} }
    .ta-card { background: #fff; border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .ta-card-title { font-size: .6875rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--muted); margin-bottom: .75rem; display:flex; align-items:center; gap:.4rem; }
    .ta-kpi { text-align: center; padding: 1.25rem 1rem; }
    .ta-kpi-val { font-size: 2.5rem; font-weight: 800; color: var(--navy); line-height: 1; }
    .ta-kpi-sub { font-size: .8125rem; color: var(--muted); margin-top: .3rem; }
    .ta-kpi.warning .ta-kpi-val { color: #e76f51; }
    .ta-kpi.alert .ta-kpi-val { color: #e63946; }
    .ta-kpi.ok .ta-kpi-val { color: #2a9d8f; }
    .ta-section-label { font-size: .8125rem; font-weight: 700; color: var(--navy); margin: 1.25rem 0 .75rem; display:flex; align-items:center; gap:.5rem; }
    /* Bar chart */
    .ta-bar-row { display: flex; align-items: center; gap: .625rem; margin-bottom: .5rem; font-size: .8125rem; }
    .ta-bar-label { width: 170px; flex-shrink: 0; color: var(--text); font-size: .8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ta-bar-track { flex: 1; height: 8px; background: var(--surface); border-radius: 4px; overflow: hidden; }
    .ta-bar-fill { height: 100%; border-radius: 4px; transition: width .4s; }
    .ta-bar-count { width: 28px; text-align: right; font-weight: 700; color: var(--navy); font-size: .8rem; flex-shrink:0; }
    /* Risk indicator */
    .risk-chip { display: inline-flex; align-items: center; gap: .3rem; font-size: .6875rem; font-weight: 700; padding: .25rem .6rem; border-radius: 20px; }
    .risk-high { background: #fee2e2; color: #991b1b; }
    .risk-med { background: #fef3c7; color: #92400e; }
    .risk-low { background: #d1fae5; color: #065f46; }
    /* Warning strip */
    .ta-alert-strip { background: linear-gradient(135deg,#fff7ed,#fef3c7); border: 1.5px solid #f59e0b; border-radius: 10px; padding: .875rem 1.125rem; margin-bottom: .875rem; display: flex; gap: .75rem; align-items: flex-start; }
    .ta-alert-icon { font-size: 1.25rem; flex-shrink:0; }
    .ta-alert-title { font-weight: 700; font-size: .875rem; color: #92400e; }
    .ta-alert-body { font-size: .8125rem; color: #78350f; line-height: 1.5; }
    /* Table */
    .ta-table { width: 100%; border-collapse: collapse; font-size: .8125rem; }
    .ta-table th { background: var(--navy); color: #fff; padding: .5rem .75rem; text-align: left; font-size: .75rem; font-weight: 600; }
    .ta-table td { padding: .4375rem .75rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    .ta-table tr:nth-child(even) td { background: #f9fafb; }
    .ta-table tr:hover td { background: #eef2ff; }
    /* Mini sparkline */
    .ta-spark { display: flex; align-items: flex-end; gap: 2px; height: 32px; }
    .ta-spark-bar { width: 12px; background: var(--navy); border-radius: 2px 2px 0 0; min-height: 3px; opacity: .7; }
    .ta-spark-bar.hot { background: #e63946; opacity: 1; }
    /* HR/Program tag */
    .dept-tag { font-size: .6875rem; font-weight: 700; padding: .2rem .5rem; border-radius: 4px; display: inline-block; }
    .dept-tag-hr { background: #fee2e2; color: #991b1b; }
    .dept-tag-prog { background: #dbeafe; color: #1e40af; }
    /* Status pill override for concerns */
    .concern-pill { font-size: .6875rem; padding: .2rem .55rem; border-radius: 20px; font-weight: 600; display:inline-block; }
    .concern-warn { background:#fef3c7; color:#92400e; }
    .concern-writeup { background:#fee2e2; color:#991b1b; }
    .concern-pgp { background:#ede9fe; color:#5b21b6; }
    .concern-term { background:#1f2937; color:#f9fafb; }
    .concern-watch { background:#dbeafe; color:#1e40af; }
    .concern-no { background:#d1fae5; color:#065f46; }
    .ta-trend-up { color: #e63946; font-weight:700; }
    .ta-trend-down { color: #2a9d8f; font-weight:700; }
    /* Expand button */
    .ta-expand-btn { font-size:.75rem; color:var(--blue-mid); cursor:pointer; border:none; background:none; padding:.25rem 0; }
    .ta-expand-btn:hover { text-decoration:underline; }

      /* â”€â”€ PDF Upload & Policy Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .policy-admin-bar { display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; padding:.875rem 1.125rem; background:linear-gradient(135deg,#1d3461,#274690); border-radius:10px; margin-bottom:1rem; }
    .policy-admin-bar .pab-label { font-size:.75rem; font-weight:700; color:#a8b8d8; text-transform:uppercase; letter-spacing:.07em; }
    .pdf-drop-zone { border:2px dashed #a8b8d8; border-radius:8px; padding:.625rem 1rem; color:#a8b8d8; font-size:.8125rem; cursor:pointer; transition:.2s; display:flex; align-items:center; gap:.5rem; }
    .pdf-drop-zone:hover, .pdf-drop-zone.drag-over { border-color:#f0a500; color:#f0a500; background:rgba(240,165,0,.08); }
    .pdf-drop-zone input[type=file] { display:none; }
    .live-toggle-wrap { display:flex; align-items:center; gap:.5rem; font-size:.8125rem; color:#d0d9ec; }
    .live-toggle { position:relative; display:inline-block; width:36px; height:20px; }
    .live-toggle input { opacity:0; width:0; height:0; }
    .lt-slider { position:absolute; inset:0; background:#4a5568; border-radius:20px; cursor:pointer; transition:.3s; }
    .lt-slider:before { content:''; position:absolute; width:14px; height:14px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.3s; }
    .live-toggle input:checked + .lt-slider { background:#f0a500; }
    .live-toggle input:checked + .lt-slider:before { transform:translateX(16px); }
    .pdf-upload-list { margin-top:.5rem; }
    .pdf-upload-item { display:flex; align-items:center; gap:.625rem; padding:.4rem .75rem; background:#fff; border:1px solid var(--border); border-radius:6px; margin-bottom:.375rem; font-size:.8125rem; }
    .pdf-upload-item .pui-name { flex:1; font-weight:600; color:var(--navy); }
    .pdf-upload-item .pui-dept { font-size:.7rem; color:var(--muted); }
    .pdf-upload-item .pui-del { color:#e63946; cursor:pointer; font-size:.875rem; border:none; background:none; }
    /* â”€â”€ Talent Filter Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-select { padding:.4rem .65rem; border:1.5px solid var(--border); border-radius:6px; font-size:.8125rem; background:#fff; color:var(--text); }
    .filter-select:focus { outline:none; border-color:var(--navy); }
    /* â”€â”€ Change Notification Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #changeNotifContainer { position:fixed; bottom:1.25rem; right:1.25rem; z-index:9999; display:flex; flex-direction:column; gap:.5rem; pointer-events:none; }
    .change-notif { background:#1d3461; color:#fff; border-left:4px solid #f0a500; border-radius:8px; padding:.875rem 1.125rem; min-width:280px; max-width:360px; box-shadow:0 8px 24px rgba(0,0,0,.25); pointer-events:all; display:flex; gap:.75rem; align-items:flex-start; animation:notif-in .3s ease; }
    @keyframes notif-in { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
    .cn-icon { font-size:1.25rem; flex-shrink:0; }
    .cn-body { flex:1; }
    .cn-title { font-weight:700; font-size:.875rem; margin-bottom:.2rem; }
    .cn-sub { font-size:.775rem; color:#a8b8d8; line-height:1.4; }
    .cn-close { background:none; border:none; color:#a8b8d8; cursor:pointer; font-size:.875rem; flex-shrink:0; padding:0; }
    /* â”€â”€ Change Activity Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .change-log-item { display:flex; gap:.75rem; padding:.625rem 0; border-bottom:1px solid var(--border); font-size:.8125rem; }
    .cl-dot { width:8px; height:8px; border-radius:50%; background:var(--navy); flex-shrink:0; margin-top:4px; }
    .cl-dot.cl-add { background:#2a9d8f; }
    .cl-dot.cl-edit { background:#f0a500; }
    .cl-dot.cl-upload { background:#7b2d8b; }
    .cl-dot.cl-toggle { background:#457b9d; }
    .cl-body { flex:1; }
    .cl-who { font-weight:700; color:var(--navy); }
    .cl-action { color:var(--text); }
    .cl-time { font-size:.75rem; color:var(--muted); }
    .cl-badge { font-size:.65rem; font-weight:700; padding:.15rem .45rem; border-radius:4px; background:#eef2ff; color:var(--navy); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KPI ANALYTICS PANEL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* Hero banner */
    .kpia-hero {
      background: linear-gradient(135deg, var(--navy) 0%, #1a3a6b 60%, #0d2847 100%);
      border-radius: var(--radius);
      padding: 2rem 2.25rem;
      margin-bottom: 1.75rem;
      position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: space-between; gap: 1.5rem; flex-wrap: wrap;
    }
    .kpia-hero::before {
      content: '';
      position: absolute; top: -60px; right: -60px;
      width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(240,165,0,.12), transparent 70%);
      border-radius: 50%;
    }
    .kpia-hero::after {
      content: '';
      position: absolute; bottom: -40px; left: 30%;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(0,80,200,.15), transparent 70%);
      border-radius: 50%;
    }
    .kpia-hero-text { position: relative; z-index: 1; }
    .kpia-hero-eyebrow {
      font-size: .625rem; font-weight: 700; text-transform: uppercase; letter-spacing: .12em;
      color: var(--gold); margin-bottom: .5rem;
    }
    .kpia-hero-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.625rem; color: #fff; line-height: 1.2; letter-spacing: -.02em;
      margin-bottom: .375rem;
    }
    .kpia-hero-sub { font-size: .875rem; color: rgba(255,255,255,.55); max-width: 520px; line-height: 1.5; }
    .kpia-hero-stats {
      display: flex; gap: 1rem; position: relative; z-index: 1; flex-wrap: wrap;
    }
    .kpia-hstat {
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 10px;
      padding: .875rem 1.125rem;
      text-align: center; min-width: 90px;
    }
    .kpia-hstat-val {
      font-family: 'DM Serif Display', serif;
      font-size: 2rem; line-height: 1; letter-spacing: -.03em;
    }
    .kpia-hstat-label { font-size: .6875rem; font-weight: 600; color: rgba(255,255,255,.5); margin-top: .25rem; text-transform: uppercase; letter-spacing: .04em; }

    /* Chart grid */
    .kpia-chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .kpia-chart-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 900px) {
      .kpia-chart-grid, .kpia-chart-grid-3 { grid-template-columns: 1fr; }
    }

    /* Analytics card */
    .kpia-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    .kpia-card:hover { box-shadow: var(--shadow); }
    .kpia-card-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .kpia-card-title {
      font-size: .9375rem; font-weight: 700; color: var(--navy);
      display: flex; align-items: center; gap: .5rem;
    }
    .kpia-card-meta { font-size: .75rem; color: var(--muted); }

    /* Donut chart (pure CSS) */
    .kpia-donut-wrap {
      display: flex; align-items: center; gap: 1.5rem;
    }
    .kpia-donut {
      width: 120px; height: 120px; flex-shrink: 0;
      border-radius: 50%;
      position: relative;
    }
    .kpia-donut-center {
      position: absolute; inset: 22px;
      background: var(--surface);
      border-radius: 50%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .kpia-donut-num {
      font-family: 'DM Serif Display', serif;
      font-size: 1.5rem; color: var(--navy); line-height: 1;
    }
    .kpia-donut-denom { font-size: .625rem; color: var(--muted); margin-top: 1px; }
    .kpia-legend { flex: 1; display: flex; flex-direction: column; gap: .5rem; }
    .kpia-legend-item {
      display: flex; align-items: center; gap: .5rem; font-size: .8125rem;
    }
    .kpia-legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .kpia-legend-label { flex: 1; color: var(--text-2); }
    .kpia-legend-val { font-weight: 700; color: var(--navy); font-family: 'JetBrains Mono', monospace; font-size: .8125rem; }
    .kpia-legend-pct { font-size: .7rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; width: 32px; text-align: right; }

    /* Horizontal bar chart */
    .kpia-bar-list { display: flex; flex-direction: column; gap: .75rem; }
    .kpia-bar-row { display: flex; flex-direction: column; gap: .3rem; }
    .kpia-bar-meta { display: flex; align-items: center; justify-content: space-between; }
    .kpia-bar-label { font-size: .8125rem; color: var(--text-2); font-weight: 500; }
    .kpia-bar-nums { font-size: .75rem; font-family: 'JetBrains Mono', monospace; color: var(--muted); display: flex; gap: .5rem; align-items: center; }
    .kpia-bar-track {
      height: 8px; background: var(--surface-3); border-radius: 4px; overflow: hidden;
    }
    .kpia-bar-fill {
      height: 100%; border-radius: 4px;
      transition: width .6s cubic-bezier(.4,0,.2,1);
    }

    /* Velocity / trend cards */
    .kpia-trend-row {
      display: flex; flex-direction: column; gap: .625rem;
    }
    .kpia-trend-item {
      display: flex; align-items: center; gap: .875rem;
      padding: .75rem;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      transition: var(--transition);
    }
    .kpia-trend-item:hover { border-color: var(--blue-mid); background: var(--surface); box-shadow: var(--shadow-sm); }
    .kpia-trend-icon {
      width: 36px; height: 36px; border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; flex-shrink: 0;
    }
    .kpia-trend-body { flex: 1; min-width: 0; }
    .kpia-trend-name {
      font-size: .8125rem; font-weight: 600; color: var(--navy);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .kpia-trend-sub { font-size: .75rem; color: var(--muted); margin-top: 1px; line-height: 1.4; }
    .kpia-trend-badge {
      font-size: .6875rem; font-weight: 700; padding: .25rem .6rem;
      border-radius: 6px; flex-shrink: 0; white-space: nowrap;
    }
    .kpia-badge-met    { background: var(--met-bg);  color: var(--met); }
    .kpia-badge-prog   { background: var(--prog-bg); color: var(--progress); }
    .kpia-badge-part   { background: var(--part-bg); color: var(--partial); }
    .kpia-badge-pipe   { background: var(--pipe-bg); color: var(--pipeline); }
    .kpia-badge-notmet { background: var(--notm-bg); color: var(--notmet); }

    /* Completion meter */
    .kpia-meter-wrap { margin-bottom: 1.25rem; }
    .kpia-meter-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: .5rem; }
    .kpia-meter-label { font-size: .8125rem; font-weight: 600; color: var(--text-2); }
    .kpia-meter-pct {
      font-family: 'DM Serif Display', serif;
      font-size: 1.375rem; color: var(--navy); letter-spacing: -.02em;
    }
    .kpia-meter-track {
      height: 12px; background: var(--surface-3); border-radius: 6px; overflow: hidden;
    }
    .kpia-meter-fill {
      height: 100%; border-radius: 6px;
      background: linear-gradient(90deg, var(--blue-mid), var(--blue-lite));
      transition: width .8s cubic-bezier(.4,0,.2,1);
    }
    .kpia-meter-segments {
      display: flex; gap: 2px; margin-top: .5rem;
      height: 6px; border-radius: 4px; overflow: hidden;
    }
    .kpia-meter-seg { height: 100%; transition: flex .6s ease; }

    /* Inquiry form modal */
    .kpia-inquiry-modal {
      position: fixed; inset: 0; z-index: 600;
      background: rgba(10,22,40,.65);
      backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      padding: 1rem;
      opacity: 0; pointer-events: none;
      transition: opacity .25s ease;
    }
    .kpia-inquiry-modal.open { opacity: 1; pointer-events: all; }
    .kpia-inquiry-box {
      background: var(--surface);
      border-radius: 16px;
      width: 100%; max-width: 620px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      transform: translateY(16px);
      transition: transform .3s cubic-bezier(.4,0,.2,1);
    }
    .kpia-inquiry-modal.open .kpia-inquiry-box { transform: translateY(0); }
    .kpia-inquiry-header {
      background: linear-gradient(135deg, var(--navy), #1a3a6b);
      padding: 1.5rem 1.75rem;
      display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;
    }
    .kpia-inquiry-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.25rem; color: #fff; margin-bottom: .25rem;
    }
    .kpia-inquiry-sub { font-size: .8125rem; color: rgba(255,255,255,.5); }
    .kpia-inquiry-close {
      background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.15);
      color: #fff; border-radius: 8px;
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1rem; flex-shrink: 0; transition: var(--transition);
    }
    .kpia-inquiry-close:hover { background: rgba(255,255,255,.2); }
    .kpia-inquiry-body { padding: 1.75rem; }
    .kpia-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
    .kpia-form-group { margin-bottom: 1rem; }
    .kpia-form-group:last-child { margin-bottom: 0; }
    .kpia-form-label {
      display: block; font-size: .8125rem; font-weight: 600; color: var(--navy);
      margin-bottom: .4rem;
    }
    .kpia-form-label .req { color: var(--notmet); margin-left: 2px; }
    .kpia-form-ctrl {
      width: 100%; padding: .625rem .875rem;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: .875rem; font-family: inherit; color: var(--text);
      background: var(--surface);
      transition: var(--transition); outline: none;
      resize: vertical;
    }
    .kpia-form-ctrl:focus {
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 3px rgba(0,80,200,.1);
    }
    .kpia-form-ctrl::placeholder { color: var(--muted); }
    .kpia-metric-select-wrap {
      position: relative;
    }
    .kpia-metric-select-wrap::after {
      content: 'â–¾';
      position: absolute; right: .75rem; top: 50%; transform: translateY(-50%);
      color: var(--muted); pointer-events: none; font-size: .75rem;
    }
    .kpia-metric-select-wrap select { appearance: none; }
    .kpia-form-footer {
      display: flex; align-items: center; justify-content: flex-end;
      gap: .75rem; padding-top: 1.25rem;
      border-top: 1px solid var(--border-2); margin-top: 1.25rem;
    }
    .kpia-form-note {
      font-size: .75rem; color: var(--muted); margin-right: auto;
      display: flex; align-items: center; gap: .375rem;
    }
    .kpia-submit-btn {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .6875rem 1.5rem;
      background: linear-gradient(135deg, var(--blue), var(--blue-mid));
      color: #fff; border: none; border-radius: 10px;
      font-size: .875rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--transition);
      box-shadow: 0 4px 12px rgba(0,48,135,.3);
    }
    .kpia-submit-btn:hover {
      background: linear-gradient(135deg, var(--blue-mid), var(--blue-lite));
      transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,80,200,.35);
    }
    .kpia-submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
    .kpia-submit-spinner {
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .kpia-submit-btn.loading .kpia-submit-spinner { display: block; }
    .kpia-submit-btn.loading .kpia-submit-txt { display: none; }

    /* Success state */
    .kpia-success {
      padding: 2rem; text-align: center; display: none;
    }
    .kpia-success.show { display: block; }
    .kpia-success-icon {
      font-size: 2.5rem; margin-bottom: .75rem;
    }
    .kpia-success-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.375rem; color: var(--navy); margin-bottom: .5rem;
    }
    .kpia-success-sub { font-size: .875rem; color: var(--text-2); line-height: 1.6; }
    .kpia-success-new {
      margin-top: 1.5rem;
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .625rem 1.25rem;
      background: var(--surface-3); color: var(--navy);
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: .875rem; font-weight: 600; cursor: pointer;
      transition: var(--transition);
    }
    .kpia-success-new:hover { border-color: var(--blue-mid); color: var(--blue-mid); }

    /* Inquiry trigger button on panel */
    .kpia-inquire-trigger {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .5625rem 1.125rem;
      background: linear-gradient(135deg, #d4890a, var(--gold));
      color: var(--navy); border: none; border-radius: 10px;
      font-size: .8125rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--transition);
      box-shadow: 0 3px 10px rgba(240,165,0,.3);
    }
    .kpia-inquire-trigger:hover { transform: translateY(-1px); box-shadow: 0 5px 14px rgba(240,165,0,.4); }

    /* Insights callout strip */
    .kpia-insight-strip {
      display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;
    }
    .kpia-insight {
      flex: 1; min-width: 200px;
      display: flex; align-items: flex-start; gap: .75rem;
      padding: 1rem 1.125rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
    }
    .kpia-insight-icon {
      font-size: 1.375rem; flex-shrink: 0; margin-top: .1rem;
    }
    .kpia-insight-label {
      font-size: .6875rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .07em; color: var(--muted); margin-bottom: .25rem;
    }
    .kpia-insight-val {
      font-size: .875rem; font-weight: 600; color: var(--navy); line-height: 1.45;
    }

    /* Goal health matrix */
    .kpia-matrix {
      display: flex; flex-direction: column; gap: .5rem;
    }
    .kpia-matrix-row {
      display: flex; align-items: center; gap: .75rem;
    }
    .kpia-matrix-label {
      font-size: .8125rem; font-weight: 500; color: var(--text-2);
      flex: 0 0 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .kpia-matrix-bar-wrap {
      flex: 1; display: flex; gap: 2px; height: 18px;
      border-radius: 4px; overflow: hidden;
    }
    .kpia-matrix-seg { height: 100%; position: relative; cursor: default; min-width: 2px; }
    .kpia-matrix-seg:hover::after {
      content: attr(data-tip);
      position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%);
      background: var(--navy); color: #fff; font-size: .7rem; padding: .25rem .5rem;
      border-radius: 5px; white-space: nowrap; pointer-events: none; z-index: 10;
    }
    .kpia-matrix-count { font-family: 'JetBrains Mono', monospace; font-size: .75rem; color: var(--muted); flex-shrink: 0; width: 28px; text-align: right; }

    /* At-a-glance scoreboard */
    .kpia-scoreboard {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: .875rem; margin-bottom: 1.5rem;
    }
    .kpia-score-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.125rem 1.25rem;
      position: relative; overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      cursor: pointer;
    }
    .kpia-score-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
    .kpia-score-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: var(--score-color, var(--blue-mid));
    }
    .kpia-score-val {
      font-family: 'DM Serif Display', serif;
      font-size: 2.25rem; color: var(--navy); line-height: 1; letter-spacing: -.03em;
    }
    .kpia-score-label {
      font-size: .6875rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .05em; color: var(--muted); margin-top: .375rem;
    }
    .kpia-score-chip {
      display: inline-flex; align-items: center; gap: .25rem;
      font-size: .6875rem; font-weight: 700;
      padding: .2rem .5rem; border-radius: 20px;
      margin-top: .5rem;
    }

    /* Focus areas */
    .kpia-focus-list { display: flex; flex-direction: column; gap: .5rem; }
    .kpia-focus-item {
      display: flex; align-items: center; gap: .875rem;
      padding: .875rem 1rem;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px; cursor: pointer; transition: var(--transition);
    }
    .kpia-focus-item:hover { border-color: var(--blue-mid); background: var(--surface); box-shadow: var(--shadow-sm); }
    .kpia-focus-rank {
      font-family: 'DM Serif Display', serif;
      font-size: 1.375rem; color: var(--muted); width: 28px; text-align: center; flex-shrink: 0;
    }
    .kpia-focus-body { flex: 1; min-width: 0; }
    .kpia-focus-goal { font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--blue-mid); margin-bottom: .2rem; }
    .kpia-focus-target { font-size: .875rem; font-weight: 600; color: var(--navy); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 380px; }
    .kpia-focus-meta { font-size: .75rem; color: var(--muted); margin-top: .15rem; }
    .kpia-focus-action {
      font-size: .75rem; font-weight: 700; color: var(--blue-mid);
      cursor: pointer; background: none; border: none; font-family: inherit;
      white-space: nowrap; flex-shrink: 0; padding: .25rem .5rem; border-radius: 6px; transition: var(--transition);
    }
    .kpia-focus-action:hover { background: var(--prog-bg); }

    /* Tabs for KPI Analytics */
    .kpia-tabs {
      display: flex; gap: .375rem; flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding: .375rem;
      background: var(--surface-3);
      border-radius: 12px;
      border: 1px solid var(--border);
      width: fit-content;
    }
    .kpia-tab {
      padding: .5rem 1rem;
      font-size: .8125rem; font-weight: 600; color: var(--text-2);
      border: none; background: transparent;
      border-radius: 8px; cursor: pointer;
      transition: var(--transition); font-family: inherit;
      white-space: nowrap;
    }
    .kpia-tab:hover { color: var(--navy); background: rgba(0,0,0,.04); }
    .kpia-tab.active {
      background: var(--surface);
      color: var(--navy);
      box-shadow: var(--shadow-sm);
    }

    /* Inquiry CTA banner */
    .kpia-cta-banner {
      background: linear-gradient(135deg, #0d2847, #1a3a6b);
      border-radius: var(--radius);
      padding: 1.5rem 1.75rem;
      display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;
      margin-top: 1.75rem;
      position: relative; overflow: hidden;
      border: 1px solid rgba(240,165,0,.2);
    }
    .kpia-cta-banner::before {
      content: '';
      position: absolute; top: -50px; right: 60px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(240,165,0,.1), transparent 70%);
      border-radius: 50%;
    }
    .kpia-cta-icon { font-size: 2rem; flex-shrink: 0; position: relative; z-index: 1; }
    .kpia-cta-body { flex: 1; position: relative; z-index: 1; }
    .kpia-cta-title { font-family: 'DM Serif Display', serif; font-size: 1.125rem; color: #fff; margin-bottom: .25rem; }
    .kpia-cta-sub { font-size: .8125rem; color: rgba(255,255,255,.5); line-height: 1.5; }
    .kpia-cta-btn {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .75rem 1.5rem;
      background: linear-gradient(135deg, #d4890a, var(--gold));
      color: var(--navy); border: none; border-radius: 10px;
      font-size: .875rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--transition);
      box-shadow: 0 4px 12px rgba(240,165,0,.4);
      position: relative; z-index: 1;
    }
    .kpia-cta-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(240,165,0,.5); }


    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SY ANALYTICS MODULE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sy-district-item{padding:.75rem 1rem;border-bottom:1px solid var(--border-2);cursor:pointer;transition:var(--transition)}
    .sy-district-item:hover{background:var(--surface-2)}
    .sy-district-item.syd-active{background:var(--prog-bg);border-left:3px solid var(--blue-mid)}
    .sy-dist-name{font-size:.8125rem;font-weight:700;color:var(--navy)}
    .sy-dist-meta{font-size:.6875rem;color:var(--muted);margin-top:.2rem;display:flex;gap:.625rem;flex-wrap:wrap}
    .sy-detail-school{font-family:'DM Serif Display',serif;font-size:1.125rem;color:var(--navy);line-height:1.3;margin-bottom:.25rem}
    .sy-detail-district{font-size:.75rem;font-weight:700;color:var(--blue-mid);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.875rem}
    .sy-detail-section{font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--blue-mid);padding:.5rem 0 .25rem;margin-top:.375rem;border-top:1px solid var(--border-2)}
    .sy-detail-row{display:flex;justify-content:space-between;align-items:baseline;padding:.3rem 0;gap:.5rem}
    .sy-detail-label{font-size:.6875rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;flex-shrink:0}
    .sy-detail-val{font-size:.8125rem;color:var(--text);text-align:right;font-weight:500;max-width:65%;word-break:break-word}
    .sy-staff-grid{display:grid;grid-template-columns:1fr 1fr;gap:.375rem .75rem;margin:.375rem 0 .5rem}
    .sy-staff-cell-label{font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .sy-staff-cell-val{font-size:.9375rem;font-weight:700;color:var(--navy);font-family:'DM Serif Display',serif}
    #syTable tbody tr{cursor:pointer;transition:background .12s}
    #syTable tbody tr:hover{background:var(--surface-2)}
    #syTable tbody tr.sy-row-hl{background:var(--prog-bg)}
    #syTable td{padding:.5rem .875rem;border-bottom:1px solid var(--border-2);vertical-align:middle}
    .sy-modal-overlay{position:fixed;inset:0;z-index:9000;background:rgba(10,22,40,.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:2rem}
    .sy-modal{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-lg);width:100%;max-width:600px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
    .sy-modal-hd{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sy-modal-title{font-family:'DM Serif Display',serif;font-size:1.25rem;color:var(--navy)}
    .sy-modal-close{background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--muted)}
    .sy-chg{padding:.625rem .875rem;border-radius:8px;margin-bottom:.5rem;font-size:.8125rem;line-height:1.5}
    .sy-chg-added{background:var(--met-bg);border-left:3px solid var(--met);color:#0a4a27}
    .sy-chg-removed{background:var(--notm-bg);border-left:3px solid var(--notmet);color:#911818}
    .sy-chg-mod{background:var(--prog-bg);border-left:3px solid var(--progress);color:#1a3a8f}
    .sy-chg-label{font-weight:700}
    .sy-chg-detail{font-size:.75rem;opacity:.85}
    .sy-popup{font-family:'DM Sans',sans-serif;min-width:190px;font-size:.8125rem}
    .sy-popup-school{font-weight:700;font-size:.9375rem;color:#0a1628;margin-bottom:.15rem}
    .sy-popup-dist{font-size:.6875rem;color:#0050c8;font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:.5rem}
    .sy-popup-row{display:flex;justify-content:space-between;gap:.5rem;padding:.2rem 0;border-bottom:1px solid #eef1f6}
    .sy-popup-row:last-child{border-bottom:none}
    .sy-popup-lbl{color:#7d8fa1}
    .sy-popup-val{font-weight:600;color:#0d1b2a}
    @media(max-width:1100px){#syMainLayout{grid-template-columns:1fr !important}#syMap{height:360px !important}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PEARL OPERATIONS MODULE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .po-badge{display:inline-flex;align-items:center;gap:.25rem;padding:.2rem .5rem;border-radius:20px;font-size:.6875rem;font-weight:700;line-height:1.2}
    .po-badge-green{background:var(--met-bg);color:#065f46}
    .po-badge-gold{background:#fef3c7;color:#92400e}
    .po-badge-red{background:var(--notm-bg);color:#991b1b}
    .po-badge-critical{background:#7f1d1d;color:#fef2f2}
    .po-badge-blue{background:var(--prog-bg);color:#1a3a8f}
    .po-badge-gray{background:var(--surface-2);color:var(--muted)}
    .po-flag-row{display:flex;align-items:center;gap:.5rem;padding:.5rem .875rem;border-bottom:1px solid var(--border-2);font-size:.8125rem}
    .po-flag-icon{font-size:1rem;flex-shrink:0}
    .po-flag-text{flex:1}
    .po-flag-label{font-weight:700;color:var(--navy)}
    .po-flag-sub{font-size:.75rem;color:var(--muted);margin-top:.1rem}
    .po-flag-count{font-size:.8125rem;font-weight:700;color:var(--navy);flex-shrink:0}
    .po-school-row{cursor:pointer;transition:background .15s}
    .po-school-row:hover{background:var(--surface-2)}
    .po-school-row td{padding:.625rem 1rem;border-bottom:1px solid var(--border-2);vertical-align:middle}
    .po-school-row.po-hl{background:var(--prog-bg)}
    .po-tab{padding:.5rem 1rem;font-size:.8125rem;font-weight:600;border:none;background:none;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s}
    .po-tab.po-tab-active{color:var(--blue-mid);border-bottom-color:var(--blue-mid)}
    .po-tab:hover{color:var(--navy)}
    .po-tabs-bar{display:flex;border-bottom:1px solid var(--border);margin-bottom:1.25rem;overflow-x:auto;flex-shrink:0}
    .po-detail-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden}
    .po-section-hd{padding:.75rem 1.25rem;border-bottom:1px solid var(--border);background:var(--surface-2);font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);display:flex;align-items:center;justify-content:space-between}
    .po-person-row{cursor:pointer;transition:background .12s}
    .po-person-row:hover{background:var(--surface-2)}
    .po-person-row td{padding:.5rem .875rem;border-bottom:1px solid var(--border-2);vertical-align:middle;font-size:.8125rem}
    .po-sparkbar{height:6px;border-radius:3px;background:var(--border-2);overflow:hidden;width:80px;display:inline-block;vertical-align:middle}
    .po-sparkbar-fill{height:100%;border-radius:3px;transition:width .4s}
    .po-modal-overlay{position:fixed;inset:0;z-index:9100;background:rgba(10,22,40,.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1.5rem}
    .po-modal{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-lg);width:100%;max-width:780px;max-height:88vh;display:flex;flex-direction:column;overflow:hidden}
    .po-modal-hd{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-shrink:0}
    .po-modal-close{background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--muted);line-height:1}
    .po-modal-close:hover{color:var(--navy)}
    .po-modal-body{overflow-y:auto;flex:1;padding:0}
    .po-modal-name{font-family:'DM Serif Display',serif;font-size:1.25rem;color:var(--navy)}
    .po-modal-meta{font-size:.75rem;color:var(--muted);margin-top:.2rem}
    .po-hist-row{display:grid;grid-template-columns:100px 1fr 90px 80px;gap:.5rem;align-items:center;padding:.5rem 1.5rem;border-bottom:1px solid var(--border-2);font-size:.8125rem}
    .po-hist-row:nth-child(even){background:var(--surface-2)}
    .po-comment-card{margin:.5rem 1.5rem;padding:.875rem 1rem;background:var(--surface-2);border-radius:8px;border-left:3px solid var(--border)}
    .po-comment-card.cc-concern{border-left-color:#ef4444}
    .po-comment-card.cc-positive{border-left-color:var(--met)}
    .po-comment-card.cc-neutral{border-left-color:var(--partial)}
    .po-comment-bucket{display:inline-block;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;padding:.15rem .5rem;border-radius:20px;margin-bottom:.3rem}
    .po-bucket-concern{background:#fee2e2;color:#991b1b}
    .po-bucket-positive{background:#d1fae5;color:#065f46}
    .po-bucket-engagement{background:#ede9fe;color:#5b21b6}
    .po-bucket-logistics{background:#fef3c7;color:#92400e}
    .po-bucket-curriculum{background:#dbeafe;color:#1e40af}
    .po-bucket-relationship{background:#fce7f3;color:#9d174d}
    .po-bucket-other{background:var(--surface-2);color:var(--muted)}
    .po-metric-row{display:flex;align-items:center;justify-content:space-between;padding:.4rem 1.5rem;border-bottom:1px solid var(--border-2);font-size:.8125rem}
    .po-metric-label{color:var(--muted);font-weight:500}
    .po-metric-val{font-weight:700;color:var(--navy)}
    .po-stars{display:inline-flex;gap:1px}
    .po-star-fill{color:#f59e0b}
    .po-star-empty{color:var(--border-2)}
    .po-breadcrumb{display:flex;align-items:center;gap:.5rem;font-size:.8125rem;color:var(--muted);margin-bottom:1rem;flex-wrap:wrap}
    .po-breadcrumb a{color:var(--blue-mid);cursor:pointer;text-decoration:none}
    .po-breadcrumb a:hover{text-decoration:underline}
    .po-breadcrumb-sep{color:var(--border)}
    .po-severity-critical{background:#7f1d1d;color:#fef2f2;padding:.15rem .5rem;border-radius:4px;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .po-severity-high{background:#fee2e2;color:#991b1b;padding:.15rem .5rem;border-radius:4px;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .po-severity-medium{background:#fef3c7;color:#92400e;padding:.15rem .5rem;border-radius:4px;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .po-severity-low{background:var(--surface-2);color:var(--muted);padding:.15rem .5rem;border-radius:4px;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .po-survey-bar-wrap{display:flex;align-items:center;gap:.5rem}
    .po-survey-bar{height:8px;border-radius:4px;background:var(--border-2);flex:1;overflow:hidden}
    .po-survey-bar-fill{height:100%;border-radius:4px}
    .po-filter-strip{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;padding:.875rem 1.25rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:1.25rem;box-shadow:var(--shadow-sm)}
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
</head>
<body>

<!-- Loading screen -->
<div id="loadingScreen" style="position:fixed;inset:0;background:var(--navy);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:1rem;">
  <div style="font-family:'DM Serif Display',serif;font-size:2rem;color:#fff;letter-spacing:-.02em;">NJTC</div>
  <div style="font-size:.875rem;color:rgba(255,255,255,.4);">Verifying accessâ€¦</div>
  <div style="width:180px;height:2px;background:rgba(255,255,255,.1);border-radius:1px;overflow:hidden;margin-top:.5rem;">
    <div style="height:100%;background:linear-gradient(90deg,var(--blue-lite),var(--gold));border-radius:1px;animation:barSlide 1.5s ease forwards;"></div>
  </div>
</div>

<!-- Top Nav -->
<nav class="ct-nav">
  <div class="nav-brand">
    <div class="nav-logo">N</div>
    <div>
      <div class="nav-title">Central Team Portal</div>
      <div class="nav-subtitle">New Jersey Tutoring Corps</div>
    </div>
  </div>
  <div class="nav-center">
    <span class="nav-date" id="navDate"></span>
  </div>
  <div class="nav-right">
    <span class="dept-pill" id="deptBadge">LOADING</span>
    <span class="session-badge" id="sessionTimer">â€”</span>
    <button class="btn-signout" onclick="NJTCAuth.logout()">Sign Out</button>
  </div>
</nav>

<!-- Layout -->
<div class="ct-layout" id="ctLayout" style="display:none">

  <!-- Sidebar -->
  <aside class="ct-sidebar">

    <!-- Dept card -->
    <div class="sidebar-dept-card" id="sidebarDeptCard">
      <div class="sdc-label">Your Department</div>
      <div class="sdc-dept" id="sdcDept">â€”</div>
      <div class="sdc-tagline" id="sdcTagline">â€”</div>
      <div class="sdc-bar"><div class="sdc-bar-fill" id="sdcBar" style="--pct:0%"></div></div>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Navigation</div>
      <button class="sidebar-link active" data-panel="home" onclick="showPanel('home',this)">
        <span class="sl-icon">ğŸ </span> Department Home
      </button>
      <button class="sidebar-link" data-panel="kpi" onclick="showPanel('kpi',this)">
        <span class="sl-icon">ğŸ“Š</span> KPI Targets
        <span class="sl-badge gold" id="metBadge">â€”</span>
      </button>
      <button class="sidebar-link" data-panel="kpi-analytics" onclick="showPanel('kpi-analytics',this)">
        <span class="sl-icon">ğŸ”</span> KPI Analytics
      </button>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Documents</div>
      <button class="sidebar-link" data-panel="policies" onclick="showPanel('policies',this)">
        <span class="sl-icon">ğŸ“š</span> Policies Library
      </button>
      <button class="sidebar-link" data-panel="upload" onclick="showPanel('upload',this)">
        <span class="sl-icon">â˜ï¸</span> Drive Center
      </button>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Reporting</div>
      <button class="sidebar-link" data-panel="sy-analytics" onclick="showPanel('sy-analytics',this)">
        <span class="sl-icon">ğŸ—ºï¸</span> SY Site Analytics
        <span class="sl-badge" id="syChangesBadge" style="display:none;background:var(--gold);color:var(--navy);border-radius:10px;padding:0 6px;font-size:.65rem;font-weight:700;margin-left:auto"></span>
      </button>
      <button class="sidebar-link" data-panel="pearl-ops" onclick="showPanel('pearl-ops',this)">
        <span class="sl-icon">ğŸ“Š</span> Pearl Operations
        <span class="sl-badge" id="pearlFlagsBadge" style="display:none;background:#ef4444;color:#fff;border-radius:10px;padding:0 6px;font-size:.65rem;font-weight:700;margin-left:auto"></span>
      </button>
      <button class="sidebar-link" data-panel="concern" onclick="showPanel('concern',this)">
        <span class="sl-icon">âš ï¸</span> Concern Form
      </button>
      <!-- Dept-restricted nav items â€” shown/hidden by initDeptNav() -->
      <button class="sidebar-link dept-nav-perf" data-panel="perf" onclick="showPanel('perf',this)" style="display:none">
        <span class="sl-icon">ğŸ‘¤</span> Performance Concerns
      </button>
      <button class="sidebar-link dept-nav-talent" data-panel="talent" onclick="showPanel('talent',this)" style="display:none">
        <span class="sl-icon">ğŸ“Š</span> <span id="talentNavLabel">Talent Analytics</span>
      </button>
    </div>

    <div class="sidebar-divider"></div>

    <!-- Dept connections -->
    <div class="dept-connections" id="deptConnectionsCard">
      <div class="dc-title">
        <span>ğŸ”—</span> Department Connections
      </div>
      <div id="deptConnectionsList"><!-- filled by JS --></div>
      <button onclick="openConnectionsModal()" style="margin-top:.625rem;font-size:.6875rem;color:rgba(255,255,255,.45);background:none;border:none;cursor:pointer;font-family:inherit;padding:0;display:flex;align-items:center;gap:.25rem;">View all connections â†’</button>
    </div>

  </aside>

  <!-- Main -->
  <main class="ct-main">

    <!-- â•â• HOME PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel active" id="panel-home">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow" id="homeEyebrow">Department Overview</div>
          <h2 class="ph-title" id="homeTitle">Welcome</h2>
          <p class="ph-subtitle" id="homeSubtitle">Your centralized hub for team operations, reporting, and goal alignment.</p>
        </div>
      </div>
      <!-- KPI summary strip -->
      <div class="stats-strip" id="homeStatsStrip"><!-- filled by JS --></div>
      <!-- Quick links -->
      <div class="ql-grid" id="homeQuickLinks"><!-- filled by JS --></div>
    </div>


    <!-- â•â• SY ANALYTICS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-sy-analytics">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">SY 2025â€“2026 Â· Live Data</div>
          <h2 class="ph-title">Site Analytics Dashboard</h2>
          <p class="ph-subtitle">All active NJTC tutoring sites â€” scholars, staff, programming, and site map. Live from the SY Database, auto-refreshes every 5 minutes.</p>
        </div>
        <div class="ph-actions">
          <span class="sync-dot loading" id="sySyncDot"></span>
          <span id="sySyncText" style="font-size:.8125rem;color:var(--muted)">Loadingâ€¦</span>
          <button class="btn btn-secondary" onclick="sya.refresh(true)" id="syRefreshBtn">â†º Refresh</button>
          <button class="btn btn-secondary" id="syChangesBtn" onclick="sya.openChangesModal()" style="display:none">
            <span id="syChangesBtnN" style="background:var(--gold);color:var(--navy);border-radius:10px;padding:1px 7px;font-size:.7rem;font-weight:700;margin-right:.3rem">0</span>Changes
          </button>
        </div>
      </div>
      <div class="stats-strip">
        <div class="stat-tile" style="--accent-color:var(--blue-mid)"><div class="st-icon">ğŸ«</div><div class="st-value" id="syStatSites">â€”</div><div class="st-label">Active Sites</div><div class="st-sub">District &amp; school data</div></div>
        <div class="stat-tile" style="--accent-color:var(--prog)"><div class="st-icon">ğŸ›ï¸</div><div class="st-value" id="syStatDistricts">â€”</div><div class="st-label">Districts</div><div class="st-sub">Unique partners</div></div>
        <div class="stat-tile" style="--accent-color:var(--met)"><div class="st-icon">ğŸ“</div><div class="st-value" id="syStatActual">â€”</div><div class="st-label">Actual Scholars</div><div class="st-sub">Enrolled via Pearl</div></div>
        <div class="stat-tile" style="--accent-color:var(--partial)"><div class="st-icon">ğŸ“‹</div><div class="st-value" id="syStatEst">â€”</div><div class="st-label">Est. Scholars</div><div class="st-sub">Quoted capacity</div></div>
        <div class="stat-tile" style="--accent-color:var(--notmet)"><div class="st-icon">ğŸ‘¥</div><div class="st-value" id="syStatStaff">â€”</div><div class="st-label">Total Staff</div><div class="st-sub">Across all sites</div></div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:.875rem 1.25rem;margin-bottom:1.5rem;box-shadow:var(--shadow-sm)">
        <div style="display:flex;align-items:center;gap:.625rem;flex-wrap:wrap">
          <span style="font-size:.6875rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;flex-shrink:0">Filter:</span>
          <select class="filter-select" id="syFDistrict" onchange="sya.applyFilters()"><option value="">All Districts</option></select>
          <select class="filter-select" id="syFContent"  onchange="sya.applyFilters()"><option value="">All Content</option></select>
          <select class="filter-select" id="syFType"     onchange="sya.applyFilters()"><option value="">All Tutoring Types</option></select>
          <select class="filter-select" id="syFAssess"   onchange="sya.applyFilters()"><option value="">All Assessments</option></select>
          <select class="filter-select" id="syFDays"     onchange="sya.applyFilters()"><option value="">All Days</option></select>
          <select class="filter-select" id="syFStatus"   onchange="sya.applyFilters()"><option value="">All Statuses</option><option>Active</option><option>Inactive</option></select>
          <button class="btn btn-secondary" onclick="sya.clearFilters()" style="padding:.4rem .875rem;font-size:.8125rem">âœ• Clear</button>
          <span id="syFilterInfo" style="font-size:.8125rem;color:var(--muted)"></span>
        </div>
      </div>
      <div id="syMainLayout" style="display:grid;grid-template-columns:252px 1fr 308px;gap:1.25rem;margin-bottom:1.5rem;align-items:start">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden">
          <div style="padding:.75rem 1rem;border-bottom:1px solid var(--border);background:var(--surface-2);font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)">Districts</div>
          <div id="syDistrictList" style="max-height:500px;overflow-y:auto;scrollbar-width:thin"></div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden;position:relative">
          <div id="syMap" style="height:500px;width:100%"></div>
          <div id="syUnmappedBanner" style="display:none;position:absolute;bottom:0;left:0;right:0;background:rgba(10,22,40,.82);color:#fff;font-size:.75rem;padding:.5rem 1rem;backdrop-filter:blur(4px)"></div>
        </div>
        <div id="syDetailCard" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:1.25rem;overflow-y:auto;max-height:500px">
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:260px;color:var(--muted);text-align:center">
            <div style="font-size:2rem;margin-bottom:.75rem">ğŸ“</div>
            <div style="font-size:.875rem;font-weight:500">Click a map pin or table row<br>to view site details</div>
          </div>
        </div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden">
        <div style="padding:.75rem 1.25rem;border-bottom:1px solid var(--border);background:var(--surface-2)">
          <span style="font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)">All Sites</span>
          <span id="syTableCount" style="color:var(--blue-mid);font-weight:500;margin-left:.5rem;font-size:.75rem"></span>
        </div>
        <div style="overflow-x:auto">
          <table id="syTable" style="width:100%;border-collapse:collapse;font-size:.8125rem">
            <thead><tr style="background:var(--surface-2)">
              <th style="padding:.5rem .875rem;text-align:left;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap">District</th>
              <th style="padding:.5rem .875rem;text-align:left;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border)">School</th>
              <th style="padding:.5rem .875rem;text-align:center;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap">Actual</th>
              <th style="padding:.5rem .875rem;text-align:center;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap">Est.</th>
              <th style="padding:.5rem .875rem;text-align:center;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap">Staff</th>
              <th style="padding:.5rem .875rem;text-align:left;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border)">Content</th>
              <th style="padding:.5rem .875rem;text-align:left;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border)">Type</th>
              <th style="padding:.5rem .875rem;text-align:left;font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border)">Assessment</th>
            </tr></thead>
            <tbody id="syTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- â•â• END SY ANALYTICS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- â•â• PEARL OPERATIONS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-pearl-ops">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">SY 2025â€“2026 Â· Live Pearl Data</div>
          <h2 class="ph-title">Pearl Operations Intelligence</h2>
          <p class="ph-subtitle" id="poSubtitle">Live attendance, surveys, HIT compliance, and service interruption tracking across all sites. Auto-refreshes every 5 minutes.</p>
        </div>
        <div class="ph-actions">
          <span class="sync-dot loading" id="poSyncDot"></span>
          <span id="poSyncText" style="font-size:.8125rem;color:var(--muted)">Loadingâ€¦</span>
          <button class="btn btn-secondary" onclick="po.refresh(true)" id="poRefreshBtn">â†º Refresh</button>
          <button class="btn btn-secondary" id="poCriticalBtn" onclick="po.openFlagsModal('critical')" style="display:none;background:#7f1d1d;color:#fef2f2;border-color:#7f1d1d">
            ğŸš¨ <span id="poCriticalN">0</span> Critical
          </button>
        </div>
      </div>

      <!-- Breadcrumb nav for drill-down -->
      <div id="poBreadcrumb" class="po-breadcrumb" style="display:none"></div>

      <!-- Executive Stats Strip -->
      <div class="stats-strip" id="poStatsStrip">
        <div class="stat-tile" style="--accent-color:var(--met)"><div class="st-icon">âœ…</div><div class="st-value" id="poStatAtt">â€”</div><div class="st-label">Scholar Attendance</div><div class="st-sub" id="poStatAttSub">Scholar rate</div></div>
        <div class="stat-tile" style="--accent-color:#0ea5e9"><div class="st-icon">ğŸ“</div><div class="st-value" id="poStatInstAtt">â€”</div><div class="st-label">Tutor Attendance</div><div class="st-sub">Tutor rate</div></div>
        <div class="stat-tile" style="--accent-color:var(--blue-mid)"><div class="st-icon">ğŸ“…</div><div class="st-value" id="poStatSessions">â€”</div><div class="st-label">Sessions Delivered</div><div class="st-sub" id="poStatSessionsSub">vs total scheduled</div></div>
        <div class="stat-tile" style="--accent-color:var(--partial)"><div class="st-icon">âš ï¸</div><div class="st-value" id="poStatInterruptions">â€”</div><div class="st-label">Service Interruptions</div><div class="st-sub">Non-absence disruptions</div></div>
        <div class="stat-tile" style="--accent-color:#8b5cf6"><div class="st-icon">â­</div><div class="st-value" id="poStatSurveyScholar">â€”</div><div class="st-label">Scholar Survey Avg</div><div class="st-sub">Confidence Â· Learning Â· Overall</div></div>
        <div class="stat-tile" style="--accent-color:#a855f7"><div class="st-icon">ğŸ“‹</div><div class="st-value" id="poStatSurveyTutor">â€”</div><div class="st-label">Tutor Survey Avg</div><div class="st-sub">Engagement Â· Quality Â· Overall</div></div>
        <div class="stat-tile" style="--accent-color:var(--notmet)"><div class="st-icon">ğŸš©</div><div class="st-value" id="poStatFlags">â€”</div><div class="st-label">HIT Flags</div><div class="st-sub">Compliance issues</div></div>
      </div>

      <!-- Filters -->
      <div class="po-filter-strip" id="poFilterStrip">
        <span style="font-size:.6875rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;flex-shrink:0">Filter:</span>
        <select class="filter-select" id="poFDistrict" onchange="po.applyFilters()"><option value="">All Districts</option></select>
        <select class="filter-select" id="poFSchool"   onchange="po.applyFilters()"><option value="">All Schools</option></select>
        <select class="filter-select" id="poFWeek"     onchange="po.applyFilters()"><option value="">All Weeks</option></select>
        <select class="filter-select" id="poFRole"     onchange="po.applyFilters()"><option value="">All Roles</option><option>Student</option><option>Instructor</option></select>
        <select class="filter-select" id="poFFlag"     onchange="po.applyFilters()"><option value="">All Records</option><option value="hit">HIT Flags Only</option><option value="si">Service Interruptions</option><option value="concern">Attendance Concern</option></select>
        <button class="btn btn-secondary" onclick="po.clearFilters()" style="padding:.4rem .875rem;font-size:.8125rem">âœ• Clear</button>
        <span id="poFilterInfo" style="font-size:.8125rem;color:var(--muted);margin-left:auto"></span>
      </div>

      <!-- Main content area â€” swaps between school grid, school detail, person detail -->
      <div id="poMainContent"></div>
    </div>
    <!-- â•â• END PEARL OPERATIONS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- â•â• KPI PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-kpi">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">SY 2025â€“2026</div>
          <h2 class="ph-title">Annual Goal Targets</h2>
          <p class="ph-subtitle">Organizational KPIs across all departments. Pulled live from the NJTC KPI Dashboard â€” updates automatically when the spreadsheet changes.</p>
        </div>
        <div class="ph-actions">
          <button class="btn btn-secondary" id="kpiRefreshBtn" onclick="fetchAndRebuildKPI(true)" title="Re-sync from Google Sheet">â†º Refresh</button>
        </div>
      </div>
      <!-- Live sync bar -->
      <div class="drive-sync-bar" id="kpiSyncBar">
        <div class="sync-dot loading" id="kpiSyncDot"></div>
        <div class="sync-text" id="kpiSyncText">Fetching live data from Google Sheetâ€¦</div>
      </div>
      <!-- Summary tiles -->
      <div class="kpi-summary-strip" id="kpiSummary"><!-- filled by JS --></div>
      <!-- Filters -->
      <div class="kpi-filters">
        <select class="filter-select" id="kpiGoalFilter" onchange="filterKPI()">
          <option value="">All Goal Areas</option>
        </select>
        <select class="filter-select" id="kpiCycleFilter" onchange="filterKPI()">
          <option value="mid">Mid Cycle Status</option>
          <option value="end">End of Cycle Status</option>
        </select>
        <select class="filter-select" id="kpiStatusFilter" onchange="filterKPI()">
          <option value="">All Statuses</option>
          <option value="Met">âœ… Met</option>
          <option value="In Progress">ğŸ”µ In Progress</option>
          <option value="Partially Met">ğŸŸ  Partially Met</option>
          <option value="Coming Down the Pipeline">ğŸŸ£ Pipeline</option>
          <option value="Has Not Met">ğŸ”´ Has Not Met</option>
        </select>
        <input type="text" class="filter-input" id="kpiSearch" placeholder="Search targetsâ€¦" oninput="filterKPI()" style="flex:1;min-width:180px;">
      </div>
      <div class="kpi-wrap">
        <table class="kpi-table">
          <thead>
            <tr>
              <th style="width:200px">Goal Area</th>
              <th>2025â€“2026 Organizational Target</th>
              <th style="width:190px" id="midCycleHeader">Mid Cycle Status</th>
              <th style="width:190px" id="endCycleHeader">End of Cycle Status</th>
            </tr>
          </thead>
          <tbody id="kpiBody"><!-- filled by JS --></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• KPI ANALYTICS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-kpi-analytics">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">Performance Intelligence</div>
          <h2 class="ph-title">KPI Analytics Dashboard</h2>
          <p class="ph-subtitle">Visual breakdown of organizational goal performance, velocity, and focus areas â€” cross-department insight at a glance.</p>
        </div>
        <div class="ph-actions">
          <button class="kpia-inquire-trigger" onclick="openKPIInquiry()">
            ğŸ’¬ Submit KPI Inquiry
          </button>
          <button class="btn btn-secondary" onclick="fetchAndRebuildKPI(true).then(()=>buildKPIAnalytics())" title="Refresh from Google Sheet">â†º Refresh</button>
        </div>
      </div>
      <!-- Content area filled by JS -->
      <div id="kpiAnalyticsContent"></div>
    </div>

    <!-- â•â• POLICIES PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- â•â• KPI INQUIRY MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="kpia-inquiry-modal" id="kpiInquiryModal" onclick="if(event.target===this)closeKPIInquiry()">
  <div class="kpia-inquiry-box">
    <div class="kpia-inquiry-header">
      <div>
        <div class="kpia-inquiry-title">KPI Inquiry & Context</div>
        <div class="kpia-inquiry-sub">Ask a question or provide context about a specific KPI metric</div>
      </div>
      <button class="kpia-inquiry-close" onclick="closeKPIInquiry()">âœ•</button>
    </div>
    <!-- Form state -->
    <div id="kpiInquiryForm">
      <div class="kpia-inquiry-body">
        <div class="kpia-form-row">
          <div class="kpia-form-group">
            <label class="kpia-form-label">Your Name <span class="req">*</span></label>
            <input type="text" id="kpiq_name" class="kpia-form-ctrl" placeholder="Full nameâ€¦" />
          </div>
          <div class="kpia-form-group">
            <label class="kpia-form-label">Metric / KPI Being Referenced <span class="req">*</span></label>
            <div class="kpia-metric-select-wrap">
              <select id="kpiq_metric" class="kpia-form-ctrl">
                <option value="">Select a metricâ€¦</option>
              </select>
            </div>
          </div>
        </div>
        <div class="kpia-form-group">
          <label class="kpia-form-label">Your Question or Context <span class="req">*</span></label>
          <textarea id="kpiq_context" class="kpia-form-ctrl" rows="5"
            placeholder="Describe your question, concern, or additional context about this KPI. What are you seeing? What do you need help understanding? Is there context the team should know?"></textarea>
        </div>
        <div id="kpiq_error" style="font-size:.8125rem;color:var(--notmet);margin-top:.5rem;display:none"></div>
        <div class="kpia-form-footer">
          <div class="kpia-form-note">
            ğŸ”’ Submitted directly to leadership for review
          </div>
          <button class="btn btn-secondary" onclick="closeKPIInquiry()">Cancel</button>
          <button class="kpia-submit-btn" id="kpiqSubmitBtn" onclick="submitKPIInquiry()">
            <span class="kpia-submit-txt">Submit Inquiry â†’</span>
            <div class="kpia-submit-spinner"></div>
          </button>
        </div>
      </div>
    </div>
    <!-- Success state -->
    <div class="kpia-success" id="kpiInquirySuccess">
      <div class="kpia-success-icon">âœ…</div>
      <div class="kpia-success-title">Inquiry Submitted</div>
      <div class="kpia-success-sub">
        Your question and context have been sent to the leadership team for review.<br>
        You'll receive follow-up through the appropriate channel.
      </div>
      <button class="kpia-success-new" onclick="resetKPIInquiry()">+ Submit Another Inquiry</button>
    </div>
  </div>
</div>    <div class="panel" id="panel-policies">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">Knowledge Base</div>
          <h2 class="ph-title">Policies & Procedures Library</h2>
          <p class="ph-subtitle">Official NJTC documents organized by department. Documents uploaded to Google Drive appear with a <strong style="color:#0969da">â˜ï¸ Google Drive Addition</strong> tag â€” separate from the Policies &amp; Procedures Manual.</p>
        </div>
        <div class="ph-actions">
          <button class="btn btn-secondary" onclick="showPanel('upload',document.querySelector('[data-panel=upload]'))">
            â˜ï¸ Upload Doc
          </button>
        </div>
      </div>

      <!-- Drive sync bar -->
      <div class="drive-sync-bar">
        <div class="sync-dot" id="syncDot"></div>
        <div class="sync-text" id="syncText">Checking Google Drive for latest documentsâ€¦</div>
        <button class="sync-btn" onclick="buildPolicies(true)">â†º Refresh</button>
      </div>
      <!-- PDF Upload Admin Bar (Leadership + Data Dept only) -->
      <div id="policyAdminBar" class="policy-admin-bar" style="display:none">
        <span class="pab-label">ğŸ“ Admin</span>
        <label class="pdf-drop-zone" id="pdfDropZone" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="event.preventDefault();this.classList.remove('drag-over');handlePdfUpload(event.dataTransfer.files)">
          <span>â¬† Drop or click to upload PDF policy</span>
          <input type="file" id="pdfFileInput" accept=".pdf" multiple onchange="handlePdfUpload(this.files)">
        </label>
        <div class="live-toggle-wrap">
          <span>Live Doc</span>
          <label class="live-toggle">
            <input type="checkbox" id="liveDocToggle" checked onchange="toggleLiveDoc(this.checked)">
            <span class="lt-slider"></span>
          </label>
          <span id="liveDocLabel" style="font-size:.75rem;color:#f0a500;font-weight:700">ON</span>
        </div>
        <button class="btn btn-secondary btn-sm" style="background:rgba(255,255,255,.1);color:#d0d9ec;border-color:#4a5568;margin-left:auto" onclick="showChangeLog()">ğŸ“‹ Change Log</button>
      </div>
      <div id="pdfUploadList" class="pdf-upload-list"></div>

      <!-- Filters -->
      <div class="policy-toolbar">
        <select class="filter-select" id="policyDeptFilter" onchange="filterPolicies()">
          <option value="">All Departments</option>
          <option value="hr">Human Resources</option>
          <option value="finance">Finance</option>
          <option value="programming">Programming</option>
          <option value="data">Data &amp; Evaluation</option>
          <option value="training">Training &amp; Development</option>
          <option value="shared">Organization-Wide</option>
          <option value="__drive__">â˜ï¸ Google Drive Additions</option>
        </select>
        <input type="text" class="filter-input" id="policySearch" placeholder="Search policiesâ€¦" oninput="filterPolicies()" style="flex:1;min-width:180px;">
        <select class="filter-select" id="policySort" onchange="filterPolicies()">
          <option value="dept">By Department</option>
          <option value="date">By Date</option>
          <option value="modified">Recently Modified</option>
          <option value="alpha">Alphabetical</option>
        </select>
      </div>

      <div id="policyContent"><!-- filled by JS --></div>
    </div>

    <!-- â•â• TALENT ANALYTICS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-talent">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">HR &amp; Program Intelligence</div>
          <h2 class="ph-title">Talent &amp; Performance Analytics</h2>
          <p class="ph-subtitle">Live snapshot of performance concerns, site leader reviews, and retention indicators â€” shared across HR and Programming.</p>
        </div>
        <div class="ph-actions" style="display:flex;gap:.625rem;align-items:center">
          <span id="talent-live-badge" class="live-badge" style="font-size:.7rem">LIVE DATA</span>
          <button class="btn btn-secondary btn-sm" onclick="buildTalentDashboard(true)" title="Force refresh from Google Sheets">â†º Refresh</button>
          <a class="btn btn-gold btn-sm" href="https://docs.google.com/spreadsheets/d/1IZSYmLgMddPtn5Ei9mehqTWJAbpcm5Tx1GL-YytLj0k/edit?gid=274671201#gid=274671201" target="_blank" rel="noopener" style="text-decoration:none;font-size:.8125rem">View Sheet â†—</a>
        </div>
      </div>
      <!-- Dept toggle -->
      <div style="display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap">
        <button class="pst-tab active" id="talentTab-all" onclick="setTalentTab('all')">All Insights</button>
        <button class="pst-tab" id="talentTab-program" onclick="setTalentTab('program')">ğŸ“‹ Programming</button>
        <button class="pst-tab" id="talentTab-hr" onclick="setTalentTab('hr')">ğŸ‘” HR</button>
        <button class="pst-tab" id="talentTab-reviews" onclick="setTalentTab('reviews')">â­ Site Leader Reviews</button>
        <button class="pst-tab" id="talentTab-log" onclick="setTalentTab('log')">ğŸ“‹ Full Log</button>
      </div>
      <!-- Filter bar -->
      <div id="talentFilterBar" style="display:flex;gap:.625rem;flex-wrap:wrap;margin-bottom:1.25rem;padding:.875rem 1rem;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;align-items:center">
        <span style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;flex-shrink:0">Filters</span>
        <select id="tf_district" class="filter-select" style="flex:1;min-width:140px" onchange="applyTalentFilters()">
          <option value="">All Districts</option>
        </select>
        <select id="tf_role" class="filter-select" style="flex:1;min-width:110px" onchange="applyTalentFilters()">
          <option value="">All Roles</option>
          <option value="Tutor">Tutor</option>
          <option value="Dual Role">Dual Role</option>
          <option value="Sub Tutor">Sub Tutor</option>
        </select>
        <select id="tf_concern" class="filter-select" style="flex:1;min-width:140px" onchange="applyTalentFilters()">
          <option value="">All Concern Types</option>
          <option value="Lesson Plans">Lesson Plans</option>
          <option value="Attendance">Attendance</option>
          <option value="Other (please explain below)">Other</option>
          <option value="Timecard incident">Timecard</option>
          <option value="Overall Lesson Delivery">Lesson Delivery</option>
        </select>
        <select id="tf_month" class="filter-select" style="flex:1;min-width:120px" onchange="applyTalentFilters()">
          <option value="">All Months</option>
        </select>
        <select id="tf_hr" class="filter-select" style="flex:1;min-width:130px" onchange="applyTalentFilters()">
          <option value="">All HR Actions</option>
          <option value="No">No Action</option>
          <option value="Yes">HR Notified</option>
          <option value="On Watch">On Watch</option>
          <option value="First Write Up - Employee Progress Report">Write-Up</option>
          <option value="PGP">PGP</option>
          <option value="Recommended Termination">Termination</option>
        </select>
        <select id="tf_submitter" class="filter-select" style="flex:1;min-width:130px" onchange="applyTalentFilters()">
          <option value="">All Submitters (PM/APM)</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="clearTalentFilters()" style="flex-shrink:0">âœ• Clear</button>
        <span id="tf_count" style="font-size:.75rem;color:var(--muted);flex-shrink:0"></span>
      </div>
      <!-- Year filter row for talent panel -->
      <div id="talentYearBar" style="display:flex;gap:.5rem;align-items:center;margin-bottom:.875rem;flex-wrap:wrap">
        <span style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em">Year</span>
        <button class="pst-tab active" id="tyrBtn-all" onclick="setTalentYear('all',this)">All Years</button>
        <button class="pst-tab" id="tyrBtn-2026" onclick="setTalentYear(2026,this)">2026 <span style="font-size:.65rem;opacity:.6">SY25-26</span></button>
        <button class="pst-tab" id="tyrBtn-2025" onclick="setTalentYear(2025,this)">2025 <span style="font-size:.65rem;opacity:.6">SY24-25</span></button>
        <span id="tyrCount" style="font-size:.75rem;color:var(--muted);margin-left:.25rem"></span>
      </div>
      <div id="talentContent"><!-- filled by JS --></div>
    </div>

    <!-- â•â• FINANCE ANALYTICS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-finance-analytics">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">Finance Intelligence</div>
          <h2 class="ph-title">Partnership &amp; Workforce Risk Analytics</h2>
          <p class="ph-subtitle">Aggregated workforce stability indicators and partner retention risk â€” tied to fee-for-service and funding goals.</p>
        </div>
        <div class="ph-actions"><span class="live-badge" style="font-size:.7rem">LIVE DATA</span></div>
      </div>
      <div id="financeAnalyticsContent"><!-- filled by JS --></div>
    </div>

    <!-- â•â• TRAINING ANALYTICS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-training-analytics">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">Training &amp; Development Intelligence</div>
          <h2 class="ph-title">Skills Gap &amp; PD Needs Analysis</h2>
          <p class="ph-subtitle">Aggregated concern categories mapped to professional development needs â€” no individual employee data shown.</p>
        </div>
        <div class="ph-actions"><span class="live-badge" style="font-size:.7rem">LIVE DATA</span></div>
      </div>
      <div id="trainingAnalyticsContent"><!-- filled by JS --></div>
    </div>

    <!-- â•â• UPLOAD / DRIVE PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-upload">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">Document Management</div>
          <h2 class="ph-title">Document Resource Center</h2>
          <p class="ph-subtitle">All NJTC policy documents are hosted in Google Drive. Upload a file and it becomes available to your team instantly â€” no technical steps required.</p>
        </div>
      </div>

      <div class="drive-hero">
        <div class="dh-icon-wrap">â˜ï¸</div>
        <div>
          <div class="dh-label">Google Drive Â· Shared Repository</div>
          <div class="dh-title">NJTC Shared Document Folder</div>
          <div class="dh-sub">All team documents, policies, and guides are stored here. Upload a file and it becomes visible in the Policies Library automatically.</div>
        </div>
        <a href="https://drive.google.com/drive/folders/1AflTMfemn1NuRK95PnBJk5a1b6QTPeiG" target="_blank" rel="noopener" class="btn btn-gold" style="margin-left:auto;flex-shrink:0;text-decoration:none">
          Open Drive Folder â†—
        </a>
      </div>

      <div class="auto-detect-card" style="margin-bottom:1.5rem">
        <div class="adc-icon">ğŸ”„</div>
        <div>
          <div class="adc-title">Automatic Updates â€” No Technical Steps</div>
          <div class="adc-desc">When you upload a new document to the Drive folder, it automatically appears in the Policies &amp; Procedures Library under a <strong style="color:#0969da">â˜ï¸ Google Drive Addition</strong> tag â€” visually distinct from the official Policies &amp; Procedures Manual. This makes it clear which documents are supplemental Drive uploads vs. formally documented policies. Simply upload to Drive and you're done.</div>
        </div>
      </div>

      <div class="drive-steps-grid">
        <div class="drive-step">
          <div class="ds-num">01</div>
          <div class="ds-title">Open the Drive Folder</div>
          <div class="ds-desc">Click "Open Drive Folder" above to access the shared NJTC document repository.</div>
        </div>
        <div class="drive-step">
          <div class="ds-num">02</div>
          <div class="ds-title">Upload Your Document</div>
          <div class="ds-desc">Drag your PDF or file into the folder. Google Drive handles the rest.</div>
        </div>
        <div class="drive-step">
          <div class="ds-num">03</div>
          <div class="ds-title">Set Sharing</div>
          <div class="ds-desc">Right-click â†’ Share â†’ set to "Anyone with the link" as Viewer so the portal can display it.</div>
        </div>
        <div class="drive-step">
          <div class="ds-num">04</div>
          <div class="ds-title">Appears Instantly</div>
          <div class="ds-desc">The document will appear in the Policies Library the next time any team member loads the portal.</div>
        </div>
      </div>

      <div class="alert alert-info" style="margin-top:1rem">
        <span>ğŸ’¡</span>
        <div><strong>Need to update an existing document?</strong> Replace the file in Drive with the new version. The portal will automatically show the updated modification date in the Policies Library card.</div>
      </div>
    </div>

    <!-- â•â• CONCERN FORM PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-concern">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">HR Reporting</div>
          <h2 class="ph-title">Performance & Program Concern Form</h2>
          <p class="ph-subtitle">Document a performance conversation or program concern. Submitted securely to HR â€” no external tools required.</p>
        </div>
      </div>

      <div class="form-wrapper">
        <!-- Success screen -->
        <div class="form-success-screen" id="formSuccess">
          <div class="fss-icon">âœ…</div>
          <div class="fss-title">Concern Submitted</div>
          <p class="fss-sub">Your submission has been logged. HR has been notified and a confirmation has been sent to your email address.</p>
          <button class="btn btn-primary" onclick="resetConcernForm()">Submit Another</button>
        </div>

        <!-- Form -->
        <div id="formContainer">

          <!-- Step progress -->
          <div class="step-progress">
            <div class="sp-step active" id="sp1">
              <div class="sp-num">1</div>
              <div class="sp-label">Submitter</div>
            </div>
            <div class="sp-step" id="sp2">
              <div class="sp-num">2</div>
              <div class="sp-label">Employee</div>
            </div>
            <div class="sp-step" id="sp3">
              <div class="sp-num">3</div>
              <div class="sp-label">Concern</div>
            </div>
            <div class="sp-step" id="sp4">
              <div class="sp-num">4</div>
              <div class="sp-label">Next Steps</div>
            </div>
          </div>

          <form id="concernForm" novalidate>

            <!-- STEP 1 -->
            <div class="form-section active" id="fs1">
              <div class="form-card">
                <div class="form-card-header">
                  <div class="fch-title">Your Information</div>
                  <div class="fch-sub">Who is completing this form?</div>
                </div>
                <div class="form-card-body">
                  <div class="form-row-2">
                    <div class="form-group">
                      <label class="form-lbl req">Your Email</label>
                      <input type="email" id="f_email" class="form-ctrl" placeholder="yourname@njtc.org" autocomplete="email"/>
                    </div>
                    <div class="form-group">
                      <label class="form-lbl req">Your Name & Title</label>
                      <input type="text" id="f_submitter" class="form-ctrl" placeholder="Jane Smith, Program Manager"/>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl req">Are you completing this on behalf of someone else?</label>
                    <div class="radio-chips">
                      <label class="radio-chip"><input type="radio" name="onBehalf" value="No" checked onchange="toggleOnBehalf(this.value)"> No, this is my own submission</label>
                      <label class="radio-chip"><input type="radio" name="onBehalf" value="Yes" onchange="toggleOnBehalf(this.value)"> Yes, on behalf of someone</label>
                    </div>
                  </div>
                  <div class="form-group" id="onBehalfField" style="display:none">
                    <label class="form-lbl">Name & role of the person you're completing this for</label>
                    <input type="text" id="f_onBehalfOf" class="form-ctrl" placeholder="John Doe, Site Coordinator"/>
                  </div>
                </div>
                <div class="form-actions">
                  <div style="font-size:.8125rem;color:var(--muted)">Step 1 of 4</div>
                  <button type="button" class="btn-next-form" onclick="goStep(2)">Continue â†’</button>
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="form-section" id="fs2">
              <div class="form-card">
                <div class="form-card-header">
                  <div class="fch-title">Employee Information</div>
                  <div class="fch-sub">Who is this concern about?</div>
                </div>
                <div class="form-card-body">
                  <div class="form-row-2">
                    <div class="form-group">
                      <label class="form-lbl req">Employee Full Name</label>
                      <input type="text" id="f_empName" class="form-ctrl" placeholder="Full name"/>
                    </div>
                    <div class="form-group">
                      <label class="form-lbl req">Employee Role</label>
                      <select id="f_empRole" class="form-ctrl">
                        <option value="">Select roleâ€¦</option>
                        <option>Tutor</option>
                        <option>SC</option>
                        <option>IC</option>
                        <option>Dual Role</option>
                        <option>Other</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl req">Employee Site / Location</label>
                    <select id="f_empSite" class="form-ctrl">
                      <option value="">Select siteâ€¦</option>
                      <option>Central Jersey College Prep</option>
                      <option>Clinton Township School District - Round Valley School</option>
                      <option>First Philadelphia Prep Charter School (American Paradigm)</option>
                      <option>Global Leadership Academy - GLA- West</option>
                      <option>Gloucester Township School District- Blackwood Elementary School</option>
                      <option>Gloucester Township School District- Erial Elementary School</option>
                      <option>Gloucester Township School District- JW Lilley Elementary School</option>
                      <option>Gloucester Township School District- Loring Flemming Elementary School</option>
                      <option>Haddon Township School District- Stoy Elementary School</option>
                      <option>Haddon Township School District-Clyde Jennings Elementary School</option>
                      <option>Haddon Township School District-Edison Elementary School</option>
                      <option>Haddon Township School District-Strawbridge Elementary School</option>
                      <option>Haddon Township School District-Van Sciver Elementary School</option>
                      <option>Hamilton Township School District- Albert E. Grice Middle School</option>
                      <option>Hamilton Township School District- Crockett Middle School</option>
                      <option>Hamilton Township School District- Kuser Elementary School</option>
                      <option>Hamilton Township School District- Mercerville Elementary School</option>
                      <option>Hamilton Township School District- Sayen Elementary School</option>
                      <option>Hamilton Township School District-Alexander Elementary School</option>
                      <option>Hoboken Dual Language Charter School (HOLA) - ES</option>
                      <option>Hoboken Dual Language Charter School (HOLA) - MS</option>
                      <option>iLearn Charter School- Bergen ES</option>
                      <option>iLearn Charter School- Bergen MS</option>
                      <option>iLearn Charter School- Clifton ES</option>
                      <option>iLearn Charter School- Clifton HS</option>
                      <option>iLearn Charter School- Clifton MS</option>
                      <option>iLearn Charter School- Hudson ES</option>
                      <option>iLearn Charter School- Hudson MS</option>
                      <option>iLearn Charter School- Passaic ES</option>
                      <option>iLearn Charter School- Passaic MS</option>
                      <option>iLearn Charter School- Paterson ES</option>
                      <option>iLearn Charter School- Paterson MS</option>
                      <option>Lawrence Township- Eldridge Park School</option>
                      <option>Lawrence Township- Slackwood Elementary</option>
                      <option>Monmouth County BGC- Bradley Elementary School</option>
                      <option>Monmouth County BGC- College Achieve (CAPS Neptune)</option>
                      <option>Paterson Charter School Science & Tech.- PCSST 4-7 Campus</option>
                      <option>Pemberton- Denbo-Crichton Location</option>
                      <option>Penns Grove - Carneys Point Regional School District- Penns Grove Middle School</option>
                      <option>Penns Grove - Field Street Elementary</option>
                      <option>Penns Grove - P.W. Carleton Elementary</option>
                      <option>Riverton School District- Riverton Public School</option>
                      <option>Salem City School District- Salem - John Fenwick Academy (K-2)</option>
                      <option>Salem City School District- Salem Middle School (3-5)</option>
                      <option>Waterford Township School District- Atco Elementary School</option>
                      <option>Waterford Township School District- Waterford Elementary School</option>
                    </select>
                  </div>
                  <div class="form-row-2">
                    <div class="form-group">
                      <label class="form-lbl req">Today's Date</label>
                      <input type="date" id="f_todayDate" class="form-ctrl"/>
                    </div>
                    <div class="form-group">
                      <label class="form-lbl req">Date Conversation Occurred</label>
                      <input type="date" id="f_convDate" class="form-ctrl"/>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl req">Is this the first documented occurrence for this employee?</label>
                    <div class="radio-chips">
                      <label class="radio-chip"><input type="radio" name="firstOccurrence" value="Yes"> Yes â€” first on record</label>
                      <label class="radio-chip"><input type="radio" name="firstOccurrence" value="No"> No â€” prior documentation exists</label>
                    </div>
                  </div>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn-back-form" onclick="goStep(1)">â† Back</button>
                  <button type="button" class="btn-next-form" onclick="goStep(3)">Continue â†’</button>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="form-section" id="fs3">
              <div class="form-card">
                <div class="form-card-header">
                  <div class="fch-title">Concern Details</div>
                  <div class="fch-sub">Describe the nature and context of this concern</div>
                </div>
                <div class="form-card-body">
                  <div class="form-group">
                    <label class="form-lbl req">Type of support being documented</label>
                    <div class="radio-chips vertical">
                      <label class="radio-chip"><input type="radio" name="supportType" value="Observation by PM Team" onchange="toggleSupportOther(this.value)"> Observation by PM Team</label>
                      <label class="radio-chip"><input type="radio" name="supportType" value="Additional Coaching Support" onchange="toggleSupportOther(this.value)"> Additional Coaching Support</label>
                      <label class="radio-chip"><input type="radio" name="supportType" value="Reminder/Verbal Warning" onchange="toggleSupportOther(this.value)"> Reminder / Verbal Warning</label>
                      <label class="radio-chip"><input type="radio" name="supportType" value="Other" onchange="toggleSupportOther(this.value)"> Other (specify below)</label>
                    </div>
                  </div>
                  <div class="form-group" id="supportOtherWrap" style="display:none">
                    <label class="form-lbl">Describe the type of support</label>
                    <input type="text" id="f_supportOther" class="form-ctrl" placeholder="Describeâ€¦"/>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl req">How was this conversation delivered?</label>
                    <div class="radio-chips">
                      <label class="radio-chip"><input type="radio" name="delivery" value="In Person"> In Person</label>
                      <label class="radio-chip"><input type="radio" name="delivery" value="Email"> Email</label>
                      <label class="radio-chip"><input type="radio" name="delivery" value="Phone"> Phone</label>
                      <label class="radio-chip"><input type="radio" name="delivery" value="Text Message"> Text</label>
                      <label class="radio-chip"><input type="radio" name="delivery" value="ZOOM meeting"> Zoom</label>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl req">Type of concern</label>
                    <div class="radio-chips vertical">
                      <label class="radio-chip"><input type="radio" name="concernType" value="Attendance" onchange="toggleConcernOther(this.value)"> Attendance</label>
                      <label class="radio-chip"><input type="radio" name="concernType" value="Lesson Plans" onchange="toggleConcernOther(this.value)"> Lesson Plans</label>
                      <label class="radio-chip"><input type="radio" name="concernType" value="Overall Lesson Delivery" onchange="toggleConcernOther(this.value)"> Overall Lesson Delivery</label>
                      <label class="radio-chip"><input type="radio" name="concernType" value="Timecard incident" onchange="toggleConcernOther(this.value)"> Timecard Incident</label>
                      <label class="radio-chip"><input type="radio" name="concernType" value="Other" onchange="toggleConcernOther(this.value)"> Other (specify below)</label>
                    </div>
                  </div>
                  <div class="form-group" id="concernOtherWrap" style="display:none">
                    <label class="form-lbl">Describe the concern type</label>
                    <input type="text" id="f_concernOther" class="form-ctrl" placeholder="Describeâ€¦"/>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl req">Relevant historical details</label>
                    <p class="form-hint">Include dates, prior feedback, specifics from this conversation, and any support offered to the employee.</p>
                    <textarea id="f_history" class="form-ctrl" rows="6" placeholder="Provide full context hereâ€¦"></textarea>
                  </div>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn-back-form" onclick="goStep(2)">â† Back</button>
                  <button type="button" class="btn-next-form" onclick="goStep(4)">Continue â†’</button>
                </div>
              </div>
            </div>

            <!-- STEP 4 -->
            <div class="form-section" id="fs4">
              <div class="form-card">
                <div class="form-card-header">
                  <div class="fch-title">Next Steps</div>
                  <div class="fch-sub">What action is being requested from HR?</div>
                </div>
                <div class="form-card-body">
                  <div class="form-group">
                    <label class="form-lbl req">Next steps requested from HR</label>
                    <div class="radio-chips vertical">
                      <label class="radio-chip"><input type="radio" name="hrNextSteps" value="On Watch"> On Watch</label>
                      <label class="radio-chip"><input type="radio" name="hrNextSteps" value="First Write Up - Employee Progress Report"> First Write Up â€” Employee Progress Report</label>
                      <label class="radio-chip"><input type="radio" name="hrNextSteps" value="Second Progress Report Report Needed"> Second Progress Report Needed</label>
                      <label class="radio-chip"><input type="radio" name="hrNextSteps" value="PGP"> PGP â€” Performance Growth Plan</label>
                      <label class="radio-chip"><input type="radio" name="hrNextSteps" value="Recommended Termination">
                        <span>Recommended Termination</span>
                        <span style="font-size:.7rem;color:var(--notmet);font-weight:600;margin-left:.25rem">âš  Contact HR immediately</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-lbl">Additional context or instructions for HR</label>
                    <textarea id="f_nextStepsDesc" class="form-ctrl" rows="4" placeholder="Any additional details, urgency, or instructions for HRâ€¦"></textarea>
                  </div>
                  <div class="confirm-box">
                    <span class="confirm-icon">ğŸ”’</span>
                    <div>
                      <strong>Confidential Submission</strong><br>
                      I confirm this information is accurate and complete. This record will be submitted directly to Human Resources and logged securely.
                    </div>
                  </div>
                </div>
                <div class="form-actions">
                  <div class="form-error" id="submitError"></div>
                  <button type="button" class="btn-back-form" onclick="goStep(3)">â† Back</button>
                  <button type="button" class="btn-submit-form" id="submitBtn" onclick="submitConcernForm()">
                    <span id="submitBtnTxt">Submit to HR</span>
                    <div class="btn-spinner" id="submitSpinner"></div>
                  </button>
                </div>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- â•â• PERFORMANCE (redirect) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-perf">
      <div class="page-header">
        <div class="ph-text">
          <div class="ph-eyebrow">HR Reporting</div>
          <h2 class="ph-title">Performance Concerns</h2>
          <p class="ph-subtitle">Use the unified concern form to document employee performance conversations.</p>
        </div>
      </div>
      <div style="max-width:480px">
        <div class="alert alert-info">
          <span>â„¹ï¸</span>
          <div>Performance and program concerns are submitted through the same secure form, which routes automatically to HR.</div>
        </div>
        <button class="btn btn-primary" onclick="showPanel('concern',document.querySelector('[data-panel=concern]'))">
          ğŸ“ Open Concern Form â†’
        </button>
      </div>
    </div>

  </main>
</div>

<!-- Dept Connections Modal -->
<div class="modal-overlay" id="connectionsModal" onclick="if(event.target===this)closeConnectionsModal()">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modalTitle">Department Connections</div>
        <div class="modal-sub" id="modalSub">How your department connects with others to achieve annual goals</div>
      </div>
      <button class="modal-close" onclick="closeConnectionsModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"><!-- filled by JS --></div>
  </div>
</div>

<!-- â•â• POLICY DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay policy-detail-overlay" id="policyDetailModal" onclick="if(event.target===this)closePolicyModal()">
  <div class="modal-box policy-detail-box">
    <div class="modal-header policy-detail-header" id="policyModalHeader">
      <div style="flex:1;min-width:0">
        <div class="policy-modal-dept" id="policyModalDept"></div>
        <div class="modal-title" id="policyModalTitle">Policy Details</div>
        <div class="modal-sub" id="policyModalMeta"></div>
      </div>
      <div style="display:flex;gap:.625rem;align-items:center;flex-shrink:0">
        <a class="btn btn-gold btn-sm" id="policyModalOpenBtn" href="#" target="_blank" rel="noopener" style="text-decoration:none;font-size:.8125rem">Open Full Doc â†—</a>
        <button class="modal-close" onclick="closePolicyModal()">âœ•</button>
      </div>
    </div>
    <!-- Live sync indicator -->
    <div class="policy-modal-sync" id="policyModalSync">
      <div class="sync-dot loading" id="policyModalSyncDot"></div>
      <span id="policyModalSyncText">Loading live content from Operations Manualâ€¦</span>
    </div>
    <!-- Section nav tabs -->
    <div class="policy-section-tabs" id="policyModalTabs"></div>
    <!-- Content area -->
    <div class="modal-body policy-modal-body" id="policyModalBody">
      <div class="policy-loading-state">
        <div class="policy-loading-spinner"></div>
        <div>Fetching latest content from Google Docsâ€¦</div>
      </div>
    </div>
    <!-- Key highlights strip -->
    <div class="policy-modal-footer" id="policyModalFooter" style="display:none">
      <div class="pmf-label">ğŸ“Œ Key Points</div>
      <div class="pmf-highlights" id="policyModalHighlights"></div>
    </div>
  </div>
</div>

<script src="../auth/auth.js?v=4"></script>
<script src="../auth/central-guard.js?v=4"></script>
<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DEPARTMENT CONFIGURATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const DEPT_CONFIG = {
    hr: {
      label: 'Human Resources', emoji: 'ğŸ‘”', color: '#e63946',
      tagline: 'Protecting our people and the organization.',
      goalPct: '78%',
      connections: ['programming','data','training','leadership'],
      quickLinks: [
        { icon: 'âš ï¸', label: 'Concern Form', bg: '#fee2e2', desc: 'Document a performance conversation', panel: 'concern' },
        { icon: 'ğŸ“Š', label: 'KPI Targets', bg: '#e6efff', desc: 'Culture & retention goals', panel: 'kpi' },
        { icon: 'ğŸ“š', label: 'HR Policies', bg: '#f3e8ff', desc: 'Access all HR documentation', panel: 'policies' },
        { icon: 'ğŸ‘¥', label: 'Performance', bg: '#fff0e0', desc: 'Review concern submissions', panel: 'perf' },
      ]
    },
    finance: {
      label: 'Finance', emoji: 'ğŸ’°', color: '#2a9d8f',
      tagline: 'Maintaining fiscal health and accountability.',
      goalPct: '85%',
      connections: ['leadership','data','programming'],
      quickLinks: [
        { icon: 'ğŸ“Š', label: 'KPI Targets', bg: '#e6efff', desc: 'Funding & financial goals', panel: 'kpi' },
        { icon: 'ğŸ“š', label: 'Finance Policies', bg: '#e6f5ed', desc: 'Budget & financial guidelines', panel: 'policies' },
        { icon: 'â˜ï¸', label: 'Upload Reports', bg: '#f6f8fc', desc: 'Submit financial documents', panel: 'upload' },
        { icon: 'âš ï¸', label: 'Concern Form', bg: '#fee2e2', desc: 'Report any concerns', panel: 'concern' },
      ]
    },
    programming: {
      label: 'Programming', emoji: 'ğŸ¯', color: '#457b9d',
      tagline: 'Delivering high-quality instructional programs.',
      goalPct: '71%',
      connections: ['hr','data','training','finance'],
      quickLinks: [
        { icon: 'âš ï¸', label: 'Concern Form', bg: '#fee2e2', desc: 'Log site-level concerns', panel: 'concern' },
        { icon: 'ğŸ“Š', label: 'KPI Targets', bg: '#e6efff', desc: 'Scholar impact goals', panel: 'kpi' },
        { icon: 'ğŸ“š', label: 'Site Policies', bg: '#e0f0ff', desc: 'Program procedures', panel: 'policies' },
        { icon: 'â˜ï¸', label: 'Upload Docs', bg: '#f6f8fc', desc: 'Submit program materials', panel: 'upload' },
      ]
    },
    data: {
      label: 'Data & Evaluation', emoji: 'ğŸ“ˆ', color: '#7b2d8b',
      tagline: 'Driving decisions through rigorous measurement.',
      goalPct: '90%',
      connections: ['programming','hr','leadership','training'],
      quickLinks: [
        { icon: 'ğŸ“Š', label: 'Full KPI Dashboard', bg: '#f3e8ff', desc: 'All organizational targets', panel: 'kpi' },
        { icon: 'ğŸ”', label: 'KPI Analytics', bg: '#ede9fe', desc: 'Visual goal performance analytics', panel: 'kpi-analytics' },
        { icon: 'â˜ï¸', label: 'Upload Reports', bg: '#f6f8fc', desc: 'Submit evaluation data', panel: 'upload' },
        { icon: 'ğŸ“š', label: 'Data Governance', bg: '#f3e8ff', desc: 'Data policies & frameworks', panel: 'policies' },
        { icon: 'âš ï¸', label: 'Concern Form', bg: '#fee2e2', desc: 'Report any concerns', panel: 'concern' },
      ]
    },
    training: {
      label: 'Training & Development', emoji: 'ğŸ“', color: '#e76f51',
      tagline: 'Building staff capacity and educator pipelines.',
      goalPct: '68%',
      connections: ['hr','programming','data'],
      quickLinks: [
        { icon: 'ğŸ“š', label: 'Training Materials', bg: '#fff0e0', desc: 'PD policies & procedures', panel: 'policies' },
        { icon: 'ğŸ“Š', label: 'KPI Targets', bg: '#e6efff', desc: 'Pipeline & apprenticeship goals', panel: 'kpi' },
        { icon: 'â˜ï¸', label: 'Upload PD Docs', bg: '#f6f8fc', desc: 'Submit training materials', panel: 'upload' },
        { icon: 'âš ï¸', label: 'Concern Form', bg: '#fee2e2', desc: 'Log training concerns', panel: 'concern' },
      ]
    },
    leadership: {
      label: 'Leadership', emoji: 'â­', color: '#f0a500',
      tagline: 'Organizational oversight and strategic direction.',
      goalPct: '82%',
      connections: ['hr','finance','data','programming','training'],
      quickLinks: [
        { icon: 'ğŸ“Š', label: 'KPI Targets', bg: '#fff7e0', desc: 'Full organizational overview', panel: 'kpi' },
        { icon: 'ğŸ”', label: 'KPI Analytics', bg: '#fef3c7', desc: 'Goal health & performance breakdown', panel: 'kpi-analytics' },
        { icon: 'ğŸ“š', label: 'All Policies', bg: '#f6f8fc', desc: 'Organization-wide library', panel: 'policies' },
        { icon: 'âš ï¸', label: 'Concern Form', bg: '#fee2e2', desc: 'All concern submissions', panel: 'concern' },
        { icon: 'â˜ï¸', label: 'Drive Center', bg: '#f6f8fc', desc: 'Document management', panel: 'upload' },
      ]
    }
  };

  // Dept connection details â€” HOW and WHY departments connect
  const DEPT_CONNECTIONS = {
    hr: [
      { with: 'programming', how: 'Performance pipeline support', why: 'HR processes concern submissions from Program Managers and coordinates corrective actions, directly impacting tutor retention and site consistency.', goals: ['Culture','Educator Pipeline'] },
      { with: 'data', how: 'Staff retention analytics', why: 'Data & Evaluation provides HR with retention trend analysis, helping identify patterns before they escalate to formal concerns.', goals: ['Culture','Systems & Infrastructure'] },
      { with: 'training', how: 'PGP design & PD alignment', why: 'When an employee enters a Performance Growth Plan, HR coordinates with T&D to ensure targeted professional development is available.', goals: ['Culture','Educator Pipeline'] },
      { with: 'leadership', how: 'Strategic workforce decisions', why: 'Leadership depends on HR for termination reviews, succession planning, and workforce composition data to make board-level decisions.', goals: ['Culture','Board Development'] },
    ],
    finance: [
      { with: 'leadership', how: 'Budget authorization & reporting', why: 'Finance provides monthly budget-to-actual reports to Leadership, which informs strategic deployment decisions and board presentations.', goals: ['Financial Health','Funding'] },
      { with: 'data', how: 'Cost-per-scholar analysis', why: 'D&E and Finance collaborate to calculate cost-per-scholar metrics used in philanthropic pitches and fee-for-service contract negotiations.', goals: ['Fee-for-Service Growth','Funding'] },
      { with: 'programming', how: 'Site staffing cost modeling', why: 'Finance models staffing costs for new sites before contract signing, ensuring financial viability of each programming deployment.', goals: ['Fee-for-Service Growth','Financial Health'] },
    ],
    programming: [
      { with: 'hr', how: 'Staff performance & site compliance', why: 'Program Managers are the primary source of performance concern submissions. Their documentation drives HR corrective action process.', goals: ['Culture','Educator Pipeline'] },
      { with: 'data', how: 'Scholar outcome measurement', why: 'D&E designs assessments and collects outcome data from sites, which Programming uses to adjust instructional models mid-year.', goals: ['Increase Impact on Scholars','Partner Experience'] },
      { with: 'training', how: 'Tutor skill development', why: 'When PM observations identify skill gaps, T&D receives that feedback to design targeted professional development sessions.', goals: ['Educator Pipeline','Increase Impact on Scholars'] },
      { with: 'finance', how: 'Contract & site viability', why: 'Finance and Programming co-review site contracts to ensure pricing aligns with staffing and operational requirements.', goals: ['Fee-for-Service Growth'] },
    ],
    data: [
      { with: 'programming', how: 'Real-time outcome feedback loops', why: 'D&E provides mid-year placement data to Programming, enabling instructional pivots before the end-of-year assessment window closes.', goals: ['Increase Impact on Scholars','Systems & Infrastructure'] },
      { with: 'hr', how: 'Workforce analytics & trend reporting', why: 'D&E tracks staff retention rates, turnover patterns, and engagement signals that HR uses for proactive workforce planning.', goals: ['Culture','Systems & Infrastructure'] },
      { with: 'leadership', how: 'Board KPI dashboards', why: 'D&E builds and maintains the organizational KPI infrastructure that Leadership presents to the board and uses for strategic decisions.', goals: ['Systems & Infrastructure','Board Development'] },
      { with: 'training', how: 'Instructional quality measurement', why: 'D&E observation data informs T&D about which instructional competencies require the most PD investment across the tutor workforce.', goals: ['Educator Pipeline','Increase Impact on Scholars'] },
    ],
    training: [
      { with: 'hr', how: 'Performance recovery programs', why: 'T&D designs and facilitates PGP learning plans that HR assigns to employees in corrective action, creating a bridge from discipline to growth.', goals: ['Culture','Educator Pipeline'] },
      { with: 'programming', how: 'Skill-gap response & PD design', why: 'PM observation reports feed directly into T&D curriculum planning â€” site-specific skill gaps become targeted PD sessions within the quarter.', goals: ['Educator Pipeline','Increase Impact on Scholars'] },
      { with: 'data', how: 'Training effectiveness measurement', why: 'D&E measures PD impact by correlating training completion with scholar outcome changes, giving T&D evidence to improve program design.', goals: ['Educator Pipeline','Systems & Infrastructure'] },
    ],
    leadership: [
      { with: 'hr', how: 'Workforce & culture oversight', why: 'Leadership reviews aggregate HR metrics â€” retention, open concerns, PGP active count â€” to gauge organizational health at board meetings.', goals: ['Culture','Board Development'] },
      { with: 'finance', how: 'Strategic financial stewardship', why: 'Monthly finance reviews with Leadership ensure reserve targets, budget variances, and funder commitments stay aligned with strategic goals.', goals: ['Financial Health','Funding','Fee-for-Service Growth'] },
      { with: 'data', how: 'Impact evidence for stakeholders', why: 'D&E provides Leadership with the impact evidence used in funder pitches, board presentations, and public communications.', goals: ['Funding','Brand Growth','Board Development'] },
      { with: 'programming', how: 'Site growth & partner strategy', why: 'Leadership sets site expansion targets; Programming validates operational feasibility and quality standards before new contracts are signed.', goals: ['Fee-for-Service Growth','Partner Experience'] },
      { with: 'training', how: 'Pipeline investment strategy', why: 'Leadership directs investment in the educator apprenticeship program based on T&D pipeline data and labor market positioning.', goals: ['Educator Pipeline'] },
    ],
  };

  const DEPT_COLORS = {
    hr: '#e63946', finance: '#2a9d8f', programming: '#457b9d',
    data: '#7b2d8b', training: '#e76f51', leadership: '#f0a500', __drive__: '#0969da'
  };
  const DEPT_ICONS = {
    hr: 'ğŸ‘”', finance: 'ğŸ’°', programming: 'ğŸ¯',
    data: 'ğŸ“ˆ', training: 'ğŸ“', leadership: 'â­', __drive__: 'â˜ï¸'
  };
  const DEPT_LABELS = {
    hr: 'HR', finance: 'Finance', programming: 'Programming',
    data: 'Data & Eval', training: 'Training', leadership: 'Leadership', __drive__: 'Google Drive Additions'
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  KPI DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ Live Google Sheet CSV URL (auto-refreshes from published sheet) â”€â”€
  const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSiWNF9u43aDBr7MOuyiPHd1umWZSvPcQZir6r_6Qnd8lh9Ku1uveMoMIsto3VmrwKJUyHOu14tfiHd/pub?output=csv';

  // Fallback static data (exact from official KPI spreadsheet, SY 2025-26)
  const KPI_DATA_STATIC = [
    { goal: "Increase Impact on Scholars", target: "By 2026, serve 2000 scholars annually", midStatus: "Partially Met", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "By 2026 serve 35 sites annually", midStatus: "Met", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "Placement Level Change: 80% of all scholars advancing a level in math or ela", midStatus: "In Progress", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "Progress Towards Proficiency: Math 20% increase of scholars that reach grade-level proficiency; ELA 20% increase of scholars that reach grade-level below", midStatus: "In Progress", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "Gap Closing: 35% decrease in scholar 2+ grade levels below", midStatus: "In Progress", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "80% scholars self-report that they increased confidence post session in ELA", midStatus: "In Progress", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "80% scholars self-report that they increased confidence post-session in Math", midStatus: "In Progress", endStatus: "" },
    { goal: "Increase Impact on Scholars", target: "92% of onsite staff observe scholar growth", midStatus: "In Progress", endStatus: "" },
    { goal: "Support Growth of New Jersey's Educator Pipeline", target: "40 tutor apprentices for SY 25-26", midStatus: "In Progress", endStatus: "" },
    { goal: "Support Growth of New Jersey's Educator Pipeline", target: "Secure 1 DOL grant to expand apprenticeship program", midStatus: "Met", endStatus: "" },
    { goal: "Support Growth of New Jersey's Educator Pipeline", target: "4 NJTC apprentices join Teacher Apprenticeship Network (TAN) in 2026", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Increase the number of fee-for-service partnerships", target: "35 SY sites - all of which are fee-for-service sites (does not include low-cost pilot)", midStatus: "Met", endStatus: "" },
    { goal: "Increase the number of fee-for-service partnerships", target: "Secure 3 new low-cost pilot customers using new grant funds", midStatus: "In Progress", endStatus: "" },
    { goal: "Increase the number of fee-for-service partnerships", target: "75% of sites cover full fee-for-service (does not include low-cost pilot)", midStatus: "Met", endStatus: "" },
    { goal: "Increase the number of fee-for-service partnerships", target: "Add 1 additional out-of-state customer", midStatus: "Met", endStatus: "" },
    { goal: "Increase the number of fee-for-service partnerships", target: "Apply to a least 10 local/regional RFPs annually", midStatus: "Partially Met", endStatus: "" },
    { goal: "Continue to pursue large and multi-year sources of funding", target: "Identify and apply to 2 new multi-year or $500K+ funding opportunities", midStatus: "Met", endStatus: "" },
    { goal: "Continue to pursue large and multi-year sources of funding", target: "Secure $850,000 in philanthropic funds", midStatus: "Met", endStatus: "" },
    { goal: "Continue to pursue large and multi-year sources of funding", target: "Secure new philanthropic partners totaling $200k", midStatus: "Has Not Met", endStatus: "" },
    { goal: "Continue to pursue large and multi-year sources of funding", target: "Secure support from FY 27 State budget", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Maintain cash position", target: "Maintain $500K in Moneymarket portion of investment accounts by the end of 2025", midStatus: "Met", endStatus: "" },
    { goal: "Further Diversify board and leverage its support", target: "Increase the number of introductions by board members to school district partners & potential donors (At least 1 intro per board member; total of 15)", midStatus: "In Progress", endStatus: "" },
    { goal: "Further Diversify board and leverage its support", target: "Maintain 100% board giving; Increase total board giving by 10%", midStatus: "Met", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "Revised performance evaluation system in place by November 2025", midStatus: "Met", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "KPI Dashboard is 100% operational by October 2025", midStatus: "Met", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "2025-2026 Program Evaluation completed by August of 2026", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "NJTC Annual Report sent to Stakeholders by December 2025", midStatus: "Partially Met", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "Data Governance is documented for all internal reporting by December of 2025", midStatus: "Met", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "Annual Budgeting process completed by August 1, 2026", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Upgrade systems to support growth", target: "Leadership completes a Mid-Year and End of year retreat", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Maintain consistent partner experience", target: "90% customer satisfaction reported at the end of the school year 25/26", midStatus: "In Progress", endStatus: "" },
    { goal: "Maintain consistent partner experience", target: "Receive 3 referrals from partners", midStatus: "Met", endStatus: "" },
    { goal: "Maintain consistent partner experience", target: "50% retention rate for school partners", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Maintain and continue to build on strong culture", target: "80% annual core staff retention", midStatus: "Met", endStatus: "" },
    { goal: "Maintain and continue to build on strong culture", target: "60% annual on-site staff retention", midStatus: "Has Not Met", endStatus: "" },
    { goal: "Maintain and continue to build on strong culture", target: "Increase diversity of tutors to mirror student diversity", midStatus: "Met", endStatus: "" },
    { goal: "Maintain and continue to build on strong culture", target: "Host 2 in person events for central team (Winter and Summer)", midStatus: "Partially Met", endStatus: "" },
    { goal: "Grow the NJTC brand", target: "10 local media hits per year", midStatus: "Met", endStatus: "" },
    { goal: "Grow the NJTC brand", target: "Attend 5 local education and/or non-profit conferences and webinars - these could include having a booth at a local conference; speaking engagements at 2", midStatus: "Met", endStatus: "" },
    { goal: "Grow the NJTC brand", target: "Participate in 3 national conferences or webinars with presentations at 2", midStatus: "Met", endStatus: "" },
    { goal: "Grow the NJTC brand", target: "Increase followers by 20% on social media platforms (in the aggregate)", midStatus: "Coming Down the Pipeline", endStatus: "" },
    { goal: "Grow the NJTC brand", target: "Meet with at least 7 education organizations across New Jersey", midStatus: "In Progress", endStatus: "" },
    { goal: "Grow the NJTC brand", target: "Attend 5 South Jersey Chamber events", midStatus: "Partially Met", endStatus: "" },
  ];

  // Live data holder â€” populated from Sheet or falls back to static
  let KPI_DATA = KPI_DATA_STATIC.map(k => ({ ...k, status: k.midStatus || 'In Progress' }));
  let _kpiLastFetched = null;
  let _kpiFromSheet = false;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  POLICIES DATA (inline â€” Drive manifest overrides this)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const DRIVE_MANIFEST_ID = '1e6fXGG0BNCdVO2SJxi4I8JgbDiXNrAcL';
  // â”€â”€ Paste your deployed Apps Script Web App URL below after setup â”€â”€
  // Once set, Drive documents appear automatically when uploaded â€” no GitHub updates needed.
  // Format: 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'
  const DRIVE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwA9HIQmEdxpANA2WENEwvRSV6jQ1CUDRHdpLwVXK4-H1NcaJ8dpSsP5nC3WfS5MiL6/exec';

  // â”€â”€ Operations Manual Drive File ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Paste the Google Drive File ID of your Operations Manual below.
  // Get it from the share URL: drive.google.com/file/d/FILE_ID_HERE/view
  // Once set, every policy card will link directly to the correct section.
  const OPS_MANUAL_FILE_ID = 'PASTE_YOUR_OPERATIONS_MANUAL_FILE_ID_HERE';
  const OPS_MANUAL_URL = OPS_MANUAL_FILE_ID.startsWith('PASTE')
    ? 'https://drive.google.com/drive/folders/1AflTMfemn1NuRK95PnBJk5a1b6QTPeiG'
    : `https://drive.google.com/file/d/${OPS_MANUAL_FILE_ID}/view`;

  // â”€â”€ Live Google Doc URL (published, auto-updates every 5 min) â”€â”€â”€â”€â”€
  const OPS_MANUAL_PUB_URL = 'https://docs.google.com/document/d/e/2PACX-1vRgaFYbkwq41rzOeLBw-T1RLB8UP5b0Dof81X5Vfdv__ABMDEtEk0JGctXXTbNVmYEGvsTbxb4BCZHM/pub';

  // â”€â”€ Parsed doc cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _docCache = null;        // { fetchedAt, sections: [{id, heading, level, html, keyPoints}] }
  let _docFetchPromise = null; // deduplicate concurrent fetches

  // â”€â”€ Map policy cards to doc sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // keys = policy titles from POLICIES_INLINE, values = section heading keywords
  const POLICY_SECTION_MAP = {
    "Employee Handbook":                  ["HR", "Recruitment", "Hiring", "Performance Management", "Benefits", "Termination"],
    "Performance Evaluation System":      ["Performance Management", "Central Team Grievance", "Sexual Harassment"],
    "HR Concern & Documentation Protocol":["Performance Concern Reporting", "Performance Management", "Removal", "Termination"],
    "Budget & Financial Controls":        ["Finances", "Expenditure", "Reimbursement", "Cash Flow"],
    "Grant Reporting Requirements":       ["Invoicing", "District Procurement", "Quotes", "Late payments"],
    "Program Concern Escalation Protocol":["Performance Concern Reporting", "Communication Chain"],
    "Site Operations Handbook":           ["Programming", "On Site Staff", "Required Training", "Loaner Devices", "Materials"],
    "Data Governance Framework":          ["Data & Reporting", "Data Governance", "Pearl Rostering"],
    "Assessment & Progress Monitoring Guide":["Pearl Reporting", "iReady", "Performance Presentations"],
    "Training & PD Calendar SY25-26":     ["Required Training", "Training", "ADP Learning"],
    "Apprenticeship Program Guide":       ["Recruitment", "Hiring", "Onsite Employee"],
    "NJTC Organizational Chart SY25-26":  ["GENERAL Business Operations", "Partnerships", "Communication"],
    "Communications & Brand Standards":   ["Glassdoor", "LinkedIn", "Facebook", "Job Fairs", "Messaging"],
  };

  // â”€â”€ Fetch and parse the published Google Doc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchOpsManual(forceRefresh) {
    // Return cache if fresh (< 5 min)
    if (!forceRefresh && _docCache && (Date.now() - _docCache.fetchedAt) < 5 * 60 * 1000) {
      return _docCache;
    }
    // Deduplicate concurrent fetches
    if (_docFetchPromise && !forceRefresh) return _docFetchPromise;

    _docFetchPromise = (async () => {
      try {
        const resp = await fetch(OPS_MANUAL_PUB_URL + '?cachebust=' + Math.floor(Date.now() / 60000), {
          signal: AbortSignal.timeout(10000)
        });
        if (!resp.ok) throw new Error('fetch failed');
        const html = await resp.text();
        const sections = parseDocHTML(html);
        _docCache = { fetchedAt: Date.now(), sections, raw: html };
        _docFetchPromise = null;
        return _docCache;
      } catch(e) {
        _docFetchPromise = null;
        return null;
      }
    })();
    return _docFetchPromise;
  }

  // â”€â”€ Parse published Google Doc HTML into sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function parseDocHTML(rawHTML) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(rawHTML, 'text/html');
    // Remove nav/header/footer noise
    doc.querySelectorAll('header,footer,nav,.kix-appview-editor,.docs-title-input').forEach(el => el.remove());

    // Get all headings and content
    const body = doc.querySelector('.doc-content') || doc.querySelector('body');
    if (!body) return [];

    const sections = [];
    let currentSection = null;
    let sectionBuffer = [];

    const flushSection = () => {
      if (currentSection) {
        // Build HTML from buffer
        const wrapper = doc.createElement('div');
        sectionBuffer.forEach(el => wrapper.appendChild(el.cloneNode(true)));
        // Clean up Google Docs cruft
        const html = cleanDocHTML(wrapper.innerHTML);
        const keyPoints = extractKeyPoints(wrapper);
        sections.push({ ...currentSection, html, keyPoints });
      }
      sectionBuffer = [];
    };

    const allNodes = Array.from(body.childNodes);
    for (const node of allNodes) {
      if (node.nodeType !== 1) continue; // skip text nodes
      const tag = node.tagName;
      const text = node.textContent.trim();
      if (!text) continue;

      if (tag === 'H1') {
        flushSection();
        currentSection = { id: slugify(text), heading: text, level: 1 };
      } else if (tag === 'H2') {
        flushSection();
        currentSection = { id: slugify(text), heading: text, level: 2 };
      } else if (tag === 'H3') {
        flushSection();
        currentSection = { id: slugify(text), heading: text, level: 3 };
      } else {
        if (!currentSection) {
          currentSection = { id: 'overview', heading: 'Overview', level: 1 };
        }
        sectionBuffer.push(node);
      }
    }
    flushSection();
    return sections;
  }

  function cleanDocHTML(html) {
    // Remove Google Docs inline styles, IDs, anchors that clutter
    return html
      .replace(/style="[^"]*"/g, '')
      .replace(/class="[^"]*"/g, '')
      .replace(/id="[^"]*"/g, '')
      .replace(/<span>/g, '')
      .replace(/<\/span>/g, '')
      .replace(/<a [^>]*href="https?:\/\/www\.google\.com\/url\?q=([^&"]+)[^"]*"[^>]*>/g, (m, url) => `<a href="${decodeURIComponent(url)}" target="_blank" rel="noopener">`)
      .replace(/\s+/g, ' ')
      .trim();
  }

  function extractKeyPoints(wrapper) {
    const points = [];
    // Extract numbered list items as key points
    const listItems = wrapper.querySelectorAll('li');
    listItems.forEach((li, i) => {
      if (i < 5 && li.textContent.trim().length > 20) {
        points.push(li.textContent.trim().substring(0, 150));
      }
    });
    // If no list items, grab first sentences from paragraphs
    if (points.length === 0) {
      const paras = wrapper.querySelectorAll('p');
      paras.forEach((p, i) => {
        if (i < 3 && p.textContent.trim().length > 30) {
          const text = p.textContent.trim().substring(0, 180);
          if (text) points.push(text);
        }
      });
    }
    return points.slice(0, 5);
  }

  function slugify(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 40);
  }

  // â”€â”€ Get sections relevant to a policy card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getSectionsForPolicy(policyTitle) {
    const keywords = POLICY_SECTION_MAP[policyTitle] || [policyTitle];
    if (!_docCache) return [];
    return _docCache.sections.filter(sec =>
      keywords.some(kw => sec.heading.toLowerCase().includes(kw.toLowerCase()))
    );
  }

  // â”€â”€ Open policy detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openPolicyModal(policyTitle, dept, tag, effectiveDate, modifiedDate, driveUrl) {
    const modal = document.getElementById('policyDetailModal');
    const titleEl = document.getElementById('policyModalTitle');
    const deptEl = document.getElementById('policyModalDept');
    const metaEl = document.getElementById('policyModalMeta');
    const bodyEl = document.getElementById('policyModalBody');
    const tabsEl = document.getElementById('policyModalTabs');
    const syncDot = document.getElementById('policyModalSyncDot');
    const syncText = document.getElementById('policyModalSyncText');
    const openBtn = document.getElementById('policyModalOpenBtn');
    const footer = document.getElementById('policyModalFooter');

    // Set header
    titleEl.textContent = policyTitle;
    deptEl.textContent = tag || dept;
    metaEl.innerHTML = `Effective: <strong>${effectiveDate || 'N/A'}</strong>${modifiedDate ? ` &nbsp;Â·&nbsp; Updated: <strong>${modifiedDate}</strong>` : ''} &nbsp;Â·&nbsp; <span class="live-badge">LIVE</span>`;
    openBtn.href = driveUrl || OPS_MANUAL_URL;
    tabsEl.innerHTML = '';
    footer.style.display = 'none';

    // Show loading
    bodyEl.innerHTML = '<div class="policy-loading-state"><div class="policy-loading-spinner"></div><div>Fetching latest content from Operations Manualâ€¦</div></div>';
    syncDot.className = 'sync-dot loading';
    syncText.textContent = 'Loading live content from Operations Manualâ€¦';

    // Open modal
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';

    // Fetch doc
    const cache = await fetchOpsManual(false);

    if (!cache) {
      syncDot.className = 'sync-dot error';
      syncText.textContent = 'Could not load live content â€” check network or doc permissions.';
      bodyEl.innerHTML = `<div style="text-align:center;padding:2.5rem;color:var(--muted)">
        <div style="font-size:2rem;margin-bottom:.75rem">ğŸ“„</div>
        <div style="font-weight:700;color:var(--navy);margin-bottom:.5rem">Content Unavailable</div>
        <div style="margin-bottom:1.25rem;font-size:.9rem">The Operations Manual could not be loaded right now.</div>
        <a href="${driveUrl || OPS_MANUAL_URL}" target="_blank" rel="noopener" class="btn btn-gold" style="text-decoration:none">Open in Google Drive â†—</a>
      </div>`;
      return;
    }

    // Get relevant sections
    const sections = getSectionsForPolicy(policyTitle);
    const lastFetched = new Date(cache.fetchedAt);

    syncDot.className = 'sync-dot';
    syncText.innerHTML = `<strong>Live from Operations Manual</strong> Â· ${_docCache.sections.length} sections loaded Â· Last synced ${lastFetched.toLocaleTimeString()}`;

    if (sections.length === 0) {
      // Show full overview with search hint
      bodyEl.innerHTML = `<div class="policy-section-content">
        <div class="psc-title">ğŸ“‹ ${policyTitle}</div>
        <div class="psc-body">
          <p>This policy is documented in the NJTC Operations Manual. Use the button above to open the full document in Google Docs where you can search for specific sections.</p>
          <div style="margin-top:1.5rem;padding:1rem 1.25rem;background:var(--surface);border-radius:10px;border:1px solid var(--border)">
            <div style="font-weight:700;color:var(--navy);margin-bottom:.5rem">ğŸ“– Operations Manual Sections Available:</div>
            ${_docCache.sections.slice(0,8).map(s => `<div style="padding:.3rem 0;font-size:.875rem;color:var(--text)">Â· ${s.heading}</div>`).join('')}
            ${_docCache.sections.length > 8 ? `<div style="font-size:.8125rem;color:var(--muted);margin-top:.375rem">+${_docCache.sections.length - 8} more sections</div>` : ''}
          </div>
        </div>
      </div>`;
      return;
    }

    // Build section tabs
    tabsEl.innerHTML = sections.map((sec, i) =>
      `<button class="pst-tab ${i===0?'active':''}" onclick="showPolicySection(${i})" data-sec="${i}">${sec.heading}</button>`
    ).join('');

    // Store sections for tab switching
    modal._sections = sections;

    // Show first section
    renderPolicySection(0, bodyEl, footer, sections);
  }

  function showPolicySection(idx) {
    const modal = document.getElementById('policyDetailModal');
    const bodyEl = document.getElementById('policyModalBody');
    const footer = document.getElementById('policyModalFooter');
    // Update tabs
    document.querySelectorAll('.pst-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
    renderPolicySection(idx, bodyEl, footer, modal._sections);
  }

  function renderPolicySection(idx, bodyEl, footer, sections) {
    const sec = sections[idx];
    if (!sec) return;

    const levelIcon = sec.level === 1 ? 'ğŸ“‚' : sec.level === 2 ? 'ğŸ“‹' : 'ğŸ“Œ';

    bodyEl.innerHTML = `<div class="policy-section-content">
      <div class="psc-title">${levelIcon} ${sec.heading}</div>
      <div class="psc-body">${sec.html || '<p><em>No content available for this section.</em></p>'}</div>
    </div>`;

    // Key points footer
    if (sec.keyPoints && sec.keyPoints.length > 0) {
      footer.style.display = 'block';
      const highlights = document.getElementById('policyModalHighlights');
      highlights.innerHTML = sec.keyPoints.map(pt =>
        `<div class="key-highlight-card">
          <div class="khc-icon">âœ¦</div>
          <div class="khc-text">${pt}</div>
        </div>`
      ).join('');
    } else {
      footer.style.display = 'none';
    }

    bodyEl.scrollTop = 0;
  }

  function closePolicyModal() {
    document.getElementById('policyDetailModal').classList.remove('open');
    document.body.style.overflow = '';
  }

  let POLICIES_REGISTRY = []; // populated by renderPolicies
  // Inline policies â€” all sourced from the NJTC Operations Manual
  // Add fileId to each entry once you have individual document IDs in Drive
  const POLICIES_INLINE = [
    // HR
    { title: "Employee Handbook", dept: "hr", tag: "Human Resources", effectiveDate: "Aug 2025", modifiedDate: "Jan 2026", sectionsModified: ["Section 4 - Leave Policy", "Section 7 - Remote Work"], desc: "Full NJTC employee handbook covering policies, procedures, expectations, and code of conduct for all staff.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Maintain and continue to build on strong culture"] },
    { title: "Performance Evaluation System", dept: "hr", tag: "Human Resources", effectiveDate: "Nov 2025", modifiedDate: null, sectionsModified: [], desc: "Revised performance evaluation rubrics, observation forms, and process documentation for all staff roles.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Maintain and continue to build on strong culture", "Support Growth of New Jersey's Educator Pipeline"] },
    { title: "HR Concern & Documentation Protocol", dept: "hr", tag: "Human Resources", effectiveDate: "Sep 2025", modifiedDate: null, sectionsModified: [], desc: "Step-by-step guidance for documenting performance concerns, progressive discipline, and PGP administration.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Maintain and continue to build on strong culture"] },
    // Finance
    { title: "Budget & Financial Controls", dept: "finance", tag: "Finance", effectiveDate: "Aug 2025", modifiedDate: null, sectionsModified: [], desc: "Budget procedures, reimbursement policy, financial accountability guidelines, and approval workflows.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Maintain cash position", "Continue to pursue large and multi-year sources of funding"] },
    { title: "Grant Reporting Requirements", dept: "finance", tag: "Finance", effectiveDate: "Oct 2025", modifiedDate: null, sectionsModified: [], desc: "Compliance requirements and timelines for all active grants including DOL, philanthropic, and fee-for-service.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Continue to pursue large and multi-year sources of funding", "Increase the number of fee-for-service partnerships"] },
    // Programming
    { title: "Program Concern Escalation Protocol", dept: "programming", tag: "Programming", effectiveDate: "Sep 2025", modifiedDate: "Dec 2025", sectionsModified: ["Section 2 - Escalation Triggers"], desc: "Step-by-step guide for when and how to escalate site-level program concerns through the correct channels.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Maintain consistent partner experience", "Increase Impact on Scholars"] },
    { title: "Site Operations Handbook", dept: "programming", tag: "Programming", effectiveDate: "Aug 2025", modifiedDate: null, sectionsModified: [], desc: "Onsite operational standards, session delivery protocols, and tutor supervisory guidelines for all sites.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Increase Impact on Scholars"] },
    // Data & Evaluation
    { title: "Data Governance Framework", dept: "data", tag: "Data & Evaluation", effectiveDate: "Dec 2025", modifiedDate: null, sectionsModified: [], desc: "Internal reporting standards, data ownership definitions, access controls, and governance workflows for all data assets.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Upgrade systems to support growth"] },
    { title: "Assessment & Progress Monitoring Guide", dept: "data", tag: "Data & Evaluation", effectiveDate: "Sep 2025", modifiedDate: null, sectionsModified: [], desc: "Protocols for benchmark assessment administration, score entry, and progress monitoring dashboard usage.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Increase Impact on Scholars", "Upgrade systems to support growth"] },
    // Training & Development
    { title: "Training & PD Calendar SY25-26", dept: "training", tag: "Training & Development", effectiveDate: "Sep 2025", modifiedDate: "Jan 2026", sectionsModified: ["Q3 Schedule Updates"], desc: "Required professional development schedule, compliance tracking, and optional enrichment opportunities for all staff.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Support Growth of New Jersey's Educator Pipeline"] },
    { title: "Apprenticeship Program Guide", dept: "training", tag: "Training & Development", effectiveDate: "Oct 2025", modifiedDate: null, sectionsModified: [], desc: "DOL-registered apprenticeship program structure, participant requirements, and TAN integration pathway.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Support Growth of New Jersey's Educator Pipeline"] },
    // Organization-Wide
    { title: "NJTC Organizational Chart SY25-26", dept: "shared", tag: "Organization-Wide", effectiveDate: "Aug 2025", modifiedDate: null, sectionsModified: [], desc: "Current organizational structure, reporting lines, and department contacts for the 2025-2026 school year.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Upgrade systems to support growth"] },
    { title: "Communications & Brand Standards", dept: "shared", tag: "Organization-Wide", effectiveDate: "Aug 2025", modifiedDate: null, sectionsModified: [], desc: "NJTC brand voice guidelines, external communications standards, social media policy, and media relations protocol.", driveUrl: OPS_MANUAL_URL, annualGoals: ["Grow the NJTC brand"] },
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  GOOGLE FORM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const FORM_ACTION = 'https://docs.google.com/forms/d/e/1FAIpQLSfBqQmfn4ZHyJ1-tv-ehKDyr-zD4RkBr5AfZ2QeJMpJFbFxHg/formResponse';

  const ENTRY = {
    email:           'entry.1457676306',
    submitterName:   'entry.580089576',
    onBehalf:        'entry.1590438580',
    onBehalfOf:      'entry.1245652844',
    empName:         'entry.629932880',
    empRole:         'entry.2044182643',
    empRoleOther:    'entry.1645253994',
    todayYear:       'entry.701375141_year',
    todayMonth:      'entry.701375141_month',
    todayDay:        'entry.701375141_day',
    convYear:        'entry.651108769_year',
    convMonth:       'entry.651108769_month',
    convDay:         'entry.651108769_day',
    firstOccurrence: 'entry.1911489470',
    supportType:     'entry.1990325444',
    supportOther:    'entry.59727443',
    delivery:        'entry.232659604',
    empSite:         'entry.2070944320',
    concernType:     'entry.2109849030',
    concernOther:    'entry.TODO_Q15',
    history:         'entry.TODO_Q16',
    hrNextSteps:     'entry.1704854495',
    nextStepsDesc:   'entry.TODO_Q18',
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PANEL SWITCHING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showPanel(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
    // Pre-warm the Operations Manual cache when policies panel is opened
    if (id === "policies" && typeof fetchOpsManual === "function") fetchOpsManual(false);
    if (id === "policies") {
      // Always reset all filters when opening the policies panel
      // so no stale dept/search/sort state persists from previous visits
      const deptF = document.getElementById('policyDeptFilter');
      const searchF = document.getElementById('policySearch');
      if (deptF) deptF.value = '';
      if (searchF) searchF.value = '';
    }
    if (id === "talent") {
      buildTalentDashboard(false);
      if (!_talentLoaded) setTimeout(() => initTalentFilters(), 800);
    }
    const panel = document.getElementById('panel-' + id);
    if (panel) panel.classList.add('active');
    // Find the sidebar button if not passed
    const linkEl = btn || document.querySelector(`[data-panel="${id}"]`);
    if (linkEl) linkEl.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STATUS HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function statusClass(s) {
    return { 'Met':'s-met','In Progress':'s-progress','Partially Met':'s-partial','Coming Down the Pipeline':'s-pipeline','Has Not Met':'s-notmet' }[s] || 's-progress';
  }
  function statusEmoji(s) {
    return { 'Met':'âœ…','In Progress':'ğŸ”µ','Partially Met':'ğŸŸ ','Coming Down the Pipeline':'ğŸŸ£','Has Not Met':'ğŸ”´' }[s] || 'âšª';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  HOME PAGE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildHome(dept) {
    const cfg = DEPT_CONFIG[dept] || DEPT_CONFIG.programming;

    // Update header
    document.getElementById('homeEyebrow').textContent = cfg.label;
    document.getElementById('homeTitle').textContent = `${cfg.emoji} ${cfg.label}`;
    document.getElementById('homeSubtitle').textContent = cfg.tagline;

    // Stats strip â€” use midStatus as primary (falls back to status for legacy data)
    const getS = k => k.midStatus || k.status || '';
    const met = KPI_DATA.filter(k=>getS(k)==='Met').length;
    const prog = KPI_DATA.filter(k=>getS(k)==='In Progress').length;
    const partial = KPI_DATA.filter(k=>getS(k)==='Partially Met').length;
    const notmet = KPI_DATA.filter(k=>getS(k)==='Has Not Met').length;
    const pipe = KPI_DATA.filter(k=>getS(k)==='Coming Down the Pipeline').length;
    document.getElementById('homeStatsStrip').innerHTML = `
      <div class="stat-tile" style="--accent-color:var(--met)" onclick="showPanel('kpi',document.querySelector('[data-panel=kpi]'));setTimeout(()=>setKpiFilter('Met'),100)">
        <div class="st-icon">âœ…</div>
        <div class="st-value">${met}</div>
        <div class="st-label">Goals Met</div>
        <div class="st-sub">SY 2025â€“26</div>
      </div>
      <div class="stat-tile" style="--accent-color:var(--progress)" onclick="showPanel('kpi',document.querySelector('[data-panel=kpi]'));setTimeout(()=>setKpiFilter('In Progress'),100)">
        <div class="st-icon">ğŸ”µ</div>
        <div class="st-value">${prog}</div>
        <div class="st-label">In Progress</div>
        <div class="st-sub">Active tracking</div>
      </div>
      <div class="stat-tile" style="--accent-color:var(--partial)" onclick="showPanel('kpi',document.querySelector('[data-panel=kpi]'))">
        <div class="st-icon">ğŸŸ </div>
        <div class="st-value">${partial}</div>
        <div class="st-label">Partially Met</div>
        <div class="st-sub">Needs attention</div>
      </div>
      <div class="stat-tile" style="--accent-color:var(--pipeline)">
        <div class="st-icon">ğŸŸ£</div>
        <div class="st-value">${pipe}</div>
        <div class="st-label">Pipeline</div>
        <div class="st-sub">In development</div>
      </div>
      <div class="stat-tile" style="--accent-color:var(--notmet)" onclick="showPanel('kpi',document.querySelector('[data-panel=kpi]'));setTimeout(()=>setKpiFilter('Has Not Met'),100)">
        <div class="st-icon">ğŸ”´</div>
        <div class="st-value">${notmet}</div>
        <div class="st-label">Not Met</div>
        <div class="st-sub">Requires focus</div>
      </div>
    `;

    // metBadge in sidebar
    const metBadgeEl = document.getElementById('metBadge');
    if (metBadgeEl) metBadgeEl.textContent = met;

    // Quick links
    document.getElementById('homeQuickLinks').innerHTML = cfg.quickLinks.map(ql => `
      <div class="ql-card" onclick="showPanel('${ql.panel}',document.querySelector('[data-panel=${ql.panel}]'))">
        <div class="ql-icon-wrap" style="background:${ql.bg}">${ql.icon}</div>
        <div class="ql-title">${ql.label}</div>
        <div class="ql-desc">${ql.desc}</div>
        <div class="ql-arrow">Go â†’ </div>
      </div>
    `).join('');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SIDEBAR DEPT CARD + CONNECTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildSidebarDept(dept) {
    const cfg = DEPT_CONFIG[dept] || {};
    document.getElementById('sdcDept').textContent = `${cfg.emoji || ''} ${cfg.label || dept}`;
    document.getElementById('sdcTagline').textContent = cfg.tagline || '';
    document.getElementById('sdcBar').style.setProperty('--pct', cfg.goalPct || '0%');

    // Connections in sidebar (show 3 max)
    const connections = cfg.connections || [];
    const connList = document.getElementById('deptConnectionsList');
    const deptConns = DEPT_CONNECTIONS[dept] || [];
    connList.innerHTML = deptConns.slice(0,3).map(c => `
      <div class="dc-item" onclick="openConnectionsModal('${dept}')">
        <div class="dc-dot" style="background:${DEPT_COLORS[c.with]}"></div>
        <div class="dc-text"><strong>${DEPT_LABELS[c.with]}</strong> Â· ${c.how}</div>
      </div>
    `).join('') + (deptConns.length === 0 ? '<div class="dc-text" style="color:rgba(255,255,255,.3)">No connections configured</div>' : '');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CONNECTIONS MODAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let _currentDept = null;
  function openConnectionsModal(dept) {
    dept = dept || _currentDept;
    const cfg = DEPT_CONFIG[dept] || {};
    const conns = DEPT_CONNECTIONS[dept] || [];
    document.getElementById('modalTitle').textContent = `${cfg.emoji || ''} ${cfg.label} Connections`;
    document.getElementById('modalSub').textContent = `How ${cfg.label} connects with other departments to achieve annual goals`;
    document.getElementById('modalBody').innerHTML = conns.map(c => `
      <div class="connection-card">
        <div class="cc-dot" style="background:${DEPT_COLORS[c.with]}20">
          <span style="font-size:1.25rem">${DEPT_ICONS[c.with]}</span>
        </div>
        <div style="flex:1">
          <div class="cc-dept">${DEPT_LABELS[c.with]}</div>
          <div class="cc-how">${c.how}</div>
          <div class="cc-why">${c.why}</div>
          <div class="cc-goals">${c.goals.map(g=>`<span class="cc-goal-tag">ğŸ“Š ${g}</span>`).join('')}</div>
        </div>
      </div>
    `).join('');
    document.getElementById('connectionsModal').classList.add('open');
  }
  function closeConnectionsModal() {
    document.getElementById('connectionsModal').classList.remove('open');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  KPI TABLE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ Parse CSV text into KPI row objects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function parseSheetCSV(csvText) {
    const rows = [];
    // Split into lines, handle 

    const lines = csvText.replace(/\r/g, '').split('\n');
    // Find header row â€” contains "Goal" in col A
    let headerIdx = -1;
    for (let i = 0; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols[0] && cols[0].trim() === 'Goal') { headerIdx = i; break; }
    }
    if (headerIdx === -1) return null; // could not parse
    // Data rows start immediately after header
    for (let i = headerIdx + 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      const goal = (cols[0] || '').trim();
      const target = (cols[1] || '').trim();
      const mid = (cols[3] || '').trim();
      const end = (cols[4] || '').trim();
      if (!goal || !target || goal.startsWith('MID') || goal.startsWith('Color')) continue;
      // Validate statuses â€” warn in console if an unrecognized value enters from the sheet
      const VALID_STATUSES = ['Met', 'In Progress', 'Partially Met', 'Coming Down the Pipeline', 'Has Not Met', ''];
      if (mid && !VALID_STATUSES.includes(mid)) console.warn(`[KPI AUDIT] Unrecognized mid status "${mid}" for: ${target}`);
      if (end && !VALID_STATUSES.includes(end)) console.warn(`[KPI AUDIT] Unrecognized end status "${end}" for: ${target}`);
      rows.push({ goal, target, midStatus: mid, endStatus: end });
    }
    return rows;
  }

  // â”€â”€ Minimal CSV line parser (handles quoted fields) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  

  // â”€â”€ Fetch live data from published Google Sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchAndRebuildKPI(forceRefresh) {
    const dot = document.getElementById('kpiSyncDot');
    const txt = document.getElementById('kpiSyncText');
    const btn = document.getElementById('kpiRefreshBtn');
    if (dot) { dot.className = 'sync-dot loading'; }
    if (txt) txt.textContent = 'Fetching live data from Google Sheetâ€¦';
    if (btn) btn.disabled = true;

    let parsed = null;
    try {
      const url = SHEET_CSV_URL + (forceRefresh ? '&t=' + Date.now() : '');
      const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
      if (res.ok) {
        const csv = await res.text();
        parsed = parseSheetCSV(csv);
      }
    } catch(e) { /* fall through to static */ }

    // â”€â”€ STALE WARNING BANNER helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showStaleWarning(msg) {
      let banner = document.getElementById('kpiStaleBanner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'kpiStaleBanner';
        banner.style.cssText = 'background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:.625rem 1rem;font-size:.8125rem;color:#92400e;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;';
        const container = document.getElementById('kpiSummary');
        if (container && container.parentNode) container.parentNode.insertBefore(banner, container);
      }
      banner.innerHTML = `âš ï¸ <strong>Data Warning:</strong> ${msg}`;
      banner.style.display = 'flex';
    }
    function clearStaleWarning() {
      const banner = document.getElementById('kpiStaleBanner');
      if (banner) banner.style.display = 'none';
    }

    if (parsed && parsed.length > 0) {
      // Live data successfully fetched â€” update everything
      KPI_DATA = parsed;
      _kpiFromSheet = true;
      _kpiLastFetched = new Date();
      if (dot) { dot.className = 'sync-dot'; }
      if (txt) txt.innerHTML = `<strong>Live from Google Sheet</strong> Â· ${parsed.length} targets Â· Last synced ${_kpiLastFetched.toLocaleTimeString()}`;
      clearStaleWarning();
    } else {
      // Fetch failed â€” PRESERVE last good live data if we have it.
      // Only fall back to static if KPI_DATA has never been populated from the sheet.
      _kpiFromSheet = false;
      if (dot) { dot.className = 'sync-dot error'; }
      if (_kpiLastFetched) {
        // We have previously-fetched live data â€” keep it, warn the user
        if (txt) txt.innerHTML = `<strong>âš ï¸ Sheet unreachable</strong> Â· Showing last synced data from ${_kpiLastFetched.toLocaleTimeString()} Â· Recent changes may not be reflected`;
        showStaleWarning(`Could not reach Google Sheet. Counts below reflect last successful sync at ${_kpiLastFetched.toLocaleTimeString()}. Recent status changes may not be visible yet.`);
      } else {
        // First load ever failed â€” use static as absolute last resort
        KPI_DATA = KPI_DATA_STATIC;
        if (txt) txt.innerHTML = '<strong>Using built-in data</strong> Â· Could not reach Google Sheet on first load Â· Refresh to retry';
        showStaleWarning('Live data unavailable. Displaying built-in baseline data â€” this may not reflect recent status changes. Click â†º Refresh to retry.');
      }
    }
    if (btn) btn.disabled = false;

    buildKPISummary();
    buildKPI();
    // Always rebuild home stats after every data refresh â€” data is now guaranteed accurate
    const session = window.NJTC_SESSION;
    if (session) buildHome(session.dept);
  }

  function buildKPISummary() {
    // Use midStatus for summary counts (primary cycle view)
    const cycle = (document.getElementById('kpiCycleFilter') || {value:'mid'}).value || 'mid';
    const getStatus = k => cycle === 'end' ? (k.endStatus || k.midStatus || '') : (k.midStatus || k.status || '');
    const counts = { Met:0, 'In Progress':0, 'Partially Met':0, 'Coming Down the Pipeline':0, 'Has Not Met':0 };
    KPI_DATA.forEach(k => { const s = getStatus(k); if(counts[s] !== undefined) counts[s]++; });
    const configs = [
      { status:'Met', emoji:'âœ…', color:'var(--met)' },
      { status:'In Progress', emoji:'ğŸ”µ', color:'var(--progress)' },
      { status:'Partially Met', emoji:'ğŸŸ ', color:'var(--partial)' },
      { status:'Coming Down the Pipeline', emoji:'ğŸŸ£', color:'var(--pipeline)' },
      { status:'Has Not Met', emoji:'ğŸ”´', color:'var(--notmet)' },
    ];
    const el = document.getElementById('kpiSummary');
    if (el) el.innerHTML = configs.map(c => `
      <div class="kss-tile" onclick="setKpiFilter('${c.status}')" style="border-top:3px solid ${c.color}">
        <div class="kss-num" style="color:${c.color}">${counts[c.status]}</div>
        <div class="kss-label">${c.status}</div>
      </div>
    `).join('');

    // Populate goal filter (only once)
    const sel = document.getElementById('kpiGoalFilter');
    if (sel && sel.options.length === 1) {
      const goals = [...new Set(KPI_DATA.map(k=>k.goal))];
      goals.forEach(g => { const o = document.createElement('option'); o.value = g; o.textContent = g; sel.appendChild(o); });
    }
  }

  function setKpiFilter(status) {
    document.getElementById('kpiStatusFilter').value = status;
    filterKPI();
  }

  function buildKPI() { filterKPI(); }

  function filterKPI() {
    const goalF   = document.getElementById('kpiGoalFilter').value;
    const statusF = document.getElementById('kpiStatusFilter').value;
    const searchF = document.getElementById('kpiSearch').value.toLowerCase();
    const cycle   = (document.getElementById('kpiCycleFilter') || {value:'mid'}).value || 'mid';

    // Update header labels to reflect selected cycle
    const midH = document.getElementById('midCycleHeader');
    const endH = document.getElementById('endCycleHeader');
    if (midH) midH.style.opacity = cycle === 'mid' ? '1' : '.45';
    if (endH) endH.style.opacity = cycle === 'end' ? '1' : '.45';

    const getStatus = k => cycle === 'end'
      ? (k.endStatus || k.midStatus || '')
      : (k.midStatus || k.status || '');

    const filtered = KPI_DATA.filter(k => {
      const s = getStatus(k);
      return (!goalF   || k.goal === goalF)
          && (!statusF || s === statusF)
          && (!searchF || k.target.toLowerCase().includes(searchF) || k.goal.toLowerCase().includes(searchF));
    });

    // Group by goal
    const groups = {};
    const goalOrder = [...new Set(KPI_DATA.map(k => k.goal))]; // preserve spreadsheet order
    filtered.forEach(k => { if(!groups[k.goal]) groups[k.goal]=[]; groups[k.goal].push(k); });

    let html = '';
    goalOrder.forEach(goal => {
      if (!groups[goal]) return;
      html += `<tr class="goal-group-header"><td colspan="4">${goal}</td></tr>`;
      groups[goal].forEach(k => {
        const mid = k.midStatus || '';
        const end = k.endStatus || '';
        html += `<tr>
          <td></td>
          <td style="font-size:.875rem;color:var(--text);line-height:1.5">${k.target}</td>
          <td>${mid ? `<span class="kpi-status ${statusClass(mid)}" style="cursor:pointer" onclick="setKpiFilter('${mid}')" title="Click to filter by this status">${statusEmoji(mid)} ${mid}</span>` : '<span style="color:var(--muted);font-size:.8125rem">â€”</span>'}</td>
          <td>${end ? `<span class="kpi-status ${statusClass(end)}" style="cursor:pointer" onclick="setKpiFilter('${end}')" title="Click to filter by this status">${statusEmoji(end)} ${end}</span>` : '<span style="color:var(--muted);font-size:.8125rem;font-style:italic">Pending</span>'}</td>
        </tr>`;
      });
    });
    const tbody = document.getElementById('kpiBody');
    if (tbody) tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--muted)">No matching targets found</td></tr>';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  POLICIES LIBRARY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let _allPolicies = POLICIES_INLINE;

  async function buildPolicies(forceRefresh) {
    const syncDot = document.getElementById('syncDot');
    const syncText = document.getElementById('syncText');
    syncDot.className = 'sync-dot loading';
    syncText.innerHTML = 'Fetching latest documents from Google Driveâ€¦';

    // â”€â”€ If live doc sync is disabled, use inline + any PDF uploads only â”€â”€
    if (typeof _liveDocEnabled !== 'undefined' && !_liveDocEnabled) {
      const pdfDocs = (typeof _pdfPolicies !== 'undefined' ? _pdfPolicies : []).map(p => ({
        title: p.name, dept: p.dept || 'shared', tag: 'PDF Upload',
        effectiveDate: new Date(p.uploadedAt).toLocaleDateString('en-US',{month:'short',year:'numeric'}),
        modifiedDate: null, sectionsModified: [], annualGoals: [],
        desc: `Uploaded PDF Â· ${p.filename} Â· By: ${p.uploadedBy}`,
        driveUrl: p.dataUrl, _isPdf: true, _isDriveUpload: true,
        _uploadedBy: p.uploadedBy, _uploadedAt: p.uploadedAt, _filename: p.filename,
      }));
      _allPolicies = [...POLICIES_INLINE, ...pdfDocs];
      syncDot.className = 'sync-dot error';
      syncText.innerHTML = '<strong>Live sync OFF</strong> Â· Showing built-in documents + uploaded PDFs Â· <em>Toggle Live Doc to re-enable</em>';
      renderPolicies();
      return;
    }

    let docs = POLICIES_INLINE;
    let fromDrive = false;
    if (forceRefresh && typeof logChange !== 'undefined') {
      logChange('edit', 'Policies library manually refreshed', typeof getDeptLabel !== 'undefined' ? getDeptLabel() : 'User', 'Policies & Procedures');
    }

    if (!DRIVE_MANIFEST_ID.startsWith('REPLACE')) {
      // Try multiple fetch strategies to work around CORS restrictions on Drive direct URLs.
      // Strategy 1: GitHub raw (preferred â€” no CORS, fastest, use if manifest.json is in the repo)
      // Strategy 2: Google Drive export with no-cors (limited but sometimes works)
      // Strategy 3: CORS proxy fallback
      // APPS_SCRIPT_URL: paste your deployed Web App URL here after setup
      // This is the primary source â€” reads your Drive folder live, zero CORS issues
      const APPS_SCRIPT_URL = typeof DRIVE_APPS_SCRIPT_URL !== 'undefined' ? DRIVE_APPS_SCRIPT_URL : '';
      const GITHUB_MANIFEST_URL = 'https://raw.githubusercontent.com/njtcdata/New-Jersey-Tutoring-Corps-Portal/main/central/manifest.json';
      const DRIVE_DIRECT_URL = `https://drive.google.com/uc?export=download&id=${DRIVE_MANIFEST_ID}`;
      const CORS_PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(DRIVE_DIRECT_URL)}`;

      const tryFetch = async (url) => {
        const res = await fetch(url + (forceRefresh ? (url.includes('?') ? '&' : '?') + 't=' + Date.now() : ''), {
          signal: AbortSignal.timeout(8000)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const raw = await res.text();
        return JSON.parse(raw);
      };

      // Apps Script removed from strategy chain â€” causes CORS errors on GitHub Pages.
      // GitHub raw is the primary source; CORS proxy is fallback.
      const strategies = [
        { label: 'GitHub', url: GITHUB_MANIFEST_URL },
        { label: 'CORS Proxy', url: CORS_PROXY_URL },
      ];

      for (const strategy of strategies) {
        try {
          const parsed = await tryFetch(strategy.url);
          if (Array.isArray(parsed) && parsed.length > 0) {
            docs = parsed.map(d => ({
              ...d,
              dept: d.dept || 'shared',
              sectionsModified: d.sectionsModified || [],
              annualGoals: d.annualGoals || [],
              _isDriveUpload: true,
              _driveManifest: true,
            }));
            fromDrive = true;
            console.log(`[Manifest] Loaded via ${strategy.label}: ${parsed.length} documents`);
            break;
          }
        } catch(e) {
          console.warn(`[Manifest] ${strategy.label} failed:`, e.message);
        }
      }
    }

    // Merge in any locally-uploaded PDF additions
    const pdfAdditions = (typeof _pdfPolicies !== 'undefined' ? _pdfPolicies : []).map(p => ({
      title: p.name, dept: p.dept || 'shared', tag: 'PDF Upload',
      effectiveDate: new Date(p.uploadedAt).toLocaleDateString('en-US',{month:'short',year:'numeric'}),
      modifiedDate: null, sectionsModified: [], annualGoals: [],
      desc: `Uploaded PDF Â· ${p.filename} Â· By: ${p.uploadedBy}`,
      driveUrl: p.dataUrl, _isPdf: true, _isDriveUpload: true,
      _uploadedBy: p.uploadedBy, _uploadedAt: p.uploadedAt, _filename: p.filename,
    }));
    // ALWAYS keep POLICIES_INLINE as the base.
    // Drive manifest entries are ADDITIONS on top â€” they never replace built-in policies.
    const driveAdditions = fromDrive ? docs : [];
    _allPolicies = [...POLICIES_INLINE, ...driveAdditions, ...pdfAdditions];

    const totalCount = POLICIES_INLINE.length + driveAdditions.length + pdfAdditions.length;
    if (fromDrive) {
      syncDot.className = 'sync-dot';
      syncText.innerHTML = `<strong>Live from Google Drive</strong> Â· ${POLICIES_INLINE.length} core policies + ${driveAdditions.length} Drive additions${pdfAdditions.length ? ' + ' + pdfAdditions.length + ' uploads' : ''} Â· Last refreshed ${new Date().toLocaleTimeString()}`;
    } else {
      syncDot.className = 'sync-dot error';
      syncText.innerHTML = DRIVE_MANIFEST_ID.startsWith('REPLACE')
        ? `<strong>${POLICIES_INLINE.length} built-in policies</strong> Â· Connect Google Drive to add supplemental documents automatically`
        : `<strong>${POLICIES_INLINE.length} built-in policies</strong> Â· Drive unreachable â€” supplemental documents unavailable Â· <em>Click â†º Refresh to retry</em>`;
    }
    renderPolicies();
  }

  function renderPolicies() {
    const deptF  = document.getElementById('policyDeptFilter').value;
    const search = document.getElementById('policySearch').value.toLowerCase();
    const sort   = document.getElementById('policySort').value;

    // Build registry from ALL policies (preserves stable pid across filter changes)
    POLICIES_REGISTRY = _allPolicies;

    // Tag each policy with its stable pid before filtering
    const allWithPid = _allPolicies.map((d, i) => ({ ...d, _pid: i }));
    let docs = allWithPid.filter(d => {
      // Special filter: "Google Drive Additions" shows only _isDriveUpload docs
      if (deptF === '__drive__') return !!d._isDriveUpload;
      return (!deptF  || d.dept === deptF) &&
        (!search || d.title.toLowerCase().includes(search) || (d.desc||'').toLowerCase().includes(search) || (d.tag||'').toLowerCase().includes(search));
    });

    if (sort === 'alpha')    docs = [...docs].sort((a,b) => a.title.localeCompare(b.title));
    if (sort === 'modified') docs = [...docs].sort((a,b) => (b.modifiedDate||'') > (a.modifiedDate||'') ? 1 : -1);
    if (sort === 'date')     docs = [...docs].sort((a,b) => (b.effectiveDate||'') > (a.effectiveDate||'') ? 1 : -1);

    if (!docs.length) {
      document.getElementById('policyContent').innerHTML = '<div class="alert alert-info"><span>â„¹ï¸</span><div>No documents match your filter.</div></div>';
      return;
    }

    let html = '';
    if (sort === 'dept' && !deptF) {
      // Group by dept
      const DEPT_ORDER = ['shared','hr','finance','programming','data','training','__drive__'];
      const groups = {};
      docs.forEach(d => { const dk = d._isDriveUpload ? '__drive__' : (d.dept||'shared'); if(!groups[dk]) groups[dk]=[]; groups[dk].push(d); });
      DEPT_ORDER.forEach(dk => {
        if (!groups[dk]) return;
        const color = DEPT_COLORS[dk] || '#888';
        const icon = DEPT_ICONS[dk] || 'ğŸ“„';
        const label = DEPT_LABELS[dk] || dk;
        const isDriveGroup = dk === '__drive__';
        const headerStyle = isDriveGroup
          ? `background:linear-gradient(90deg,#e8f4fd,#f0f7ff);border:1.5px solid #b6d9f7;border-radius:10px;padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem`
          : ``;
        const titleStyle = isDriveGroup ? `color:#0969da;font-weight:700` : ``;
        const driveNote = isDriveGroup
          ? `<span style="font-size:.7rem;font-weight:400;color:#0969da;margin-left:.5rem;opacity:.8">â€” Separate from the Policies &amp; Procedures Manual</span>`
          : ``;
        html += isDriveGroup
          ? `<div style="${headerStyle}">
              <div class="dsh-icon" style="background:#0969da18;font-size:1.25rem">â˜ï¸</div>
              <div style="flex:1">
                <div class="dsh-title" style="${titleStyle}">Google Drive Additions ${driveNote}</div>
                <div style="font-size:.75rem;color:#0969da;margin-top:.125rem">${groups[dk].length} document${groups[dk].length>1?'s':''} uploaded directly to Google Drive</div>
              </div>
              <span style="font-size:.625rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;background:#0969da;color:#fff;padding:.2rem .6rem;border-radius:20px">Drive Addition</span>
            </div>
            <div class="policy-grid" style="margin-bottom:2rem">
              ${groups[dk].map(d => policyCardHTML(d, d._pid)).join('')}
            </div>`
          : `<div class="dept-section-header">
              <div class="dsh-icon" style="background:${color}18">${icon}</div>
              <div class="dsh-title">${label}</div>
              <div class="dsh-count">${groups[dk].length} document${groups[dk].length>1?'s':''}</div>
            </div>
            <div class="policy-grid" style="margin-bottom:1.5rem">
              ${groups[dk].map(d => policyCardHTML(d, d._pid)).join('')}
            </div>`;
      });
    } else {
      html = `<div class="policy-grid">${docs.map(d => policyCardHTML(d, d._pid)).join('')}</div>`;
    }
    document.getElementById('policyContent').innerHTML = html;
  }

  function policyCardHTML(d, pid) {
    const color = DEPT_COLORS[d.dept] || '#888';
    const url = d.driveUrl || (d.fileId && !d.fileId.startsWith('REPLACE') && !d.fileId.startsWith('TODO') && !d.fileId.startsWith('PASTE')
      ? `https://drive.google.com/file/d/${d.fileId}/view`
      : null);
    const modified = d.modifiedDate && d.sectionsModified && d.sectionsModified.length > 0;
    const modTooltip = modified
      ? `<div class="has-tooltip" style="display:inline-block">
          <span class="policy-changes-badge">ğŸ“ Updated ${d.modifiedDate}
            <div class="tooltip-box">
              <strong>Sections Modified:</strong><br>${(d.sectionsModified||[]).map(s=>`â€¢ ${s}`).join('<br>')}
            </div>
          </span>
        </div>`
      : '';
    const goalTags = (d.annualGoals||[]).map(g =>
      `<span class="has-tooltip" style="display:inline-block">
        <span style="font-size:.6rem;font-weight:600;background:rgba(0,80,200,.07);color:var(--blue-mid);padding:.15rem .45rem;border-radius:4px;cursor:default">ğŸ“Š ${g}</span>
        <div class="tooltip-box" style="width:220px">Aligns with organizational goal: <strong>${g}</strong></div>
      </span>`
    ).join('');
    const safeId = pid !== undefined ? pid : 0;

    // â”€â”€ Drive Addition rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const isDrive = !!d._isDriveUpload;
    const driveTag = isDrive
      ? `<span class="drive-addition-tag" title="This document was uploaded directly to Google Drive â€” it is separate from the Policies &amp; Procedures Manual">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16M12 4v12M8 8l4-4 4 4"/></svg>
          Google Drive Addition
        </span>`
      : '';
    const driveUploadMeta = isDrive && d._uploadedBy
      ? `<div class="drive-upload-meta">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Uploaded by ${d._uploadedBy}${d._uploadedAt ? ' Â· ' + new Date(d._uploadedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : ''}
          ${d._filename ? ` Â· <em>${d._filename}</em>` : ''}
        </div>`
      : '';
    const cardClass = isDrive ? 'policy-card drive-addition' : 'policy-card';
    const openDocLink = url ? `<a class="policy-link" href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${isDrive ? 'â˜ï¸ Open in Drive â†—' : 'Open Doc â†—'}</a>` : '';
    const readBtn = isDrive
      ? `<button class="policy-open-btn" style="border-color:#0969da;color:#0969da" onclick="event.stopPropagation();openPolicyByIdx(${safeId})">â˜ï¸ View Document</button>`
      : `<button class="policy-open-btn" onclick="event.stopPropagation();openPolicyByIdx(${safeId})">ğŸ“– Read Policy</button>`;

    return `
      <div class="${cardClass}" data-pid="${safeId}" onclick="openPolicyByIdx(${safeId})" title="${isDrive ? 'Google Drive Addition â€” click to open' : 'Click to read policy'}">
        <div class="policy-card-top">
          <div class="policy-tag-group">
            <div class="policy-dept-dot" style="background:${color}"></div>
            <span class="policy-tag" style="background:${color}18;color:${color}">${d.tag || d.dept}</span>
            ${driveTag}
            ${modTooltip}
          </div>
          <span class="policy-modified">ğŸ“… ${d.effectiveDate||'â€”'}</span>
        </div>
        <div class="policy-title">${d.title}</div>
        <div class="policy-desc">${d.desc||''}</div>
        ${driveUploadMeta}
        ${goalTags ? `<div style="display:flex;flex-wrap:wrap;gap:.375rem;margin-top:.625rem">${goalTags}</div>` : ''}
        <div class="policy-footer" style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap">
          <span class="policy-date">${isDrive ? 'Added ' : 'Effective '}${d.effectiveDate||'â€”'}</span>
          <div style="display:flex;gap:.5rem;align-items:center">
            ${readBtn}
            ${openDocLink}
          </div>
        </div>
      </div>`;
  }

  function openPolicyByIdx(pid) {
    const d = POLICIES_REGISTRY[pid];
    if (!d) { console.warn('openPolicyByIdx: no policy at index', pid); return; }

    // Drive Additions (uploaded files) open directly in Drive â€” no section reader modal
    if (d._isDriveUpload) {
      const url = d.driveUrl || OPS_MANUAL_URL;
      // PDF uploads have a dataUrl â€” open in a new tab via blob
      if (d._isPdf && url.startsWith('data:')) {
        const win = window.open('', '_blank');
        win.document.write('<iframe src="' + url + '" style="width:100%;height:100vh;border:none"></iframe>');
        return;
      }
      window.open(url, '_blank', 'noopener');
      return;
    }

    // Built-in policies â†’ open the rich section reader modal
    const url = d.driveUrl || (d.fileId && !d.fileId.startsWith('REPLACE')
      ? 'https://drive.google.com/file/d/' + d.fileId + '/view'
      : OPS_MANUAL_URL);
    openPolicyModal(d.title, d.dept, d.tag || d.dept, d.effectiveDate || '', d.modifiedDate || '', url || OPS_MANUAL_URL);
  }

  function filterPolicies() { renderPolicies(); }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CONCERN FORM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let _step = 1;

  function goStep(n) {
    if (n > _step && !validateStep(_step)) return;
    document.getElementById(`fs${_step}`).classList.remove('active');
    document.getElementById(`fs${n}`).classList.add('active');
    ['sp1','sp2','sp3','sp4'].forEach((id,i) => {
      const el = document.getElementById(id);
      el.classList.remove('active','completed');
      if (i+1 === n) el.classList.add('active');
      else if (i+1 < n) el.classList.add('completed');
    });
    _step = n;
    document.querySelector('.form-wrapper').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  function validateStep(n) {
    const errs = [];
    if (n===1) {
      if (!document.getElementById('f_email').value.trim()) errs.push('Email is required.');
      if (!document.getElementById('f_submitter').value.trim()) errs.push('Your name and title are required.');
    }
    if (n===2) {
      if (!document.getElementById('f_empName').value.trim()) errs.push('Employee name is required.');
      if (!document.getElementById('f_empRole').value) errs.push('Employee role is required.');
      if (!document.getElementById('f_empSite').value) errs.push('Employee site is required.');
      if (!document.getElementById('f_todayDate').value) errs.push("Today's date is required.");
      if (!document.getElementById('f_convDate').value) errs.push('Date conversation occurred is required.');
      if (!document.querySelector('input[name="firstOccurrence"]:checked')) errs.push('Please indicate if this is the first documented occurrence.');
    }
    if (n===3) {
      if (!document.querySelector('input[name="supportType"]:checked')) errs.push('Support type is required.');
      if (!document.querySelector('input[name="delivery"]:checked')) errs.push('Delivery method is required.');
      if (!document.querySelector('input[name="concernType"]:checked')) errs.push('Concern type is required.');
      if (!document.getElementById('f_history').value.trim()) errs.push('Historical details are required.');
    }
    if (errs.length) { alert(errs.join('\n')); return false; }
    return true;
  }

  function toggleOnBehalf(val) {
    document.getElementById('onBehalfField').style.display = val==='Yes' ? 'block' : 'none';
  }
  function toggleSupportOther(val) {
    document.getElementById('supportOtherWrap').style.display = val==='Other' ? 'block' : 'none';
  }
  function toggleConcernOther(val) {
    document.getElementById('concernOtherWrap').style.display = val==='Other' ? 'block' : 'none';
  }

  function _parseDate(s) {
    const [y,m,d] = (s||'').split('-');
    return { year:y||'', month:m?String(parseInt(m)):'', day:d?String(parseInt(d)):'' };
  }

  async function submitConcernForm() {
    if (!validateStep(4)) return;
    if (!document.querySelector('input[name="hrNextSteps"]:checked')) {
      const errEl = document.getElementById('submitError');
      errEl.textContent = 'Please select the next steps requested from HR.';
      errEl.style.display = 'block';
      return;
    }
    document.getElementById('submitError').style.display = 'none';
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    document.getElementById('submitBtnTxt').textContent = 'Submittingâ€¦';
    document.getElementById('submitSpinner').style.display = 'inline-block';

    const td = _parseDate(document.getElementById('f_todayDate').value);
    const cd = _parseDate(document.getElementById('f_convDate').value);
    const params = new URLSearchParams();
    const g = (id) => document.getElementById(id)?.value?.trim() || '';
    const r = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';

    params.append(ENTRY.email,           g('f_email'));
    params.append(ENTRY.submitterName,   g('f_submitter'));
    params.append(ENTRY.onBehalf,        r('onBehalf') || 'No');
    params.append(ENTRY.onBehalfOf,      g('f_onBehalfOf'));
    params.append(ENTRY.empName,         g('f_empName'));
    params.append(ENTRY.empRole,         document.getElementById('f_empRole').value);
    params.append(ENTRY.empRoleOther,    document.getElementById('f_empRole').value === 'Other' ? '' : '');
    params.append(ENTRY.todayYear,       td.year);
    params.append(ENTRY.todayMonth,      td.month);
    params.append(ENTRY.todayDay,        td.day);
    params.append(ENTRY.convYear,        cd.year);
    params.append(ENTRY.convMonth,       cd.month);
    params.append(ENTRY.convDay,         cd.day);
    params.append(ENTRY.firstOccurrence, r('firstOccurrence'));
    params.append(ENTRY.supportType,     r('supportType'));
    params.append(ENTRY.supportOther,    g('f_supportOther'));
    params.append(ENTRY.delivery,        r('delivery'));
    params.append(ENTRY.empSite,         document.getElementById('f_empSite').value);
    params.append(ENTRY.concernType,     r('concernType'));
    params.append(ENTRY.concernOther,    g('f_concernOther'));
    params.append(ENTRY.history,         g('f_history'));
    params.append(ENTRY.hrNextSteps,     r('hrNextSteps'));
    params.append(ENTRY.nextStepsDesc,   g('f_nextStepsDesc'));

    try {
      await fetch(FORM_ACTION, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:params.toString() });
      document.getElementById('formContainer').style.display = 'none';
      document.getElementById('formSuccess').style.display = 'block';
    } catch(e) {
      const errEl = document.getElementById('submitError');
      errEl.textContent = 'Submission failed. Please try again or contact your Program Manager.';
      errEl.style.display = 'block';
      btn.disabled = false;
      document.getElementById('submitBtnTxt').textContent = 'Submit to HR';
      document.getElementById('submitSpinner').style.display = 'none';
    }
  }

  function resetConcernForm() {
    document.getElementById('concernForm').reset();
    ['onBehalfField','supportOtherWrap','concernOtherWrap'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
    document.getElementById('formContainer').style.display = 'block';
    document.getElementById('formSuccess').style.display = 'none';
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtnTxt').textContent = 'Submit to HR';
    document.getElementById('submitSpinner').style.display = 'none';
    document.getElementById('submitError').style.display = 'none';
    _step = 1;
    goStep(1);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SESSION TIMER + NAV DATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function startSessionTimer(exp) {
    function update() {
      const left = exp - Date.now();
      if (left <= 0) { NJTCAuth.logout(); return; }
      const h = Math.floor(left/3600000);
      const m = Math.floor((left%3600000)/60000);
      document.getElementById('sessionTimer').textContent = `Session: ${h}h ${m}m`;
    }
    update();
    setInterval(update, 60000);
  }

  function updateNavDate() {
    const d = new Date();
    document.getElementById('navDate').textContent = d.toLocaleDateString('en-US',{ weekday:'short', month:'short', day:'numeric', year:'numeric' });
  }

  function setupPerfSection() { /* no legacy elements */ }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init() {
    updateNavDate();

    await new Promise(resolve => {
      if (window.NJTC_SESSION) { resolve(); return; }
      const t = setInterval(() => {
        if (window.NJTC_SESSION) { clearInterval(t); resolve(); }
      }, 50);
      setTimeout(() => { clearInterval(t); resolve(); }, 3000);
    });

    const session = window.NJTC_SESSION;
    if (!session) return;

    const dept = session.dept;
    _currentDept = dept;
    const cfg = DEPT_CONFIG[dept] || {};

    // Nav badge
    document.getElementById('deptBadge').textContent = cfg.label || dept.toUpperCase();

    // Session timer
    startSessionTimer(session.exp);

    // Build content
    // buildHome is called from INSIDE fetchAndRebuildKPI after KPI_DATA is populated from the live sheet.
    // Calling it here first would render stale static counts then visibly jump â€” race condition eliminated.
    buildSidebarDept(dept);
    buildPolicies(false);
    // Fetch live KPI data first â€” then buildHome fires with accurate data
    fetchAndRebuildKPI(true);
    // Init dept-aware nav (show/hide sidebar items) + policy admin bar
    initDeptNav(dept);
    setTimeout(() => initPolicyAdmin(), 500);

    // Auto-fill today's date
    const today = new Date().toISOString().split('T')[0];
    const todayField = document.getElementById('f_todayDate');
    if (todayField) todayField.value = today;

    // Show UI
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('ctLayout').style.display = 'grid';
  }

  init();

  // Auto-refresh KPI data from Google Sheet every 5 minutes
  // forceRefresh=true appends cache-bust timestamp â€” guarantees fresh data, never stale CDN cache
  setInterval(() => {
    if (document.getElementById('panel-kpi') && document.getElementById('panel-kpi').classList.contains('active')) {
      fetchAndRebuildKPI(true);
    }
  }, 5 * 60 * 1000);

  // Cycle filter toggle also rebuilds summary counts
  const cycleFilter = document.getElementById('kpiCycleFilter');
  if (cycleFilter) cycleFilter.addEventListener('change', () => {
    buildKPISummary();
    filterKPI();
  });


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CHANGE LOG + NOTIFICATION SYSTEM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let _changeLog = JSON.parse(localStorage.getItem('njtc_change_log') || '[]');
  let _pdfPolicies = JSON.parse(localStorage.getItem('njtc_pdf_policies') || '[]');
  let _liveDocEnabled = localStorage.getItem('njtc_live_doc') !== 'false';

  function logChange(type, action, who, detail) {
    const entry = { type, action, who: who || getDeptLabel(), detail, time: new Date().toISOString() };
    _changeLog.unshift(entry);
    if (_changeLog.length > 200) _changeLog = _changeLog.slice(0, 200);
    try { localStorage.setItem('njtc_change_log', JSON.stringify(_changeLog)); } catch(e) {}
    showChangeNotif(entry);
    broadcastChange(entry);
  }

  function getDeptLabel() {
    const cfg = (typeof DEPT_CONFIG !== 'undefined' && _currentDept) ? DEPT_CONFIG[_currentDept] : null;
    return cfg ? cfg.label : (_currentDept || 'System');
  }

  function showChangeNotif(entry) {
    const el = document.getElementById('changeNotifContainer');
    if (!el) return;
    const icons = { add:'â•', edit:'âœï¸', upload:'ğŸ“', toggle:'ğŸ”„', delete:'ğŸ—‘ï¸', csv:'ğŸ“Š' };
    const div = document.createElement('div');
    div.className = 'change-notif';
    div.innerHTML = `
      <div class="cn-icon">${icons[entry.type]||'ğŸ””'}</div>
      <div class="cn-body">
        <div class="cn-title">${entry.action}</div>
        <div class="cn-sub"><strong>${entry.who}</strong> Â· ${entry.detail||''} Â· ${new Date(entry.time).toLocaleTimeString()}</div>
      </div>
      <button class="cn-close" onclick="this.closest('.change-notif').remove()">âœ•</button>`;
    el.appendChild(div);
    setTimeout(() => { if (div.parentNode) div.remove(); }, 7000);
  }

  function broadcastChange(entry) {
    try {
      const bc = new BroadcastChannel('njtc_portal_changes');
      bc.postMessage(entry);
      bc.close();
    } catch(e) {}
  }

  // Listen for changes from other tabs
  try {
    const bc = new BroadcastChannel('njtc_portal_changes');
    bc.onmessage = (e) => { showChangeNotif({ ...e.data, action: 'ğŸ“¡ ' + e.data.action + ' (other tab)' }); };
  } catch(e) {}

  // â”€â”€ Change Log Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showChangeLog() {
    const existing = document.getElementById('changeLogModal');
    if (existing) { existing.remove(); return; }
    const modal = document.createElement('div');
    modal.id = 'changeLogModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9000;display:flex;align-items:center;justify-content:center;padding:1rem';
    const entries = _changeLog.slice(0, 50);
    const rows = entries.length ? entries.map(e => {
      const dotClass = {add:'cl-add',edit:'cl-edit',upload:'cl-upload',toggle:'cl-toggle',delete:'cl-delete',csv:'cl-add'}[e.type]||'';
      return `<div class="change-log-item">
        <div class="cl-dot ${dotClass}"></div>
        <div class="cl-body">
          <span class="cl-who">${e.who}</span>
          <span class="cl-action"> â€” ${e.action}</span>
          ${e.detail ? `<span class="cl-badge">${e.detail.substring(0,60)}</span>` : ''}
          <div class="cl-time">${new Date(e.time).toLocaleString()}</div>
        </div>
      </div>`;
    }).join('') : '<div style="padding:2rem;text-align:center;color:var(--muted)">No changes recorded yet.</div>';
    modal.innerHTML = `<div style="background:#fff;border-radius:14px;max-width:600px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column">
      <div style="padding:1.25rem 1.5rem;background:var(--navy);color:#fff;display:flex;align-items:center;gap:.75rem;border-radius:14px 14px 0 0">
        <span style="font-size:1.25rem">ğŸ“‹</span>
        <div style="flex:1"><div style="font-weight:700;font-size:1rem">Change Log</div><div style="font-size:.75rem;opacity:.7">All policy and data updates across the portal</div></div>
        <button onclick="document.getElementById('changeLogModal').remove()" style="background:none;border:none;color:#fff;font-size:1.25rem;cursor:pointer">âœ•</button>
      </div>
      <div style="padding:1.25rem 1.5rem;overflow-y:auto;flex:1">${rows}</div>
      <div style="padding:.875rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:.5rem">
        <button class="btn btn-secondary btn-sm" onclick="if(confirm('Clear all change history?')){_changeLog=[];localStorage.removeItem('njtc_change_log');document.getElementById('changeLogModal').remove();}">ğŸ—‘ Clear Log</button>
        <span style="flex:1"></span>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('changeLogModal').remove()">Close</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PDF UPLOAD SYSTEM (Leadership + Data depts only)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TALENT DATA â€” Seeded + Live fetch from Google Sheets CSV
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let CONCERNS = [{"ts": "3/6/2025 15:23:31", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Genesis Troya", "role": "Dual Role", "support_type": "Observation", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Lack of Tutor Observations", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 15:26:44", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Genesis Troya", "role": "Dual Role", "support_type": "Observation", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Tutor Observations", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 15:29:04", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Genesis Troya", "role": "Dual Role", "support_type": "Coaching Support or feedback", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 15:32:27", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Genesis Troya", "role": "Dual Role", "support_type": "Coaching Support or feedback", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 15:35:30", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Genesis Troya", "role": "Dual Role", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Overage of hours on timecards in two back-to-back pay periods", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 15:50:11", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Timothy Winn", "role": "Dual Role", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Keeping up with Tutors' Pearl Attendance", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 16:48:30", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Timothy Winn", "role": "Dual Role", "support_type": "Coaching Support or feedback", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "Yes", "first_time": ""}, {"ts": "3/6/2025 16:53:24", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Manager", "emp": "Timothy Winn", "role": "Dual Role", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Various: Pearl attendance & reminders, Lesson Plan Review", "hr_action": "Yes", "first_time": ""}, {"ts": "3/11/2025 13:54:32", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Dr. Clemons- Program Manager", "emp": "Huda D", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "No", "first_time": "No"}, {"ts": "3/11/2025 14:07:31", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Dr. Clemons-Program Manager", "emp": "Timothy Winn", "role": "Dual Role", "support_type": "Reminder/Verbal Warning", "delivery": "Text Message", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "There has been many conversations regarding coverage being a priority- Tim was aware that he had two tutors out and one tutor leaving at noon. Instead of going to the middle school, he went to the elementary school instead of helping cover any sessions.", "hr_action": "Yes", "first_time": "No"}, {"ts": "3/13/2025 0:52:04", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Dr. Clemons- Program Manager", "emp": "Nicole Cill", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/13/2025 0:52:38", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Dr. Clemons", "emp": "Huda Deweat", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "Yes", "first_time": "No"}, {"ts": "3/14/2025 10:57:22", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Briana Nurse", "emp": "Dylan Aiken", "role": "Tutor", "support_type": "Coaching Support or feedback", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Overall Lesson Delivery", "concern_label": "Overall Lesson Delivery", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:10:38", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, Asst. Program Mgr", "emp": "Sara Gonzalez", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:17:21", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Zahnick Underdue", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:35:32", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Trushti Shah", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:38:39", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Evan White", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:48:16", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Coleen Piontkowskie", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:50:56", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Carlos Jacho", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:52:41", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Norelis Ramirez", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 16:54:10", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "No"}, {"ts": "3/18/2025 16:56:01", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Dylan Aiken", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "No"}, {"ts": "3/18/2025 16:57:10", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Shanice Jackman", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/18/2025 17:56:01", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Dr. Clemons- Program Manager", "emp": "James DeJesus", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "3/20/2025 21:25:41", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Jenny Irwin, APM", "emp": "Eliza Kabashi", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "3/21/2025 9:51:54", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Rene Lintz Program Assistant", "emp": "Durel Freeman", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Regarding the technology, the tablets were deemed unusable, which unfortunately resulted in a lower trade-in value than expected.", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "3/27/2025 13:59:35", "month": "Mar 2025", "yr": 2025, "mo": 3, "submitter": "Dr. Clemons", "emp": "Huda Deweat", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "Yes", "first_time": "No"}, {"ts": "4/21/2025 9:37:39", "month": "Apr 2025", "yr": 2025, "mo": 4, "submitter": "Dr. Clemons", "emp": "Zahnik Underdue", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Text Message", "site": "iLearn Charter Schools", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "4/21/2025 10:09:47", "month": "Apr 2025", "yr": 2025, "mo": 4, "submitter": "Dr. Clemons", "emp": "Brandon (Bergen Middle Tutor)", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Incident on Site", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "4/25/2025 11:21:11", "month": "Apr 2025", "yr": 2025, "mo": 4, "submitter": "Tierney Tittermary/APM", "emp": "Robert Whitman", "role": "Dual Role", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "Gloucester Township SD", "concern_type": "Other (please explain below)", "concern_label": "Incomplete progress reports. Despite four reminders\u2014including emails, text messages, and in-person conversations\u2014one tutor still had not submitted a completed progress report prior to Gloucester's program ending on 4/24", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "4/28/2025 11:00:07", "month": "Apr 2025", "yr": 2025, "mo": 4, "submitter": "Andrea Brooks/PM", "emp": "Robb Whitman", "role": "Dual Role", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "Gloucester Township SD", "concern_type": "Other (please explain below)", "concern_label": "Communication with the Program Management Team", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "4/30/2025 12:53:12", "month": "Apr 2025", "yr": 2025, "mo": 4, "submitter": "JLC", "emp": "Rob Whittman", "role": "Dual Role", "support_type": "Coaching Support or feedback", "delivery": "Email", "site": "Gloucester Township SD", "concern_type": "Other (please explain below)", "concern_label": "Rob was contacted about not adding comments to plans, and while it was done for a while, it was an area of weakness for Rob this school year.", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "4/30/2025 21:42:53", "month": "Apr 2025", "yr": 2025, "mo": 4, "submitter": "Tierney Tittermary", "emp": "Robb Whitman", "role": "Dual Role", "support_type": "Observation", "delivery": "Email", "site": "Gloucester Township SD", "concern_type": "Other (please explain below)", "concern_label": "Other (please explain below)", "hr_action": "Yes", "first_time": "No"}, {"ts": "5/16/2025 14:55:35", "month": "May 2025", "yr": 2025, "mo": 5, "submitter": "Bertin Lefkovic", "emp": "Claudia Barbieri", "role": "Dual Role", "support_type": "Other (please describe below)", "delivery": "Phone", "site": "Gloucester Township SD", "concern_type": "Timecard incident", "concern_label": "Timecard incident", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "5/20/2025 10:44:30", "month": "May 2025", "yr": 2025, "mo": 5, "submitter": "Tierney Tittermary/APM", "emp": "Dylan Sepulveda", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "Hamilton Township SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "No", "first_time": "Yes"}, {"ts": "6/6/2025 12:16:14", "month": "Jun 2025", "yr": 2025, "mo": 6, "submitter": "Andrea Brooks- Program Manager", "emp": "Erica Mela", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "Salem City SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "6/27/2025 10:38:10", "month": "Jun 2025", "yr": 2025, "mo": 6, "submitter": "Tierney Tittermary/APM", "emp": "Tabitha Parris", "role": "Dual Role", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Salem City SD", "concern_type": "Other (please explain below)", "concern_label": "I only became aware that additional Hand2Mind pre-assessments focused on letter recognition, sounds, and phonics were being administered to Kindergarten and first-grade scholars when I came onsite to drop off materials and check on pre-assessment progress.", "hr_action": "No", "first_time": "Yes"}, {"ts": "6/27/2025 10:53:26", "month": "Jun 2025", "yr": 2025, "mo": 6, "submitter": "Tierney Tittermary/APM", "emp": "Katie Hennigan", "role": "Dual Role", "support_type": "Other (please describe below)", "delivery": "Email", "site": "Salem City SD", "concern_type": "Other (please explain below)", "concern_label": "We only became aware of the change Katie made to the oral fluency assessment after I followed up with her on May 13th, requesting that she send scanned copies or photos of the paper-based Grade 3 oral fluency assessments for data collection purposes. In response, she replied with the email mentioned above, stating that she had forgotten to inform us that she had used a different assessment for Grade 3 oral fluency.", "hr_action": "No", "first_time": "Yes"}, {"ts": "7/10/2025 11:59:31", "month": "Jul 2025", "yr": 2025, "mo": 7, "submitter": "Katharine Samberg-Lawrence", "emp": "Queen Beaute", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Global Leadership Academy", "concern_type": "Other (please explain below)", "concern_label": "We had a tutor who had a migraine and was struggling. She has one student. Another tutor had all scholars absent, and I requested she support the tutor with the migraine. The sick tutor soon after requested to go home and I gave her permission. Queen, the tutor who's students were absent, then sent a text stating she had agreed to support, not provide coverage and she did not want to cover the afternoon session. I messaged my supervisors about it for their feedback on how to best address it. \n\nI originally made arrangements for the scholar to work with a tutoring group, so that Queen would not have to cover, then was informed by my supervisor that they were notifying Queen that if she had no scholars and was unwilling to cover the other tutor, she was expected to clock out and go home. My supervisor (Andrea) called Queen to inform her of this, then notified me the conversation did not go well. \n\nQueen then came to request the lesson plans of the absent tutor. I provided her the plans, apologized that I had not been clear that the support could turn into coverage, but also reminder her that at previous meetings I have told all the tutors that if your scholars are absent, come speak to me so I can assign you to support or cover elsewhere as needed. Queen was clearly agitated and mentioned she did not appreciate how the call with Andrea went. I told her that Andrea was at another site assisting with assessments so patience would be greatly appreciated. She then left and pulled the scholar to tutor them without incident.", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "7/11/2025 12:34:21", "month": "Jul 2025", "yr": 2025, "mo": 7, "submitter": "Andrea Brooks, PM", "emp": "Queen Beaute", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Phone", "site": "Global Leadership Academy", "concern_type": "Other (please explain below)", "concern_label": "Queen's unwillingness to cover when a colleague was ill. Overall attitude and unprofessionalism.", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "7/14/2025 8:15:18", "month": "Jul 2025", "yr": 2025, "mo": 7, "submitter": "Tierney Tittermary/ APM", "emp": "Mattelyn Bullock", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "Global Leadership Academy", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "No", "first_time": "Yes"}, {"ts": "7/16/2025 11:42:45", "month": "Jul 2025", "yr": 2025, "mo": 7, "submitter": "Katharine Samberg-Lawrence", "emp": "Katharine Samberg-Lawrence", "role": "Dual Role", "support_type": "Other (please describe below)", "delivery": "Text Message", "site": "Global Leadership Academy", "concern_type": "Other (please explain below)", "concern_label": "This involved an issue between two tutors who share the same tutoring space, Queen (tutor #1) and Mattie (Tutor #2). Today we starting the final assessments for our program. At 9:58 AM Queen sent a text in the group chat which includes all GLAW tutors asking whether or not it was appropriate for tutors to help their scholars with the assessment. She then sent a private message stating that Mattie had with the first assessment, and with the second assessment, was helping her student and it did not seem right. \n\nI responded in the group chat that we could troubleshoot, encourage, and remind students how to start the steps, but we would not assist them in completing any problems. I then responded to Queen thank you for letting me know, and that she did not need to worry about the assessments being compared to see which tutor saw the most improvement as many factors are considered. Queen reiterated that she was worried the scholar would get a higher score than they deserved and this was essentially a lie. I informed her I would talk to Mattie about it to clarify. \n\nI then both texted directly and spoke to Mattie stating that I wanted to make sure she knew she what she could and could not do during the assessments. Mattie was clearly upset, and stated she did not understand why Queen was watching her this way and that it felt like Queen was deliberately looking for things to report. I reiterated not to worry, that I trusted her to know the line between setting her scholar up for a successful completion and assisting them too much, and that Queen may not be aware of the way we use the assessments, so Mattie should not let her opinion bother her. I also offered to move Mattie into the room across the hall for the remainder of the day so she would not feel like she was being observed and reported on. Mattie initially turned me down and returned to her room. \n\nAs short period later, Queen texted that she heard Mattie saying over her headphones that she would \"get back at her\" and was about to become \"unprofessional.\" Queen was surprised at her annoyance as she had not said anything directly to Mattie (though I reminded Queen she texted her question to the entire group). The GLAW staff was not in the room, nor was I, so I cannot confirm what Mattie did or did not say. I requested they give each other space as much as possible and focus on their own scholars and assessments. Queen then texted that she could not give Mattie space in the same room especially as she had \"all but threatened her.\" I asked if Mattie said something directly too her or it was just what she previous overheard (just that), and I offered that Queen could move into the room across the hall. Queen responded that Mattie should have to move because she issued the threat and only had one scholar. I responded stating I would contact my supervisor and then come to rearrange them in different rooms. \n\nI contacted Andrea, informed her of the developments. Andrea encouraged me to have Queen move as she was the one taking issue, but I requested to move Mattie because I believed she would move without incident and would remain professional. I then texted Mattie requesting she move and informed her it was by no means a punishment, and that I had made it clear to my supervisors that she was being professional throughout the exchange from all the behavior I had seen, and her handling of the assessment itself.", "hr_action": "Yes", "first_time": "No"}, {"ts": "8/7/2025 12:40:44", "month": "Aug 2025", "yr": 2025, "mo": 8, "submitter": "Tierney Tittermary/APM", "emp": "Queen Beaute", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "Lawrence Township SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "Yes", "first_time": "No"}, {"ts": "9/18/2025 12:53:33", "month": "Sep 2025", "yr": 2025, "mo": 9, "submitter": "Taneisha Clemons", "emp": "Takiyah Jackson", "role": "Dual Role", "support_type": "Warning/Write Up to Follow", "delivery": "Text Message", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "In addition to missing training this is to document an email thread.", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "9/18/2025 13:42:26", "month": "Sep 2025", "yr": 2025, "mo": 9, "submitter": "Anne Lee", "emp": "Takiyah Jackson", "role": "Dual Role", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "The responses that Takiyah to every single one of my emails seemed confrontational. She has alluded that I held some biases against her and her work ethics. She felt that I gave information about a question that she did not ask and felt that was unnecessary on my part and felt offended and attacked with my response. I responded with an apology for any misunderstandings on my end and explained my responses to her. She emailed back with more accusations and assumptions about my character and her past experiences with dealing with a workforce that has biases. The thread continued to grow and the emails seemed to get more intensive that Taneisha stepped in to mitigate and de-escalate the situation. Takiyah continued to respond in the thread with more emails concerning how needs and her feelings about what transpired in this thread and about her past work history, where she has felt similarly.", "hr_action": "No", "first_time": "Yes"}, {"ts": "10/17/2025 9:30:30", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "T. Clemons-Program Manager", "emp": "James DeJesus", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "10/17/2025 9:40:26", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "T.Clemons", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Ending Session Early, Completing Student Survey on his own (when advised not) incomplete attendance", "hr_action": "Yes", "first_time": "No"}, {"ts": "10/17/2025 9:51:04", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "T.Clemons", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "No"}, {"ts": "10/20/2025 12:12:20", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "Lakeeda Sessoms (Site Leader/Instructional Coach)", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Timeliness of Deliverables", "hr_action": "No", "first_time": "No"}, {"ts": "10/20/2025 12:18:13", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "Lakeeda Sessoms (Site Leader/Instructional Coach)", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Lack of Communication/ Didn't Prep as outlined in our first conversation that took place on October 3, 2025", "hr_action": "No", "first_time": "No"}, {"ts": "10/20/2025 12:25:58", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "Lakeeda Sessoms (Site Leader/ Instructional Coach)", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Tone Concerns", "hr_action": "No", "first_time": "No"}, {"ts": "10/21/2025 19:34:32", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "Dr. T. Clemons / Program Manager", "emp": "D. Singleton", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Late Procedures", "hr_action": "Yes", "first_time": "No"}, {"ts": "10/23/2025 9:26:34", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "T. Clemons/Program Manager", "emp": "James DeJesus", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "No"}, {"ts": "10/23/2025 12:17:52", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "T Clemons Program Manager", "emp": "Michelle Kim", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Email sent to Admin", "hr_action": "Yes", "first_time": "Yes"}, {"ts": "10/23/2025 16:50:35", "month": "Oct 2025", "yr": 2025, "mo": 10, "submitter": "Lakeeda Sessoms (Site Leader/Instructional Coach)", "emp": "Sharon Kessel", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "During my meeting with Silk City\u2019s Leadership Team, they expressed concerns regarding Mrs. Kessel\u2019s professionalism. The team shared that they received a parent complaint in which the parent\u2019s child stated that Mrs. Kessel allegedly said, \u201cShe has more authority over him than his parents because he is in their care,\u201d and also told the student to \u201cact his age and stay in a child\u2019s place.\u201d The parent was reportedly upset by this interaction, and the leadership team was surprised by the comment.\n\nAdditionally, Mrs. Parisi mentioned that after granting Mrs. Kessel permission to lead her small group in another class, Mrs. Kessel made a remark saying, \u201cOh, now you trust me.\u201d Mrs. Parisi noted that this comment \"rubbed her the wrong way.\"\n\nOverall, the leadership team expressed concerns about Mrs. Kessel\u2019s professionalism.", "hr_action": "No", "first_time": "Yes"}, {"ts": "11/11/2025 15:23:40", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Tierney Tittermary/ APM", "emp": "Micaela Wilkerson", "role": "Tutor", "support_type": "Coaching Support or feedback", "delivery": "In Person", "site": "Haddon Township SD", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "11/11/2025 16:05:34", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Tierney Tittermary/ APM", "emp": "Micaela Wilkerson", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Phone", "site": "Haddon Township SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "No", "first_time": "No"}, {"ts": "11/11/2025 16:18:21", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Tierney Tittermary/ APM", "emp": "Micaela Wilkerson", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Text Message", "site": "Haddon Township SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "Yes", "first_time": "No"}, {"ts": "11/12/2025 18:48:21", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Taneisha Clemons- Program Manager", "emp": "Michelle Kim", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Irate email communication to school admin", "hr_action": "No", "first_time": "Yes"}, {"ts": "11/12/2025 18:57:23", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Taneisha Clemons- Program Manager", "emp": "Michelle Kim", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Email Commuication", "hr_action": "Yes", "first_time": "No"}, {"ts": "11/20/2025 15:45:09", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Sharlene Rahim", "emp": "Sharlene Rahim", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Lesson Plans and Behavioral Concerns", "hr_action": "No", "first_time": "Yes"}, {"ts": "11/26/2025 10:17:18", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Ms. Sessoms (Site Leader/Instructional Coach)", "emp": "Disan Singleton", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Please advise how this incident should be classified.", "hr_action": "No", "first_time": "No"}, {"ts": "11/26/2025 11:39:28", "month": "Nov 2025", "yr": 2025, "mo": 11, "submitter": "Ms. Sessoms (Site Leader/Instructional Coach)", "emp": "Sharon Kessle", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Professionalism Concern", "hr_action": "No", "first_time": "No"}, {"ts": "12/3/2025 1:00:53", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Dr. Taneisha Clemons- Program Manager", "emp": "Bryanna Matos", "role": "Tutor", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "No", "first_time": "Yes"}, {"ts": "12/3/2025 10:29:57", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Tierney Tittermary/ APM", "emp": "Laura Gallucci", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "Global Leadership Academy", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "No", "first_time": "Yes"}, {"ts": "12/4/2025 0:08:16", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Taneisha Clemons", "emp": "Kimara Ramsey", "role": "Dual Role", "support_type": "Coaching Support or feedback", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Other (please explain below)", "hr_action": "No", "first_time": "Yes"}, {"ts": "12/4/2025 0:17:27", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Taneisha Clemons", "emp": "Kimara Ramsey", "role": "Dual Role", "support_type": "Warning/Write Up to Follow", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Other (please explain below)", "hr_action": "No", "first_time": "No"}, {"ts": "12/4/2025 18:50:20", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Colleen Elam", "emp": "Shabnam Mustari", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "Central Jersey College Prep", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "First Write Up - Employee Progress Report", "first_time": "Yes"}, {"ts": "12/9/2025 14:47:41", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Andrea Brooks", "emp": "Fasiha Shaikh", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Phone", "site": "Hamilton Township SD", "concern_type": "Other (please explain below)", "concern_label": "Sra Peake, the principal at Kuser, informed me Fasiha has complained to her and the vice principal several times upon receiving her schedule that she does not have enough time in between each tutoring session.  Fasiha has also asked the principal to switch schedules with the other tutor.  Upon hearing this, I spoke with Fasiha on the phone, reminding her she should speak to Marta her site leader with any questions or concerns, and that Marta is her first line of defense.  If she is unsatisfied with Marta's response then the program management team would be her second line of defense. At no point should she be discussing scheduling concerns with the principal.", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "12/10/2025 9:28:09", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Tierney Tittermary/ APM", "emp": "Fasiha Shaikh", "role": "Tutor", "support_type": "Additional Coaching Support", "delivery": "Email", "site": "Hamilton Township SD", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "12/15/2025 9:11:51", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Tanya Israel-Sainthilaire", "emp": "Sharlene Rahim", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Other (please explain below)", "hr_action": "First Write Up - Employee Progress Report", "first_time": "No"}, {"ts": "12/17/2025 16:24:49", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Marta Reyes-IC/SC", "emp": "Fasihah SHAIKH", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Hamilton Township SD", "concern_type": "Timecard incident", "concern_label": "Timecard incident", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "12/18/2025 17:33:03", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Andrea Brooks- PM", "emp": "Fasiha Shaikh", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Phone", "site": "Hamilton Township SD", "concern_type": "Other (please explain below)", "concern_label": "Fasiha is very unhappy about her schedule and being asked to accurately reflect her work time on her timecard. She began speaking to Lilia in the teacher's lounge with district employees present negatively about Andrea her PM and NJTC. She encouraged Lilia to call and email complaints to Andrea and Jess. She continued to speak loudly and in earshot of district employees despite Lilia asking her to stop talking to her about it.", "hr_action": "Recommended Termination", "first_time": "Yes"}, {"ts": "12/18/2025 20:02:30", "month": "Dec 2025", "yr": 2025, "mo": 12, "submitter": "Tierney Tittermary", "emp": "Fasiha Shaikh", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "Hamilton Township SD", "concern_type": "Timecard incident", "concern_label": "Timecard incident", "hr_action": "On Watch", "first_time": "No"}, {"ts": "1/5/2026 10:55:53", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Marta Reyes SC/IC", "emp": "Fasiha SHAIKH", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Text Message", "site": "Hamilton Township SD", "concern_type": "Other (please explain below)", "concern_label": "Call out protocols", "hr_action": "On Watch", "first_time": "No"}, {"ts": "1/6/2026 10:12:08", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Marta Reyes, IC/SC", "emp": "Fasiha SHAIKH", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Text Message", "site": "Hamilton Township SD", "concern_type": "Other (please explain below)", "concern_label": "Failure to follow call-out protocols", "hr_action": "On Watch", "first_time": "No"}, {"ts": "1/12/2026 16:12:19", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Taneisha Clemons- Program Manager", "emp": "Sharlene Rahim", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Other (please explain below)", "concern_label": "Other (please explain below)", "hr_action": "PGP", "first_time": "No"}, {"ts": "1/14/2026 21:45:13", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Tierney Tittermary (Assistant Program Manager)", "emp": "Angelica Werts", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "First Philadelphia Prep", "concern_type": "Other (please explain below)", "concern_label": "- Communication: She was very difficult to engage, barely responded to questions, and spent much of the time sitting in a corner, not speaking.\n\n- Punctuality and Introduction: She arrived over an hour late and was unwilling to provide her name until Tierney repeatedly asked. Despite this, she made an effort to welcome her and express our appreciation for her help.\n\n- Unprofessional Behavior: She was wearing a jacket with the tags still attached and disappeared twice during the day\u2014once for 15 minutes and once for nearly 30 minutes.\n\n- Incident During Tour: She disappeared while the principal was giving us a tour. Nic (another tutor) eventually found her, but she did not respond when Tierney mentioned we were looking for her. She then began holding her side as if she were injured, though she claimed to be fine when asked. The principal noticed the behavior and professionally offered the use of the elevator.\n\n-Lack of Engagement with Scholars: She also did not engage with scholars at all during the time we were testing them and continued to sit in the corner while everyone else walked around to assist and check in on progress.\n\n-Disengaged in Mid-Discussion: While Tierney was discussing lesson planning and reviewing data, Angelica gathered her belongings and began to leave. This was not abrupt, but it was unexpected, as I was addressing both her and Nic (the other tutor) during the conversation. I stopped her and asked her not to head out yet since we were discussing lesson planning. She appeared confused and said, \u201cOh, I need to stay?\u201d I confirmed that she did, explaining that lesson plans are an important part of her role and something she needs to know how to complete as a tutor.", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/15/2026 13:00:53", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Jessica Kelly, Exec Dir Programs", "emp": "Angelica Werts", "role": "Tutor", "support_type": "Additional Coaching Support", "delivery": "Email", "site": "First Philadelphia Prep", "concern_type": "Other (please explain below)", "concern_label": "In-person interaction on day two of diagnostics", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/20/2026 12:07:18", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Colleen Elam", "emp": "Pooja Tyagi", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "Central Jersey College Prep", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/20/2026 12:09:13", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Colleen Elam (Instructional Coach/Site Leader)", "emp": "Naima Boutria", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "Central Jersey College Prep", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/22/2026 13:29:54", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Lakeeda Sessoms", "emp": "Jeff Wilder", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Paterson Charter Sci & Tech", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/26/2026 15:26:04", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Jenny Irwin, APM", "emp": "Ted Mills", "role": "Sub Tutor", "support_type": "Other (please describe below)", "delivery": "Email", "site": "HOLA Hoboken Charter", "concern_type": "Other (please explain below)", "concern_label": "This was emailed on 1/22/26 from the HoLa ES Principal: \"I would like to share a concern that occurred at the end of the day with the second group at the elementary school. Mr Mills appeared at my office after I had picked up the students and walked them and him to the classroom where he was going to tutor. He asked me if I could redirect him back to the classroom.  I quickly asked him where the students were and he said he left them in the classroom [unsupervised] because he had to step out to get copy paper-the laptops were not used. \n\nWe quickly returned to the classroom, and I explained students are never to be left unsupervised.  Thankfully there was no incident and students were patiently waiting for the tutor to return.  He mentioned he was still getting used to things.  I ask that this substitute not be sent back to HoLa Elementary.\"", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/26/2026 15:53:52", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Tierney Tittermary/ APM", "emp": "Alexandra Cristescu", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "Penns Grove-Carneys Point SD", "concern_type": "Other (please explain below)", "concern_label": "Alex has been repeatedly reaching out to me via text and email when she does not receive answers as quickly as she expects. This concerns lesson plans, i-Ready scholar names, and the Pearl schedule. For instance, on Friday, 1/23, at 4:19 PM, she sent a very lengthy text while I was out of the office. I did not respond at that time due to being away. On Sunday, 1/25, she sent me another lengthy text message at 2:38 PM and simultaneously sent the exact same message via email. Additionally, she is not following proper protocol by copying her site leader or Andrea on her communications and continues to reach out outside of working hours to obtain a response. I replied to her email on Monday, 1/26, during business hours and reminded her of my designated working hours", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "1/29/2026 9:02:05", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Colleen Elam (Instructional Coach/Site Leader)", "emp": "Pooja Tyagi", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Central Jersey College Prep", "concern_type": "Other (please explain below)", "concern_label": "On 1/15/2026 Pooja left the site and went home. When I spoke with her over the phone, she explained that she was very upset after getting into an argument with another tutor over a tissue. She explained that Naima yelled at her, and she felt very disrespected. She explained that she was not able to teach, and she had to leave immediately due to her being upset.", "hr_action": "On Watch", "first_time": "No"}, {"ts": "1/30/2026 14:25:36", "month": "Jan 2026", "yr": 2026, "mo": 1, "submitter": "Tierney Tittermary/ APM", "emp": "Nicholas Antoine", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "Email", "site": "First Philadelphia Prep", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/2/2026 11:00:40", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Andrea Brooks/PM", "emp": "Sharmina Ellis", "role": "Dual Role", "support_type": "Observation by PM Team", "delivery": "Email", "site": "Penns Grove-Carneys Point SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/3/2026 22:08:05", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Tierney Tittermary/ APM", "emp": "Nicholas Antoine", "role": "Tutor", "support_type": "Reminder/Verbal Warning", "delivery": "In Person", "site": "First Philadelphia Prep", "concern_type": "Other (please explain below)", "concern_label": "Communication: Nic appears to be struggling with timely communication regarding updates, changes, and email correspondence. When I was on site today at First Philly to support our two new tutors and new site leader, Nic arrived half an hour late. We had reached out to him via email to check on his whereabouts, as he knew both Andrea and I would be on site with new staff. We had discussed this visit with him the day before over Zoom. Knowing Nic uses public transportation, Andrea also mentioned this in her email asking for an update. Nic did not respond via email but informed us in person upon arrival that public transportation had been running extremely late. We reiterated the importance of communicating delays in advance\u2014via phone, text, or email\u2014so we are aware and can ensure everyone\u2019s safety. Andrea also reminded him that she had sent him an email.\n\nLater that same day, Nic informed us that he had been pulling scholars out of the classroom for tutoring into the office space. This was the first we were hearing of this change, and we reminded Nic that the expectation is for scholars to receive tutoring within the classroom, as this is a push-in model. We then confirmed with the principal whether this approach was acceptable given the limited space, and she approved it while offering additional options for the other two tutors to manage space constraints.\n\nWe emphasized to Nic that, as a tutor, he must communicate any changes like this with us beforehand. Decisions affecting tutoring structure or scholar placement cannot be made independently without prior discussion.", "hr_action": "On Watch", "first_time": "No"}, {"ts": "2/4/2026 10:48:48", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Lakeeda Sessoms (Site Leader/Instructional Coach)", "emp": "Maryann Ficker", "role": "Tutor", "support_type": "Observation by PM Team", "delivery": "In Person", "site": "iLearn Charter Schools", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/4/2026 15:10:59", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Chelsea Ostrowski", "emp": "Susan Dominguez", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Phone", "site": "Penns Grove-Carneys Point SD", "concern_type": "Other (please explain below)", "concern_label": "It was a passing incidence but after today's meeting and pondering it; it definitely caused pause and much thought from me. We were having a conversation regarding lesson plans and how overall as a team we need to get them in on time. She questioned if NJTC has ever fired someone for not turning them in on time. I was caught off guard a bit but did state that I do not personally have access to that information and I'm unaware what occurs in other programs. She further asked if it had ever occurred in the programs I was in; I stated that to my knowledge turning in lesson plans on time was not an issue I was made aware of and I only was aware of what I did as a tutor.", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/6/2026 0:50:03", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Tierney Tittermary/APM", "emp": "Victoria Nachimson", "role": "Tutor", "support_type": "Observation by PM Team", "delivery": "In Person", "site": "Penns Grove-Carneys Point SD", "concern_type": "Other (please explain below)", "concern_label": "Vicky is struggling with following directions and completing tasks as requested. She frequently questions instructions and sometimes provides responses that contradict earlier statements. In conversations, she can come across as tense and may not fully consider the perspective of others.", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/12/2026 16:50:53", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Sharmina Ellis-SC/IC", "emp": "Victoria Nachimson", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Penns Grove-Carneys Point SD", "concern_type": "Other (please explain below)", "concern_label": "Victoria has been navigating a season of ebbs and flows since stepping into the Penns Grove Middle School environment, and it is clear that the transition has brought a level of culture shock. While V shows moments of genuine care for scholars and a desire to be helpful, the adjustment to the building\u2019s routines, expectations, and communication norms has been more challenging than anticipated.", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/12/2026 17:18:08", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Sharmina Ellis-SC/IC", "emp": "Victoria Nachimson", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "In Person", "site": "Penns Grove-Carneys Point SD", "concern_type": "Overall Lesson Delivery", "concern_label": "Overall Lesson Delivery", "hr_action": "On Watch", "first_time": "No"}, {"ts": "2/12/2026 17:37:58", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Sharmina Ellis-SC/IC", "emp": "Victoria Nachimson", "role": "Tutor", "support_type": "Additional Coaching Support", "delivery": "In Person", "site": "Penns Grove-Carneys Point SD", "concern_type": "Other (please explain below)", "concern_label": "Vicky shared that, in order to maintain instructional flow and ensure the lesson is delivered, she will at times \u201cfilter out\u201d scholars whose behavior becomes problematic during a tutoring session. She further indicated that, in some cases, she uses the last five to ten minutes of the session to briefly relay the lesson content to the student who was removed or disengaged due to behavior. Vicky stated that the scholar is still marked as having attended the full 30 minute tutoring session, even when the student did not participate for the majority of that instructional time.", "hr_action": "On Watch", "first_time": "No"}, {"ts": "2/18/2026 18:13:37", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Tierney Tittermary", "emp": "Jenny Seligman", "role": "Tutor", "support_type": "Additional Coaching Support", "delivery": "Email", "site": "First Philadelphia Prep", "concern_type": "Lesson Plans", "concern_label": "Lesson Plans", "hr_action": "On Watch", "first_time": "Yes"}, {"ts": "2/18/2026 18:25:41", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Tierney Tittermary", "emp": "Nicholas Antoine", "role": "Tutor", "support_type": "Observation by PM Team", "delivery": "Email", "site": "First Philadelphia Prep", "concern_type": "Other (please explain below)", "concern_label": "Scholars have never logged into Pearl individually using their own scholar accounts.", "hr_action": "On Watch", "first_time": "No"}, {"ts": "2/20/2026 15:20:20", "month": "Feb 2026", "yr": 2026, "mo": 2, "submitter": "Faye Lewis Instructional Coach/Site Coordinator", "emp": "Caela Wilkerson", "role": "Tutor", "support_type": "Other (please describe below)", "delivery": "Phone", "site": "Haddon Township SD", "concern_type": "Attendance", "concern_label": "Attendance", "hr_action": "On Watch", "first_time": "Yes"}];
  let REVIEWS  = [{"ts": "7/17/2025 14:57:14", "month": "July 2025", "pm": "Andrea Brooks", "leader": "Katharine Samberg-Laurence", "site": "Global Leadership Academy", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/5/2026 15:44:14", "month": "January 2026", "pm": "Andrea Brooks", "leader": "Katharine Samberg-Lawrence", "site": "Hamilton Township SD", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/5/2026 10:42:36", "month": "January 2026", "pm": "Andrea Brooks", "leader": "Marta Reyes", "site": "Hamilton Township SD", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/2/2026 16:19:54", "month": "January 2026", "pm": "Dr. Taneisha Clemons", "leader": "Lakeeda Sessoms", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Partially Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "8/18/2025 13:42:49", "month": "July 2025", "pm": "Dr. Taneisha Clemons", "leader": "Dr. Ema", "site": "Belleville Public Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "8/18/2025 14:19:11", "month": "July 2025", "pm": "Dr. Taneisha Clemons", "leader": "Maria Zia", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/2/2026 16:17:18", "month": "November 2025", "pm": "Dr. Taneisha Clemons", "leader": "Nicole O.", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "12/17/2025 13:12:06", "month": "November 2025", "pm": "Dr. Taneisha Clemons", "leader": "Jodi Bianchi", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "8/22/2025 16:16:02", "month": "July 2025", "pm": "Jenny Irwin", "leader": "Alyssa DeAngelis", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "8/22/2025 16:19:44", "month": "July 2025", "pm": "Jenny Irwin", "leader": "Cara DeBonis", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/21/2025 17:32:03", "month": "November 2025", "pm": "Jenny Irwin", "leader": "Colleen Elam", "site": "Central Jersey College Prep", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/9/2026 17:03:23", "month": "January 2026", "pm": "Jenny Irwin", "leader": "Colleen Elam", "site": "Central Jersey College Prep", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/3/2025 11:27:56", "month": "October 2025", "pm": "Jenny Irwin", "leader": "Jodi Bianchi", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/3/2025 11:25:30", "month": "October 2025", "pm": "Jenny Irwin", "leader": "Lakeeda Sessoms", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/24/2025 13:33:09", "month": "November 2025", "pm": "Jenny Irwin", "leader": "Lakeeda Sessoms", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/3/2025 11:18:34", "month": "October 2025", "pm": "Jenny Irwin", "leader": "Leslie Black", "site": "iLearn Charter Schools", "role": "Site Coordinator", "d1": "N/A", "d23": "N/A", "d4": "N/A", "notes": ""}, {"ts": "8/22/2025 16:13:41", "month": "July 2025", "pm": "Jenny Irwin", "leader": "Mike Ettore", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/3/2025 11:22:01", "month": "October 2025", "pm": "Jenny Irwin", "leader": "Nicole Odigie", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/6/2026 12:25:34", "month": "January 2026", "pm": "Jenny Irwin", "leader": "Nicole Odigie", "site": "iLearn Charter Schools", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/6/2026 0:26:04", "month": "February 2026", "pm": "Tierney Tittermary", "leader": "Chelsea Ostrowski", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "10/14/2025 20:10:03", "month": "October 2025", "pm": "Tierney Tittermary", "leader": "Danielle Hallahan", "site": "Global Leadership Academy", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "7/24/2025 17:04:05", "month": "July 2025", "pm": "Tierney Tittermary", "leader": "Kaleigh Mizner", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "11/20/2025 9:31:02", "month": "November 2025", "pm": "Tierney Tittermary", "leader": "Katie Hennigan", "site": "Haddon Township SD", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "7/24/2025 17:01:23", "month": "July 2025", "pm": "Tierney Tittermary", "leader": "Robert Whitman", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "8/4/2025 15:21:14", "month": "August 2025", "pm": "Tierney Tittermary", "leader": "Robert Whitman", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/6/2026 0:29:23", "month": "February 2026", "pm": "Tierney Tittermary", "leader": "Sharmina Ellis", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "2/6/2026 0:28:26", "month": "February 2026", "pm": "Tierney Tittermary", "leader": "Tabitha Parris", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}, {"ts": "7/30/2025 13:54:52", "month": "July 2025", "pm": "Tierney Tittermary", "leader": "Danielle Hallahan", "site": "Boys & Girls Club", "role": "Dual Role SC/IC", "d1": "Meets Expectations", "d23": "Meets Expectations", "d4": "Meets Expectations", "notes": ""}];

  let _talentLoaded  = false;
  let _talentTab     = 'all';
  let _talentYear_selected = 'all';
  let _filteredConcerns = CONCERNS;
  let _talentFilters = {};

  function parseCSVLine(line) {
    const result = []; let cur = ''; let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') { inQ = !inQ; }
      else if (c === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
      else cur += c;
    }
    result.push(cur.trim()); return result;
  }
  function normDistrict(raw) {
    if (!raw) return 'Unknown';
    const l = raw.toLowerCase().trim();
    if (l.includes('ilearn')) return 'iLearn Charter Schools';
    if (l.startsWith('bgc') || l.includes('boys & girls')) return 'Boys & Girls Club';
    if (l.includes('hamilton')) return 'Hamilton Township SD';
    if (l.includes('gloucester')) return 'Gloucester Township SD';
    if (l.includes('penns grove')) return 'Penns Grove-Carneys Point SD';
    if (l.includes('haddon')) return 'Haddon Township SD';
    if (l.includes('salem')) return 'Salem City SD';
    if (l.includes('central jersey')) return 'Central Jersey College Prep';
    if (l.includes('global leadership') || (l.includes('gla') && l.length < 20)) return 'Global Leadership Academy';
    if (l.includes('hoboken') || l.includes('hola')) return 'HOLA Hoboken Charter';
    if (l.includes('first philadelphia')) return 'First Philadelphia Prep';
    if (l.includes('lawrence')) return 'Lawrence Township SD';
    if (l.includes('paterson charter') || l.includes('pcsst')) return 'Paterson Charter Sci & Tech';
    if (l.includes('belleville')) return 'Belleville Public Schools';
    return raw.trim();
  }
  // â”€â”€ Talent live-data status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _talentLiveStatus = 'pending'; // 'live' | 'fallback' | 'pending'

  // Published CSV URL â€” must use pub?output=csv (not /export which requires login)
  // Base URL targets Form Responses tab via gid=274671201
  const TALENT_CSV_GIDS = ['274671201'];
  const TALENT_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvtHFBuZ4GqbRooDaRlxIIq1mqzYyvTGyMaJkRd3eCMniaSY8EZh3p1-g1av2Mi-R0zp8BdFmc_ZMy/pub?output=csv';

  function _parseConcernsCSV(text) {
    const lines = text.split('\n').filter(l => l.trim());
    let hRow = -1;
    for (let i = 0; i < Math.min(5, lines.length); i++) {
      if (lines[i].toLowerCase().includes('timestamp')) { hRow = i; break; }
    }
    if (hRow < 0) return [];
    const fresh = [];
    for (let i = hRow + 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (!cols[0]) continue;
      let dt;
      try { dt = new Date(cols[0].replace(/\"/g,'')); if (isNaN(dt.getTime())) continue; } catch(e) { continue; }
      const cType = (cols[13]||'').trim(), cOther = (cols[14]||'').trim();
      fresh.push({
        ts: cols[0],
        month: dt.toLocaleString('en-US',{month:'short',year:'numeric'}),
        yr: dt.getFullYear(), mo: dt.getMonth()+1,
        submitter:    (cols[2] ||'').trim(),
        emp:          (cols[5] ||'').trim(),
        role:         (cols[6] ||'').trim(),
        support_type: (cols[9] ||'').trim(),
        delivery:     (cols[11]||'').trim(),
        site:         normDistrict(cols[12]),
        concern_type: cType,
        concern_label:(cType==='Other (please explain below)'&&cOther) ? cOther : cType,
        hr_action:    (cols[17]||'').trim(),
        first_time:   (cols[19]||'').trim(),
      });
    }
    return fresh;
  }

  async function fetchLiveConcerns() {
    // Direct export URL: sheet ID + gid=274671201 (Form Responses 1 tab)
    // Same fetch pattern as KPI â€” plain fetch, AbortSignal.timeout, no extra headers
    const cacheBust = (typeof _talentForceRefresh !== 'undefined' && _talentForceRefresh) ? '&t=' + Date.now() : '';
    const url = TALENT_CSV_URL + '&gid=' + TALENT_CSV_GIDS[0] + cacheBust;
    try {
      const res = await fetch(url, { signal: AbortSignal.timeout(10000) });
      if (res.ok) {
        const text = await res.text();
        const fresh = _parseConcernsCSV(text);
        if (fresh.length > 0) {
          CONCERNS = fresh;
          _talentLiveStatus = 'live';
          console.log('[Talent] Live data loaded: ' + fresh.length + ' records');
          return;
        }
      }
    } catch(e) {
      console.warn('[Talent] Fetch failed:', e.message);
    }
    _talentLiveStatus = 'fallback';
    console.warn('[Talent] Using built-in seed data: ' + CONCERNS.length + ' records');
  }

  function countBy(arr, key) {
    const map = {};
    arr.forEach(r => { const v=r[key]||'Unknown'; map[v]=(map[v]||0)+1; });
    return Object.entries(map).sort((a,b)=>b[1]-a[1]);
  }
  function groupBy(arr, key) {
    const map = {};
    arr.forEach(r => { const v=r[key]||'Unknown'; if(!map[v]) map[v]=[]; map[v].push(r); });
    return map;
  }
  function barRows(entries, maxVal, color) {
    return (entries||[]).map(([label,cnt]) =>
      `<div class="ta-bar-row">
        <div class="ta-bar-label" title="${label}">${label.length>32?label.slice(0,30)+'â€¦':label}</div>
        <div class="ta-bar-track"><div class="ta-bar-fill" style="width:${Math.round(cnt/(maxVal||1)*100)}%;background:${color}"></div></div>
        <div class="ta-bar-count">${cnt}</div>
      </div>`).join('');
  }
  function hrActionClass(action) {
    if (!action) return 'concern-no';
    const a = action.toLowerCase();
    if (a.includes('terminat')) return 'concern-term';
    if (a==='pgp') return 'concern-pgp';
    if (a.includes('write up')||a.includes('progress')) return 'concern-writeup';
    if (a==='on watch') return 'concern-watch';
    if (a==='yes') return 'concern-warn';
    return 'concern-no';
  }
  function computeWarnings(data) {
    const total=data.length; if (!total) return [];
    const w=[];
    const iL=data.filter(r=>r.site==='iLearn Charter Schools').length;
    if (iL/total>0.45) w.push({icon:'ğŸ¢',level:'high',title:`iLearn Concentration Risk: ${iL}/${total} (${Math.round(iL/total*100)}%)`,body:'If this partnership is impacted, retention and partner satisfaction KPIs will be significantly affected.'});
    const ec={};data.forEach(r=>{if(r.emp)ec[r.emp]=(ec[r.emp]||0)+1;});
    const r3=Object.entries(ec).filter(([e,c])=>c>=3);
    if (r3.length) w.push({icon:'ğŸ‘¤',level:'medium',title:`${r3.length} employee${r3.length>1?'s':''} with 3+ concerns`,body:r3.sort((a,b)=>b[1]-a[1]).slice(0,3).map(([e,c])=>e+' ('+c+')').join(', ')});
    const esc=data.filter(r=>r.hr_action&&(r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
    if (esc>2) w.push({icon:'âš ï¸',level:'high',title:`${esc} formal HR actions active`,body:'Each write-up or PGP requires documented HR file and follow-up per policy.'});
    const lp=data.filter(r=>r.concern_type==='Lesson Plans').length;
    if (lp/total>0.25) w.push({icon:'ğŸ“‹',level:'medium',title:`Lesson plan compliance: ${lp} concerns (${Math.round(lp/total*100)}%)`,body:'Systemic pattern. Consider T&D refresher or streamlined submission process.'});
    return w;
  }
  function setTalentYear(yr, btn) {
    document.querySelectorAll('#talentYearBar .pst-tab').forEach(b=>b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    _talentYear_selected = yr;
    const countEl=document.getElementById('tyrCount');
    if (countEl) countEl.textContent = yr!=='all' ? CONCERNS.filter(c=>c.yr===Number(yr)).length+' records' : '';
    applyTalentFilters();
  }
  function setTalentTab(tab) {
    document.querySelectorAll('[id^="talentTab-"]').forEach(b=>b.classList.remove('active'));
    const btn=document.getElementById('talentTab-'+tab);
    if (btn) btn.classList.add('active');
    _talentTab=tab; buildTalentContent();
  }
  function renderTalentReviews() {
    const total=REVIEWS.length; if (!total) return '<div style="padding:2rem;text-align:center;color:var(--muted)">No review data.</div>';
    const d1Total=REVIEWS.filter(r=>r.d1.includes('Meets')&&!r.d1.includes('Partial')).length;
    const d23Total=REVIEWS.filter(r=>r.d23.includes('Meets')&&!r.d23.includes('Partial')).length;
    const d4Total=REVIEWS.filter(r=>r.d4.includes('Meets')&&!r.d4.includes('Partial')).length;
    const partial=REVIEWS.filter(r=>r.d23.includes('Partially')||r.d1.includes('Partially')||r.d4.includes('Partially'));
    let html=`<div class="ta-grid ta-grid-4" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi ok"><div class="ta-kpi-val">${total}</div><div class="ta-kpi-sub">Reviews Completed</div></div>
      <div class="ta-card ta-kpi ${d1Total===total?'ok':'warning'}"><div class="ta-kpi-val">${Math.round(d1Total/total*100)}%</div><div class="ta-kpi-sub">Domain 1 â€” Planning</div></div>
      <div class="ta-card ta-kpi ${d23Total>=total*.95?'ok':'warning'}"><div class="ta-kpi-val">${Math.round(d23Total/total*100)}%</div><div class="ta-kpi-sub">Domain 2&3 â€” Instruction</div></div>
      <div class="ta-card ta-kpi ${d4Total===total?'ok':'warning'}"><div class="ta-kpi-val">${Math.round(d4Total/total*100)}%</div><div class="ta-kpi-sub">Domain 4 â€” Professionalism</div></div>
    </div>`;
    if (partial.length) html+=`<div class="ta-alert-strip"><div class="ta-alert-icon">âš ï¸</div><div><div class="ta-alert-title">ğŸŸ¡ ${partial.length} site leader(s) "Partially Meets" â€” coaching needed</div><div class="ta-alert-body">${partial.map(r=>`<strong>${r.leader}</strong> (${r.site}, ${r.month})`).join('; ')}</div></div></div>`;
    html+=`<div class="ta-grid ta-grid-2" style="margin-bottom:1rem">
      <div class="ta-card"><div class="ta-card-title">ğŸ“ Reviews by District</div>${barRows(countBy(REVIEWS,'site').slice(0,8),total,'#2a9d8f')}</div>
      <div class="ta-card"><div class="ta-card-title">ğŸ‘¤ Reviews by PM/APM</div>${barRows(countBy(REVIEWS,'pm').slice(0,8),total,'#457b9d')}</div>
    </div>`;
    html+=`<div class="ta-card"><div class="ta-card-title">ğŸ“‹ Site Leader Review Log</div><div style="overflow-x:auto"><table class="ta-table">
      <thead><tr><th>Leader</th><th>District</th><th>PM</th><th>Month</th><th>D1</th><th>D2&3</th><th>D4</th></tr></thead>
      <tbody>${REVIEWS.map(r=>`<tr>
        <td><strong>${r.leader}</strong></td><td style="font-size:.75rem">${r.site}</td>
        <td style="font-size:.75rem">${r.pm}</td><td style="font-size:.75rem">${r.month}</td>
        ${['d1','d23','d4'].map(dom=>`<td><span class="concern-pill ${r[dom].includes('Partially')?'concern-warn':'concern-no'}" style="font-size:.65rem">${r[dom].replace('Expectations','').trim()}</span></td>`).join('')}
      </tr>`).join('')}</tbody>
    </table></div></div>`;
    return html;
  }
  function renderTalentLog() {
    const data=_filteredConcerns.slice().sort((a,b)=>new Date(b.ts)-new Date(a.ts));
    if (!data.length) return '<div style="padding:3rem;text-align:center;color:var(--muted)">No records match filters.</div>';
    return `<div class="ta-card">
      <div class="ta-card-title">ğŸ“‹ Full Concern Log (${data.length} records)</div>
      <div style="overflow-x:auto"><table class="ta-table">
        <thead><tr><th>Date</th><th>Employee</th><th>Role</th><th>District</th><th>Concern</th><th>Support</th><th>HR Action</th><th>First?</th></tr></thead>
        <tbody>${data.map(r=>`<tr>
          <td style="font-size:.72rem;white-space:nowrap">${r.ts.split(' ')[0]}</td>
          <td><strong style="font-size:.78rem">${r.emp||'â€”'}</strong></td>
          <td><span class="dept-tag dept-tag-prog" style="font-size:.65rem">${r.role||'â€”'}</span></td>
          <td style="font-size:.72rem">${r.site}</td>
          <td style="font-size:.72rem;max-width:140px">${(r.concern_label||r.concern_type||'').substring(0,45)}</td>
          <td style="font-size:.72rem">${r.support_type||'â€”'}</td>
          <td><span class="concern-pill ${hrActionClass(r.hr_action)}" style="font-size:.65rem">${r.hr_action||'â€”'}</span></td>
          <td style="font-size:.72rem">${r.first_time||'â€”'}</td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>`;
  }
  function initTalentFilters() {
    const dSel=document.getElementById('tf_district');
    if (!dSel) return;
    if (dSel.options.length<=1) {
      ["Central Jersey College Prep", "First Philadelphia Prep", "Global Leadership Academy", "Gloucester Township SD", "HOLA Hoboken Charter", "Haddon Township SD", "Hamilton Township SD", "Lawrence Township SD", "Paterson Charter Sci & Tech", "Penns Grove-Carneys Point SD", "Salem City SD", "iLearn Charter Schools"].forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; dSel.appendChild(o); });
      const mSel=document.getElementById('tf_month');
      if (mSel) ["Mar 2025", "Apr 2025", "May 2025", "Jun 2025", "Jul 2025", "Aug 2025", "Sep 2025", "Oct 2025", "Nov 2025", "Dec 2025", "Jan 2026", "Feb 2026"].forEach(m=>{ const o=document.createElement('option'); o.value=o.textContent=m; mSel.appendChild(o); });
      const sSel=document.getElementById('tf_submitter');
      if (sSel) ["Andrea Brooks", "Andrea Brooks, PM", "Andrea Brooks- PM", "Andrea Brooks- Program Manager", "Andrea Brooks/PM", "Anne Lee", "Bertin Lefkovic", "Briana Nurse", "Chelsea Ostrowski", "Colleen Elam", "Colleen Elam (Instructional Coach/Site Leader)", "Dr. Clemons", "Dr. Clemons- Program Manager", "Dr. Clemons-Program Manager", "Dr. T. Clemons / Program Manager", "Dr. Taneisha Clemons- Program Manager", "Faye Lewis Instructional Coach/Site Coordinator", "JLC", "Jenny Irwin, APM", "Jenny Irwin, Asst. Program Manager", "Jenny Irwin, Asst. Program Mgr", "Jessica Kelly, Exec Dir Programs", "Katharine Samberg-Lawrence", "Lakeeda Sessoms", "Lakeeda Sessoms (Site Leader/ Instructional Coach)", "Lakeeda Sessoms (Site Leader/Instructional Coach)", "Marta Reyes SC/IC", "Marta Reyes, IC/SC", "Marta Reyes-IC/SC", "Ms. Sessoms (Site Leader/Instructional Coach)", "Rene Lintz Program Assistant", "Sharlene Rahim", "Sharmina Ellis-SC/IC", "T Clemons Program Manager", "T. Clemons-Program Manager", "T. Clemons/Program Manager", "T.Clemons", "Taneisha Clemons", "Taneisha Clemons- Program Manager", "Tanya Israel-Sainthilaire", "Tierney Tittermary", "Tierney Tittermary (Assistant Program Manager)", "Tierney Tittermary/ APM", "Tierney Tittermary/APM"].filter(s=>s).forEach(s=>{ const o=document.createElement('option'); o.value=o.textContent=s; sSel.appendChild(o); });
      const fb=document.getElementById('talentFilterBar');
      if (fb&&!document.getElementById('tf_employee')) {
        const empSel=document.createElement('select');
        empSel.id='tf_employee'; empSel.className='filter-select'; empSel.style.cssText='flex:1;min-width:140px'; empSel.onchange=applyTalentFilters;
        const allOpt=document.createElement('option'); allOpt.value=''; allOpt.textContent='All Employees'; empSel.appendChild(allOpt);
        ["Alexandra Cristescu", "Angelica Werts", "Brandon (Bergen Middle Tutor)", "Bryanna Matos", "Caela Wilkerson", "Carlos Jacho", "Claudia Barbieri", "Coleen Piontkowskie", "D. Singleton", "Disan Singleton", "Durel Freeman", "Dylan Aiken", "Dylan Sepulveda", "Eliza Kabashi", "Erica Mela", "Evan White", "Fasiha SHAIKH", "Fasiha Shaikh", "Fasihah SHAIKH", "Genesis Troya", "Huda D", "Huda Deweat", "James DeJesus", "Jeff Wilder", "Jenny Seligman", "Katharine Samberg-Lawrence", "Katie Hennigan", "Kimara Ramsey", "Laura Gallucci", "Maryann Ficker", "Mattelyn Bullock", "Micaela Wilkerson", "Michelle Kim", "Naima Boutria", "Nicholas Antoine", "Nicole Cill", "Norelis Ramirez", "Pooja Tyagi", "Queen Beaute", "Rob Whittman", "Robb Whitman", "Robert Whitman", "Sara Gonzalez", "Shabnam Mustari", "Shanice Jackman", "Sharlene Rahim", "Sharmina Ellis", "Sharon Kessel", "Sharon Kessle", "Susan Dominguez", "Tabitha Parris", "Takiyah Jackson", "Ted Mills", "Timothy Winn", "Trushti Shah", "Victoria Nachimson", "Zahnick Underdue", "Zahnik Underdue"].forEach(e=>{ const o=document.createElement('option'); o.value=o.textContent=e; empSel.appendChild(o); });
        const cb=fb.querySelector('button'); if (cb) fb.insertBefore(empSel,cb);
      }
    }
    applyTalentFilters();
  }
  function applyTalentFilters() {
    const g=id=>document.getElementById(id)?.value||'';
    const district=g('tf_district'),role=g('tf_role'),concern=g('tf_concern'),
          month=g('tf_month'),hr=g('tf_hr'),submitter=g('tf_submitter'),employee=g('tf_employee');
    const yr=_talentYear_selected;
    _filteredConcerns=CONCERNS.filter(c=>
      (!district||c.site===district)&&(!role||c.role===role)&&(!concern||c.concern_type===concern)&&
      (!month||c.month===month)&&(!hr||c.hr_action===hr)&&(!submitter||c.submitter===submitter)&&
      (!employee||c.emp===employee)&&(yr==='all'||yr===null||c.yr===Number(yr))
    );
    const hasF=!![district,role,concern,month,hr,submitter,employee].find(v=>v)||(yr!=='all'&&yr!==null);
    const countEl=document.getElementById('tf_count');
    if (countEl) {
      countEl.textContent=hasF?`${_filteredConcerns.length} of ${CONCERNS.length} records`:`${CONCERNS.length} records`;
      countEl.style.color=hasF&&_filteredConcerns.length<CONCERNS.length?'#e76f51':'var(--muted)';
    }
    buildTalentContent();
  }
  function clearTalentFilters() {
    ['tf_district','tf_role','tf_concern','tf_month','tf_hr','tf_submitter','tf_employee'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    _talentYear_selected='all';
    document.querySelectorAll('#talentYearBar .pst-tab').forEach(b=>b.classList.remove('active'));
    const ab=document.getElementById('tyrBtn-all'); if(ab) ab.classList.add('active');
    applyTalentFilters();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const ADMIN_DEPTS = ['leadership', 'data'];

  function initPolicyAdmin() {
    const bar = document.getElementById('policyAdminBar');
    if (!bar) return;
    const isAdmin = ADMIN_DEPTS.includes(_currentDept) || _currentDept === 'leadership' || _currentDept === 'data';
    if (isAdmin) {
      bar.style.display = 'flex';
      document.getElementById('liveDocToggle').checked = _liveDocEnabled;
      document.getElementById('liveDocLabel').textContent = _liveDocEnabled ? 'ON' : 'OFF';
      document.getElementById('liveDocLabel').style.color = _liveDocEnabled ? '#f0a500' : '#6b7280';
      renderPdfUploadList();
    }
  }

  function toggleLiveDoc(enabled) {
    _liveDocEnabled = enabled;
    localStorage.setItem('njtc_live_doc', enabled ? 'true' : 'false');
    document.getElementById('liveDocLabel').textContent = enabled ? 'ON' : 'OFF';
    document.getElementById('liveDocLabel').style.color = enabled ? '#f0a500' : '#6b7280';
    logChange('toggle', enabled ? 'Live document sync ENABLED' : 'Live document sync DISABLED', getDeptLabel(), 'Policies library');
    buildPolicies(true);
  }

  function handlePdfUpload(files) {
    if (!files || !files.length) return;
    Array.from(files).forEach(file => {
      if (!file.name.endsWith('.pdf')) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const entry = {
          id: 'pdf_' + Date.now() + '_' + Math.random().toString(36).slice(2),
          name: file.name.replace('.pdf',''),
          filename: file.name,
          dept: _currentDept || 'shared',
          size: file.size,
          dataUrl: e.target.result,
          uploadedBy: getDeptLabel(),
          uploadedAt: new Date().toISOString(),
        };
        _pdfPolicies.push(entry);
        try { localStorage.setItem('njtc_pdf_policies', JSON.stringify(_pdfPolicies.map(p => ({...p, dataUrl: p.dataUrl.substring(0,100)})))); } catch(ex) {}
        logChange('upload', `PDF uploaded: ${entry.name}`, entry.uploadedBy, entry.filename);
        renderPdfUploadList();
        mergePdfPolicies();
      };
      reader.readAsDataURL(file);
    });
  }

  function removePdfPolicy(id) {
    const entry = _pdfPolicies.find(p => p.id === id);
    if (!entry) return;
    if (!confirm('Remove "' + entry.name + '" from the policies library?')) return;
    _pdfPolicies = _pdfPolicies.filter(p => p.id !== id);
    logChange('delete', `PDF removed: ${entry.name}`, getDeptLabel(), entry.filename);
    renderPdfUploadList();
    mergePdfPolicies();
  }

  function renderPdfUploadList() {
    const el = document.getElementById('pdfUploadList');
    if (!el) return;
    if (!_pdfPolicies.length) { el.innerHTML = ''; return; }
    el.innerHTML = _pdfPolicies.map(p => `
      <div class="pdf-upload-item">
        <span style="font-size:1rem">ğŸ“„</span>
        <span class="pui-name">{p.name}</span>
        <span class="pui-dept">{p.dept.toUpperCase()} Â· Uploaded by {p.uploadedBy} Â· {new Date(p.uploadedAt).toLocaleDateString()}</span>
        <button class="pui-del" onclick="removePdfPolicy('{p.id}')" title="Remove">âœ•</button>
      </div>
    `.replace(/{p\.name}/g, p.name).replace(/{p\.dept\.toUpperCase\(\)}/g, p.dept.toUpperCase())
     .replace(/{p\.uploadedBy}/g, p.uploadedBy).replace(/{new Date\(p\.uploadedAt\)\.toLocaleDateString\(\)}/g, new Date(p.uploadedAt).toLocaleDateString())
     .replace(/{p\.id}/g, p.id)).join('');
  }

  function mergePdfPolicies() {
    // Re-run buildPolicies so PDF additions are merged through the unified pipeline
    // (handles live-doc toggle, Drive manifest docs, and PDF uploads all in one place)
    buildPolicies(false);
  }

  // buildPolicies override removed â€” live-doc toggle logic merged into main buildPolicies function above

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DEPARTMENT-AWARE ANALYTICS ENGINE v3
  //  Rules: hr + programming + leadership + data â†’ full talent panel
  //         finance â†’ partnership/workforce cost risk (aggregated)
  //         training â†’ skills gap / PD needs (aggregated, no names)
  //  Year filter available to all analytics views
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Dept access rules
  const TALENT_FULL_DEPTS  = ['hr','programming','leadership','data'];
  const TALENT_FINANCE_DEPT = ['finance'];
  const TALENT_TRAINING_DEPT = ['training'];

  // Annual goal â†’ department mapping for contextual callouts
  const GOAL_DEPT_MAP = {
    hr:          ['Maintain and continue to build on strong culture'],
    programming: ['Increase Impact on Scholars','Maintain consistent partner experience','Support Growth of New Jersey\'s Educator Pipeline'],
    leadership:  ['Increase the number of fee-for-service partnerships','Continue to pursue large and multi-year sources of funding','Further Diversify board and leverage its support','Maintain cash position','Upgrade systems to support growth','Grow the NJTC brand'],
    finance:     ['Increase the number of fee-for-service partnerships','Continue to pursue large and multi-year sources of funding','Maintain cash position'],
    data:        ['Upgrade systems to support growth','Increase Impact on Scholars'],
    training:    ['Support Growth of New Jersey\'s Educator Pipeline','Maintain and continue to build on strong culture'],
  };

  // â”€â”€ Department nav initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initDeptNav(dept) {
    // Show/hide perf + talent nav based on dept
    const perfBtns   = document.querySelectorAll('.dept-nav-perf');
    const talentBtns = document.querySelectorAll('.dept-nav-talent');
    const label      = document.getElementById('talentNavLabel');

    const showPerf   = TALENT_FULL_DEPTS.includes(dept);
    const showTalent = TALENT_FULL_DEPTS.includes(dept) || TALENT_FINANCE_DEPT.includes(dept) || TALENT_TRAINING_DEPT.includes(dept);

    perfBtns.forEach(b   => b.style.display = showPerf   ? '' : 'none');
    talentBtns.forEach(b => b.style.display = showTalent ? '' : 'none');

    // Rename the talent nav link and panel for finance/training
    if (dept === 'finance') {
      if (label) label.textContent = 'Partnership Risk';
      // Point talent nav to finance analytics panel
      talentBtns.forEach(b => {
        b.setAttribute('data-panel', 'finance-analytics');
        b.setAttribute('onclick', "showPanel('finance-analytics',this)");
        b.onclick = () => showPanel('finance-analytics', b);
      });
    } else if (dept === 'training') {
      if (label) label.textContent = 'Skills Gap Analysis';
      talentBtns.forEach(b => {
        b.setAttribute('data-panel', 'training-analytics');
        b.onclick = () => showPanel('training-analytics', b);
      });
    } else {
      if (label) label.textContent = 'Talent Analytics';
      talentBtns.forEach(b => {
        b.setAttribute('data-panel', 'talent');
        b.onclick = () => showPanel('talent', b);
      });
    }
  }

  // â”€â”€ Year extraction helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getAvailableYears() {
    const years = [...new Set(CONCERNS.map(c => c.yr))].sort((a,b) => b-a);
    if (!years.length) years.push(new Date().getFullYear());
    return years;
  }

  function getSchoolYear(yr) {
    // School year: SY25-26 means Jul 2025 â€“ Jun 2026
    return `SY${String(yr-1).slice(2)}-${String(yr).slice(2)}`;
  }

  function addYearFilter(containerId, filterFn, defaultAll) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const years = getAvailableYears();
    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap';
    wrap.innerHTML = `<span style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em">Year</span>
      <button class="pst-tab active" data-yr="all" onclick="__setYr(this,'all','${containerId}')">All Years</button>
      ${years.map(y => `<button class="pst-tab" data-yr="${y}" onclick="__setYr(this,${y},'${containerId}')">${y} <span style="font-size:.65rem;opacity:.6">${getSchoolYear(y)}</span></button>`).join('')}
      <span id="${containerId}_yrcount" style="font-size:.75rem;color:var(--muted);margin-left:.5rem"></span>`;
    el.prepend(wrap);
    window[`__yrFilter_${containerId}`] = defaultAll ? 'all' : (years[0] || 'all');
    window[`__yrFilterFn_${containerId}`] = filterFn;
  }

  window.__setYr = function(btn, yr, containerId) {
    document.querySelectorAll(`#${containerId} .pst-tab[data-yr]`).forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window[`__yrFilter_${containerId}`] = yr;
    const fn = window[`__yrFilterFn_${containerId}`];
    if (fn) fn(yr === 'all' ? null : Number(yr));
  };

  function filterByYear(data, yr) {
    if (!yr || yr === 'all') return data;
    return data.filter(c => c.yr === Number(yr));
  }

  // â”€â”€ Shared render utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // (countBy, groupBy, barRows, hrActionClass, etc. are already defined above)

  function goalAlignmentBadges(dept) {
    const goals = GOAL_DEPT_MAP[dept] || [];
    if (!goals.length) return '';
    return `<div style="display:flex;gap:.375rem;flex-wrap:wrap;margin-bottom:1.25rem">
      ${goals.map(g => `<span style="font-size:.7rem;font-weight:700;padding:.3rem .7rem;border-radius:20px;background:rgba(240,165,0,.12);color:#92400e;border:1px solid rgba(240,165,0,.3)">ğŸ¯ ${g}</span>`).join('')}
    </div>`;
  }

  function retentionRing(label, current, target, color) {
    const pct = Math.min(100, Math.round(current / target * 100));
    const r = 30, circ = 2 * Math.PI * r;
    const dash = (pct / 100) * circ;
    const status = pct >= 100 ? 'ok' : pct >= 75 ? 'warning' : 'alert';
    return `<div class="ta-card" style="text-align:center;padding:1.25rem .875rem">
      <svg width="80" height="80" style="transform:rotate(-90deg)">
        <circle cx="40" cy="40" r="${r}" fill="none" stroke="#e5e7eb" stroke-width="6"/>
        <circle cx="40" cy="40" r="${r}" fill="none" stroke="${color}" stroke-width="6"
          stroke-dasharray="${dash.toFixed(1)} ${circ.toFixed(1)}" stroke-linecap="round"/>
      </svg>
      <div style="font-size:1.375rem;font-weight:800;color:${color};margin-top:-.25rem">${pct}%</div>
      <div style="font-size:.75rem;font-weight:700;color:var(--navy);margin-top:.2rem">${label}</div>
      <div style="font-size:.7rem;color:var(--muted)">Goal: ${target}%</div>
    </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  HR ANALYTICS â€” Escalation pipeline, risk, action queue
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderHRAnalytics(data) {
    const total      = data.length;
    if (!total) return `<div style="padding:3rem;text-align:center;color:var(--muted)">No records match current filters.</div>`;
    const firstTime  = data.filter(r => r.first_time === 'Yes').length;
    const repeated   = data.filter(r => r.first_time === 'No').length;
    const onWatch    = data.filter(r => r.hr_action === 'On Watch').length;
    const writeup    = data.filter(r => r.hr_action && (r.hr_action.includes('Write Up') || r.hr_action.includes('Progress'))).length;
    const pgp        = data.filter(r => r.hr_action === 'PGP').length;
    const term       = data.filter(r => r.hr_action && r.hr_action.includes('Terminat')).length;
    const noAction   = data.filter(r => r.hr_action === 'No').length;
    const byEmp      = countBy(data, 'emp').filter(([e,c]) => c >= 2 && e);
    const byDistrict = groupBy(data, 'site');

    // Retention goal context
    const coreRet   = 80; // goal
    const onsiteRet = 60; // goal

    let html = `<div style="margin-bottom:1.25rem">
      <div style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.5rem">ğŸ“Œ Annual Goal Alignment</div>
      ${goalAlignmentBadges('hr')}
    </div>`;

    // Retention rings + KPI callout
    html += `<div class="ta-grid ta-grid-4" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi"><div class="ta-kpi-val">${total}</div><div class="ta-kpi-sub">Total Concerns on Record</div></div>
      <div class="ta-card ta-kpi ${repeated/total>0.4?'warning':'ok'}"><div class="ta-kpi-val">${repeated}</div><div class="ta-kpi-sub">Repeat Occurrences (${Math.round(repeated/total*100)}%)</div></div>
      <div class="ta-card ta-kpi ${onWatch>5?'warning':'ok'}"><div class="ta-kpi-val">${onWatch}</div><div class="ta-kpi-sub">On Watch â€” Active Monitoring</div></div>
      <div class="ta-card ta-kpi ${writeup+pgp+term>3?'alert':'warning'}"><div class="ta-kpi-val">${writeup+pgp+term}</div><div class="ta-kpi-sub">Formal HR Actions (W/U, PGP, Term)</div></div>
    </div>`;

    // Retention goal tie-in
    html += `<div class="ta-card" style="margin-bottom:1rem;background:linear-gradient(135deg,#1d3461,#274690);color:#fff">
      <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;opacity:.6;margin-bottom:.875rem">ğŸ¯ Culture Goal: Staff Retention Watchpoints</div>
      <div class="ta-grid ta-grid-3">
        <div style="text-align:center">
          <div style="font-size:2rem;font-weight:800;color:#f0a500">${onWatch}</div>
          <div style="font-size:.8125rem;opacity:.8">Employees On Watch<br><span style="font-size:.7rem;opacity:.6">Retention risk: MEDIUM</span></div>
        </div>
        <div style="text-align:center">
          <div style="font-size:2rem;font-weight:800;color:#e63946">${pgp+writeup}</div>
          <div style="font-size:.8125rem;opacity:.8">Write-Up / PGP Stage<br><span style="font-size:.7rem;opacity:.6">Retention risk: HIGH</span></div>
        </div>
        <div style="text-align:center">
          <div style="font-size:2rem;font-weight:800;color:#a8b8d8">${term}</div>
          <div style="font-size:.8125rem;opacity:.8">Recommended Termination<br><span style="font-size:.7rem;opacity:.6">Separation imminent</span></div>
        </div>
      </div>
      <div style="margin-top:1rem;padding:.75rem;background:rgba(255,255,255,.07);border-radius:8px;font-size:.8125rem;line-height:1.6;opacity:.85">
        âš ï¸ <strong>Goal: 80% core staff retention / 60% onsite staff retention.</strong>
        Each formal HR action (W/U or above) represents a retention risk. ${byEmp.filter(([e,c])=>c>=3).length} employees have 3+ documented concerns â€” these are high-priority cases for joint Program + HR intervention before escalation.
      </div>
    </div>`;

    // Escalation pipeline
    html += `<div class="ta-card" style="margin-bottom:1rem">
      <div class="ta-card-title">ğŸ“Š HR Escalation Pipeline â€” Full Lifecycle View</div>
      <div style="display:flex;gap:2px;border-radius:8px;overflow:hidden;margin-bottom:.75rem">
        ${[['No Action','#d1fae5','#065f46',noAction],['On Watch','#dbeafe','#1e40af',onWatch],['Write-Up','#fef3c7','#92400e',writeup],['PGP','#ede9fe','#5b21b6',pgp],['Terminated','#fee2e2','#991b1b',term]].map(([lbl,bg,col,cnt]) =>
          `<div style="flex:${cnt||0.5};background:${bg};padding:.875rem .5rem;text-align:center;min-width:56px;cursor:default">
            <div style="font-size:1.5rem;font-weight:800;color:${col}">${cnt}</div>
            <div style="font-size:.6875rem;color:${col};font-weight:700">${lbl}</div>
            <div style="font-size:.65rem;color:${col};opacity:.7">${cnt?Math.round(cnt/total*100)+'%':''}</div>
          </div>`).join('<div style="width:2px;background:#fff"></div>')}
      </div>
      <div style="font-size:.8rem;color:var(--muted);line-height:1.5">Pipeline flows left â†’ right. Every case at Write-Up or above should have an active HR file and documented plan. PGP cases require biweekly check-ins per policy.</div>
    </div>`;

    // District HR exposure table
    html += `<div class="ta-card" style="margin-bottom:1rem">
      <div class="ta-card-title">ğŸ“ HR Exposure by District â€” Action Required Summary</div>
      <table class="ta-table">
        <thead><tr><th>District</th><th>Total</th><th>First</th><th>Repeat</th><th>Watch</th><th>Write-Up+</th><th>HR File?</th></tr></thead>
        <tbody>
        ${Object.entries(byDistrict).sort((a,b)=>b[1].length-a[1].length).map(([dist, rows]) => {
          const ft  = rows.filter(r => r.first_time === 'Yes').length;
          const rep = rows.filter(r => r.first_time === 'No').length;
          const w   = rows.filter(r => r.hr_action === 'On Watch').length;
          const f   = rows.filter(r => r.hr_action && (r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
          const needsFile = f > 0 ? '<span style="color:#e63946;font-weight:700">âš ï¸ Yes</span>' : '<span style="color:#2a9d8f;font-size:.75rem">Monitoring</span>';
          return `<tr>
            <td><strong>${dist}</strong></td>
            <td style="font-weight:700">${rows.length}</td>
            <td><span class="concern-pill concern-no">${ft}</span></td>
            <td><span class="concern-pill concern-warn">${rep}</span></td>
            <td><span class="concern-pill concern-watch">${w}</span></td>
            <td><span class="concern-pill ${f>0?'concern-writeup':'concern-no'}">${f}</span></td>
            <td style="font-size:.8125rem">${needsFile}</td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>
    </div>`;

    // Repeat employee action queue
    if (byEmp.length) {
      html += `<div class="ta-card">
        <div class="ta-card-title">ğŸ‘¤ HR Action Queue â€” Employees with 2+ Documented Concerns</div>
        <div style="font-size:.8125rem;color:var(--muted);margin-bottom:.75rem">These employees require active HR monitoring. Entries with Write-Up, PGP, or Termination require formal documentation in their HR file.</div>
        <table class="ta-table">
          <thead><tr><th>Employee</th><th>Role</th><th>District</th><th>Concerns</th><th>Most Recent Support</th><th>HR Status</th><th>Priority</th></tr></thead>
          <tbody>
          ${byEmp.map(([emp,cnt]) => {
            const rows = data.filter(r => r.emp === emp).sort((a,b) => new Date(b.ts)-new Date(a.ts));
            const latest = rows[0];
            const priority = cnt >= 5 ? 'ğŸ”´ Critical' : cnt >= 3 ? 'ğŸŸ¡ High' : 'ğŸŸ¢ Monitor';
            return `<tr>
              <td><strong>${emp}</strong></td>
              <td><span class="dept-tag dept-tag-prog" style="font-size:.65rem">${latest?.role||'â€”'}</span></td>
              <td style="font-size:.75rem">${latest?.site||'â€”'}</td>
              <td style="font-weight:800;color:${cnt>=4?'#e63946':cnt>=3?'#e76f51':'#f0a500'}">${cnt}</td>
              <td style="font-size:.75rem">${latest?.support_type||'â€”'}</td>
              <td><span class="concern-pill ${hrActionClass(latest?.hr_action)}">${latest?.hr_action||'None'}</span></td>
              <td style="font-size:.75rem;font-weight:600">${priority}</td>
            </tr>`;
          }).join('')}
          </tbody>
        </table>
      </div>`;
    }
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PROGRAMMING ANALYTICS â€” Site risk, coaching, partner impact
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderProgrammingAnalytics(data) {
    if (!data.length) return `<div style="padding:3rem;text-align:center;color:var(--muted)">No records match current filters.</div>`;
    const total = data.length;
    const byDistrict = groupBy(data, 'site');

    let html = `${goalAlignmentBadges('programming')}`;

    // Partner experience risk callout
    const highRiskDistricts = Object.entries(byDistrict).filter(([d, rows]) => {
      const esc = rows.filter(r => r.hr_action && (r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
      return esc > 0 || rows.length >= 6;
    });

    if (highRiskDistricts.length) {
      html += `<div class="ta-alert-strip" style="margin-bottom:1.25rem">
        <div class="ta-alert-icon">âš ï¸</div>
        <div><div class="ta-alert-title">ğŸ”´ Partner Satisfaction Risk â€” ${highRiskDistricts.length} District${highRiskDistricts.length>1?'s':''} Flagged</div>
        <div class="ta-alert-body">Goal: 90% partner satisfaction, 50% site retention. Sites with 6+ concerns or escalated HR actions may indicate delivery quality or staff stability issues that could affect partner renewal decisions. Flagged: <strong>${highRiskDistricts.map(([d])=>d).join(', ')}</strong>.</div></div>
      </div>`;
    }

    // KPI cards
    const lpCount   = data.filter(r => r.concern_type === 'Lesson Plans' || (r.concern_label||'').toLowerCase().includes('lesson')).length;
    const attCount  = data.filter(r => r.concern_type === 'Attendance').length;
    const escCount  = data.filter(r => r.hr_action && (r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
    html += `<div class="ta-grid ta-grid-4" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi"><div class="ta-kpi-val">${total}</div><div class="ta-kpi-sub">Total Site Concerns</div></div>
      <div class="ta-card ta-kpi ${lpCount/total>0.3?'warning':'ok'}"><div class="ta-kpi-val">${lpCount}</div><div class="ta-kpi-sub">Lesson Plan Issues (${Math.round(lpCount/total*100)}%)</div></div>
      <div class="ta-card ta-kpi ${attCount>10?'warning':'ok'}"><div class="ta-kpi-val">${attCount}</div><div class="ta-kpi-sub">Attendance Concerns</div></div>
      <div class="ta-card ta-kpi ${escCount>3?'alert':'ok'}"><div class="ta-kpi-val">${escCount}</div><div class="ta-kpi-sub">Escalated (HR Formal Action)</div></div>
    </div>`;

    // District risk cards
    html += `<div class="ta-section-label">ğŸ“ Site-by-Site Risk Assessment</div>
    <div class="ta-grid ta-grid-3" style="margin-bottom:1.25rem">`;
    countBy(data,'site').forEach(([dist, cnt]) => {
      const dRows = byDistrict[dist] || [];
      const esc    = dRows.filter(r => r.hr_action && (r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
      const rep    = dRows.filter(r => r.first_time === 'No').length;
      const lp     = dRows.filter(r => r.concern_type === 'Lesson Plans').length;
      const att    = dRows.filter(r => r.concern_type === 'Attendance').length;
      const risk   = esc > 0 || cnt >= 8 ? 'high' : rep > 2 || cnt >= 4 ? 'med' : 'low';
      const rLabel = risk==='high'?'âš ï¸ Partner Risk':risk==='med'?'ğŸ‘ Monitor':'âœ… Stable';
      html += `<div class="ta-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
          <div style="font-weight:700;font-size:.9375rem;color:var(--navy);flex:1">${dist}</div>
          <span class="risk-chip risk-${risk}">${rLabel}</span>
        </div>
        <div style="font-size:2rem;font-weight:800;color:var(--navy);line-height:1">${cnt}</div>
        <div style="font-size:.75rem;color:var(--muted);margin-bottom:.75rem">${Math.round(cnt/total*100)}% of all concerns</div>
        <div style="display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:.75rem">
          ${esc>0?`<span class="concern-pill concern-writeup">${esc} escalated</span>`:''}
          ${rep>0?`<span class="concern-pill concern-warn">${rep} repeat</span>`:''}
          ${lp>0?`<span class="concern-pill concern-watch">${lp} lesson plans</span>`:''}
          ${att>0?`<span class="concern-pill concern-no">${att} attendance</span>`:''}
        </div>
        ${barRows(countBy(dRows,'concern_label').slice(0,3), cnt, '#457b9d')}
      </div>`;
    });
    html += `</div>`;

    // Site leader reviews cross-reference
    const reviewCount = REVIEWS.length;
    const reviewsByDistrict = groupBy(REVIEWS, 'site');
    html += `<div class="ta-grid ta-grid-2" style="margin-bottom:1rem">
      <div class="ta-card">
        <div class="ta-card-title">ğŸ“‹ Concern Type Distribution</div>
        ${barRows(countBy(data,'concern_type').slice(0,6), total, '#457b9d')}
      </div>
      <div class="ta-card">
        <div class="ta-card-title">â­ Site Leader Review Coverage</div>
        <div style="font-size:.8125rem;color:var(--muted);margin-bottom:.75rem">${reviewCount} site leader reviews completed this cycle</div>
        ${barRows(countBy(REVIEWS,'site').slice(0,6), reviewCount||1, '#2a9d8f')}
        <div style="margin-top:.75rem;padding:.75rem;background:#f0fdf4;border-radius:8px;font-size:.8125rem;color:#065f46">
          âœ… All reviewed site leaders are rated "Meets Expectations" in Domains 1 & 4.
          ${REVIEWS.filter(r=>r.d23.includes('Partially')).length > 0 ?
            `<br>âš ï¸ ${REVIEWS.filter(r=>r.d23.includes('Partially')).length} site leader(s) "Partially Meets" in Domain 2&3 â€” coaching intervention recommended.` : ''}
        </div>
      </div>
    </div>`;

    // Support type â†’ coaching loop
    html += `<div class="ta-card">
      <div class="ta-card-title">ğŸ›  Intervention Type Analysis â€” Coaching Effectiveness Loop</div>
      <div class="ta-grid ta-grid-2">
        <div>${barRows(countBy(data,'support_type').slice(0,6), total, '#e76f51')}</div>
        <div style="font-size:.8125rem;line-height:1.7;padding:.5rem 0;color:var(--text)">
          <strong>Coaching Loop Insight:</strong><br>
          Verbal warnings without follow-up escalation suggest intervention is resolving issues. Sites where the same employee appears in 3+ entries despite coaching signal the need to loop in HR for formal support.<br><br>
          <strong>Partner Satisfaction Connection:</strong><br>
          Lesson plan concerns at 6+ per district should trigger a district-level PM conversation before the next partner check-in â€” these directly affect the 90% satisfaction goal.
        </div>
      </div>
    </div>`;
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  LEADERSHIP ANALYTICS â€” Executive lens, all goals, org health
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderLeadershipAnalytics(data) {
    if (!data.length) return `<div style="padding:3rem;text-align:center;color:var(--muted)">No records for selected period.</div>`;
    const total     = data.length;
    const escalated = data.filter(r => r.hr_action && (r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
    const onWatch   = data.filter(r => r.hr_action === 'On Watch').length;
    const repeated  = data.filter(r => r.first_time === 'No').length;
    const iLearnPct = Math.round((data.filter(r=>r.site==='iLearn Charter Schools').length/total)*100);
    const byDistrict = countBy(data,'site');
    const monthMap  = {};
    data.forEach(r => { monthMap[r.month]=(monthMap[r.month]||0)+1; });
    const monthOrder = Object.keys(monthMap).sort((a,b)=>new Date('01 '+a)-new Date('01 '+b));
    const recent2   = monthOrder.slice(-2);
    const prior2    = monthOrder.slice(-4,-2);
    const recentCnt = data.filter(r=>recent2.includes(r.month)).length;
    const priorCnt  = data.filter(r=>prior2.includes(r.month)).length;
    const trend     = priorCnt > 0 ? Math.round((recentCnt/priorCnt-1)*100) : 0;

    let html = `<div style="margin-bottom:1rem">
      <div style="font-size:.8125rem;color:var(--text);line-height:1.6;padding:.875rem 1.125rem;background:linear-gradient(135deg,#fff7ed,#fef3c7);border:1.5px solid #f59e0b;border-radius:10px">
        <strong>Executive Summary Â· ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}</strong><br>
        ${total} performance concerns documented across ${byDistrict.length} districts.
        ${iLearnPct >= 40 ? `<strong>âš ï¸ iLearn represents ${iLearnPct}% of all concerns â€” portfolio concentration risk for partner retention goal.</strong>` : ''}
        ${trend > 30 ? ` Concern volume is up ${trend}% vs prior 2-month period â€” warrants cross-departmental review.` : trend < -20 ? ` Concern volume is down ${Math.abs(trend)}% vs prior 2-month period â€” positive trajectory.` : ''}
        ${escalated > 3 ? ` ${escalated} formal HR actions are active â€” review with HR Director for succession/retention impact.` : ''}
      </div>
    </div>`;

    // Org health grid
    html += `<div class="ta-grid ta-grid-4" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi ${trend>30?'alert':trend<0?'ok':'warning'}">
        <div class="ta-kpi-val">${trend>0?'+':''}${trend}%</div>
        <div class="ta-kpi-sub">Concern Volume Trend<br><span style="font-size:.7rem">(vs prior 2 months)</span></div>
      </div>
      <div class="ta-card ta-kpi ${escalated>5?'alert':'warning'}">
        <div class="ta-kpi-val">${escalated}</div>
        <div class="ta-kpi-sub">Active Formal HR Actions</div>
      </div>
      <div class="ta-card ta-kpi ${iLearnPct>=50?'alert':iLearnPct>=35?'warning':'ok'}">
        <div class="ta-kpi-val">${iLearnPct}%</div>
        <div class="ta-kpi-sub">Concerns at Single Partner<br><span style="font-size:.7rem">(iLearn Charter Schools)</span></div>
      </div>
      <div class="ta-card ta-kpi ok">
        <div class="ta-kpi-val">${REVIEWS.length}</div>
        <div class="ta-kpi-sub">Site Leader Reviews<br><span style="font-size:.7rem">Completed This Cycle</span></div>
      </div>
    </div>`;

    // Annual goals alignment
    html += `<div class="ta-card" style="margin-bottom:1rem">
      <div class="ta-card-title">ğŸ¯ Annual Goal Alignment â€” Workforce &amp; Partner Health</div>
      <div class="ta-grid ta-grid-3" style="margin-top:.75rem">
        <div style="padding:.75rem;background:#f0fdf4;border-radius:8px">
          <div style="font-weight:700;font-size:.875rem;color:#065f46;margin-bottom:.375rem">Culture â€” Staff Retention</div>
          <div style="font-size:.8125rem;color:#064e3b;line-height:1.6">
            Goal: 80% core / 60% onsite retention.<br>
            <strong>${onWatch + escalated}</strong> employees at Watch/Formal stage = retention risk pool.<br>
            ${onWatch+escalated <= 5 ? 'âœ… Risk pool within manageable range.' : 'âš ï¸ Risk pool elevated â€” flag for board conversation.'}
          </div>
        </div>
        <div style="padding:.75rem;background:#eff6ff;border-radius:8px">
          <div style="font-weight:700;font-size:.875rem;color:#1e40af;margin-bottom:.375rem">Partner Experience</div>
          <div style="font-size:.8125rem;color:#1e3a8a;line-height:1.6">
            Goal: 90% satisfaction, 50% retention.<br>
            ${byDistrict.filter(([d,c])=>c>=6).length} district${byDistrict.filter(([d,c])=>c>=6).length!==1?'s':''} with 6+ concerns.<br>
            ${byDistrict.filter(([d,c])=>c>=6).length === 0 ? 'âœ… No single-partner concern spikes.' : `âš ï¸ ${byDistrict.filter(([d,c])=>c>=6).map(([d])=>d).join(', ')} â€” review with PM team.`}
          </div>
        </div>
        <div style="padding:.75rem;background:#fff7ed;border-radius:8px">
          <div style="font-weight:700;font-size:.875rem;color:#92400e;margin-bottom:.375rem">Educator Pipeline</div>
          <div style="font-size:.8125rem;color:#78350f;line-height:1.6">
            Goal: 40 apprentices, DOL grant secured.<br>
            Dual-role concerns: <strong>${data.filter(r=>r.role==='Dual Role').length}</strong> (site leader tier).<br>
            ${data.filter(r=>r.role==='Dual Role').length <= 5 ? 'âœ… Site leader performance stable.' : 'âš ï¸ Multiple dual-role concerns â€” review SC/IC quality.'}
          </div>
        </div>
      </div>
    </div>`;

    // District portfolio map
    html += `<div class="ta-grid ta-grid-2" style="margin-bottom:1rem">
      <div class="ta-card">
        <div class="ta-card-title">ğŸ“ District Portfolio Risk Map</div>
        ${barRows(byDistrict.slice(0,8), byDistrict[0]?.[1]||1, '#1d3461')}
      </div>
      <div class="ta-card">
        <div class="ta-card-title">ğŸ“ˆ 12-Month Concern Volume Trend</div>
        ${monthOrder.slice(-12).map(m=>`<div class="ta-bar-row">
          <div class="ta-bar-label">${m}</div>
          <div class="ta-bar-track"><div class="ta-bar-fill" style="width:${Math.round((monthMap[m]||0)/Math.max(...Object.values(monthMap))*100)}%;background:${recent2.includes(m)?'#e63946':'#457b9d'}"></div></div>
          <div class="ta-bar-count">${monthMap[m]||0}</div>
        </div>`).join('')}
        <div style="font-size:.75rem;color:var(--muted);margin-top:.5rem">ğŸ”´ = Most recent 2 months</div>
      </div>
    </div>`;

    // Site leader quality summary for leadership
    const partial = REVIEWS.filter(r=>r.d23.includes('Partially')||r.d1.includes('Partially')||r.d4.includes('Partially'));
    html += `<div class="ta-card">
      <div class="ta-card-title">â­ Site Leader Quality â€” Executive Summary</div>
      <div class="ta-grid ta-grid-3" style="margin-top:.75rem">
        ${['d1','d23','d4'].map((domain, i) => {
          const labels = ['Domain 1: Planning & Prep','Domain 2&3: Instruction','Domain 4: Professionalism'];
          const meets = REVIEWS.filter(r=>r[domain].includes('Meets') && !r[domain].includes('Partial')).length;
          const pct = REVIEWS.length ? Math.round(meets/REVIEWS.length*100) : 0;
          return `<div style="text-align:center;padding:.875rem;background:${pct>=90?'#f0fdf4':pct>=70?'#fff7ed':'#fef2f2'};border-radius:8px">
            <div style="font-size:1.75rem;font-weight:800;color:${pct>=90?'#065f46':pct>=70?'#92400e':'#991b1b'}">${pct}%</div>
            <div style="font-size:.75rem;font-weight:700;color:var(--navy)">${labels[i]}</div>
            <div style="font-size:.7rem;color:var(--muted)">${meets} of ${REVIEWS.length} Meets</div>
          </div>`;
        }).join('')}
      </div>
      ${partial.length ? `<div style="margin-top:.75rem;font-size:.8125rem;color:#92400e;padding:.625rem .875rem;background:#fff7ed;border-radius:6px">âš ï¸ ${partial.length} site leader(s) below standard: ${partial.map(r=>r.leader+' ('+r.site+')').join(', ')}</div>` : ''}
    </div>`;
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DATA DEPT ANALYTICS â€” Full analytical, year-over-year, raw
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderDataAnalytics(data) {
    if (!data.length) return `<div style="padding:3rem;text-align:center;color:var(--muted)">No records match current filters.</div>`;
    const total = data.length;
    const byDistrict = countBy(data, 'site');
    const byConcern  = countBy(data, 'concern_type');
    const byRole     = countBy(data, 'role');
    const byHR       = countBy(data, 'hr_action');
    const byMonth    = {};
    data.forEach(r => { byMonth[r.month]=(byMonth[r.month]||0)+1; });
    const months = Object.keys(byMonth).sort((a,b)=>new Date('01 '+a)-new Date('01 '+b));

    let html = `${goalAlignmentBadges('data')}
    <div class="ta-grid ta-grid-4" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi"><div class="ta-kpi-val">${total}</div><div class="ta-kpi-sub">Total Records</div></div>
      <div class="ta-card ta-kpi"><div class="ta-kpi-val">${[...new Set(data.map(r=>r.site))].length}</div><div class="ta-kpi-sub">Unique Districts</div></div>
      <div class="ta-card ta-kpi"><div class="ta-kpi-val">${[...new Set(data.map(r=>r.emp).filter(Boolean))].length}</div><div class="ta-kpi-sub">Unique Employees</div></div>
      <div class="ta-card ta-kpi"><div class="ta-kpi-val">${[...new Set(data.map(r=>r.month))].length}</div><div class="ta-kpi-sub">Months of Data</div></div>
    </div>`;

    html += `<div class="ta-grid ta-grid-2" style="margin-bottom:1rem">
      <div class="ta-card"><div class="ta-card-title">ğŸ“ District Distribution (${byDistrict.length} sites)</div>${barRows(byDistrict, byDistrict[0]?.[1]||1,'#7b2d8b')}</div>
      <div class="ta-card"><div class="ta-card-title">ğŸ“… Monthly Volume (${months.length} months)</div>
        ${months.map(m=>`<div class="ta-bar-row">
          <div class="ta-bar-label">${m}</div>
          <div class="ta-bar-track"><div class="ta-bar-fill" style="width:${Math.round((byMonth[m]||0)/Math.max(...Object.values(byMonth))*100)}%;background:#7b2d8b"></div></div>
          <div class="ta-bar-count">${byMonth[m]}</div>
        </div>`).join('')}
      </div>
    </div>
    <div class="ta-grid ta-grid-2" style="margin-bottom:1rem">
      <div class="ta-card"><div class="ta-card-title">ğŸ” Concern Type Breakdown</div>${barRows(byConcern, byConcern[0]?.[1]||1,'#457b9d')}</div>
      <div class="ta-card">
        <div class="ta-card-title">ğŸ“‹ HR Action Distribution</div>${barRows(byHR, byHR[0]?.[1]||1,'#2a9d8f')}
        <div class="ta-card-title" style="margin-top:1rem">ğŸ‘¥ Role Breakdown</div>${barRows(byRole, byRole[0]?.[1]||1,'#e76f51')}
      </div>
    </div>`;

    // Full raw log for D&E
    html += `<div class="ta-card">
      <div class="ta-card-title">ğŸ“Š Complete Analytical Record (${total} rows)</div>
      <div style="overflow-x:auto">
      <table class="ta-table">
        <thead><tr><th>Date</th><th>Employee</th><th>Role</th><th>District</th><th>Concern Category</th><th>Support Type</th><th>HR Action</th><th>First Time</th><th>Submitter</th></tr></thead>
        <tbody>
        ${data.slice(0,100).map(r=>`<tr>
          <td style="font-size:.72rem;white-space:nowrap">${r.ts.split(' ')[0]}</td>
          <td style="font-size:.78rem"><strong>${r.emp||'â€”'}</strong></td>
          <td><span class="dept-tag dept-tag-prog" style="font-size:.65rem">${r.role||'â€”'}</span></td>
          <td style="font-size:.72rem">${r.site}</td>
          <td style="font-size:.72rem;max-width:130px">${(r.concern_label||r.concern_type||'').substring(0,45)}</td>
          <td style="font-size:.72rem">${r.support_type||'â€”'}</td>
          <td><span class="concern-pill ${hrActionClass(r.hr_action)}" style="font-size:.65rem">${r.hr_action||'â€”'}</span></td>
          <td style="font-size:.72rem">${r.first_time||'â€”'}</td>
          <td style="font-size:.7rem;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${(r.submitter||'â€”').split(',')[0]}</td>
        </tr>`).join('')}
        </tbody>
      </table>
      ${total > 100 ? `<div style="padding:.75rem;font-size:.8rem;color:var(--muted);text-align:center">Showing first 100 of ${total} records. Use filters to narrow.</div>` : ''}
      </div>
    </div>`;
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  FINANCE ANALYTICS â€” Partnership risk, workforce cost model
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderFinanceAnalytics() {
    const data = CONCERNS;
    const years = getAvailableYears();
    const yr = window.__yrFilter_financeAnalyticsContent || 'all';
    const filtered = yr === 'all' ? data : filterByYear(data, yr);
    if (!filtered.length) return `<div style="padding:3rem;text-align:center;color:var(--muted)">No workforce data for selected period.</div>`;

    const total = filtered.length;
    const byDistrict = countBy(filtered, 'site');
    const escalated  = filtered.filter(r => r.hr_action && (r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
    const onWatch    = filtered.filter(r => r.hr_action === 'On Watch').length;
    const highRisk   = byDistrict.filter(([d,c]) => c >= 6).length;

    let html = `${goalAlignmentBadges('finance')}
    <div style="font-size:.8125rem;color:var(--muted);margin-bottom:1.25rem;padding:.75rem 1rem;background:var(--surface);border-radius:8px;border:1px solid var(--border)">
      â„¹ï¸ Finance view shows <strong>aggregated workforce stability metrics only</strong> â€” no individual employee data. This view supports fee-for-service partner retention modeling and turnover cost risk assessment.
    </div>`;

    html += `<div class="ta-grid ta-grid-4" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi ${highRisk>=3?'alert':highRisk>=1?'warning':'ok'}">
        <div class="ta-kpi-val">${highRisk}</div><div class="ta-kpi-sub">High-Concern Districts<br><span style="font-size:.7rem">(6+ concern flags)</span></div>
      </div>
      <div class="ta-card ta-kpi ${onWatch>5?'warning':'ok'}">
        <div class="ta-kpi-val">${onWatch}</div><div class="ta-kpi-sub">Employees On Watch<br><span style="font-size:.7rem">(turnover risk)</span></div>
      </div>
      <div class="ta-card ta-kpi ${escalated>3?'alert':'warning'}">
        <div class="ta-kpi-val">${escalated}</div><div class="ta-kpi-sub">Formal HR Actions<br><span style="font-size:.7rem">(separation risk)</span></div>
      </div>
      <div class="ta-card ta-kpi ok">
        <div class="ta-kpi-val">${byDistrict.length}</div><div class="ta-kpi-sub">Active Partner Districts<br><span style="font-size:.7rem">(concern on record)</span></div>
      </div>
    </div>`;

    // Partner retention risk by district (aggregated)
    html += `<div class="ta-card" style="margin-bottom:1rem">
      <div class="ta-card-title">ğŸ¢ Partner Portfolio â€” Workforce Stability Index</div>
      <div style="font-size:.8125rem;color:var(--muted);margin-bottom:.875rem">Districts ordered by concern volume. High concern volume + escalated HR actions = elevated risk of service delivery disruption, which directly impacts fee-for-service renewal probability.</div>
      <table class="ta-table">
        <thead><tr><th>District / Partner</th><th>Concern Volume</th><th>Stability Risk</th><th>Escalated</th><th>Fee-for-Service Impact</th></tr></thead>
        <tbody>
        ${byDistrict.map(([dist, cnt]) => {
          const dRows = filtered.filter(r=>r.site===dist);
          const esc   = dRows.filter(r=>r.hr_action&&(r.hr_action.includes('Write Up')||r.hr_action==='PGP'||r.hr_action.includes('Terminat'))).length;
          const risk  = esc>0||cnt>=8?'High':'med'===(cnt>=4?'med':'low')?'Moderate':'Low';
          const rColor= risk==='High'?'#e63946':risk==='Moderate'?'#e76f51':'#2a9d8f';
          const impact= risk==='High'?'âš ï¸ Renewal review recommended':risk==='Moderate'?'ğŸ‘ Monitor service quality':'âœ… Stable';
          return `<tr>
            <td><strong>${dist}</strong></td>
            <td style="font-weight:700">${cnt}</td>
            <td><span style="font-weight:700;color:${rColor}">${risk}</span></td>
            <td><span class="concern-pill ${esc>0?'concern-writeup':'concern-no'}">${esc}</span></td>
            <td style="font-size:.8rem">${impact}</td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>
    </div>`;

    // Goal alignment
    html += `<div class="ta-card">
      <div class="ta-card-title">ğŸ¯ Goal Alignment â€” Fee-for-Service &amp; Funding Risk Signals</div>
      <div class="ta-grid ta-grid-3" style="margin-top:.75rem">
        <div style="padding:.875rem;background:#f0fdf4;border-radius:8px">
          <div style="font-weight:700;color:#065f46;margin-bottom:.375rem">Fee-for-Service Retention</div>
          <div style="font-size:.8125rem;line-height:1.6;color:#064e3b">Goal: 50% partner retention.<br>${highRisk} district${highRisk!==1?'s':''} flagged for delivery risk.<br>${highRisk===0?'âœ… Portfolio stable.':'âš ï¸ Proactive outreach recommended.'}</div>
        </div>
        <div style="padding:.875rem;background:#eff6ff;border-radius:8px">
          <div style="font-weight:700;color:#1e40af;margin-bottom:.375rem">Turnover Cost Risk</div>
          <div style="font-size:.8125rem;line-height:1.6;color:#1e3a8a">~${onWatch+escalated} employees at separation risk.<br>Estimated turnover cost: $${(onWatch*1500+escalated*3500).toLocaleString()} if all separate.<br><span style="font-size:.7rem;opacity:.7">(Estimate: ~$1.5K on-watch, ~$3.5K formal)</span></div>
        </div>
        <div style="padding:.875rem;background:#fff7ed;border-radius:8px">
          <div style="font-weight:700;color:#92400e;margin-bottom:.375rem">Cash Position Impact</div>
          <div style="font-size:.8125rem;line-height:1.6;color:#78350f">Goal: $500K money market.<br>Unplanned turnover at ${escalated} formal cases: potential disruption to site billing continuity.<br>${escalated<=2?'âœ… Minimal risk.':'âš ï¸ Flag for finance review.'}</div>
        </div>
      </div>
    </div>`;
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TRAINING ANALYTICS â€” Skills gap, PD needs (no employee names)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderTrainingAnalytics() {
    const data = CONCERNS;
    const yr = window.__yrFilter_trainingAnalyticsContent || 'all';
    const filtered = yr === 'all' ? data : filterByYear(data, yr);
    if (!filtered.length) return `<div style="padding:3rem;text-align:center;color:var(--muted)">No data for selected period.</div>`;

    const total    = filtered.length;
    const lpCount  = filtered.filter(r => r.concern_type === 'Lesson Plans' || (r.concern_label||'').toLowerCase().includes('lesson')).length;
    const ldCount  = filtered.filter(r => r.concern_type === 'Overall Lesson Delivery').length;
    const attCount = filtered.filter(r => r.concern_type === 'Attendance').length;
    const tcCount  = filtered.filter(r => r.concern_type === 'Timecard incident').length;
    const otherCount = total - lpCount - ldCount - attCount - tcCount;
    const byDistrict = countBy(filtered, 'site');

    // PD need mapping
    const pdMap = [
      { category:'Lesson Planning Compliance', count:lpCount, pct:Math.round(lpCount/total*100), pd:'Lesson Plan Workshop Â· Submission Process Training', urgency: lpCount/total>0.3?'High':'Medium' },
      { category:'Instructional Delivery Quality', count:ldCount, pct:Math.round(ldCount/total*100), pd:'Instructional Coaching Â· Model Lessons Â· Video Analysis', urgency: ldCount>5?'High':'Low' },
      { category:'Attendance & Reliability', count:attCount, pct:Math.round(attCount/total*100), pd:'Expectations Refresher Â· Accountability Systems', urgency: attCount>10?'High':'Medium' },
      { category:'Timecard/Compliance', count:tcCount, pct:Math.round(tcCount/total*100), pd:'Payroll & Timecard Process Training', urgency: tcCount>3?'Medium':'Low' },
      { category:'Other / Site-Specific', count:otherCount, pct:Math.round(otherCount/total*100), pd:'Needs Assessment at Site Level', urgency:'Low' },
    ].filter(r => r.count > 0).sort((a,b)=>b.count-a.count);

    let html = `${goalAlignmentBadges('training')}
    <div style="font-size:.8125rem;color:var(--muted);margin-bottom:1.25rem;padding:.75rem 1rem;background:var(--surface);border-radius:8px;border:1px solid var(--border)">
      â„¹ï¸ Training view shows <strong>aggregated skill gap indicators only</strong> â€” no individual employee names. Use this to plan PD calendar and targeted intervention sessions.
    </div>`;

    html += `<div class="ta-grid ta-grid-3" style="margin-bottom:1.25rem">
      <div class="ta-card ta-kpi ${lpCount/total>0.3?'alert':'warning'}"><div class="ta-kpi-val">${lpCount}</div><div class="ta-kpi-sub">Lesson Plan Gaps<br><span style="font-size:.7rem">(${Math.round(lpCount/total*100)}% of concerns)</span></div></div>
      <div class="ta-card ta-kpi ${ldCount>5?'warning':'ok'}"><div class="ta-kpi-val">${ldCount}</div><div class="ta-kpi-sub">Delivery Quality Issues<br><span style="font-size:.7rem">Instructional coaching needed</span></div></div>
      <div class="ta-card ta-kpi ok"><div class="ta-kpi-val">${REVIEWS.length}</div><div class="ta-kpi-sub">Site Leader Reviews<br><span style="font-size:.7rem">Performance observations</span></div></div>
    </div>`;

    // PD needs table
    html += `<div class="ta-card" style="margin-bottom:1rem">
      <div class="ta-card-title">ğŸ“š PD Needs Map â€” Concern Category â†’ Intervention</div>
      <table class="ta-table">
        <thead><tr><th>Skill Gap Category</th><th>Cases</th><th>% of Total</th><th>Recommended PD Intervention</th><th>Urgency</th></tr></thead>
        <tbody>
        ${pdMap.map(r => {
          const urgColor = r.urgency==='High'?'concern-writeup':r.urgency==='Medium'?'concern-warn':'concern-no';
          return `<tr>
            <td><strong>${r.category}</strong></td>
            <td style="font-weight:700">${r.count}</td>
            <td>
              <div style="display:flex;align-items:center;gap:.5rem">
                <div style="flex:1;height:6px;background:var(--surface);border-radius:3px"><div style="height:100%;width:${r.pct}%;background:#e76f51;border-radius:3px"></div></div>
                <span style="font-size:.8rem;font-weight:700">${r.pct}%</span>
              </div>
            </td>
            <td style="font-size:.8rem">${r.pd}</td>
            <td><span class="concern-pill ${urgColor}">${r.urgency}</span></td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>
    </div>`;

    // District skill gap heatmap (aggregated)
    html += `<div class="ta-card" style="margin-bottom:1rem">
      <div class="ta-card-title">ğŸ—º District Skill Gap Distribution</div>
      <div style="font-size:.8125rem;color:var(--muted);margin-bottom:.75rem">Concern volume by district indicates where targeted PD deployment would have the highest impact. High-volume districts should be prioritized for on-site PD sessions.</div>
      ${barRows(byDistrict.slice(0,8), byDistrict[0]?.[1]||1, '#e76f51')}
    </div>`;

    // Site leader domain analysis
    const partialD23 = REVIEWS.filter(r => r.d23.includes('Partially') || r.d1.includes('Partially') || r.d4.includes('Partially'));
    html += `<div class="ta-card">
      <div class="ta-card-title">â­ Site Leader Competency Signals â€” PD Priority Areas</div>
      <div class="ta-grid ta-grid-3" style="margin-top:.75rem">
        ${['d1','d23','d4'].map((domain, i) => {
          const labels = ['Domain 1\nPlanning & Prep','Domain 2&3\nInstruction & Environment','Domain 4\nProfessionalism'];
          const meets  = REVIEWS.filter(r => r[domain].includes('Meets') && !r[domain].includes('Partial')).length;
          const partial = REVIEWS.filter(r => r[domain].includes('Partially')).length;
          const pct = REVIEWS.length ? Math.round(meets/REVIEWS.length*100) : 0;
          return `<div style="padding:.875rem;background:${pct>=90?'#f0fdf4':pct>=70?'#fff7ed':'#fef2f2'};border-radius:8px;text-align:center">
            <div style="font-size:1.75rem;font-weight:800;color:${pct>=90?'#065f46':pct>=70?'#92400e':'#991b1b'}">${pct}%</div>
            <div style="font-size:.75rem;font-weight:700;white-space:pre-line">${labels[i]}</div>
            ${partial>0?`<div style="font-size:.7rem;color:#92400e;margin-top:.25rem">âš ï¸ ${partial} needs coaching</div>`:'<div style="font-size:.7rem;color:#065f46;margin-top:.25rem">âœ… All meeting standard</div>'}
          </div>`;
        }).join('')}
      </div>
      ${partialD23.length?`<div style="margin-top:.875rem;padding:.75rem;background:#fff7ed;border-radius:8px;font-size:.8125rem;color:#92400e">
        âš ï¸ ${partialD23.length} site leader(s) rated "Partially Meets" in at least one domain. Consider targeted coaching or T&D resource deployment to these sites.
      </div>`:''}
    </div>`;
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TALENT PANEL ROUTER â€” dept-aware tab + render logic
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildTalentContent() {
    const el = document.getElementById('talentContent');
    if (!el) return;
    try {
      const dept = _currentDept || 'hr';
      if (_talentTab === 'all') {
        // Route "All Insights" to dept-specific lens
        if (dept === 'hr')         el.innerHTML = renderHRAnalytics(_filteredConcerns);
        else if (dept === 'programming') el.innerHTML = renderProgrammingAnalytics(_filteredConcerns);
        else if (dept === 'leadership')  el.innerHTML = renderLeadershipAnalytics(_filteredConcerns);
        else if (dept === 'data')        el.innerHTML = renderDataAnalytics(_filteredConcerns);
        else el.innerHTML = renderLeadershipAnalytics(_filteredConcerns); // fallback
      } else if (_talentTab === 'program') el.innerHTML = renderProgrammingAnalytics(_filteredConcerns);
      else if (_talentTab === 'hr')      el.innerHTML = renderHRAnalytics(_filteredConcerns);
      else if (_talentTab === 'reviews') el.innerHTML = renderTalentReviews();
      else if (_talentTab === 'log')     el.innerHTML = renderTalentLog();
    } catch(e) {
      document.getElementById('talentContent').innerHTML = `<div style="padding:2rem;color:var(--muted);text-align:center">Render error: ${e.message}</div>`;
      console.error('Talent dashboard error:', e);
    }
  }

  // Update tab labels and layout based on dept
  function initTalentTabsForDept(dept) {
    const tabBar = document.querySelector('#panel-talent .pst-tab[id="talentTab-all"]')?.parentElement;
    if (!tabBar) return;
    // Update "All Insights" label to be dept-specific
    const allTab = document.getElementById('talentTab-all');
    if (allTab) {
      const labels = {
        hr: 'ğŸ‘” HR Overview',
        programming: 'ğŸ¯ Site Overview',
        leadership: 'â­ Exec Summary',
        data: 'ğŸ“ˆ Full Analytics',
      };
      allTab.textContent = labels[dept] || 'ğŸ“Š Overview';
    }
    // Show/hide tabs based on dept
    const programTab = document.getElementById('talentTab-program');
    const hrTab      = document.getElementById('talentTab-hr');
    const logTab     = document.getElementById('talentTab-log');
    if (dept === 'hr') {
      if (programTab) programTab.style.display = '';
      if (hrTab)      hrTab.style.display = 'none'; // their main view is "all"
      if (logTab)     logTab.style.display = '';
    } else if (dept === 'programming') {
      if (programTab) programTab.style.display = 'none';
      if (hrTab)      hrTab.style.display = '';
      if (logTab)     logTab.style.display = 'none';
    } else if (dept === 'leadership') {
      if (programTab) programTab.style.display = '';
      if (hrTab)      hrTab.style.display = '';
      if (logTab)     logTab.style.display = '';
    } else if (dept === 'data') {
      if (programTab) programTab.style.display = '';
      if (hrTab)      hrTab.style.display = '';
      if (logTab)     logTab.style.display = '';
    }
  }

  // â”€â”€ Finance analytics panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildFinanceAnalytics() {
    const el = document.getElementById('financeAnalyticsContent');
    if (!el) return;
    el.innerHTML = '';
    addYearFilter('financeAnalyticsContent', () => {
      el.querySelectorAll('[data-finance-content]').forEach(e => e.remove());
      const c = document.createElement('div');
      c.setAttribute('data-finance-content','1');
      c.innerHTML = renderFinanceAnalytics();
      el.appendChild(c);
    }, true);
    const c = document.createElement('div');
    c.setAttribute('data-finance-content','1');
    c.innerHTML = renderFinanceAnalytics();
    el.appendChild(c);
  }

  // â”€â”€ Training analytics panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildTrainingAnalytics() {
    const el = document.getElementById('trainingAnalyticsContent');
    if (!el) return;
    el.innerHTML = '';
    addYearFilter('trainingAnalyticsContent', () => {
      el.querySelectorAll('[data-training-content]').forEach(e => e.remove());
      const c = document.createElement('div');
      c.setAttribute('data-training-content','1');
      c.innerHTML = renderTrainingAnalytics();
      el.appendChild(c);
    }, true);
    const c = document.createElement('div');
    c.setAttribute('data-training-content','1');
    c.innerHTML = renderTrainingAnalytics();
    el.appendChild(c);
  }

  // â”€â”€ Override showPanel to trigger dept analytics panels â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const _origShowPanel = typeof showPanel !== 'undefined' ? showPanel : null;
  function showPanel(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
    if (id === 'policies' && typeof fetchOpsManual === 'function') fetchOpsManual(false);
    if (id === 'talent') {
      buildTalentDashboard(false);
      if (!_talentLoaded) setTimeout(() => initTalentFilters(), 800);
    }
    if (id === 'finance-analytics') buildFinanceAnalytics();
    if (id === 'training-analytics') buildTrainingAnalytics();
    if (id === 'kpi-analytics') { buildKPIAnalytics(); }
    const panel = document.getElementById('panel-' + id);
    if (panel) panel.classList.add('active');
    const linkEl = btn || document.querySelector(`[data-panel="${id}"]`);
    if (linkEl) linkEl.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  KPI ANALYTICS DASHBOARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  let _kpiAnalyticsTab = 'overview';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SCORING ENGINE  (live â€” reads directly from KPI_DATA each call)
  //  Met=1.0 | Partial=0.5 | In Progress=0.25 | Pipeline=0.10 | Not Met=0
  //  Risk: â‰¥85% Healthy Â· 65â€“84% Watch Â· 40â€“64% At Risk Â· <40% Critical
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const KPI_PT = { 'Met':1, 'Partially Met':.5, 'In Progress':.25, 'Coming Down the Pipeline':.1, 'Has Not Met':0 };

  function kpiPts(s){ return KPI_PT[s] ?? 0; }

  function riskBucket(pct){
    if(pct >= 85) return { label:'Healthy',  short:'Healthy',  color:'#166534', bg:'#dcfce7', icon:'ğŸŸ¢', tip:'On track â€” keep going!' };
    if(pct >= 65) return { label:'Watch',    short:'Watch',    color:'#92400e', bg:'#fef3c7', icon:'ğŸŸ¡', tip:'Making progress but monitor closely.' };
    if(pct >= 40) return { label:'At Risk',  short:'At Risk',  color:'#9a3412', bg:'#ffedd5', icon:'ğŸŸ ', tip:'Needs attention â€” action recommended.' };
    return               { label:'Critical', short:'Critical', color:'#991b1b', bg:'#fee2e2', icon:'ğŸ”´', tip:'Urgent â€” significant gaps to close.' };
  }

  // Build full analytics object fresh from live KPI_DATA
  function calcKPI(){
    const data = KPI_DATA || [];
    const getS = k => k.midStatus || k.status || 'Unknown';
    let totalPts=0, maxPts=0;
    const counts = { Met:0,'Partially Met':0,'In Progress':0,'Coming Down the Pipeline':0,'Has Not Met':0 };
    const goals = {};

    data.forEach(k => {
      const s = getS(k);
      totalPts += kpiPts(s);
      maxPts++;
      if(counts[s] !== undefined) counts[s]++;
      const g = k.goal || 'Other';
      if(!goals[g]) goals[g] = {pts:0,max:0,counts:{Met:0,'Partially Met':0,'In Progress':0,'Coming Down the Pipeline':0,'Has Not Met':0},items:[]};
      goals[g].pts += kpiPts(s);
      goals[g].max++;
      if(goals[g].counts[s] !== undefined) goals[g].counts[s]++;
      goals[g].items.push(k);
    });

    const score = maxPts ? (totalPts/maxPts*100) : 0;
    const risk  = riskBucket(score);

    Object.entries(goals).forEach(([,g]) => {
      g.score = g.max ? (g.pts/g.max*100) : 0;
      g.risk  = riskBucket(g.score);
    });

    return { data, counts, totalPts, maxPts, score, risk, goals, total: data.length };
  }

  function buildKPIAnalytics(){
    const el = document.getElementById('kpiAnalyticsContent');
    if(!el) return;
    populateKPIMetricDropdown();
    el.innerHTML = renderKPIAnalytics();
  }

  function setKPIAnalyticsTab(tab){
    _kpiAnalyticsTab = tab;
    document.querySelectorAll('.kpia-tab').forEach(t=>t.classList.remove('active'));
    const btn = document.getElementById('kpiaTab-'+tab);
    if(btn) btn.classList.add('active');
    const content = document.getElementById('kpiaTabContent');
    if(content) content.innerHTML = renderKPIAnalyticsTab(tab);
  }

  // â”€â”€ Friendly plain-English headline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function friendlyHeadline(risk, score){
    const s = score.toFixed(0);
    if(risk.label==='Healthy')  return `We're performing well overall â€” ${s}% of our goals are on track.`;
    if(risk.label==='Watch')    return `Solid progress at ${s}%, but a few goal areas need closer attention.`;
    if(risk.label==='At Risk')  return `We're at ${s}% â€” several areas need action before year-end.`;
    return `At ${s}%, we have significant gaps to close. Immediate focus is needed.`;
  }

  // â”€â”€ Plain-English goal summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function friendlyGoalLine(g, name){
    const s = g.score.toFixed(0);
    const c = g.counts;
    const parts = [];
    if(c['Met'])    parts.push(`${c['Met']} completed`);
    if(c['In Progress']) parts.push(`${c['In Progress']} in progress`);
    if(c['Partially Met']) parts.push(`${c['Partially Met']} partially done`);
    if(c['Coming Down the Pipeline']) parts.push(`${c['Coming Down the Pipeline']} not yet started`);
    if(c['Has Not Met']) parts.push(`${c['Has Not Met']} not met`);
    return parts.join(' Â· ');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  MAIN RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderKPIAnalytics(){
    const d = calcKPI();
    if(!d.total){
      return `<div style="padding:3rem;text-align:center;color:var(--muted)">
        <div style="font-size:2.5rem;margin-bottom:1rem">ğŸ“Š</div>
        <div style="font-weight:600;color:var(--navy);margin-bottom:.5rem">No KPI data loaded yet</div>
        <button class="btn btn-secondary" onclick="fetchAndRebuildKPI(true).then(()=>buildKPIAnalytics())">â†º Refresh Data</button>
      </div>`;
    }

    const { counts, score, risk, goals, total, totalPts, maxPts } = d;

    // Quick counts for hero
    const criticalGoals = Object.entries(goals).filter(([,g])=>g.risk.label==='Critical');
    const healthyGoals  = Object.entries(goals).filter(([,g])=>g.risk.label==='Healthy');

    let html = '';

    // â”€â”€ Friendly Summary Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += `
    <div class="kpia-summary-banner" style="background:linear-gradient(135deg,${risk.bg},white);border:2px solid ${risk.color}22;border-radius:16px;padding:1.5rem 1.75rem;margin-bottom:1.5rem;display:flex;gap:1.5rem;align-items:flex-start;flex-wrap:wrap">
      <div style="font-size:2.75rem;line-height:1">${risk.icon}</div>
      <div style="flex:1;min-width:220px">
        <div style="font-size:1.125rem;font-weight:700;color:var(--navy);margin-bottom:.375rem;line-height:1.4">${friendlyHeadline(risk,score)}</div>
        <div style="font-size:.875rem;color:var(--text-2);line-height:1.5">
          Out of <strong>${total} targets</strong> this cycle:
          ${counts['Met']>0?`<strong style="color:#166534">${counts['Met']} fully completed</strong>`:''}${counts['Met']>0&&counts['In Progress']>0?' Â· ':''}${counts['In Progress']>0?`<strong style="color:var(--progress)">${counts['In Progress']} in progress</strong>`:''}${(counts['Met']+counts['In Progress']>0)&&(counts['Partially Met']+counts['Has Not Met'])>0?' Â· ':''}${counts['Partially Met']>0?`<strong style="color:#92400e">${counts['Partially Met']} partially done</strong>`:''}${counts['Has Not Met']>0?` Â· <strong style="color:#991b1b">${counts['Has Not Met']} not yet met</strong>`:''}${counts['Coming Down the Pipeline']>0?` Â· <strong style="color:var(--pipeline)">${counts['Coming Down the Pipeline']} upcoming</strong>`:''}
        </div>
        ${criticalGoals.length ? `<div style="margin-top:.625rem;font-size:.8125rem;background:#fee2e2;color:#991b1b;padding:.375rem .75rem;border-radius:20px;display:inline-block;font-weight:600">
          ğŸ”´ ${criticalGoals.length} goal area${criticalGoals.length>1?'s require':'requires'} urgent attention: ${criticalGoals.map(([name])=>name).join(', ')}
        </div>` : `<div style="margin-top:.625rem;font-size:.8125rem;background:#dcfce7;color:#166534;padding:.375rem .75rem;border-radius:20px;display:inline-block;font-weight:600">âœ… No critical goal areas â€” great work!</div>`}
      </div>
      <div style="text-align:center;background:white;border-radius:12px;padding:1rem 1.25rem;border:1px solid ${risk.color}33;min-width:100px;flex-shrink:0">
        <div style="font-size:2.25rem;font-weight:800;color:${risk.color};font-family:'DM Serif Display',serif;line-height:1">${score.toFixed(0)}%</div>
        <div style="font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:${risk.color};margin-top:.25rem">${risk.label}</div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:.25rem">Weighted Score</div>
      </div>
    </div>`;

    // â”€â”€ What does this score mean? (beginner callout) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += `
    <details class="kpia-explainer" style="margin-bottom:1.25rem;border:1px solid var(--border);border-radius:10px;overflow:hidden">
      <summary style="padding:.875rem 1.125rem;cursor:pointer;font-size:.8125rem;font-weight:600;color:var(--navy);list-style:none;display:flex;justify-content:space-between;align-items:center;background:var(--surface-2)">
        <span>â„¹ï¸ How is this score calculated?</span>
        <span style="color:var(--muted);font-weight:400;font-size:.75rem">Click to expand</span>
      </summary>
      <div style="padding:1rem 1.25rem;font-size:.8125rem;color:var(--text-2);line-height:1.6;background:white">
        <p style="margin:0 0 .625rem">Each target earns points based on its status. Points are added up and divided by the maximum possible to get a <strong>weighted score</strong> â€” a fair measure that accounts for targets still in progress.</p>
        <div style="display:flex;gap:.625rem;flex-wrap:wrap;margin-bottom:.625rem">
          ${[['âœ… Completed (Met)','1.0 pt','#166534','#dcfce7'],['ğŸŸ  Partially Done','0.5 pts','#9a3412','#ffedd5'],['ğŸ”µ In Progress','0.25 pts','var(--progress)','#eff6ff'],['ğŸŸ£ Coming Up','0.10 pts','var(--pipeline)','var(--pipe-bg)'],['ğŸ”´ Not Met','0 pts','#991b1b','#fee2e2']].map(([l,p,c,bg])=>
            `<span style="background:${bg};color:${c};padding:.3rem .6rem;border-radius:6px;font-weight:600;font-size:.75rem;white-space:nowrap">${l} = ${p}</span>`
          ).join('')}
        </div>
        <p style="margin:0">Risk levels: <strong style="color:#166534">ğŸŸ¢ Healthy â‰¥85%</strong> Â· <strong style="color:#92400e">ğŸŸ¡ Watch 65â€“84%</strong> Â· <strong style="color:#9a3412">ğŸŸ  At Risk 40â€“64%</strong> Â· <strong style="color:#991b1b">ğŸ”´ Critical &lt;40%</strong></p>
      </div>
    </details>`;

    // â”€â”€ Tab nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += `<div class="kpia-tabs">
      <button class="kpia-tab active" id="kpiaTab-overview"   onclick="setKPIAnalyticsTab('overview')">ğŸ  At a Glance</button>
      <button class="kpia-tab"        id="kpiaTab-breakdown"  onclick="setKPIAnalyticsTab('breakdown')">ğŸ“Š By Goal Area</button>
      <button class="kpia-tab"        id="kpiaTab-atRisk"     onclick="setKPIAnalyticsTab('atRisk')">âš ï¸ Needs Attention</button>
      <button class="kpia-tab"        id="kpiaTab-pipeline"   onclick="setKPIAnalyticsTab('pipeline')">ğŸŸ£ Coming Up</button>
      <button class="kpia-tab"        id="kpiaTab-scorecard"  onclick="setKPIAnalyticsTab('scorecard')">ğŸ† Full Scorecard</button>
    </div>`;

    html += `<div id="kpiaTabContent">${renderKPIAnalyticsTab('overview')}</div>`;

    html += `<div class="kpia-cta-banner">
      <div class="kpia-cta-icon">ğŸ’¬</div>
      <div class="kpia-cta-body">
        <div class="kpia-cta-title">Questions about a specific goal?</div>
        <div class="kpia-cta-sub">Submit a KPI inquiry to provide context, ask for clarification, or flag something leadership should know.</div>
      </div>
      <button class="kpia-cta-btn" onclick="openKPIInquiry()">âœï¸ Ask a Question</button>
    </div>`;

    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TAB RENDERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderKPIAnalyticsTab(tab){
    const d = calcKPI();
    if(!d.total) return '';
    const { counts, score, risk, goals, total, totalPts, maxPts } = d;
    const getS = k => k.midStatus || k.status || '';

    // â”€â”€ AT A GLANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(tab === 'overview'){
      // Goal area health grid â€” the meat of the overview
      const sortedGoals = Object.entries(goals).sort((a,b)=>b[1].score-a[1].score);

      let html = '';

      // 4 big stat tiles
      html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.875rem;margin-bottom:1.5rem">
        ${[
          { icon:'âœ…', val: counts['Met'], label:'Completed', color:'#166534', bg:'#dcfce7', desc:'Fully achieved' },
          { icon:'ğŸ”µ', val: counts['In Progress'], label:'In Progress', color:'var(--progress)', bg:'#eff6ff', desc:'Actively tracked' },
          { icon:'ğŸŸ ', val: counts['Partially Met']+counts['Has Not Met'], label:'Need Attention', color:'#9a3412', bg:'#ffedd5', desc:'Partial or not met' },
          { icon:'ğŸŸ£', val: counts['Coming Down the Pipeline'], label:'Coming Up', color:'var(--pipeline)', bg:'var(--pipe-bg)', desc:'Planned ahead' },
        ].map(s=>`<div style="background:${s.bg};border-radius:12px;padding:1rem 1.125rem;border:1px solid ${s.color}22">
          <div style="font-size:1.625rem;margin-bottom:.25rem">${s.icon}</div>
          <div style="font-size:1.75rem;font-weight:800;color:${s.color};font-family:'DM Serif Display',serif;line-height:1">${s.val}</div>
          <div style="font-size:.8125rem;font-weight:700;color:var(--navy);margin-top:.25rem">${s.label}</div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:.125rem">${s.desc}</div>
        </div>`).join('')}
      </div>`;

      // Overall progress bar â€” visual + plain English
      html += `<div class="kpia-card" style="margin-bottom:1.25rem">
        <div class="kpia-card-header" style="margin-bottom:.875rem">
          <div class="kpia-card-title">ğŸ“ˆ Overall Progress â€” How Are We Doing?</div>
          <div class="kpia-card-meta">Live from Google Sheet Â· updates automatically when data changes</div>
        </div>
        <div style="display:flex;gap:2px;height:22px;border-radius:11px;overflow:hidden;margin-bottom:.75rem">
          ${counts['Met']               ?`<div style="flex:${counts['Met']};background:#22c55e" title="Completed: ${counts['Met']}"></div>`:''}
          ${counts['In Progress']       ?`<div style="flex:${counts['In Progress']};background:var(--progress)" title="In Progress: ${counts['In Progress']}"></div>`:''}
          ${counts['Partially Met']     ?`<div style="flex:${counts['Partially Met']};background:#f97316" title="Partially Done: ${counts['Partially Met']}"></div>`:''}
          ${counts['Coming Down the Pipeline']?`<div style="flex:${counts['Coming Down the Pipeline']};background:var(--pipeline)" title="Coming Up: ${counts['Coming Down the Pipeline']}"></div>`:''}
          ${counts['Has Not Met']       ?`<div style="flex:${counts['Has Not Met']};background:#ef4444" title="Not Met: ${counts['Has Not Met']}"></div>`:''}
        </div>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;font-size:.75rem">
          ${[['#22c55e','âœ… Completed',counts['Met']],['var(--progress)','ğŸ”µ In Progress',counts['In Progress']],['#f97316','ğŸŸ  Partially Done',counts['Partially Met']],['var(--pipeline)','ğŸŸ£ Coming Up',counts['Coming Down the Pipeline']],['#ef4444','ğŸ”´ Not Met',counts['Has Not Met']]].filter(x=>x[2]>0).map(([c,l,v])=>`
            <span style="display:flex;align-items:center;gap:.3rem">
              <span style="width:10px;height:10px;border-radius:2px;background:${c};display:inline-block;flex-shrink:0"></span>
              <span style="color:var(--text-2)">${l}</span>
              <strong style="color:var(--navy)">${v}</strong>
              <span style="color:var(--muted)">(${Math.round(v/total*100)}%)</span>
            </span>`).join('')}
        </div>
      </div>`;

      // Goal area health â€” simplified cards
      html += `<div class="kpia-card">
        <div class="kpia-card-header" style="margin-bottom:1rem">
          <div class="kpia-card-title">ğŸ—‚ï¸ Goal Areas â€” Health at a Glance</div>
          <div class="kpia-card-meta">Sorted best to lowest Â· Click "By Goal Area" tab for full breakdown</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:.625rem">
          ${sortedGoals.map(([name,g])=>{
            const pct = g.score.toFixed(0);
            return `<div style="display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:10px;border:1px solid ${g.risk.color}22;background:${g.risk.bg}11">
              <span style="font-size:1.125rem;flex-shrink:0" title="${g.risk.tip}">${g.risk.icon}</span>
              <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:baseline;justify-content:space-between;gap:.5rem;flex-wrap:wrap;margin-bottom:.3rem">
                  <span style="font-size:.8125rem;font-weight:700;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px" title="${name}">${name}</span>
                  <span style="font-size:.75rem;color:${g.risk.color};font-weight:700;flex-shrink:0">${pct}% Â· ${g.risk.label}</span>
                </div>
                <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden">
                  <div style="height:100%;width:${Math.min(g.score,100).toFixed(1)}%;background:${g.risk.color};border-radius:3px;transition:width .5s ease"></div>
                </div>
                <div style="font-size:.7rem;color:var(--muted);margin-top:.3rem">${friendlyGoalLine(g,name)}</div>
              </div>
              <span style="background:${g.risk.bg};color:${g.risk.color};font-size:.6875rem;font-weight:700;padding:.2rem .5rem;border-radius:20px;flex-shrink:0;white-space:nowrap">${g.risk.short}</span>
            </div>`;
          }).join('')}
        </div>
      </div>`;

      return html;

    // â”€â”€ BY GOAL AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    } else if(tab === 'breakdown'){
      const sorted = Object.entries(goals).sort((a,b)=>b[1].score-a[1].score);
      let html = `<div style="margin-bottom:1.25rem;padding:.875rem 1rem;background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;font-size:.8125rem;color:#0c4a6e;line-height:1.5">
        ğŸ’¡ <strong>How to read this:</strong> Each goal area has multiple targets. The <strong>score</strong> reflects how close we are to completing all of them â€” higher is better. Green = on track, yellow = watch closely, orange = needs action, red = urgent.
      </div>`;

      sorted.forEach(([name,g])=>{
        const pct = g.score.toFixed(1);
        const c = g.counts;
        const statusBars = [
          {s:'Met',n:c['Met'],color:'#22c55e',icon:'âœ…',label:'Completed'},
          {s:'In Progress',n:c['In Progress'],color:'var(--progress)',icon:'ğŸ”µ',label:'In Progress'},
          {s:'Partially Met',n:c['Partially Met'],color:'#f97316',icon:'ğŸŸ ',label:'Partially Done'},
          {s:'Coming Down the Pipeline',n:c['Coming Down the Pipeline'],color:'var(--pipeline)',icon:'ğŸŸ£',label:'Coming Up'},
          {s:'Has Not Met',n:c['Has Not Met'],color:'#ef4444',icon:'ğŸ”´',label:'Not Met'},
        ].filter(x=>x.n>0);

        html += `<div class="kpia-card" style="margin-bottom:1rem;border-left:4px solid ${g.risk.color}">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:.875rem">
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.25rem">
                <span style="font-size:1rem">${g.risk.icon}</span>
                <span style="font-size:.9375rem;font-weight:700;color:var(--navy)">${name}</span>
                <span style="background:${g.risk.bg};color:${g.risk.color};font-size:.6875rem;font-weight:700;padding:.2rem .5rem;border-radius:20px">${g.risk.label}</span>
              </div>
              <div style="font-size:.8125rem;color:var(--text-2)">${g.risk.tip} Â· ${g.max} targets total</div>
            </div>
            <div style="text-align:right;flex-shrink:0">
              <div style="font-family:'DM Serif Display',serif;font-size:1.75rem;font-weight:700;color:${g.risk.color};line-height:1">${pct}%</div>
              <div style="font-size:.7rem;color:var(--muted)">weighted score</div>
            </div>
          </div>

          <!-- Progress bar -->
          <div style="height:10px;background:var(--border);border-radius:5px;overflow:hidden;margin-bottom:.875rem">
            <div style="height:100%;width:${Math.min(g.score,100).toFixed(1)}%;background:${g.risk.color};border-radius:5px;transition:width .5s ease"></div>
          </div>

          <!-- What makes up this score -->
          <div style="font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem">Target Breakdown</div>
          <div style="display:flex;flex-direction:column;gap:.375rem">
            ${statusBars.map(sb=>`
              <div style="display:flex;align-items:center;gap:.625rem">
                <span style="font-size:.875rem;flex-shrink:0">${sb.icon}</span>
                <span style="font-size:.8125rem;color:var(--text-2);flex:1">${sb.label}</span>
                <span style="font-weight:700;color:${sb.color};font-size:.8125rem;min-width:1.5rem;text-align:right">${sb.n}</span>
                <div style="width:80px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;flex-shrink:0">
                  <div style="height:100%;width:${Math.round(sb.n/g.max*100)}%;background:${sb.color};border-radius:3px"></div>
                </div>
                <span style="font-size:.7rem;color:var(--muted);width:28px;text-align:right">${Math.round(sb.n/g.max*100)}%</span>
              </div>`).join('')}
          </div>

          <!-- Individual targets (expandable) -->
          <details style="margin-top:.875rem">
            <summary style="font-size:.8125rem;color:var(--blue-mid);cursor:pointer;font-weight:600;list-style:none">â–¸ Show all ${g.max} individual targets</summary>
            <div style="margin-top:.625rem;display:flex;flex-direction:column;gap:.375rem">
              ${g.items.map(k=>{
                const s = getS(k);
                const pts = kpiPts(s);
                const stColor = s==='Met'?'#166534':s==='In Progress'?'var(--progress)':s==='Partially Met'?'#9a3412':s==='Coming Down the Pipeline'?'var(--pipeline)':'#991b1b';
                const stBg    = s==='Met'?'#dcfce7':s==='In Progress'?'#eff6ff':s==='Partially Met'?'#ffedd5':s==='Coming Down the Pipeline'?'var(--pipe-bg)':'#fee2e2';
                return `<div style="display:flex;align-items:flex-start;gap:.625rem;padding:.5rem .625rem;border-radius:7px;border:1px solid var(--border);background:var(--surface-2)">
                  <div style="flex:1;font-size:.8125rem;color:var(--navy);line-height:1.4">${k.target}</div>
                  <span style="background:${stBg};color:${stColor};font-size:.6875rem;font-weight:700;padding:.15rem .4rem;border-radius:4px;white-space:nowrap;flex-shrink:0">${s}</span>
                </div>`;
              }).join('')}
            </div>
          </details>
        </div>`;
      });
      return html;

    // â”€â”€ NEEDS ATTENTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    } else if(tab === 'atRisk'){
      const atRiskItems = d.data.filter(k=>['Partially Met','Has Not Met'].includes(getS(k)));

      if(!atRiskItems.length){
        return `<div style="padding:3rem;text-align:center">
          <div style="font-size:2.5rem;margin-bottom:.75rem">ğŸ‰</div>
          <div style="font-size:1rem;font-weight:700;color:var(--navy);margin-bottom:.5rem">No At-Risk Targets Right Now</div>
          <div style="font-size:.875rem;color:var(--muted)">All current targets are Met, In Progress, or planned ahead â€” great work!</div>
        </div>`;
      }

      const notMetN  = atRiskItems.filter(k=>getS(k)==='Has Not Met').length;
      const partialN = atRiskItems.filter(k=>getS(k)==='Partially Met').length;

      let html = `<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:1rem 1.25rem;margin-bottom:1.25rem">
        <div style="font-weight:700;color:#9a3412;margin-bottom:.375rem;font-size:.9375rem">âš ï¸ ${atRiskItems.length} target${atRiskItems.length>1?'s need':'needs'} attention</div>
        <div style="font-size:.8125rem;color:#7c2d12;line-height:1.5">
          ${notMetN>0?`<strong>${notMetN} not yet met</strong> â€” these need immediate focus.`:''} 
          ${partialN>0?`<strong>${partialN} partially completed</strong> â€” on the right track but not there yet.`:''}
          Use the "Ask a Question" button below to flag context or request support from leadership.
        </div>
      </div>`;

      // Group by goal
      const byGoal = {};
      atRiskItems.forEach(k=>{if(!byGoal[k.goal])byGoal[k.goal]=[];byGoal[k.goal].push(k);});

      Object.entries(byGoal).sort((a,b)=>b[1].length-a[1].length).forEach(([gname,items])=>{
        const gd = goals[gname];
        html += `<div class="kpia-card" style="margin-bottom:1rem;border-left:4px solid ${gd?gd.risk.color:'#f97316'}">
          <div class="kpia-card-header" style="margin-bottom:.75rem">
            <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
              <div class="kpia-card-title">${gname}</div>
              ${gd?`<span style="background:${gd.risk.bg};color:${gd.risk.color};font-size:.6875rem;font-weight:700;padding:.2rem .5rem;border-radius:20px">${gd.risk.icon} ${gd.risk.label} Â· ${gd.score.toFixed(0)}%</span>`:''}
            </div>
            <div class="kpia-card-meta">${items.length} target${items.length>1?'s':''} need attention</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.5rem">
            ${items.sort((a,b)=>kpiPts(getS(a))-kpiPts(getS(b))).map(k=>{
              const s = getS(k);
              const isNotMet = s==='Has Not Met';
              const bColor = isNotMet?'#991b1b':'#9a3412';
              const bBg    = isNotMet?'#fee2e2':'#ffedd5';
              return `<div style="display:flex;align-items:flex-start;gap:.75rem;padding:.75rem;border-radius:9px;border:1px solid ${bColor}22;background:${bBg}44">
                <div style="font-size:1.125rem;flex-shrink:0">${isNotMet?'ğŸ”´':'ğŸŸ '}</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:.8125rem;font-weight:600;color:var(--navy);line-height:1.4;margin-bottom:.25rem">${k.target}</div>
                  <div style="font-size:.75rem;color:var(--muted)">Owner: ${k.owner||'Unassigned'}</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.375rem;flex-shrink:0">
                  <span style="background:${bBg};color:${bColor};font-size:.6875rem;font-weight:700;padding:.15rem .4rem;border-radius:4px;white-space:nowrap">${s}</span>
                  <button style="font-size:.7rem;color:var(--blue-mid);background:none;border:1px solid var(--blue-mid);padding:.2rem .5rem;border-radius:4px;cursor:pointer;white-space:nowrap" onclick="openKPIInquiryWithMetric(${JSON.stringify(k.target).replace(/"/g,'&quot;')})">Ask about this â†’</button>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
      return html;

    // â”€â”€ COMING UP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    } else if(tab === 'pipeline'){
      const pipeItems = d.data.filter(k=>getS(k)==='Coming Down the Pipeline');
      if(!pipeItems.length){
        return `<div style="padding:3rem;text-align:center;color:var(--muted)">
          <div style="font-size:2rem;margin-bottom:.75rem">ğŸŸ£</div>
          <div>No upcoming pipeline targets at this time.</div>
        </div>`;
      }

      const byGoal = {};
      pipeItems.forEach(k=>{if(!byGoal[k.goal])byGoal[k.goal]=[];byGoal[k.goal].push(k);});

      let html = `<div style="background:#faf5ff;border:1px solid #d8b4fe;border-radius:12px;padding:1rem 1.25rem;margin-bottom:1.25rem">
        <div style="font-weight:700;color:var(--pipeline);margin-bottom:.375rem;font-size:.9375rem">ğŸŸ£ ${pipeItems.length} targets are planned ahead</div>
        <div style="font-size:.8125rem;color:#6b21a8;line-height:1.5">
          These targets are <strong>intentionally planned</strong> for later in the cycle â€” they haven't started yet, but the intent is documented.
          Each earns <strong>0.10 points</strong> now and will earn full credit when completed.
        </div>
      </div>`;

      Object.entries(byGoal).forEach(([gname,items])=>{
        html += `<div class="kpia-card" style="margin-bottom:1rem;border-left:4px solid var(--pipeline)">
          <div class="kpia-card-header" style="margin-bottom:.75rem">
            <div class="kpia-card-title">ğŸŸ£ ${gname}</div>
            <div class="kpia-card-meta">${items.length} upcoming target${items.length>1?'s':''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.5rem">
            ${items.map(k=>`
              <div style="display:flex;align-items:flex-start;gap:.75rem;padding:.75rem;border-radius:9px;border:1px solid #e9d5ff;background:#faf5ff">
                <div style="font-size:1.125rem;flex-shrink:0">ğŸŸ£</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:.8125rem;font-weight:600;color:var(--navy);line-height:1.4;margin-bottom:.25rem">${k.target}</div>
                  <div style="font-size:.75rem;color:var(--muted)">Owner: ${k.owner||'Unassigned'} Â· Intent confirmed Â· 0.10 pts now</div>
                </div>
                <button style="font-size:.7rem;color:var(--pipeline);background:none;border:1px solid var(--pipeline);padding:.2rem .5rem;border-radius:4px;cursor:pointer;white-space:nowrap;flex-shrink:0" onclick="openKPIInquiryWithMetric(${JSON.stringify(k.target).replace(/"/g,'&quot;')})">Ask about this â†’</button>
              </div>`).join('')}
          </div>
        </div>`;
      });
      return html;

    // â”€â”€ FULL SCORECARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    } else if(tab === 'scorecard'){
      const sorted = Object.entries(goals).sort((a,b)=>b[1].score-a[1].score);
      let html = `<div style="margin-bottom:1.25rem;padding:.875rem 1rem;background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;font-size:.8125rem;color:#0c4a6e;line-height:1.5">
        ğŸ“‹ <strong>Full Scorecard</strong> â€” All goal areas ranked from highest to lowest performance. Use this to present to leadership or compare across quarters.
      </div>`;

      html += `<div style="display:flex;flex-direction:column;gap:1rem">`;
      sorted.forEach(([name,g],rank)=>{
        const pct = g.score.toFixed(1);
        html += `<div class="kpia-card" style="border-left:4px solid ${g.risk.color}">
          <div style="display:flex;align-items:center;gap:.875rem;flex-wrap:wrap;margin-bottom:.75rem">
            <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--muted);width:28px;text-align:center;flex-shrink:0">#${rank+1}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:.9375rem;font-weight:700;color:var(--navy);margin-bottom:.25rem">${name}</div>
              <div style="font-size:.8125rem;color:var(--text-2)">${friendlyGoalLine(g,name)}</div>
            </div>
            <div style="text-align:right;flex-shrink:0">
              <div style="font-family:'DM Serif Display',serif;font-size:2rem;font-weight:700;color:${g.risk.color};line-height:1">${pct}%</div>
              <span style="background:${g.risk.bg};color:${g.risk.color};font-size:.6875rem;font-weight:700;padding:.2rem .5rem;border-radius:20px">${g.risk.icon} ${g.risk.label}</span>
            </div>
          </div>

          <!-- Score bar with threshold markers -->
          <div style="position:relative;margin-bottom:.5rem">
            <div style="height:10px;background:var(--border);border-radius:5px;overflow:hidden">
              <div style="height:100%;width:${Math.min(g.score,100).toFixed(1)}%;background:${g.risk.color};border-radius:5px;transition:width .5s ease"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:.65rem;color:var(--muted);margin-top:.25rem;padding:0 1px">
              <span>0%</span><span>|40% Critical</span><span>|65% Watch</span><span>|85% Healthy</span><span>100%</span>
            </div>
          </div>

          <!-- Target status bar -->
          <div style="display:flex;gap:2px;height:6px;border-radius:3px;overflow:hidden;margin-bottom:.625rem">
            ${g.counts['Met']?`<div style="flex:${g.counts['Met']};background:#22c55e" title="Met: ${g.counts['Met']}"></div>`:''}
            ${g.counts['In Progress']?`<div style="flex:${g.counts['In Progress']};background:var(--progress)" title="In Progress: ${g.counts['In Progress']}"></div>`:''}
            ${g.counts['Partially Met']?`<div style="flex:${g.counts['Partially Met']};background:#f97316" title="Partially Met: ${g.counts['Partially Met']}"></div>`:''}
            ${g.counts['Coming Down the Pipeline']?`<div style="flex:${g.counts['Coming Down the Pipeline']};background:var(--pipeline)" title="Pipeline: ${g.counts['Coming Down the Pipeline']}"></div>`:''}
            ${g.counts['Has Not Met']?`<div style="flex:${g.counts['Has Not Met']};background:#ef4444" title="Not Met: ${g.counts['Has Not Met']}"></div>`:''}
          </div>

          <div style="font-size:.75rem;color:var(--muted)">
            ${g.pts.toFixed(2)} pts earned of ${g.max} possible Â· ${g.max} targets
          </div>
        </div>`;
      });
      html += `</div>`;
      return html;
    }
    return '';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  KPI INQUIRY FORM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const KPI_INQUIRY_FORM = 'https://docs.google.com/forms/d/e/1FAIpQLSd59ZRol4DKvJjX2oDAuO2mSICuo5H7ac3giNbUQQfAoMkUTg/formResponse';

  const KPI_INQUIRY_ENTRY = {
    userName:   'entry.1971354312',   // Name of user
    context:    'entry.1060571871',   // Open field - context / question
    metric:     'entry.1490774208',   // KPI metric being reported
  };

  function populateKPIMetricDropdown() {
    const sel = document.getElementById('kpiq_metric');
    if (!sel || sel.options.length > 1) return;
    const seen = new Set();
    KPI_DATA.forEach(k => {
      if (!seen.has(k.target)) {
        seen.add(k.target);
        const o = document.createElement('option');
        o.value = k.target;
        o.textContent = k.target.length > 80 ? k.target.slice(0,80) + 'â€¦' : k.target;
        sel.appendChild(o);
      }
    });
  }

  function openKPIInquiry(preselect) {
    populateKPIMetricDropdown();
    if (preselect) {
      const sel = document.getElementById('kpiq_metric');
      if (sel) {
        for (let i = 0; i < sel.options.length; i++) {
          if (sel.options[i].value === preselect) { sel.selectedIndex = i; break; }
        }
      }
    }
    document.getElementById('kpiInquiryModal').classList.add('open');
    const nameField = document.getElementById('kpiq_name');
    if (nameField && !nameField.value && window.NJTC_SESSION) {
      nameField.value = window.NJTC_SESSION.name || '';
    }
  }

  function openKPIInquiryWithMetric(metric) {
    openKPIInquiry(metric);
  }

  function closeKPIInquiry() {
    document.getElementById('kpiInquiryModal').classList.remove('open');
  }

  function resetKPIInquiry() {
    document.getElementById('kpiInquiryForm').style.display = '';
    document.getElementById('kpiInquirySuccess').classList.remove('show');
    document.getElementById('kpiq_name').value = '';
    document.getElementById('kpiq_metric').selectedIndex = 0;
    document.getElementById('kpiq_context').value = '';
    document.getElementById('kpiq_error').style.display = 'none';
    const btn = document.getElementById('kpiqSubmitBtn');
    if (btn) { btn.classList.remove('loading'); btn.disabled = false; }
  }

  async function submitKPIInquiry() {
    const name    = (document.getElementById('kpiq_name')?.value || '').trim();
    const context = (document.getElementById('kpiq_context')?.value || '').trim();
    const metric  = document.getElementById('kpiq_metric')?.value || '';
    const errEl   = document.getElementById('kpiq_error');

    // Validate
    const missing = [];
    if (!name)    missing.push('Your Name');
    if (!metric)  missing.push('KPI Metric');
    if (!context) missing.push('Question / Context');
    if (missing.length) {
      errEl.textContent = `Please complete: ${missing.join(', ')}`;
      errEl.style.display = 'block';
      return;
    }
    errEl.style.display = 'none';

    const btn = document.getElementById('kpiqSubmitBtn');
    btn.classList.add('loading');
    btn.disabled = true;

    // Build form data â€” Google Forms requires application/x-www-form-urlencoded
    const params = new URLSearchParams();
    params.append(KPI_INQUIRY_ENTRY.userName, name);
    params.append(KPI_INQUIRY_ENTRY.context, context);
    params.append(KPI_INQUIRY_ENTRY.metric, metric);

    try {
      await fetch(KPI_INQUIRY_FORM, {
        method: 'POST',
        body: params.toString(),
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
    } catch(e) { /* no-cors fetch always resolves */ }

    // Reset button then show success
    btn.classList.remove('loading');
    btn.disabled = false;
    document.getElementById('kpiInquiryForm').style.display = 'none';
    document.getElementById('kpiInquirySuccess').classList.add('show');
  }

  // â”€â”€ Wire KPI Analytics panel into showPanel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const _kpiaOrigShowPanel = showPanel;
  // showPanel is overridden later in the file, so we patch the one that matters
  // via an event-style approach â€” when kpi-analytics panel opens, build it
  const _kpiaPanelObserver = new MutationObserver(() => {
    const p = document.getElementById('panel-kpi-analytics');
    if (p && p.classList.contains('active')) {
      const content = document.getElementById('kpiAnalyticsContent');
      if (content && !content.innerHTML.trim()) buildKPIAnalytics();
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
    const p = document.getElementById('panel-kpi-analytics');
    if (p) _kpiaPanelObserver.observe(p, { attributes: true, attributeFilter: ['class'] });
  });

  // â”€â”€ Wire dept-aware init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function buildTalentDashboard(forceRefresh) {
    const el = document.getElementById('talentContent');
    if (!el) return;
    if (_talentLoaded && !forceRefresh) { buildTalentContent(); return; }
    el.innerHTML = '<div class="policy-loading-state"><div class="policy-loading-spinner"></div><div>Loading analyticsâ€¦</div></div>';
    _talentLiveStatus = 'pending';
    _updateTalentBadge('pending');
    // Signal whether this is a forced refresh (adds cache-bust param, same as KPI refresh)
    window._talentForceRefresh = !!forceRefresh;
    try { await fetchLiveConcerns(); } catch(e) { _talentLiveStatus = 'fallback'; }
    window._talentForceRefresh = false;
    _talentLoaded = true;
    _filteredConcerns = CONCERNS;
    _updateTalentBadge(_talentLiveStatus);
    initTalentFilters();
    initTalentTabsForDept(_currentDept || 'hr');
  }

  function _updateTalentBadge(status) {
    const badge = document.getElementById('talent-live-badge');
    if (!badge) return;
    if (status === 'live') {
      badge.style.cssText = 'font-size:.7rem;color:#0d6e3a;background:#d1fae5';
      badge.textContent = 'LIVE DATA';
    } else if (status === 'fallback') {
      badge.style.cssText = 'font-size:.7rem;color:#92400e;background:#fef3c7';
      badge.textContent = 'BUILT-IN DATA';
    } else {
      badge.style.cssText = 'font-size:.7rem;color:#1d4ed8;background:#dbeafe';
      badge.textContent = 'LOADINGâ€¦';
    }
  }


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SY ANALYTICS MODULE  â€”  NJTC Central Team Portal  SY 2025-2026
  //
  //  LIVE SOURCE â€” identical pattern to SHEET_CSV_URL and TALENT_CSV_URL:
  //    Uses the published-to-web embed URL (2PACX-â€¦ format).
  //    File â†’ Share â†’ Publish to web â†’ Tab â†’ CSV â†’ Publish â†’ copy URL.
  //    This is the ONLY format that works from a static GitHub Pages host.
  //    The /export?format=csv URL requires Google login and causes a CORS
  //    redirect to accounts.google.com â€” do NOT use that format here.
  //
  //  DATA LAYOUT (from CSV):
  //    Row 1 (idx 0) : summary row â€” skip
  //    Row 2 (idx 1) : aggregate totals row â€” skip
  //    Row 3 (idx 2) : HEADERS  ("Fee for service partner", "Status", â€¦)
  //    Row 4+ (idx 3+): DATA
  //
  //  CSV PARSING:
  //    Full RFC-4180 state-machine parser (parseCSVFull).
  //    This sheet has 170+ embedded newlines inside quoted cells.
  //    A naive text.split('\n') breaks those into corrupt fragments â†’ wrong numbers.
  //
  //  ROLE GATING:
  //    Fee for service (col A / idx 0)  : finance, leadership only
  //    Percent hired   (col AH / idx 33): programming, leadership, hr only
  //    Fields are not rendered at all for unauthorised roles.
  //
  //  CHANGE DETECTION:
  //    Diffs district+school keyed snapshots between refreshes.
  //    Badge + modal show added / removed / changed rows with field detail.
  //
  //  GEOCODING:
  //    Nominatim (OSM) client-side, rate-limited â‰¤1 req/sec.
  //    Results cached in localStorage (key: njtc_sy_geocache_v4).
  //    Re-geocodes only when address changes or cache is cold.
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const sya = (() => {

    // â”€â”€ LIVE DATA URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Same 2PACX pub?output=csv pattern as SHEET_CSV_URL & TALENT_CSV_URL.
    // The sheet is published to web â€” anyone with the link can access it.
    const SY_CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJhAQMZ8nUJ6fV03eV0-uALiqnvQ3wEZ7n03n-ZuvPSNJz9QQbjL06uVM2hnajdcLSDL3m83HfSfVM/pub?output=csv&gid=628127573';

    const SY_REFRESH_MS   = 5 * 60 * 1000;  // 5 min â€” matches KPI pattern
    const GEOCODE_RATE_MS = 1150;            // Nominatim â‰¤1 req/sec + buffer
    const GEOCODE_CACHE_KEY = 'njtc_sy_geocache_v4';

    // â”€â”€ COLUMN INDEXES (0-based, from CSV row 3 / sheet row 3 headers) â”€â”€â”€
    const C = {
      FEE:         0,   // A  â€” ROLE GATED: finance, leadership
      STATUS:      1,   // B
      COUNTY:      2,   // C
      PM:          3,   // D
      LEAD_HIRING: 4,   // E
      DISTRICT:    5,   // F  â€” INCLUSION: must be non-blank
      SCHOOL:      6,   // G  â€” INCLUSION: must be non-blank
      ADDRESS:     7,   // H  â€” geocoding only; never shown as text
      CONFIRMED:   8,   // I
      EST:         9,   // J  â€” Estimated # Scholars
      ACT:         10,  // K  â€” Actual # Scholars (Pearl)
      CONTENT:     11,  // L
      GRADES:      12,  // M
      TUTOR_TYPE:  13,  // N
      BLOCK:       14,  // O
      START:       15,  // P
      MIDPOINT:    16,  // Q
      ENDPOINT:    17,  // R
      DAYS:        18,  // S
      ASSESS:      19,  // T
      TUTOR_POS:   23,  // X  â€” Tutor Positions
      TUTOR_FILL:  24,  // Y  â€” Filled Tutor Positions
      APPRENT:     25,  // Z  â€” Apprentice Tutors
      SC_POS:      26,  // AA â€” SC Positions
      SC_FILL:     27,  // AB â€” Filled SC
      IC_POS:      28,  // AC â€” IC Positions
      IC_FILL:     29,  // AD â€” Filled IC
      DR_POS:      30,  // AE â€” Dual Role Positions
      DR_FILL:     31,  // AF â€” Filled Dual Role
      TOTAL_STAFF: 32,  // AG â€” Total staffing  (authoritative â†’ 102.0)
      PCT_HIRED:   33,  // AH â€” ROLE GATED: programming, leadership, hr
      PARTNER_NM:  37,  // AL â€” Partner Contact Name
      PARTNER_EM:  38,  // AM â€” Partner Email
      MOU:         39,  // AN â€” MOU/DSA Signed
      DS_NAME:     40,  // AO â€” Data Specialist Name
      DS_EMAIL:    41,  // AP â€” Data Specialist Email
      BA_NAME:     42,  // AQ â€” BA/Finance Name
    };

    const ROLES_FEE   = ['finance', 'leadership'];
    const ROLES_PCTHR = ['programming', 'leadership', 'hr'];

    // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _allSites  = [];
    let _filtered  = [];
    let _snapshot  = {};
    let _changes   = [];
    let _geocache  = {};
    let _markers   = {};
    let _map       = null;
    let _geoQueue  = [];
    let _geocoding = false;
    let _selKey    = null;
    let _inited    = false;
    let _lastFetch = null;

    // â”€â”€ RFC-4180 CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // State-machine parser that correctly handles quoted fields containing
    // embedded newlines and commas. Required because this sheet has 170+
    // newlines inside quoted cells (spring-break dates, contact info, etc.).
    // A simple text.split('\n') would fracture those rows â†’ wrong totals.
    function parseCSVFull(text) {
      const rows = [];
      let row = [], field = '', inQ = false;
      const src = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      for (let i = 0; i < src.length; i++) {
        const ch = src[i];
        if (inQ) {
          if (ch === '"') {
            if (src[i + 1] === '"') { field += '"'; i++; }  // escaped ""
            else inQ = false;
          } else {
            field += ch;  // newlines inside quotes are part of the field
          }
        } else {
          if      (ch === '"')  { inQ = true; }
          else if (ch === ',')  { row.push(field.trim()); field = ''; }
          else if (ch === '\n') { row.push(field.trim()); field = ''; rows.push(row); row = []; }
          else                  { field += ch; }
        }
      }
      if (field.trim() || row.length) { row.push(field.trim()); rows.push(row); }
      return rows;
    }

    // â”€â”€ PARSE SY ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Headers in sheet row 3 â†’ CSV index 2 (contains "Fee for service partner").
    // Data from sheet row 4 â†’ CSV index 3+.
    // Rows missing District (col F) OR School (col G) are excluded â€” always.
    function parseSYRows(text) {
      const rows = parseCSVFull(text);
      let hIdx = -1;
      for (let i = 0; i < Math.min(8, rows.length); i++) {
        if (rows[i].join(',').toLowerCase().includes('fee for service')) { hIdx = i; break; }
      }
      if (hIdx < 0) { console.warn('[SY] Header row not found'); return []; }

      const sites = [];
      for (let i = hIdx + 1; i < rows.length; i++) {
        const cols = rows[i];
        if (!cols || cols.length < 7) continue;
        const district = (cols[C.DISTRICT] || '').replace(/\n/g, ' ').trim();
        const school   = (cols[C.SCHOOL]   || '').replace(/\n/g, ' ').trim();
        if (!district || !school) continue;  // INCLUSION RULE â€” non-negotiable

        const g = idx => (cols[idx] || '').replace(/\n/g, ' ').trim();
        const n = idx => { const v = g(idx); if (!v) return 0; const f = parseFloat(v); return isNaN(f) ? 0 : f; };

        const agNum     = n(C.TOTAL_STAFF);
        const filledSum = n(C.TUTOR_FILL) + n(C.SC_FILL) + n(C.IC_FILL) + n(C.DR_FILL);
        const address   = (cols[C.ADDRESS] || '').replace(/[\r\n]+/g, ' ').replace(/\s{2,}/g, ' ').trim();

        sites.push({
          key: district + ' | ' + school,
          district, school, address,
          status: g(C.STATUS), county: g(C.COUNTY), pm: g(C.PM),
          act: n(C.ACT), est: n(C.EST),
          content: g(C.CONTENT), grades: g(C.GRADES),
          tutorType: g(C.TUTOR_TYPE), startDate: g(C.START),
          midpoint: g(C.MIDPOINT), endpoint: g(C.ENDPOINT),
          days: g(C.DAYS), assessModel: g(C.ASSESS),
          tutorPos: n(C.TUTOR_POS), tutorFill: n(C.TUTOR_FILL),
          apprentice: n(C.APPRENT),
          scPos: n(C.SC_POS),   scFill: n(C.SC_FILL),
          icPos: n(C.IC_POS),   icFill: n(C.IC_FILL),
          drPos: n(C.DR_POS),   drFill: n(C.DR_FILL),
          totalStaff: agNum || filledSum,
          pctHired:   g(C.PCT_HIRED),   // role-gated
          feePartner: g(C.FEE),         // role-gated
          partnerName: g(C.PARTNER_NM), partnerEmail: g(C.PARTNER_EM),
          mou: g(C.MOU), dsName: g(C.DS_NAME), dsEmail: g(C.DS_EMAIL),
          baName: g(C.BA_NAME),
          lat: null, lng: null, geocodeFailed: false, geocodeReason: '',
        });
      }
      return sites;
    }

    // â”€â”€ ROLE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function dept() {
      const d = typeof _currentDept !== 'undefined' ? _currentDept
              : (window.NJTC_SESSION ? window.NJTC_SESSION.dept : '');
      return (d || '').toLowerCase();
    }
    const canSeeFee = () => ROLES_FEE.includes(dept());
    const canSeePct = () => ROLES_PCTHR.includes(dept());

    // â”€â”€ CHANGE DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TRACKED = [
      ['act','Actual Scholars'],['est','Est. Scholars'],['totalStaff','Total Staff'],
      ['content','Content'],['tutorType','Tutoring Type'],['startDate','Start Date'],
      ['midpoint','Midpoint'],['endpoint','End Date'],['days','Days of Week'],
      ['assessModel','Assessment Model'],['status','Status'],['pctHired','% Hired'],
    ];
    const mkSnap = sites => { const s = {}; sites.forEach(r => { s[r.key] = r; }); return s; };
    function diffSnaps(oldSnap, newSites) {
      const chg = [], ns = mkSnap(newSites);
      const ok = new Set(Object.keys(oldSnap)), nk = new Set(Object.keys(ns));
      nk.forEach(k => { if (!ok.has(k)) chg.push({ type:'added',   key:k, school:ns[k].school, district:ns[k].district }); });
      ok.forEach(k => { if (!nk.has(k)) chg.push({ type:'removed', key:k, school:oldSnap[k].school, district:oldSnap[k].district }); });
      nk.forEach(k => {
        if (!ok.has(k)) return;
        const fc = TRACKED.reduce((a,[f,lbl]) => {
          const ov = String(oldSnap[k][f]??''), nv = String(ns[k][f]??'');
          if (ov !== nv) a.push({field:lbl, from:ov||'â€”', to:nv||'â€”'});
          return a;
        }, []);
        if (fc.length) chg.push({type:'modified', key:k, school:ns[k].school, district:ns[k].district, fields:fc});
      });
      return chg;
    }

    // â”€â”€ FETCH / REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refresh(force = false) {
      setSyncState('loading');
      const btn = document.getElementById('syRefreshBtn');
      if (btn) btn.disabled = true;
      try {
        // Cache-bust appended as query param â€” same pattern as KPI fetch
        const url = SY_CSV_URL + (force ? '&t=' + Date.now() : '');
        const res = await fetch(url, { signal: AbortSignal.timeout(12000) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const csv = await res.text();
        const sites = parseSYRows(csv);
        if (!sites.length) throw new Error('Parsed 0 valid sites');
        _changes   = _allSites.length ? diffSnaps(mkSnap(_allSites), sites) : [];
        _allSites  = sites;
        _snapshot  = mkSnap(sites);
        _lastFetch = new Date();
        setSyncState('live');
        populateFilters();
        applyFilters();
        queueGeocoding();
      } catch (e) {
        console.warn('[SY Analytics] Fetch failed:', e.message);
        setSyncState('error');
      }
      if (btn) btn.disabled = false;
    }

    function setSyncState(state) {
      const dot  = document.getElementById('sySyncDot');
      const txt  = document.getElementById('sySyncText');
      const cbtn = document.getElementById('syChangesBtn');
      const nbdg = document.getElementById('syChangesBadge');
      if (!dot) return;
      if (state === 'loading') {
        dot.className = 'sync-dot loading';
        if (txt) txt.textContent = 'Fetching live SY dataâ€¦';
      } else if (state === 'live') {
        dot.className = 'sync-dot';
        const t = _lastFetch ? _lastFetch.toLocaleTimeString() : 'â€”';
        if (txt) txt.innerHTML = `<strong>Live Â· Google Sheet</strong>&nbsp;Â· ${_allSites.length} sites Â· Updated ${t}`;
        const hc = _changes.length > 0;
        if (cbtn) { cbtn.style.display = hc ? '' : 'none'; if (hc) document.getElementById('syChangesBtnN').textContent = _changes.length; }
        if (nbdg) { nbdg.style.display = hc ? '' : 'none'; if (hc) nbdg.textContent = _changes.length; }
      } else {
        dot.className = 'sync-dot error';
        if (txt) txt.innerHTML = _lastFetch
          ? `<strong>âš ï¸ Sheet unreachable</strong> Â· Last: ${_lastFetch.toLocaleTimeString()}`
          : '<strong>âš ï¸ Could not load SY data</strong> Â· Click â†º Refresh';
      }
    }

    // â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyFilters() {
      const v = id => (document.getElementById(id)||{}).value||'';
      const fD=v('syFDistrict'),fC=v('syFContent'),fT=v('syFType'),
            fA=v('syFAssess'),  fW=v('syFDays'),   fS=v('syFStatus');
      _filtered = _allSites.filter(s =>
        (!fD || s.district === fD) &&
        (!fC || s.content.toLowerCase().includes(fC.toLowerCase())) &&
        (!fT || s.tutorType.toLowerCase().includes(fT.toLowerCase())) &&
        (!fA || s.assessModel.toLowerCase().includes(fA.toLowerCase())) &&
        (!fW || s.days.toLowerCase().includes(fW.toLowerCase())) &&
        (!fS || s.status === fS)
      );
      const fi = document.getElementById('syFilterInfo');
      const active = !!(fD||fC||fT||fA||fW||fS);
      if (fi) fi.textContent = active ? `${_filtered.length} site${_filtered.length!==1?'s':''} matching` : '';
      updateStats(); renderDistrictList(); renderTable(); updateMapMarkers();
    }

    function clearFilters() {
      ['syFDistrict','syFContent','syFType','syFAssess','syFDays','syFStatus']
        .forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
      applyFilters();
    }

    function filterByDistrict(dist) {
      const sel = document.getElementById('syFDistrict');
      if (!sel) return;
      sel.value = (sel.value === dist) ? '' : dist;
      applyFilters();
    }

    function populateFilters() {
      function pop(id, vals) {
        const el = document.getElementById(id); if (!el) return;
        const cur = el.value, first = el.options[0] ? el.options[0].outerHTML : '';
        el.innerHTML = first + [...vals].filter(Boolean).sort()
          .map(v => `<option value="${v}">${v}</option>`).join('');
        if ([...el.options].some(o => o.value === cur)) el.value = cur;
      }
      pop('syFDistrict', new Set(_allSites.map(s => s.district)));
      pop('syFContent',  new Set(_allSites.map(s => s.content)));
      pop('syFType',     new Set(_allSites.map(s => s.tutorType)));
      pop('syFAssess',   new Set(_allSites.map(s => s.assessModel)));
      pop('syFDays',     new Set(_allSites.map(s => s.days)));
    }

    // â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateStats() {
      const s = _filtered;
      const stf = s.reduce((a,r) => a + r.totalStaff, 0);
      setText('syStatSites',     s.length);
      setText('syStatDistricts', new Set(s.map(r => r.district)).size);
      setText('syStatActual',    s.reduce((a,r) => a + r.act, 0).toLocaleString());
      setText('syStatEst',       s.reduce((a,r) => a + r.est, 0).toLocaleString());
      setText('syStatStaff',     stf % 1 === 0 ? stf.toLocaleString() : stf.toFixed(1));
    }

    // â”€â”€ DISTRICT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderDistrictList() {
      const el = document.getElementById('syDistrictList'); if (!el) return;
      const map = {};
      _filtered.forEach(s => {
        if (!map[s.district]) map[s.district] = {c:0,act:0,est:0,stf:0};
        map[s.district].c++; map[s.district].act+=s.act;
        map[s.district].est+=s.est; map[s.district].stf+=s.totalStaff;
      });
      const cur = (document.getElementById('syFDistrict')||{}).value||'';
      el.innerHTML = Object.entries(map).sort((a,b)=>b[1].act-a[1].act).map(([d,v]) => {
        const esc = d.replace(/'/g,"\\'");
        const stfStr = v.stf%1===0?v.stf.toLocaleString():v.stf.toFixed(1);
        return `<div class="sy-district-item${cur===d?' syd-active':''}" onclick="sya.filterByDistrict('${esc}')">
          <div class="sy-dist-name">${d}</div>
          <div class="sy-dist-meta">
            <span>${v.c} site${v.c!==1?'s':''}</span>
            <span>Â· ${v.act.toLocaleString()} scholars</span>
            <span>Â· ${stfStr} staff</span>
          </div>
        </div>`;
      }).join('');
    }

    // â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable() {
      const tbody = document.getElementById('syTableBody');
      const cnt   = document.getElementById('syTableCount');
      if (!tbody) return;
      if (cnt) cnt.textContent = `(${_filtered.length} of ${_allSites.length})`;
      const dash = '<span style="color:var(--muted)">â€”</span>';
      tbody.innerHTML = _filtered.map(s => {
        const hl  = s.key === _selKey ? 'sy-row-hl' : '';
        const esc = s.key.replace(/'/g,"\\'");
        const stfStr = s.totalStaff ? (s.totalStaff%1===0?s.totalStaff:s.totalStaff.toFixed(1)) : dash;
        return `<tr class="${hl}" onclick="sya.selectSite('${esc}')">
          <td style="font-size:.75rem;color:var(--text-2);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${s.district}">${s.district}</td>
          <td style="font-weight:600;color:var(--navy);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${s.school}">${s.school}</td>
          <td style="text-align:center;font-family:'DM Serif Display',serif;font-size:1rem;color:var(--navy)">${s.act||dash}</td>
          <td style="text-align:center;font-family:'DM Serif Display',serif;font-size:1rem;color:var(--navy)">${s.est||dash}</td>
          <td style="text-align:center;font-family:'DM Serif Display',serif;font-size:1rem;color:var(--navy)">${stfStr}</td>
          <td style="font-size:.75rem;color:var(--text-2)">${s.content||dash}</td>
          <td style="font-size:.75rem;color:var(--text-2)">${s.tutorType||dash}</td>
          <td style="font-size:.75rem;color:var(--text-2)">${s.assessModel||dash}</td>
        </tr>`;
      }).join('');
    }

    // â”€â”€ DETAIL CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function selectSite(key) {
      _selKey = key;
      const site = _allSites.find(s => s.key === key);
      if (!site) return;
      renderDetail(site);
      if (_map && typeof site.lat === 'number' && isFinite(site.lat)
               && typeof site.lng === 'number' && isFinite(site.lng)) {
        _map.flyTo([site.lat, site.lng], 14, {duration:0.8});
        if (_markers[key]) _markers[key].openPopup();
      }
      document.querySelectorAll('#syTableBody tr').forEach(tr => tr.classList.remove('sy-row-hl'));
      const idx = _filtered.findIndex(s => s.key === key);
      const rows = document.querySelectorAll('#syTableBody tr');
      if (idx >= 0 && rows[idx]) { rows[idx].classList.add('sy-row-hl'); rows[idx].scrollIntoView({behavior:'smooth',block:'nearest'}); }
    }

    function renderDetail(s) {
      const card = document.getElementById('syDetailCard'); if (!card) return;
      const v   = x => (x !== null && x !== undefined && String(x).trim()) ? x : null;
      const row = (lbl, val) => val !== null && val !== undefined && String(val).trim()
        ? `<div class="sy-detail-row"><span class="sy-detail-label">${lbl}</span><span class="sy-detail-val">${val}</span></div>` : '';
      const sec = lbl => `<div class="sy-detail-section">${lbl}</div>`;
      const stfStr = s.totalStaff ? (s.totalStaff%1===0?s.totalStaff:s.totalStaff.toFixed(1)) : 'â€”';
      const staffPairs = [['Tutors',s.tutorFill,s.tutorPos],['Site Coord',s.scFill,s.scPos],['Instr. Coach',s.icFill,s.icPos],['Dual Role',s.drFill,s.drPos]].filter(([,f,p])=>f||p);
      const staffGrid = staffPairs.length ? `<div class="sy-staff-grid">
        ${staffPairs.map(([lbl,f,p])=>`<div><div class="sy-staff-cell-label">${lbl}</div><div class="sy-staff-cell-val">${f||0}/${p||0}</div></div>`).join('')}
        ${s.apprentice?`<div><div class="sy-staff-cell-label">Apprentice</div><div class="sy-staff-cell-val">${s.apprentice}</div></div>`:''}
      </div>` : '';
      const partnerBlock = (v(s.partnerName)||v(s.partnerEmail)||v(s.mou)||v(s.dsName)||v(s.baName))
        ? sec('Partner & Contacts') +
          row('LEA / Partner',    v(s.partnerName)) +
          row('Partner Email',    v(s.partnerEmail) ? `<a href="mailto:${s.partnerEmail}" style="color:var(--blue-mid)">${s.partnerEmail}</a>` : null) +
          row('MOU / DSA Signed', v(s.mou)) +
          row('Data Specialist',  v(s.dsName)) +
          row('DS Email',         v(s.dsEmail) ? `<a href="mailto:${s.dsEmail}" style="color:var(--blue-mid)">${s.dsEmail}</a>` : null) +
          row('BA / Finance',     v(s.baName)) : '';
      const feeBlock = canSeeFee() ? row('Fee for Service Partner', v(s.feePartner)||'N/A') : '';
      const pctBlock = canSeePct() ? row('Percent Hired',           v(s.pctHired)||'â€”')    : '';
      const gatedBlock = (feeBlock||pctBlock) ? sec('Finance / Staffing') + feeBlock + pctBlock : '';
      card.innerHTML = `
        <div class="sy-detail-school">${s.school}</div>
        <div class="sy-detail-district">${s.district}</div>
        ${sec('Scholars')}
        ${row('Actual (Pearl)', s.act||null)}${row('Estimated', s.est||null)}
        ${sec('Programming')}
        ${row('Content', v(s.content))}${row('Tutoring Type', v(s.tutorType))}
        ${row('Days of Week', v(s.days))}${row('Assessment', v(s.assessModel))}
        ${row('Start Date', v(s.startDate))}${row('Midpoint', v(s.midpoint))}
        ${row('End Date', v(s.endpoint))}${row('Grades', v(s.grades))}
        ${sec('Staffing')}${staffGrid}${row('Total Staff', stfStr)}
        ${partnerBlock}${gatedBlock}`;
    }

    // â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initMap() {
      if (_map || !window.L) return;
      const el = document.getElementById('syMap');
      if (!el || el.offsetParent === null) return;  // must be visible â€” see onPanelOpen
      _map = L.map('syMap', {zoomControl:true}).setView([40.0, -74.7], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>', maxZoom:19
      }).addTo(_map);
      delete L.Icon.Default.prototype._getIconUrl;
      L.Icon.Default.mergeOptions({
        iconUrl:       'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
        iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
        shadowUrl:     'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      });
    }

    function updateMapMarkers() {
      if (!_map) return;
      const fk = new Set(_filtered.map(s => s.key));
      const ak = new Set(_allSites.map(s => s.key));
      Object.keys(_markers).forEach(k => { if (!ak.has(k)) { _map.removeLayer(_markers[k]); delete _markers[k]; } });
      Object.keys(_markers).forEach(k => {
        const m = _markers[k];
        if (fk.has(k)) { if (!_map.hasLayer(m)) m.addTo(_map); }
        else            { if (_map.hasLayer(m))  _map.removeLayer(m); }
      });
      _allSites.forEach(s => {
        if (typeof s.lat==='number' && isFinite(s.lat) &&
            typeof s.lng==='number' && isFinite(s.lng) && !_markers[s.key]) addMarker(s);
      });
      updateUnmapped();
    }

    function addMarker(site) {
      if (!_map) return;
      if (typeof site.lat !== 'number' || !isFinite(site.lat)) return;
      if (typeof site.lng !== 'number' || !isFinite(site.lng)) return;
      const col = site.status.toLowerCase().includes('active') ? '#0050c8' : '#7d8fa1';
      const icon = L.divIcon({
        className:'',
        html:`<div style="width:20px;height:20px;background:${col};border:2.5px solid #fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.28);cursor:pointer"></div>`,
        iconSize:[20,20], iconAnchor:[10,10], popupAnchor:[0,-13]
      });
      const marker = L.marker([site.lat, site.lng], {icon});
      marker.bindPopup(buildPopup(site), {maxWidth:260});
      marker.on('click', () => selectSite(site.key));
      _markers[site.key] = marker;
      if (new Set(_filtered.map(s=>s.key)).has(site.key)) marker.addTo(_map);
    }

    function buildPopup(s) {
      const stfStr = s.totalStaff ? (s.totalStaff%1===0?s.totalStaff:s.totalStaff.toFixed(1)) : 'â€”';
      return `<div class="sy-popup">
        <div class="sy-popup-school">${s.school}</div>
        <div class="sy-popup-dist">${s.district}</div>
        <div class="sy-popup-row"><span class="sy-popup-lbl">Actual Scholars</span><span class="sy-popup-val">${s.act||'â€”'}</span></div>
        <div class="sy-popup-row"><span class="sy-popup-lbl">Est. Scholars</span><span class="sy-popup-val">${s.est||'â€”'}</span></div>
        <div class="sy-popup-row"><span class="sy-popup-lbl">Content</span><span class="sy-popup-val">${s.content||'â€”'}</span></div>
        <div class="sy-popup-row"><span class="sy-popup-lbl">Type</span><span class="sy-popup-val">${s.tutorType||'â€”'}</span></div>
        <div class="sy-popup-row"><span class="sy-popup-lbl">Total Staff</span><span class="sy-popup-val">${stfStr}</span></div>
      </div>`;
    }

    function updateUnmapped() {
      const b = document.getElementById('syUnmappedBanner'); if (!b) return;
      const u = _filtered.filter(s => s.geocodeFailed);
      b.style.display = u.length ? '' : 'none';
      if (u.length) b.textContent = `${u.length} site${u.length!==1?'s':''} could not be mapped: ${u.map(s=>s.school).join(', ')}`;
    }

    // â”€â”€ GEOCODING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadGeoCache() { try { _geocache = JSON.parse(localStorage.getItem(GEOCODE_CACHE_KEY)||'{}'); } catch(e) { _geocache={}; } }
    function saveGeoCache() { try { localStorage.setItem(GEOCODE_CACHE_KEY, JSON.stringify(_geocache)); } catch(e) {} }
    const normAddr = a => a.toLowerCase().replace(/\s+/g,' ').trim();

    function queueGeocoding() {
      loadGeoCache(); _geoQueue = [];
      _allSites.forEach(s => {
        if (!s.address) { s.geocodeFailed=true; s.geocodeReason='No address'; return; }
        const ck = normAddr(s.address);
        const c  = _geocache[ck];
        if (c) {
          if (c.failed) { s.geocodeFailed=true; s.geocodeReason=c.reason||'Failed'; }
          else { s.lat=c.lat; s.lng=c.lng; }
        } else { _geoQueue.push({site:s, ck}); }
      });
      updateMapMarkers();
      if (_geoQueue.length && !_geocoding) processGeoQueue();
    }

    async function processGeoQueue() {
      _geocoding = true;
      while (_geoQueue.length) {
        const item = _geoQueue.shift();
        await geocodeOne(item.site, item.ck);
        await new Promise(r => setTimeout(r, GEOCODE_RATE_MS));
      }
      _geocoding = false; saveGeoCache(); updateMapMarkers();
    }

    async function geocodeOne(site, ck) {
      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(site.address)}&format=json&limit=1`,
          { headers:{'Accept-Language':'en','User-Agent':'NJTC-Portal/2.0'}, signal:AbortSignal.timeout(8000) }
        );
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if (data && data.length) {
          const lat = parseFloat(data[0].lat), lng = parseFloat(data[0].lon);
          if (!isFinite(lat)||!isFinite(lng)) throw new Error('Non-finite coordinates');
          site.lat=lat; site.lng=lng; _geocache[ck]={lat,lng};
          addMarker(site);
          const fk = new Set(_filtered.map(s=>s.key));
          if (fk.has(site.key) && _markers[site.key] && !_map.hasLayer(_markers[site.key]))
            _markers[site.key].addTo(_map);
          updateUnmapped();
        } else {
          site.geocodeFailed=true; site.geocodeReason='Not found';
          _geocache[ck]={failed:true, reason:'Not found'}; updateUnmapped();
        }
      } catch(e) {
        site.geocodeFailed=true; site.geocodeReason=e.message;
        _geocache[ck]={failed:true, reason:e.message}; updateUnmapped();
      }
    }

    // â”€â”€ CHANGES MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openChangesModal() {
      let o = document.getElementById('syChangesModal');
      if (!o) { o=document.createElement('div'); o.id='syChangesModal'; o.className='sy-modal-overlay'; o.onclick=e=>{if(e.target===o)o.style.display='none';}; document.body.appendChild(o); }
      const close = `<button class="sy-modal-close" onclick="document.getElementById('syChangesModal').style.display='none'">âœ•</button>`;
      if (!_changes.length) {
        o.innerHTML=`<div class="sy-modal"><div class="sy-modal-hd"><span class="sy-modal-title">No Changes</span>${close}</div><div class="sy-modal-body" style="text-align:center;padding:2rem;color:var(--muted)">Data matches last refresh.</div></div>`;
      } else {
        const html=[
          ..._changes.filter(c=>c.type==='added').map(c=>`<div class="sy-chg sy-chg-added"><div class="sy-chg-label">âœ… Added: ${c.school}</div><div class="sy-chg-detail">${c.district}</div></div>`),
          ..._changes.filter(c=>c.type==='removed').map(c=>`<div class="sy-chg sy-chg-removed"><div class="sy-chg-label">ğŸ—‘ï¸ Removed: ${c.school}</div><div class="sy-chg-detail">${c.district}</div></div>`),
          ..._changes.filter(c=>c.type==='modified').map(c=>`<div class="sy-chg sy-chg-mod"><div class="sy-chg-label">ğŸ“ ${c.school}</div><div class="sy-chg-detail">${c.district}</div>${c.fields.map(f=>`<div class="sy-chg-detail" style="margin-top:.2rem">â€¢ ${f.field}: <strong>${f.from}</strong> â†’ <strong>${f.to}</strong></div>`).join('')}</div>`)
        ].join('');
        o.innerHTML=`<div class="sy-modal"><div class="sy-modal-hd"><div><div class="sy-modal-title">What Changed</div><div style="font-size:.8125rem;color:var(--muted);margin-top:.2rem">${_changes.length} change${_changes.length!==1?'s':''} Â· ${_lastFetch?_lastFetch.toLocaleTimeString():'â€”'}</div></div>${close}</div><div class="sy-modal-body">${html}</div><div style="padding:1rem 1.5rem;border-top:1px solid var(--border);text-align:right"><button class="btn btn-secondary" onclick="document.getElementById('syChangesModal').style.display='none'">Close</button></div></div>`;
      }
      o.style.display='flex';
    }

    // â”€â”€ PANEL OPEN HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Called by patched showPanel when the SY panel becomes visible.
    // Defers map init to ensure the container has non-zero dimensions.
    // Calls invalidateSize() to fix blank/grey tiles after panel reveal.
    function onPanelOpen() {
      setTimeout(() => {
        if (!_map) {
          initMap();
          if (_allSites.length) { updateMapMarkers(); queueGeocoding(); }
        }
        if (_map) _map.invalidateSize();
      }, 80);
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function init() {
      if (_inited) return;
      _inited = true;
      loadGeoCache();
      refresh(true);
      setInterval(() => {
        const p = document.getElementById('panel-sy-analytics');
        if (p && p.classList.contains('active')) refresh(true);
      }, SY_REFRESH_MS);
    }

    function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = v; }

    return { init, refresh, applyFilters, clearFilters, filterByDistrict, selectSite, openChangesModal, onPanelOpen };
  })();

  // â”€â”€ Patch showPanel to call onPanelOpen when SY panel is activated â”€â”€â”€â”€â”€
  (function patchShowPanelSY() {
    const _orig = showPanel;
    window.showPanel = function(id, btn) { _orig(id, btn); if (id === 'sy-analytics') sya.onPanelOpen(); };
  })();

  // Boot SY Analytics after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => sya.init());
  } else {
    sya.init();
  }



  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PEARL OPERATIONS INTELLIGENCE MODULE  â€”  NJTC Central Team Portal
  //  SY 2025â€“2026  |  Live from Pearl via published Google Sheet
  //
  //  DATA SOURCES (same 2PACX pub format as all other live sheets):
  //    Attendance Detail  â€” read cols Aâ€“AF (idx 0â€“31) only, stop at AF
  //    Instructor Surveys â€” full sheet
  //    Student Surveys    â€” full sheet
  //    Session Details    â€” full sheet
  //
  //  TAB ORDER (from screenshot, leftâ†’right):
  //    1. Attendance Detail   â†’ gid auto-detected by header "User"
  //    2. Instructor Surveys  â†’ gid auto-detected by header "Filled By" + col C "engaged"
  //    3. Student Surveys     â†’ gid auto-detected by header "Filled By" + col C "confident"
  //    4. Session Details     â†’ gid auto-detected by header "Title"
  //
  //  GID DETECTION: Tried sequentially 0,1,2,3 â€” identified by first header cell.
  //    Each tab linked by:
  //      â€¢ Pearl Session ID  (session â†” both surveys)
  //      â€¢ Pearl User ID     (attendance â†” session instructor/student IDs, comma-parsed)
  //
  //  ATTENDANCE CLASSIFICATION:
  //    âœ… ATTENDED:              Attendance Status = "Attended" OR "Late"
  //                              Missed Reason = "Tutor Left Early (no sub)" â€” counts in att
  //                              Missed Reason = "Scholar Left Early" â€” counts in att
  //                              Missed Reason = "Classroom Teacher Requested..." â€” counts in att
  //    âŒ ABSENT (student):      Missed Reason starts with "Absent" or = "Tutor Absent"
  //                              "Scholar declined attending tutoring session" â€” counts as ABSENT (impacts attendance)
  //                              AND triggers a Program Team flag for engagement/re-enrollment review.
  //                              NOT a service interruption â€” it is a scholar attendance event.
  //    ğŸ”´ CRITICAL INTERRUPTION: "NJTC Internal Issue/Error" â†’ always critical severity
  //    ğŸŸ  HIGH INTERRUPTION:     "Tutor Vacancy" (HIGH â€” flagged for HR + Programming + Leadership, excluded from attendance metrics)
  //                              "Unscheduled School Closure/Delay/Dismissal", "Scholar Archived"
  //    NOTE: "Tutor Vacancy" is intentionally NOT in ABSENT_REASONS. It does not count against
  //          attendance rate. It is a staffing gap â€” surfaced as a high-severity service interruption
  //          visible to HR, Programming, and Leadership for backfill action.
  //    ğŸŸ¡ MEDIUM INTERRUPTION:   School events, testing, drills, holidays
  //    ğŸ“Š DATA QUALITY:          Attendance Status = "Not recorded"
  //
  //  HIT COMPLIANCE FLAGS:
  //    RATIO:      > 4 students per session â†’ flag (check MOU) â€” 1:4 max
  //    FREQUENCY:  Scholar attended < 2 sessions in a week â†’ flag
  //    CONTINUITY: Scholar has 2+ different instructors â†’ flag
  //    CONSECUTIVE:Col Y (idx 24) = "Attendance Concern" â†’ flag
  //    VACANCY:    Col AU (idx 46) = "Current Vacancy..." â†’ flag
  //
  //  ROLE VISIBILITY:
  //    leadership / data: everything, all analytics
  //    hr:    attendance compliance, vacancy flags, ADP flag on low attendance, individual names
  //    finance: low attendance flag (check ADP records)
  //    programming: district/school filter, drill to user, service interruptions, HIT flags
  //    training_development: survey details, comments, comment buckets, flags
  //    Others: aggregate stats only, no individual names
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const po = (() => {

    // â”€â”€ PUBLISHED SHEET CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BASE_ID = '2PACX-1vQ1iC8NZFJt3iinGUEqftKtP32N43axi_JN_RQI36EBUdhZS0PaZRwd-1AJT3bEVe6cqHA0tCA3vb5K';
    const csvUrl = gid => `https://docs.google.com/spreadsheets/d/e/${BASE_ID}/pub?output=csv&gid=${gid}`;
    // GIDs for tab order: Attendance Detail(0), Instructor Surveys(1), Student Surveys(2), Session Details(3)
    // Auto-detected at load time â€” stored once resolved
    const GIDS = { att: null, inst: null, stu: null, sess: null };

    const REFRESH_MS = 5 * 60 * 1000;

    // â”€â”€ COLUMN INDEXES â€” ATTENDANCE DETAIL (read ONLY cols 0â€“31 / Aâ€“AF) â”€â”€
    const ATT = {
      USER: 0,           // A  User name
      ROLE: 1,           // B  Student | Instructor
      SESSION: 2,        // C  Session title
      SESS_STATUS: 3,    // D  Session Status
      PLAN_START: 4,     // E  Planned Session Start
      SESS_DATE: 5,      // F  Session Date  (MM/DD/YYYY)
      ATT_STATUS: 6,     // G  Attendance Status
      MISS_REASON: 7,    // H  Attendance Missed Reason
      GRADE: 8,          // I  Grade
      SEX: 9,            // J  Sex
      RACE: 10,          // K  Race
      SCHOOL: 11,        // L  School
      DISTRICT: 12,      // M  District
      USER_ID: 13,       // N  Pearl User ID
      IND_ATT_RATE: 14,  // O  Individual Attendance Rate %
      SCHOLAR_ATT_PCT: 15, // P Scholar Attendance %
      AVG_ATT: 16,       // Q  Tutors+Scholars avg attendance %
      STU_AVG_ATT: 17,   // R  Student Average Attendance %
      INST_AVG: 18,      // S  Instructor Average Attendance %
      STU_ATT_CNT: 19,   // T  Student Attended Session Count
      STU_MISS_CNT: 20,  // U  Student Missed Session Count
      INST_ATT_CNT: 21,  // V  Instructor Attended Session Count
      INST_MISS_CNT: 22, // W  Instructor Missed Session Count
      MISS_TAG: 23,      // X  Missed Session Tag
      CONSEC_STATUS: 24, // Y  10 consecutive sessions missed status
      ATT_PER_SCHOLAR: 25, // Z  Attended Sessions per Scholar
      WEEK: 26,          // AA Weekly Grouping  (e.g. "Week 23")
      // AB (27) = blank
      VACANT_ID: 28,     // AC Pearl Vacant User ID
      SCHOLAR_NAME: 29,  // AD Scholar (vacancy pairing)
      VAC_START: 30,     // AE Tutor Vacancy Start Date
      // AF (31) = blank â€” HARD STOP
      // cols 32-39 = blank
      // col 40 = Scholar - Pearl User ID
      // col 41 = Scholar Name
      // col 42 = School
      // col 43 = Tutor Vacancy Start Date
      // col 44 = First Attended Date
      // col 45 = Last Attended Date
      VACANCY_FLAG: 46,  // AG Vacancy Flag  ("Current Vacancy...")
      // col 47 = Active Flag
    };
    const ATT_MAX_COL = 31; // read through col AF (idx 31), ignore rest

    // â”€â”€ COLUMN INDEXES â€” SESSION DETAILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SESS = {
      TITLE: 0,       // A  Title
      INSTRUCTOR: 1,  // B  Instructor name
      STUDENTS: 2,    // C  Student names (comma-separated)
      LOCATION: 3,    // D  Location
      STATUS: 4,      // E  Status
      ATTENDANCE: 5,  // F  Attendance summary
      START: 6,       // G  Scheduled Start (datetime)
      SCHED_DUR: 7,   // H  Scheduled Duration
      ACTUAL_DUR: 8,  // I  Actual Duration
      SUBJECT: 9,     // J  Subject
      GRADE: 10,      // K  Grade
      SCHOOL: 11,     // L  School
      DISTRICT: 12,   // M  District
      REGION: 13,     // N  Region
      SESS_ID: 14,    // O  Pearl Session ID
      INST_ID: 15,    // P  Pearl Instructor ID
      STU_IDS: 16,    // Q  Pearl Student IDs (comma-separated)
      SESS_PER_SCHOOL: 17, // R  Sessions Delivered Per School
      TOTAL_SESS: 19, // T  Total Sessions Delivered
      TOTAL_SUCCESS: 20, // U  Total Successful Sessions
      TOTAL_MISS_STU: 21, // V  Total Missed Sessions by Scholar
      TOTAL_MISS_INST: 22,// W  Total Missed Sessions by Instructor
    };

    // â”€â”€ COLUMN INDEXES â€” STUDENT SURVEYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const STU_S = {
      FILLED_BY: 0, FILLED_FOR: 1,
      CONFIDENCE: 2, ENJOYMENT: 3, LEARNING: 4, OVERALL: 5,
      COMMENT: 6, DATE: 7, SCHOOL: 8, DISTRICT: 9, REGION: 10,
      SESS_ID: 11, FILLED_BY_ID: 12, FILLED_FOR_ID: 13,
      AVG_CONF: 14, AVG_ENJOY: 15, AVG_LEARN: 16, AVG_OVERALL: 17,
      CLUMP_CONF: 18, CLUMP_ENJOY: 19, CLUMP_LEARN: 20, CLUMP_OVERALL: 21,
      WEEK: 22,
    };

    // â”€â”€ COLUMN INDEXES â€” INSTRUCTOR SURVEYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const INST_S = {
      FILLED_BY: 0, FILLED_FOR: 1,
      ENGAGEMENT: 2, ENJOYMENT: 3, LEARNING: 4, OVERALL: 5,
      COMMENT_ADMIN: 6, COMMENT_SELF: 7,
      DATE: 8, SCHOOL: 9, DISTRICT: 10,
      SESS_ID: 11, FILLED_BY_ID: 12, FILLED_FOR_ID: 13,
      COMMENT_BANK: 14,
      AVG_ENGAGE: 15, AVG_ENJOY: 16, AVG_LEARN: 17, AVG_OVERALL: 18,
      CLUMP_ENGAGE: 19, CLUMP_ENJOY: 20, CLUMP_LEARN: 21, CLUMP_OVERALL: 22,
      WEEK: 23,
    };

    // â”€â”€ WEEK DERIVATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // The new raw sheet has no pre-computed Week column.
    // We derive the week label from Session Date (col F / idx 5).
    // CSV dates arrive as strings: "2/20/2026", "2026-02-20", or similar.
    // We normalise to ISO "YYYY-Www" for sorting and group display as "Week of MM/DD".
    function weekKeyFromDateStr(dateStr) {
      if (!dateStr) return '';
      // Try to parse the date string
      let d = new Date(dateStr);
      // Fallback: handle MM/DD/YYYY
      if (isNaN(d.getTime())) {
        const m = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (m) d = new Date(+m[3], +m[1]-1, +m[2]);
      }
      if (isNaN(d.getTime())) return dateStr; // unparseable â€” return raw
      // Get Monday of the week
      const day = d.getDay(); // 0=Sun
      const diff = (day === 0) ? -6 : 1 - day; // adjust to Monday
      const mon = new Date(d);
      mon.setDate(d.getDate() + diff);
      // ISO week label: YYYY-Www for sort, display as "Week of M/D"
      const mm = String(mon.getMonth()+1).padStart(2,'0');
      const dd = String(mon.getDate()).padStart(2,'0');
      const yyyy = mon.getFullYear();
      // Pad ISO week for correct sort
      const isoWeek = getISOWeek(mon);
      return `${yyyy}-W${String(isoWeek).padStart(2,'0')}`; // YYYY-W## â†’ sorts correctly
    }
    function weekDisplayFromKey(key) {
      // Convert "2026-W08" â†’ "Week of 2/16" etc.
      if (!key || !key.startsWith('20')) return key;
      // Reconstruct Monday date from ISO week
      try {
        const [year, wStr] = key.split('-W');
        const y = +year, w = +wStr;
        // Jan 4 is always in week 1
        const jan4 = new Date(y, 0, 4);
        const jan4Day = jan4.getDay() || 7;
        const weekStart = new Date(jan4);
        weekStart.setDate(jan4.getDate() - (jan4Day - 1) + (w - 1) * 7);
        return `Week of ${weekStart.getMonth()+1}/${weekStart.getDate()}`;
      } catch { return key; }
    }
    function getISOWeek(d) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }
    // Attended counts: actual Attended/Late status AND these miss reasons
    const COUNTS_AS_ATTENDED = new Set([
      'Tutor Left Early (no sub)',
      'Scholar Left Early',
      'Classroom Teacher Requested to Keep Scholar in Class',
      'HADDON TWP ONLY -- Teacher requested whole group support',
    ]);
    const ABSENT_REASONS = new Set([
      'Absent','Absent; Covered by Dual Role','Absent; Covered by Sub Tutor',
      'Absent; Covered by the Instructional Coach','Absent; Covered by the Site Leader',
      'Absent; Not Covered (Tutor not available)','Tutor Absent',
      // Counts against attendance AND triggers a Program Team flag (see buildIndexes)
      'Scholar declined attending tutoring session',
      // 'Tutor Vacancy' is intentionally NOT here â€” it must NOT affect attendance rates.
      // It is classified as a high-severity service interruption below.
    ]);
    // Declined sessions: tracked separately so we can flag patterns for Programming
    const DECLINED_REASON = 'Scholar declined attending tutoring session';
    // Everything else that's a missed session = service interruption
    const SI_SEVERITY = {
      'NJTC Internal Issue/Error':                  'critical',
      'Tutor Vacancy':                              'high',    // staffing gap â€” excluded from attendance; flag HR + Programming + Leadership
      'Scholar Archived - Removed from Sessions':   'high',
      'Unscheduled School Closure/Delay/Dismissal': 'high',
      'NJTC Diagnostic Testing':                    'medium',
      'School-administered Testing':                'medium',
      'School Event':                               'medium',
      'Scheduled/Unscheduled School Drill':         'medium',
      'HADDON TWP ONLY -- Program Redevelopment':   'medium',
      'Half Day':                                   'low',
      'Holiday - scheduled':                        'low',
      // 'Scholar declined attending tutoring session' intentionally removed â€”
      // counts as an absence (impacts attendance) and flags Program Team instead.
    };

    function classifyRecord(r) {
      const attStat   = r[ATT.ATT_STATUS]  || '';
      const missReason = r[ATT.MISS_REASON] || '';
      if (attStat === 'Attended' || attStat === 'Late')      return 'attended';
      if (COUNTS_AS_ATTENDED.has(missReason))                 return 'attended';
      if (attStat === 'Not recorded')                        return 'not_recorded';
      if (ABSENT_REASONS.has(missReason))                    return 'absent';
      if (missReason && SI_SEVERITY[missReason])             return 'service_interruption';
      if (missReason)                                        return 'service_interruption'; // catch-all
      return 'other';
    }

    function getSISeverity(reason) {
      return SI_SEVERITY[reason] || 'medium';
    }

    // â”€â”€ COMMENT CATEGORIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const COMMENT_BUCKETS = {
      concern:    { label: 'Concern', css: 'concern',    keywords: ['concern','problem','issue','struggle','difficult','hard','poor','bad','confused','distract','behavior','not understand','behind','worry','fail'] },
      positive:   { label: 'Positive Feedback', css: 'positive',  keywords: ['great','excellent','amazing','wonderful','good','enjoyed','love','fantastic','perfect','best','happy','engaged','excited','helpful','fun'] },
      engagement: { label: 'Engagement', css: 'engagement', keywords: ['engage','participat','attention','focus','interest','active','involv','motivat','enthusias','energy'] },
      logistics:  { label: 'Logistics', css: 'logistics',  keywords: ['late','time','reschedul','cancel','interrup','delay','technolog','zoom','link','access','material','room','space','tool'] },
      curriculum: { label: 'Curriculum', css: 'curriculum', keywords: ['lesson','curriculum','material','content','topic','math','reading','ela','english','skill','standard','objective','worksheet','practice'] },
      relationship: { label: 'Relationship', css: 'relationship', keywords: ['rapport','relationship','bond','trust','comfort','familiar','personali','know','connect','feel safe','individual'] },
    };

    function categorizeComment(text) {
      if (!text || !text.trim()) return null;
      const lower = text.toLowerCase();
      let best = null, bestScore = 0;
      for (const [key, {keywords}] of Object.entries(COMMENT_BUCKETS)) {
        const score = keywords.filter(kw => lower.includes(kw)).length;
        if (score > bestScore) { bestScore = score; best = key; }
      }
      return best || 'other';
    }

    // â”€â”€ ROLE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function role() {
      const d = typeof _currentDept !== 'undefined' ? _currentDept
              : (window.NJTC_SESSION ? window.NJTC_SESSION.dept : '');
      return (d || 'leadership').toLowerCase();
    }
    const isData       = () => ['data','leadership'].includes(role());
    const isHR         = () => ['hr','leadership','data'].includes(role());
    const isFinance    = () => ['finance','leadership','data'].includes(role());
    const isProg       = () => ['programming','leadership','data'].includes(role());
    const isTD         = () => ['training_development','leadership','data'].includes(role());
    const canSeeNames  = () => ['leadership','data','hr','programming','training_development'].includes(role());
    const canSeeIndiv  = () => ['leadership','data','hr','programming'].includes(role());

    // â”€â”€ RFC-4180 CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parseCSV(text) {
      const rows = []; let row = [], f = '', inQ = false;
      const src = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      for (let i=0; i<src.length; i++) {
        const ch = src[i];
        if (inQ) {
          if (ch==='"') { if (src[i+1]==='"') {f+='"'; i++;} else inQ=false; }
          else f+=ch;
        } else {
          if (ch==='"') inQ=true;
          else if (ch===',') { row.push(f.trim()); f=''; }
          else if (ch==='\n') { row.push(f.trim()); f=''; rows.push(row); row=[]; }
          else f+=ch;
        }
      }
      if (f.trim()||row.length) { row.push(f.trim()); rows.push(row); }
      return rows;
    }

    function parseCSVLimit(text, maxCol) {
      // Same parser but trims each row to maxCol+1 columns
      const full = parseCSV(text);
      return full.map(row => row.slice(0, maxCol+1));
    }

    // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _attRows  = [];   // parsed attendance (cols Aâ€“AF only)
    let _sessRows = [];   // parsed session details
    let _stuRows  = [];   // parsed student surveys
    let _instRows = [];   // parsed instructor surveys

    // Derived indexes (built once after all tabs load)
    let _schoolMap   = {};  // school â†’ {att, sess, stu, inst, ...}
    let _personMap   = {};  // userId â†’ person object
    let _sessMap     = {};  // sessionId â†’ session object
    let _gidsResolved = false;

    let _lastFetch = null;
    let _loading   = false;
    let _inited    = false;

    // View state
    let _view       = 'schools'; // 'schools' | 'school' | 'person'
    let _selSchool  = null;
    let _selPerson  = null;
    let _activeTab  = 'attendance';
    let _filtDistrict = '';
    let _filtSchool   = '';
    let _filtWeek     = '';
    let _filtRole     = '';
    let _filtFlag     = '';

    // â”€â”€ GID RESOLUTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ GID RESOLUTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Google assigns arbitrary large gid integers to each tab â€” they are NOT
    // sequential (0,1,2,3). The pubhtml page for the workbook is publicly
    // accessible and contains all real gid values in its HTML.
    //
    // Strategy:
    //   1. Fetch the pubhtml page (no auth required â€” same as the CSV URLs)
    //   2. Extract all gid= numbers from the HTML using a regex
    //   3. Fetch each discovered gid as CSV in parallel
    //   4. Identify each tab by its header row content
    //   5. Cache result so we never re-probe within a session
    async function resolveGids() {
      if (_gidsResolved) return true;

      // Step 1: fetch the pubhtml index to discover real gid values
      let probedGids = [];
      try {
        const pubhtmlUrl = `https://docs.google.com/spreadsheets/d/e/${BASE_ID}/pubhtml`;
        const res = await fetch(pubhtmlUrl, { signal: AbortSignal.timeout(12000) });
        if (res.ok) {
          const html = await res.text();
          // Extract all numeric gid values from href/data attributes in the HTML
          const matches = [...html.matchAll(/[?&]gid=(\d+)/g)];
          const found = [...new Set(matches.map(m => parseInt(m[1], 10)))].filter(n => !isNaN(n));
          if (found.length) probedGids = found;
          console.log('[Pearl Ops] Discovered gids from pubhtml:', found);
        }
      } catch(e) {
        console.warn('[Pearl Ops] pubhtml probe failed, will try fallback gids:', e.message);
      }

      // Step 2: if pubhtml didn't yield gids, fall back to a broad sweep of
      // common Google Sheets gid patterns. Includes known gid from edit URL.
      if (!probedGids.length) {
        probedGids = [0, 1, 2, 3,
                      1748668439,          // known gid from edit URL provided
                      628127573, 274671201, 1372188422, 1640135663,
                      1303503567, 1649760609, 1978724299, 1784717262,
                      100, 200, 300, 400, 500, 600, 700, 800];
      }

      // Step 3: fetch each candidate gid as CSV â€” in parallel, ignore 400s
      const results = await Promise.all(probedGids.map(async gid => {
        try {
          const res = await fetch(csvUrl(gid) + '&t=' + Date.now(), {signal: AbortSignal.timeout(12000)});
          if (!res.ok) return null;
          const text = await res.text();
          const firstRow = text.split('\n')[0].toLowerCase().replace(/"/g, '');
          return { gid, text, firstRow };
        } catch { return null; }
      }));

      // Step 4: identify each tab by its unique header signature
      // New sheet (raw data) tab headers:
      //   Missed Reasons:     "user,role,session,session status,...,pearl user id"
      //   Instructor Surveys: "filled by,filled for,how engaged were..."
      //   Student Surveys:    "filled by,filled for,how confident are you..."
      //   Session Details:    "title,instructor,students,...,pearl session id,pearl instructor id"
      for (const r of results) {
        if (!r) continue;
        const h = r.firstRow;
        // Attendance/Missed Reasons: starts with "user" and has "role" and "attendance"
        if      (h.startsWith('user,') && h.includes('role,') && h.includes('attendance'))
          GIDS.att  = r.gid;
        // Instructor Surveys: "filled by" + engaged (instructor question)
        else if (h.startsWith('filled by,') && h.includes('engaged'))
          GIDS.inst = r.gid;
        // Student Surveys: "filled by" + confident (student question)
        else if (h.startsWith('filled by,') && h.includes('confident'))
          GIDS.stu  = r.gid;
        // Session Details: "title" + "instructor" + "pearl session id"
        else if (h.startsWith('title,') && h.includes('instructor') && h.includes('pearl session id'))
          GIDS.sess = r.gid;
      }

      // Log what was resolved (helps with future debugging)
      console.log('[Pearl Ops] GIDs resolved â†’', JSON.stringify(GIDS));

      // If any tab still unresolved, log a clear error rather than silently failing
      for (const [tab, gid] of Object.entries(GIDS)) {
        if (gid === null) console.error(`[Pearl Ops] Could not resolve gid for tab: ${tab}`);
      }

      _gidsResolved = true;
      return Object.values(GIDS).some(v => v !== null); // at least one resolved
    }

    // â”€â”€ FETCH ALL TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refresh(force = false) {
      if (_loading) return;
      _loading = true;
      setSyncState('loading');
      const btn = document.getElementById('poRefreshBtn');
      if (btn) btn.disabled = true;
      try {
        await resolveGids();
        const bust = force ? '&t=' + Date.now() : '';
        const [attText, instText, stuText, sessText] = await Promise.all([
          fetchTab(GIDS.att,  bust), fetchTab(GIDS.inst, bust),
          fetchTab(GIDS.stu,  bust), fetchTab(GIDS.sess, bust),
        ]);
        // Attendance Detail â€” read through col AF (idx 31), ignore rest
        _attRows  = parseCSVLimit(attText,  ATT_MAX_COL).slice(1);  // skip header
        _sessRows = parseCSV(sessText).slice(1);
        _stuRows  = parseCSV(stuText).slice(1);
        _instRows = parseCSV(instText).slice(1);
        _lastFetch = new Date();
        buildIndexes();
        setSyncState('live');
        populateFilters();
        renderView();
      } catch(e) {
        console.warn('[Pearl Ops] Fetch failed:', e.message);
        setSyncState('error');
      }
      if (btn) btn.disabled = false;
      _loading = false;
    }

    async function fetchTab(gid, bust) {
      if (gid === null) return '';   // tab gid was not resolved â€” return empty, skip silently
      const res = await fetch(csvUrl(gid) + bust, {signal: AbortSignal.timeout(15000)});
      if (!res.ok) throw new Error('HTTP ' + res.status + ' for tab gid=' + gid);
      return res.text();
    }

    // â”€â”€ BUILD INDEXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildIndexes() {
      _schoolMap = {}; _personMap = {}; _sessMap = {};

      // â”€â”€ Session index â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      for (const r of _sessRows) {
        if (!r[SESS.SESS_ID]) continue;
        const sid = r[SESS.SESS_ID];
        const stuIds = (r[SESS.STU_IDS] || '').split(',').map(s => s.trim()).filter(Boolean);
        const ratio = stuIds.length;
        _sessMap[sid] = {
          id: sid, title: r[SESS.TITLE], instructor: r[SESS.INSTRUCTOR],
          instId: r[SESS.INST_ID], studentIds: stuIds,
          students: r[SESS.STUDENTS], location: r[SESS.LOCATION],
          status: r[SESS.STATUS], attendance: r[SESS.ATTENDANCE],
          start: r[SESS.START], schedDur: r[SESS.SCHED_DUR],
          actualDur: r[SESS.ACTUAL_DUR], subject: r[SESS.SUBJECT],
          grade: r[SESS.GRADE], school: r[SESS.SCHOOL], district: r[SESS.DISTRICT],
          ratio,
          ratioFlag: ratioFlag: ratio > 4,  // HIT: must be â‰¤ 4:1 (flag, MOU governs)
        };
      }

      // â”€â”€ Student survey index by sessionId â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const stuSurveyBySess = {};
      for (const r of _stuRows) {
        const sid = r[STU_S.SESS_ID];
        if (!stuSurveyBySess[sid]) stuSurveyBySess[sid] = [];
        stuSurveyBySess[sid].push(r);
      }

      // â”€â”€ Instructor survey index by sessionId â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const instSurveyBySess = {};
      for (const r of _instRows) {
        const sid = r[INST_S.SESS_ID];
        if (!instSurveyBySess[sid]) instSurveyBySess[sid] = [];
        instSurveyBySess[sid].push(r);
      }

      // â”€â”€ Person index from attendance rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const personWeekSessions = {}; // userId â†’ { week â†’ attended count }

      for (const r of _attRows) {
        if (!r[ATT.USER_ID]) continue;
        const uid = r[ATT.USER_ID];
        const school = r[ATT.SCHOOL] || '';
        const district = r[ATT.DISTRICT] || '';
        const week = r[ATT.WEEK] || '';
        const cls = classifyRecord(r);
        const missReason = r[ATT.MISS_REASON] || '';

        if (!_personMap[uid]) {
          _personMap[uid] = {
            uid, name: r[ATT.USER] || uid, role: r[ATT.ROLE],
            school, district, grade: r[ATT.GRADE],
            sex: r[ATT.SEX], race: r[ATT.RACE],
            attended: 0, absent: 0, interruptions: 0, notRecorded: 0,
            totalRows: 0, indAttRate: r[ATT.IND_ATT_RATE] || '',
            consecStatus: r[ATT.CONSEC_STATUS] || '',
            vacantId: r[ATT.VACANT_ID] || '',
            rows: [],
            instructorIds: new Set(),  // for continuity HIT check
            flags: [],
          };
        }
        const p = _personMap[uid];
        p.totalRows++;
        p.rows.push(r);
        if (cls === 'attended')             p.attended++;
        else if (cls === 'absent')          p.absent++;
        else if (cls === 'service_interruption') p.interruptions++;
        else if (cls === 'not_recorded')    p.notRecorded++;

        // Track weeks with attended sessions for HIT frequency check (students only)
        if (cls === 'attended' && r[ATT.ROLE] === 'Student') {
          if (!personWeekSessions[uid]) personWeekSessions[uid] = {};
          personWeekSessions[uid][week] = (personWeekSessions[uid][week] || 0) + 1;
        }

        // School aggregation
        if (!_schoolMap[school]) initSchool(school, district);
        const sc = _schoolMap[school];
        sc.rows.push(r);
        if (r[ATT.ROLE] === 'Student') {
          sc.totalStudentRows++;
          if (cls === 'attended')             sc.stuAttended++;
          else if (cls === 'absent')          sc.stuAbsent++;
          else if (cls === 'service_interruption') { sc.stuInterruptions++; sc.siReasons.push(missReason); }
          else if (cls === 'not_recorded')    sc.notRecorded++;
        } else {
          sc.totalInstRows++;
          if (cls === 'attended')             sc.instAttended++;
          else if (cls === 'absent')          sc.instAbsent++;
          else if (cls === 'service_interruption') sc.instInterruptions++;
        }
      }

      // â”€â”€ Link sessions to schools and instructor IDs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      for (const sess of Object.values(_sessMap)) {
        if (!sess.school) continue;
        if (!_schoolMap[sess.school]) initSchool(sess.school, sess.district);
        const sc = _schoolMap[sess.school];
        sc.sessions.push(sess);

        // Track instructor IDs per student for continuity check
        for (const stuId of sess.studentIds) {
          if (_personMap[stuId]) {
            _personMap[stuId].instructorIds.add(sess.instId);
          }
        }
      }

      // â”€â”€ Build HIT compliance flags per person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      for (const [uid, p] of Object.entries(_personMap)) {
        if (p.role === 'Student') {
          // Flag: consecutive attendance concern (from col Y - '10 consecutive sessions missed status')
          if (p.consecStatus === 'Attendance Concern')
            p.flags.push({ type:'consecutive', severity:'high', msg:'10+ consecutive sessions missed â€” attendance concern' });

          // Flag: tutor continuity (multiple instructors)
          if (p.instructorIds.size > 1)
            p.flags.push({ type:'continuity', severity:'medium', msg:`${p.instructorIds.size} different instructors â€” rapport continuity concern` });

          // Flag: low attendance (< 70%)
          const total = p.attended + p.absent;
          if (total > 0 && (p.attended / total) < 0.70)
            p.flags.push({ type:'low_att', severity:'high', msg:`Attendance below 70% â€” verify ADP records (${Math.round(p.attended/total*100)}%)` });

          // Flag: vacancy â€” from col AC (Pearl Vacant User ID) and col AG (Vacancy Flag)
          // NOT counted in attendance â€” staffing gap flag for HR + Programming + Leadership
          if (p.vacantId)
            p.flags.push({ type:'vacancy', severity:'high', msg:'Tutor vacancy active â€” staffing gap requires follow-up (HR, Programming)' });

          // Flag: scholar declined sessions â€” counts as absent AND flags Program Team
          // Count how many of this scholar's rows are a decline
          const declineCount = p.rows.filter(r => (r[ATT.MISS_REASON] || '') === DECLINED_REASON).length;
          if (declineCount > 0)
            p.flags.push({
              type: 'declined', severity: declineCount >= 3 ? 'high' : 'medium',
              audience: 'Programming',
              msg: `Scholar declined ${declineCount} session${declineCount > 1 ? 's' : ''} â€” Program Team follow-up needed (engagement/re-enrollment review)`,
            });

          // Flag: weekly frequency
          if (personWeekSessions[uid]) {
            const belowMin = Object.values(personWeekSessions[uid]).filter(c => c < 2).length;
            const totalWeeks = Object.keys(personWeekSessions[uid]).length;
            if (belowMin > 0 && totalWeeks > 0)
              p.flags.push({ type:'frequency', severity:'medium', msg:`${belowMin} of ${totalWeeks} attended weeks below 2 sessions (HIT minimum)` });
          }
        }

        if (p.role === 'Instructor') {
          const total = p.attended + p.absent;
          if (total > 0 && (p.attended / total) < 0.80)
            p.flags.push({ type:'inst_att', severity:'high', msg:`Instructor attendance below 80% â€” verify ADP records (${Math.round(p.attended/total*100)}%)` });
        }
      }

      // â”€â”€ Link survey data to persons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Student surveys: link by filledByID (student who responded)
      const stuSurveyByUser = {};
      for (const r of _stuRows) {
        const uid = r[STU_S.FILLED_BY_ID];
        if (!stuSurveyByUser[uid]) stuSurveyByUser[uid] = [];
        stuSurveyByUser[uid].push(r);
      }
      const instSurveyByUser = {};
      for (const r of _instRows) {
        const uid = r[INST_S.FILLED_BY_ID];
        if (!instSurveyByUser[uid]) instSurveyByUser[uid] = [];
        instSurveyByUser[uid].push(r);
      }
      for (const [uid, p] of Object.entries(_personMap)) {
        p.stuSurveys  = stuSurveyByUser[uid]  || [];
        p.instSurveys = instSurveyByUser[uid] || [];
      }

      // â”€â”€ Build school survey aggregates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      for (const [school, sc] of Object.entries(_schoolMap)) {
        // Student surveys
        const stuRows = _stuRows.filter(r => r[STU_S.SCHOOL] === school);
        sc.stuSurveyAvg = avgSurvey(stuRows, [STU_S.CONFIDENCE, STU_S.ENJOYMENT, STU_S.LEARNING, STU_S.OVERALL]);
        sc.stuSurveyRows = stuRows;
        // Instructor surveys
        const instRows = _instRows.filter(r => r[INST_S.SCHOOL] === school);
        sc.instSurveyAvg = avgSurvey(instRows, [INST_S.ENGAGEMENT, INST_S.ENJOYMENT, INST_S.LEARNING, INST_S.OVERALL]);
        sc.instSurveyRows = instRows;

        // School-level HIT flags
        sc.ratioViolations = sc.sessions.filter(s => s.ratioFlag).length;
        if (sc.ratioViolations > 0)
          sc.flags.push({ type:'ratio', severity:'medium', msg:`${sc.ratioViolations} sessions exceed 1:4 ratio â€” check MOU` });
        const criticalSI  = sc.siReasons.filter(r => getSISeverity(r) === 'critical').length;
        const vacancySI   = sc.siReasons.filter(r => r === 'Tutor Vacancy').length;
        const otherHighSI = sc.siReasons.filter(r => getSISeverity(r) === 'high' && r !== 'Tutor Vacancy').length;
        if (criticalSI > 0)
          sc.flags.push({ type:'critical_si', severity:'critical', msg:`${criticalSI} NJTC Internal Issues require immediate review` });
        if (vacancySI > 0)
          // Vacancy is NOT counted in attendance â€” it is a staffing gap flag for HR, Programming, and Leadership
          sc.flags.push({ type:'vacancy_si', severity:'high', audience:'HR Â· Programming Â· Leadership', msg:`${vacancySI} sessions impacted by tutor vacancy â€” backfill action required` });
        if (otherHighSI > 0)
          sc.flags.push({ type:'high_si', severity:'high', msg:`${otherHighSI} high-severity interruptions (closures / archived scholars)` });

        // Declined sessions: count across all student rows for this school
        // Declines count as absences in attendance AND surface to Programming
        const declinedCount = sc.rows.filter(r => r[ATT.ROLE] === 'Student' && (r[ATT.MISS_REASON] || '') === DECLINED_REASON).length;
        if (declinedCount > 0)
          sc.flags.push({ type:'declined', severity: declinedCount >= 5 ? 'high' : 'medium', audience:'Programming', msg:`${declinedCount} scholar-declined session${declinedCount > 1 ? 's' : ''} â€” Program Team engagement review needed` });

        // Attendance rate for school
        sc.attRate = sc.totalStudentRows > 0
          ? Math.round(sc.stuAttended / (sc.stuAttended + sc.stuAbsent + sc.stuInterruptions) * 100) : 0;
      }

      // Update global flags badge
      updateFlagsBadge();
    }

    function initSchool(school, district) {
      _schoolMap[school] = {
        school, district, rows: [],
        totalStudentRows: 0, stuAttended: 0, stuAbsent: 0, stuInterruptions: 0, notRecorded: 0,
        totalInstRows: 0, instAttended: 0, instAbsent: 0, instInterruptions: 0,
        sessions: [], siReasons: [], flags: [],
        stuSurveyAvg: 0, instSurveyAvg: 0, stuSurveyRows: [], instSurveyRows: [],
        attRate: 0, ratioViolations: 0,
      };
    }

    function avgSurvey(rows, cols) {
      let sum = 0, cnt = 0;
      for (const r of rows) {
        for (const c of cols) {
          const v = parseFloat(r[c]);
          if (!isNaN(v)) { sum += v; cnt++; }
        }
      }
      return cnt > 0 ? (sum / cnt) : 0;
    }

    // â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyFilters() {
      _filtDistrict = (document.getElementById('poFDistrict')||{}).value || '';
      _filtSchool   = (document.getElementById('poFSchool')||{}).value   || '';
      _filtWeek     = (document.getElementById('poFWeek')||{}).value     || '';
      _filtRole     = (document.getElementById('poFRole')||{}).value     || '';
      _filtFlag     = (document.getElementById('poFFlag')||{}).value     || '';
      if (_filtSchool && _view === 'schools') { drillSchool(_filtSchool); return; }
      renderView();
    }

    function clearFilters() {
      ['poFDistrict','poFSchool','poFWeek','poFRole','poFFlag']
        .forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
      _filtDistrict = _filtSchool = _filtWeek = _filtRole = _filtFlag = '';
      renderView();
    }

    function populateFilters() {
      function pop(id, vals) {
        const el = document.getElementById(id); if (!el) return;
        const cur = el.value, first = el.options[0] ? el.options[0].outerHTML : '';
        el.innerHTML = first + [...vals].filter(Boolean).sort()
          .map(v => `<option value="${v}">${v}</option>`).join('');
        if ([...el.options].some(o => o.value === cur)) el.value = cur;
      }
      pop('poFDistrict', new Set(_attRows.map(r => r[ATT.DISTRICT])));
      pop('poFSchool',   new Set(_attRows.map(r => r[ATT.SCHOOL])));
      const weeks = new Set(_attRows.map(r => r[ATT.WEEK]).filter(Boolean));
      pop('poFWeek', [...weeks].sort((a,b) => {
        const na = parseInt(a.replace('Week ','')), nb = parseInt(b.replace('Week ',''));
        return na - nb;
      }).reduce((m,v) => {m.add(v);return m;}, new Set()));
    }

    // â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateStats() {
      const rows = filteredAttRows();

      // â”€â”€ Scholar attendance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Always calculated from ALL scholar rows matching school/district/week filters
      // (not the role filter, so it shows even when Instructor is selected)
      const allScholarRows = _attRows.filter(r => {
        if (r[ATT.ROLE] !== 'Student') return false;
        if (!matchesSchoolFilter(r[ATT.SCHOOL], r[ATT.DISTRICT])) return false;
        if (_filtWeek && r[ATT.WEEK] !== _filtWeek) return false;
        return true;
      });
      const stuAtt  = allScholarRows.filter(r => classifyRecord(r) === 'attended').length;
      const stuAbs  = allScholarRows.filter(r => classifyRecord(r) === 'absent').length;
      const stuTotal = stuAtt + stuAbs;
      const stuAttPct = stuTotal > 0 ? (stuAtt / stuTotal * 100).toFixed(1) + '%' : 'â€”';

      // â”€â”€ Tutor attendance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Always calculated from ALL instructor rows matching school/district/week filters
      const allInstRows = _attRows.filter(r => {
        if (r[ATT.ROLE] !== 'Instructor') return false;
        if (!matchesSchoolFilter(r[ATT.SCHOOL], r[ATT.DISTRICT])) return false;
        if (_filtWeek && r[ATT.WEEK] !== _filtWeek) return false;
        return true;
      });
      const instAtt  = allInstRows.filter(r => classifyRecord(r) === 'attended').length;
      const instAbs  = allInstRows.filter(r => classifyRecord(r) === 'absent').length;
      const instTotal = instAtt + instAbs;
      const instAttPct = instTotal > 0 ? (instAtt / instTotal * 100).toFixed(1) + '%' : 'â€”';

      // â”€â”€ Service interruptions (student rows only for display) â”€â”€â”€â”€â”€â”€
      const si = allScholarRows.filter(r => classifyRecord(r) === 'service_interruption').length;

      // â”€â”€ Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const filtSess = filteredSessions();
      const completed = filtSess.filter(s => s.status === 'Completed').length;
      const totalSess = filtSess.length;

      // â”€â”€ Scholar survey avg (from student survey rows, filtered by school) â”€â”€
      // Uses raw score columns: CONFIDENCE, ENJOYMENT, LEARNING, OVERALL (cols 2-5)
      const stuSurvRows = _stuRows.filter(r => matchesSchoolFilter(r[STU_S.SCHOOL], r[STU_S.DISTRICT]));
      const stuSurvScores = [];
      for (const r of stuSurvRows) {
        [STU_S.CONFIDENCE, STU_S.ENJOYMENT, STU_S.LEARNING, STU_S.OVERALL].forEach(c => {
          const v = parseFloat(r[c]); if (!isNaN(v) && v > 0) stuSurvScores.push(v);
        });
      }
      const stuSurvAvg = stuSurvScores.length
        ? (stuSurvScores.reduce((a,b)=>a+b,0)/stuSurvScores.length).toFixed(2)
        : 'â€”';

      // â”€â”€ Tutor survey avg (from instructor survey rows, filtered by school) â”€â”€
      // Uses raw score columns: ENGAGEMENT, ENJOYMENT, LEARNING, OVERALL (cols 2-5)
      const instSurvRows = _instRows.filter(r => matchesSchoolFilter(r[INST_S.SCHOOL], r[INST_S.DISTRICT]));
      const instSurvScores = [];
      for (const r of instSurvRows) {
        [INST_S.ENGAGEMENT, INST_S.ENJOYMENT, INST_S.LEARNING, INST_S.OVERALL].forEach(c => {
          const v = parseFloat(r[c]); if (!isNaN(v) && v > 0) instSurvScores.push(v);
        });
      }
      const instSurvAvg = instSurvScores.length
        ? (instSurvScores.reduce((a,b)=>a+b,0)/instSurvScores.length).toFixed(2)
        : 'â€”';

      // â”€â”€ HIT flags (school-filtered) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let hitFlags = 0;
      for (const p of Object.values(_personMap)) {
        if (matchesSchoolFilter(p.school, p.district)) hitFlags += p.flags.length;
      }

      setText('poStatAtt',           stuAttPct);
      setText('poStatInstAtt',       instAttPct);
      setText('poStatSessions',      completed.toLocaleString());
      setText('poStatSessionsSub',   `of ${totalSess.toLocaleString()} scheduled`);
      setText('poStatInterruptions', si.toLocaleString());
      setText('poStatSurveyScholar', stuSurvAvg === 'â€”' ? 'â€”' : 'â˜… ' + stuSurvAvg);
      setText('poStatSurveyTutor',   instSurvAvg === 'â€”' ? 'â€”' : 'â˜… ' + instSurvAvg);
      setText('poStatFlags',         hitFlags.toLocaleString());
    }

    function updateFlagsBadge() {
      const critCount = Object.values(_schoolMap)
        .flatMap(sc => sc.flags).filter(f => f.severity === 'critical').length
        + Object.values(_personMap).flatMap(p => p.flags || []).filter(f => f.severity === 'critical').length;

      const totalFlags = Object.values(_schoolMap).flatMap(sc => sc.flags).length
        + Object.values(_personMap).flatMap(p => p.flags || []).length;

      const badge = document.getElementById('pearlFlagsBadge');
      if (badge) {
        badge.style.display = totalFlags > 0 ? '' : 'none';
        badge.textContent = totalFlags;
      }
      const critBtn = document.getElementById('poCriticalBtn');
      if (critBtn) {
        critBtn.style.display = critCount > 0 ? '' : 'none';
        setText('poCriticalN', critCount);
      }
    }

    // â”€â”€ FILTERED DATA HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function matchesSchoolFilter(school, district) {
      if (_filtDistrict && district !== _filtDistrict) return false;
      if (_filtSchool   && school   !== _filtSchool)   return false;
      return true;
    }

    function filteredAttRows() {
      return _attRows.filter(r => {
        if (!matchesSchoolFilter(r[ATT.SCHOOL], r[ATT.DISTRICT])) return false;
        if (_filtWeek && r[ATT.WEEK] !== _filtWeek) return false;
        if (_filtRole && r[ATT.ROLE] !== _filtRole) return false;
        if (_filtFlag === 'hit') {
          const p = _personMap[r[ATT.USER_ID]];
          return p && p.flags && p.flags.length > 0;
        }
        if (_filtFlag === 'si') return classifyRecord(r) === 'service_interruption';
        if (_filtFlag === 'concern') return r[ATT.CONSEC_STATUS] === 'Attendance Concern';
        return true;
      });
    }

    function filteredSessions() {
      return Object.values(_sessMap).filter(s =>
        matchesSchoolFilter(s.school, s.district)
      );
    }

    function filteredSchools() {
      return Object.values(_schoolMap).filter(sc =>
        (!_filtDistrict || sc.district === _filtDistrict) &&
        (!_filtSchool   || sc.school   === _filtSchool)
      );
    }

    // â”€â”€ VIEW ROUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderView() {
      updateStats();
      if (_view === 'schools')         renderSchoolGrid();
      else if (_view === 'school')     renderSchoolDetail();
      else if (_view === 'person')     renderPersonDetail();
    }

    function drillSchool(school) {
      _selSchool = school; _view = 'school'; _activeTab = 'attendance';
      const schoolObj = _schoolMap[school];
      if (schoolObj) {
        const selSchool = document.getElementById('poFSchool');
        if (selSchool) selSchool.value = school;
      }
      renderBreadcrumb();
      renderView();
    }

    function drillPerson(uid) {
      _selPerson = uid; _view = 'person'; _activeTab = 'attendance';
      renderBreadcrumb();
      renderView();
    }

    function goBack() {
      if (_view === 'person') { _view = 'school'; _selPerson = null; }
      else if (_view === 'school') { _view = 'schools'; _selSchool = null; const el = document.getElementById('poFSchool'); if(el) el.value=''; }
      renderBreadcrumb();
      renderView();
    }

    function renderBreadcrumb() {
      const el = document.getElementById('poBreadcrumb');
      if (!el) return;
      const parts = [`<a onclick="po.goBack()">All Schools</a>`];
      if (_selSchool) parts.push(`<span class="po-breadcrumb-sep">â€º</span> <a onclick="po.goBack()">${_selSchool}</a>`);
      if (_selPerson && _view === 'person') {
        const p = _personMap[_selPerson];
        const nm = canSeeNames() ? (p ? p.name : _selPerson) : 'Individual';
        parts.push(`<span class="po-breadcrumb-sep">â€º</span> <span style="color:var(--navy)">${nm}</span>`);
      }
      el.innerHTML = parts.join(' ');
      el.style.display = _view === 'schools' ? 'none' : 'flex';
    }

    // â”€â”€ SCHOOL GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSchoolGrid() {
      const mc = document.getElementById('poMainContent'); if (!mc) return;
      const schools = filteredSchools().sort((a, b) => b.attRate - a.attRate);

      const criticalSI = si => getSISeverity(si) === 'critical';
      const highSI     = si => getSISeverity(si) === 'high';

      const rows = schools.map(sc => {
        const attColor = sc.attRate >= 90 ? 'var(--met)' : sc.attRate >= 75 ? 'var(--gold)' : 'var(--notmet)';
        const siCount  = sc.stuInterruptions;
        const hasCrit  = sc.flags.some(f => f.severity === 'critical');
        const hasHigh  = sc.flags.some(f => f.severity === 'high');
        const survAvg  = sc.stuSurveyAvg > 0 ? sc.stuSurveyAvg.toFixed(1) : 'â€”';
        const flagCount = sc.flags.length;
        const schoolPersons = Object.values(_personMap).filter(p => p.school === sc.school && p.role === 'Student');
        const personFlags = schoolPersons.flatMap(p => p.flags || []).length;
        const totalFlags = flagCount + personFlags;

        return `<tr class="po-school-row${_selSchool===sc.school?' po-hl':''}" onclick="po.drillSchool('${esc(sc.school)}')">
          <td>
            <div style="font-weight:700;color:var(--navy);font-size:.875rem">${sc.school}</div>
            <div style="font-size:.75rem;color:var(--muted)">${sc.district}</div>
          </td>
          <td style="text-align:center">
            <span style="font-family:'DM Serif Display',serif;font-size:1.1rem;font-weight:700;color:${attColor}">${sc.attRate}%</span>
            <div class="po-sparkbar" style="margin:.2rem auto 0"><div class="po-sparkbar-fill" style="width:${sc.attRate}%;background:${attColor}"></div></div>
          </td>
          <td style="text-align:center">
            <span style="font-family:'DM Serif Display',serif;font-size:1rem;font-weight:700;color:var(--navy)">${sc.sessions.length}</span>
          </td>
          <td style="text-align:center">${siCount > 0 ? `<span class="po-badge ${hasCrit?'po-badge-critical':hasHigh?'po-badge-red':'po-badge-gold'}">âš ï¸ ${siCount}</span>` : '<span class="po-badge po-badge-green">âœ“ 0</span>'}</td>
          <td style="text-align:center">${sc.ratioViolations > 0 ? `<span class="po-badge po-badge-red" title="Exceeds 1:4 â€” check MOU">âš‘ ${sc.ratioViolations}</span>` : '<span class="po-badge po-badge-green">âœ“</span>'}</td>
          <td style="text-align:center"><span style="font-weight:700;color:var(--navy)">${survAvg}</span></td>
          <td style="text-align:center">${totalFlags > 0 ? `<span class="po-badge ${totalFlags>3?'po-badge-red':'po-badge-gold'}">ğŸš© ${totalFlags}</span>` : '<span class="po-badge po-badge-green">âœ“</span>'}</td>
          <td style="text-align:center">${hasCrit ? '<span class="po-severity-critical">Critical</span>' : hasHigh ? '<span class="po-severity-high">High</span>' : '<span class="po-badge po-badge-green">OK</span>'}</td>
        </tr>`;
      }).join('');

      mc.innerHTML = `
        <div class="po-detail-card">
          <div class="po-section-hd">
            School Performance Overview
            <span style="font-weight:400;font-size:.75rem;color:var(--muted)">${schools.length} schools Â· Click any row to drill down</span>
          </div>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr style="background:var(--surface-2)">
                ${['School / District','Attendance Rate','Sessions','Service Interruptions','Ratio Flags','Survey Avg','HIT Flags','Status']
                  .map(h=>`<th style="padding:.5rem .875rem;text-align:${h.includes('School')?'left':'center'};font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap">${h}</th>`).join('')}
              </thead>
              <tbody>${rows || '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--muted)">Loading school dataâ€¦</td></tr>'}</tbody>
            </table>
          </div>
        </div>`;
    }

    // â”€â”€ SCHOOL DETAIL VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSchoolDetail() {
      const mc = document.getElementById('poMainContent'); if (!mc) return;
      const sc = _schoolMap[_selSchool]; if (!sc) { renderSchoolGrid(); return; }
      const tabs = buildSchoolTabs();
      mc.innerHTML = `
        <div class="po-detail-card">
          <div class="po-section-hd">
            <div>
              <span style="font-size:.875rem;font-weight:700;color:var(--navy)">${sc.school}</span>
              <span style="font-size:.75rem;color:var(--muted);margin-left:.75rem">${sc.district}</span>
            </div>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              ${sc.flags.map(f => `<span class="po-severity-${f.severity}" title="${f.msg}">${f.msg.substring(0,40)}â€¦</span>`).join('')}
            </div>
          </div>
          <div class="po-tabs-bar" id="poSchoolTabsBar">
            ${tabs.map(t=>`<button class="po-tab${_activeTab===t.id?' po-tab-active':''}" onclick="po.switchTab('${t.id}')">${t.label}</button>`).join('')}
          </div>
          <div id="poSchoolTabContent"></div>
        </div>`;
      renderSchoolTab(_activeTab);
    }

    function buildSchoolTabs() {
      const tabs = [{ id:'attendance', label:'ğŸ“‹ Attendance' }];
      if (isProg() || isHR() || isData()) tabs.push({ id:'sessions', label:'ğŸ“… Sessions' });
      tabs.push({ id:'interruptions', label:'âš ï¸ Interruptions' });
      if (isTD() || isData()) tabs.push({ id:'surveys', label:'â­ Surveys' });
      if (isData()) tabs.push({ id:'hit', label:'ğŸš© HIT Compliance' });
      return tabs;
    }

    function switchTab(tabId) {
      _activeTab = tabId;
      // Update active tab button
      document.querySelectorAll('#poSchoolTabsBar .po-tab').forEach(btn => {
        btn.classList.toggle('po-tab-active', btn.textContent.includes(tabId) || btn.getAttribute('onclick').includes(`'${tabId}'`));
      });
      renderSchoolTab(tabId);
    }

    function renderSchoolTab(tab) {
      const el = document.getElementById('poSchoolTabContent'); if (!el) return;
      const sc = _schoolMap[_selSchool]; if (!sc) return;

      if (tab === 'attendance')     el.innerHTML = renderAttendanceTab(sc);
      else if (tab === 'sessions')  el.innerHTML = renderSessionsTab(sc);
      else if (tab === 'interruptions') el.innerHTML = renderInterruptionsTab(sc);
      else if (tab === 'surveys')   el.innerHTML = renderSurveysTab(sc);
      else if (tab === 'hit')       el.innerHTML = renderHITTab(sc);
    }

    function renderAttendanceTab(sc) {
      const persons = Object.values(_personMap)
        .filter(p => p.school === sc.school)
        .sort((a, b) => {
          const aRate = a.attended / Math.max(1, a.attended + a.absent);
          const bRate = b.attended / Math.max(1, b.attended + b.absent);
          return aRate - bRate;
        });

      const students  = persons.filter(p => p.role === 'Student');
      const instructors = persons.filter(p => p.role === 'Instructor');

      const renderPersonRow = (p) => {
        const total = p.attended + p.absent;
        const rate  = total > 0 ? Math.round(p.attended / total * 100) : 0;
        const color = rate >= 90 ? 'var(--met)' : rate >= 75 ? 'var(--gold)' : 'var(--notmet)';
        const flagCount = p.flags.length;
        const hasCrit = p.flags.some(f => f.severity === 'high' || f.severity === 'critical');
        const name = canSeeNames() ? p.name : 'â€”';
        const adpFlag = isHR() || isFinance() ? (rate < 70 ? '<span class="po-badge po-badge-red" title="Low attendance â€” verify ADP records">âš‘ Check ADP</span>' : '') : '';
        return `<tr class="po-person-row" onclick="po.drillPerson('${esc(p.uid)}')">
          <td style="font-weight:600;color:var(--navy)">${name}</td>
          <td style="color:var(--muted)">${p.grade||'â€”'}</td>
          <td style="text-align:center">
            <span style="font-weight:700;color:${color}">${rate}%</span>
            <div class="po-sparkbar" style="margin:.2rem auto 0"><div class="po-sparkbar-fill" style="width:${rate}%;background:${color}"></div></div>
          </td>
          <td style="text-align:center">${p.attended}</td>
          <td style="text-align:center">${p.absent}</td>
          <td style="text-align:center">${p.interruptions > 0 ? `<span class="po-badge po-badge-gold">${p.interruptions}</span>` : '0'}</td>
          <td>${flagCount > 0 ? `<span class="po-badge po-badge-red">ğŸš© ${flagCount} flag${flagCount>1?'s':''}</span>` : '<span class="po-badge po-badge-green">âœ“ OK</span>'}${adpFlag}</td>
          ${p.consecStatus==='Attendance Concern' ? '<td><span class="po-badge po-badge-critical">Concern</span></td>' : '<td><span class="po-badge po-badge-green">Good</span></td>'}
        </tr>`;
      };

      const thStyle = `padding:.4rem .875rem;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border)`;
      const theads = `<tr style="background:var(--surface-2)"><th style="${thStyle}">${canSeeNames()?'Name':'Scholar'}</th><th style="${thStyle}">Grade</th><th style="${thStyle};text-align:center">Att. Rate</th><th style="${thStyle};text-align:center">Attended</th><th style="${thStyle};text-align:center">Absent</th><th style="${thStyle};text-align:center">Interruptions</th><th style="${thStyle}">Flags</th><th style="${thStyle}">Consec.</th></tr>`;

      return `
        <div style="padding:1.25rem 1.5rem 0">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.875rem;margin-bottom:1.25rem">
            ${[
              ['Scholar Attendance', `${sc.attRate}%`, sc.attRate>=90?'var(--met)':sc.attRate>=75?'var(--gold)':'var(--notmet)'],
              ['Attended Sessions', sc.stuAttended.toLocaleString(), 'var(--met)'],
              ['Student Absences', sc.stuAbsent.toLocaleString(), 'var(--notmet)'],
              ['Service Interruptions', sc.stuInterruptions.toLocaleString(), 'var(--partial)'],
            ].map(([lbl,val,col])=>`<div style="background:var(--surface-2);padding:.875rem;border-radius:var(--radius);border:1px solid var(--border)">
              <div style="font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)">${lbl}</div>
              <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;font-weight:700;color:${col};margin-top:.2rem">${val}</div>
            </div>`).join('')}
          </div>
        </div>
        <div style="padding:0 1.5rem 1.5rem">
          <div style="font-size:.75rem;font-weight:700;color:var(--navy);margin-bottom:.5rem">Scholars (${students.length})</div>
          <div style="overflow-x:auto;margin-bottom:1.5rem">
            <table style="width:100%;border-collapse:collapse;font-size:.8125rem">
              <thead>${theads}</thead>
              <tbody>${students.map(renderPersonRow).join('') || '<tr><td colspan="8" style="text-align:center;padding:1.5rem;color:var(--muted)">No scholars found</td></tr>'}</tbody>
            </table>
          </div>
          ${instructors.length > 0 ? `
          <div style="font-size:.75rem;font-weight:700;color:var(--navy);margin-bottom:.5rem">Instructors (${instructors.length})</div>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:.8125rem">
              <thead>${theads.replace('Scholar','Instructor')}</thead>
              <tbody>${instructors.map(renderPersonRow).join('')}</tbody>
            </table>
          </div>` : ''}
        </div>`;
    }

    function renderSessionsTab(sc) {
      const sessions = sc.sessions.sort((a,b) => new Date(b.start) - new Date(a.start)).slice(0, 100);
      const rows = sessions.map(s => {
        const statusColor = s.status === 'Completed' ? 'var(--met)' : s.status === 'Missed' ? 'var(--notmet)' : 'var(--partial)';
        const ratioFlag = s.ratioFlag ? `<span class="po-badge po-badge-red" title="Exceeds 1:4 ratio â€” check MOU">âš‘ ${s.ratio}:1</span>` : `<span class="po-badge po-badge-green">âœ“ ${s.ratio}:1</span>`;
        return `<tr style="font-size:.8125rem">
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2)">${s.start||'â€”'}</td>
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2);font-weight:600;color:var(--navy);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${s.title}">${s.title}</td>
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2)">${s.instructor||'â€”'}</td>
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2)"><span style="font-weight:600;color:${statusColor}">${s.status}</span></td>
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2);text-align:center">${ratioFlag}</td>
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2)">${s.subject||'â€”'}</td>
          <td style="padding:.5rem .875rem;border-bottom:1px solid var(--border-2)">${s.schedDur||'â€”'}</td>
        </tr>`;
      }).join('');
      return `<div style="padding:1.5rem"><div style="font-size:.75rem;color:var(--muted);margin-bottom:.75rem">Most recent ${Math.min(100,sessions.length)} of ${sc.sessions.length} sessions Â· Ratio flag = exceeds 1:4 (check MOU per school contract)</div>
        <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:var(--surface-2)">${['Date','Session Title','Instructor','Status','Scholar Ratio','Subject','Duration'].map(h=>`<th style="padding:.4rem .875rem;text-align:left;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap">${h}</th>`).join('')}</tr></thead>
          <tbody>${rows || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--muted)">No sessions found</td></tr>'}</tbody>
        </table></div></div>`;
    }

    function renderInterruptionsTab(sc) {
      const siRows = sc.rows.filter(r => classifyRecord(r) === 'service_interruption' && r[ATT.ROLE] === 'Student');
      const grouped = {};
      for (const r of siRows) {
        const reason = r[ATT.MISS_REASON] || 'Unknown';
        if (!grouped[reason]) grouped[reason] = [];
        grouped[reason].push(r);
      }
      const sorted = Object.entries(grouped).sort((a,b) => {
        const order = {critical:0, high:1, medium:2, low:3};
        return (order[getSISeverity(a[0])]||2) - (order[getSISeverity(b[0])]||2);
      });

      const groupRows = sorted.map(([reason, recs]) => {
        const sev        = getSISeverity(reason);
        const isVacancy  = reason === 'Tutor Vacancy';
        const isCritical = sev === 'critical';
        const sevLabel   = `<span class="po-severity-${sev}">${sev.toUpperCase()}</span>`;
        const rowBg      = isCritical ? 'background:#fef2f2' : isVacancy ? 'background:#fffbeb' : '';
        const icon       = isCritical ? 'ğŸš¨' : isVacancy ? 'ğŸ‘¤' : sev === 'high' ? 'ğŸ”´' : sev === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
        const note       = isCritical
          ? '<div style="margin-top:.4rem;font-size:.75rem;color:#991b1b;font-weight:600">âš ï¸ Requires immediate review, check-in, and cleanup</div>'
          : isVacancy
            ? '<div style="margin-top:.4rem;font-size:.75rem;color:#92400e;font-weight:600">ğŸ‘¥ Staffing gap â€” <strong>not counted in attendance</strong>. Escalate to HR &amp; Programming for backfill. Visible to: HR Â· Programming Â· Leadership.</div>'
            : '';
        const weeks = [...new Set(recs.map(r => r[ATT.WEEK]))].filter(Boolean).sort((a,b)=>{ const na=parseInt(a.replace('Week ','')),nb=parseInt(b.replace('Week ','')); return na-nb; }).join(', ');
        return `<div class="po-flag-row" style="${rowBg}">
          <div class="po-flag-icon">${icon}</div>
          <div class="po-flag-text">
            <div class="po-flag-label">${reason}</div>
            <div class="po-flag-sub">Affected weeks: ${weeks}</div>
            ${note}
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.3rem">
            ${sevLabel}
            <span class="po-flag-count">${recs.length} records</span>
          </div>
        </div>`;
      }).join('');

      const notRecorded = sc.rows.filter(r => r[ATT.ATT_STATUS] === 'Not recorded').length;
      return `<div>
        <div style="padding:1rem 1.5rem .5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:.8125rem;color:var(--muted)">${siRows.length} service interruption records Â· Sorted by severity</span>
          ${notRecorded > 0 ? `<span class="po-badge po-badge-gold">âš ï¸ ${notRecorded} not recorded â€” data quality flag</span>` : ''}
        </div>
        ${groupRows || '<div style="text-align:center;padding:2rem;color:var(--muted)">No service interruptions found</div>'}
      </div>`;
    }

    function renderSurveysTab(sc) {
      const stuAvg = sc.stuSurveyAvg;
      const instAvg = sc.instSurveyAvg;

      // Comments with bucketing
      const stuComments = sc.stuSurveyRows
        .filter(r => r[STU_S.COMMENT] && r[STU_S.COMMENT].trim())
        .slice(0, 40);
      const instComments = sc.instSurveyRows
        .filter(r => (r[INST_S.COMMENT_ADMIN] || r[INST_S.COMMENT_SELF]))
        .slice(0, 40);

      const renderCommentCard = (text, bucketKey) => {
        const bucket = COMMENT_BUCKETS[bucketKey] || { label: 'Other', css: 'other' };
        const clampCss = 'font-size:.8125rem;color:var(--text);line-height:1.5';
        const cardCss  = bucketKey === 'concern' ? 'concern' : bucketKey === 'positive' ? 'positive' : 'neutral';
        return `<div class="po-comment-card cc-${cardCss}">
          <div class="po-comment-bucket po-bucket-${bucket.css}">${bucket.label}</div>
          <div style="${clampCss}">"${text}"</div>
        </div>`;
      };

      const stuRatingBars = [
        ['Confidence', STU_S.CONFIDENCE],
        ['Enjoyment', STU_S.ENJOYMENT],
        ['Learning', STU_S.LEARNING],
        ['Overall', STU_S.OVERALL],
      ].map(([lbl, col]) => {
        const scores = sc.stuSurveyRows.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
        const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
        const pct = avg / 5 * 100;
        const col2 = avg >= 4 ? 'var(--met)' : avg >= 3 ? 'var(--gold)' : 'var(--notmet)';
        return `<div style="margin-bottom:.625rem">
          <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:.25rem"><span>${lbl}</span><span style="font-weight:700;color:var(--navy)">${avg.toFixed(2)}/5</span></div>
          <div class="po-survey-bar"><div class="po-survey-bar-fill" style="width:${pct}%;background:${col2}"></div></div>
        </div>`;
      }).join('');

      const instRatingBars = [
        ['Scholar Engagement', INST_S.ENGAGEMENT],
        ['Enjoyment', INST_S.ENJOYMENT],
        ['Scholar Learning', INST_S.LEARNING],
        ['Overall', INST_S.OVERALL],
      ].map(([lbl, col]) => {
        const scores = sc.instSurveyRows.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
        const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
        const pct = avg / 5 * 100;
        const col2 = avg >= 4 ? 'var(--met)' : avg >= 3 ? 'var(--gold)' : 'var(--notmet)';
        return `<div style="margin-bottom:.625rem">
          <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:.25rem"><span>${lbl}</span><span style="font-weight:700;color:var(--navy)">${avg.toFixed(2)}/5</span></div>
          <div class="po-survey-bar"><div class="po-survey-bar-fill" style="width:${pct}%;background:${col2}"></div></div>
        </div>`;
      }).join('');

      const stuCommentHTML = stuComments.map(r => {
        const text = r[STU_S.COMMENT];
        const bucket = categorizeComment(text);
        return renderCommentCard(text, bucket);
      }).join('');

      const instCommentHTML = instComments.map(r => {
        const admin = r[INST_S.COMMENT_ADMIN], self = r[INST_S.COMMENT_SELF];
        const text = [admin, self].filter(Boolean).join(' | ');
        const bucket = categorizeComment(text);
        return renderCommentCard(text, bucket);
      }).join('');

      return `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;padding:1.25rem 1.5rem">
          <div>
            <div style="font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.75rem">Scholar Survey Ratings <span style="font-weight:400">(${sc.stuSurveyRows.length} responses)</span></div>
            ${stuRatingBars || '<p style="color:var(--muted);font-size:.8125rem">No scholar survey data</p>'}
          </div>
          <div>
            <div style="font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.75rem">Instructor Survey Ratings <span style="font-weight:400">(${sc.instSurveyRows.length} responses)</span></div>
            ${instRatingBars || '<p style="color:var(--muted);font-size:.8125rem">No instructor survey data</p>'}
          </div>
        </div>
        ${stuComments.length > 0 || instComments.length > 0 ? `
        <div style="padding:0 1.5rem 1.5rem">
          <div style="font-size:.75rem;font-weight:700;color:var(--navy);margin-bottom:.5rem">Scholar Comments â€” Auto-Categorized (${stuComments.length} shown)</div>
          <div style="margin-bottom:1.25rem">${stuCommentHTML || '<p style="color:var(--muted);font-size:.8125rem">No comments</p>'}</div>
          <div style="font-size:.75rem;font-weight:700;color:var(--navy);margin-bottom:.5rem">Instructor Comments â€” Auto-Categorized (${instComments.length} shown)</div>
          ${instCommentHTML || '<p style="color:var(--muted);font-size:.8125rem">No instructor comments</p>'}
        </div>` : ''}`;
    }

    function renderHITTab(sc) {
      const students = Object.values(_personMap).filter(p => p.school === sc.school && p.role === 'Student');
      const flaggedStudents = students.filter(p => p.flags.length > 0)
        .sort((a,b) => b.flags.length - a.flags.length);

      const ratioRows = sc.sessions.filter(s => s.ratioFlag)
        .sort((a,b) => b.ratio - a.ratio)
        .slice(0, 30);

      const personFlagRows = flaggedStudents.map(p => {
        const name = canSeeNames() ? p.name : 'â€”';
        return `<div style="padding:.75rem 1.5rem;border-bottom:1px solid var(--border-2)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.4rem">
            <span style="font-weight:700;color:var(--navy);font-size:.875rem;cursor:pointer" onclick="po.drillPerson('${esc(p.uid)}')">${name}</span>
            <span class="po-badge ${p.flags.length>2?'po-badge-critical':'po-badge-red'}">ğŸš© ${p.flags.length} flag${p.flags.length>1?'s':''}</span>
          </div>
          ${p.flags.map(f=>`<div style="font-size:.75rem;color:var(--muted);margin:.2rem 0;display:flex;align-items:center;gap:.4rem"><span class="po-severity-${f.severity}">${f.severity}</span> ${f.msg}</div>`).join('')}
        </div>`;
      }).join('');

      const ratioRowsHTML = ratioRows.map(s => `
        <tr style="font-size:.8125rem">
          <td style="padding:.45rem .875rem;border-bottom:1px solid var(--border-2)">${s.start||'â€”'}</td>
          <td style="padding:.45rem .875rem;border-bottom:1px solid var(--border-2);font-weight:600;color:var(--navy)">${s.title}</td>
          <td style="padding:.45rem .875rem;border-bottom:1px solid var(--border-2)">${s.instructor}</td>
          <td style="padding:.45rem .875rem;border-bottom:1px solid var(--border-2);text-align:center"><span class="po-badge po-badge-red">âš‘ ${s.ratio}:1</span></td>
          <td style="padding:.45rem .875rem;border-bottom:1px solid var(--border-2);font-size:.75rem;color:var(--muted)">Exceeds 1:4 HIT ratio â€” MOU governs actual limit</td>
        </tr>`).join('');

      return `
        <div>
          <div style="padding:1rem 1.5rem;border-bottom:1px solid var(--border);background:var(--surface-2)">
            <div style="font-size:.75rem;color:var(--muted);line-height:1.6">
              <strong>HIT Compliance Standards:</strong> &nbsp;â‰¤4 scholars per session (1:4 ratio) &nbsp;Â·&nbsp; â‰¥2 sessions per week &nbsp;Â·&nbsp; Same instructor for continuity/rapport &nbsp;Â·&nbsp; No 10+ consecutive misses<br>
              <em>Note: Ratio flag does not equal a violation â€” some schools have approved higher ratios per MOU. Flag = review required.</em>
            </div>
          </div>
          ${flaggedStudents.length > 0 ? `
          <div style="padding:1rem 1.5rem .5rem">
            <div style="font-size:.75rem;font-weight:700;color:var(--navy)">Scholars With Active HIT Flags (${flaggedStudents.length})</div>
          </div>
          ${personFlagRows}` : '<div style="padding:2rem;text-align:center;color:var(--muted)">No HIT flags for scholars at this school</div>'}
          ${ratioRows.length > 0 ? `
          <div style="padding:1rem 1.5rem .5rem;border-top:1px solid var(--border)">
            <div style="font-size:.75rem;font-weight:700;color:var(--navy)">Sessions With Ratio Flags (${ratioRows.length} of ${sc.ratioViolations})</div>
          </div>
          <div style="overflow-x:auto;padding:0 1.5rem 1.5rem">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr style="background:var(--surface-2)">${['Date','Session','Instructor','Ratio','Note'].map(h=>`<th style="padding:.4rem .875rem;text-align:left;font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border)">${h}</th>`).join('')}</tr></thead>
              <tbody>${ratioRowsHTML}</tbody>
            </table>
          </div>` : ''}
        </div>`;
    }

    // â”€â”€ PERSON DETAIL VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPersonDetail() {
      const mc = document.getElementById('poMainContent'); if (!mc) return;
      const p = _personMap[_selPerson]; if (!p) { _view = 'school'; renderView(); return; }
      const isStudent = p.role === 'Student';
      const name = canSeeNames() ? p.name : (isStudent ? 'Scholar' : 'Instructor');
      const total = p.attended + p.absent;
      const rate  = total > 0 ? Math.round(p.attended / total * 100) : 0;
      const attColor = rate >= 90 ? 'var(--met)' : rate >= 75 ? 'var(--gold)' : 'var(--notmet)';

      const tabs = [{ id:'attendance', label:'ğŸ“‹ History' }];
      if (isTD() || isData()) tabs.push({ id:'surveys', label:'â­ Surveys' });
      if (isData() || isHR() || isProg()) tabs.push({ id:'flags', label:`ğŸš© Flags (${p.flags.length})` });

      mc.innerHTML = `
        <div class="po-detail-card">
          <div class="po-section-hd">
            <div>
              <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--navy)">${name}</div>
              <div style="font-size:.75rem;color:var(--muted)">${p.role} Â· ${p.school} Â· ${p.district}${p.grade ? ' Â· ' + p.grade : ''}</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.375rem">
              <span style="font-family:'DM Serif Display',serif;font-size:1.5rem;font-weight:700;color:${attColor}">${rate}%</span>
              <span style="font-size:.75rem;color:var(--muted)">${p.attended} attended Â· ${p.absent} absent Â· ${p.interruptions} interrupted</span>
              ${(isHR() || isFinance()) && rate < 70 ? '<span class="po-badge po-badge-critical">âš‘ Low Attendance â€” Check ADP Records</span>' : ''}
              ${p.consecStatus === 'Attendance Concern' ? '<span class="po-badge po-badge-critical">10+ Consecutive Misses</span>' : ''}
              ${p.vacantId ? '<span class="po-badge po-badge-red">Tutor Vacancy Active</span>' : ''}
            </div>
          </div>
          <div class="po-tabs-bar" id="poPersonTabsBar">
            ${tabs.map(t=>`<button class="po-tab${_activeTab===t.id?' po-tab-active':''}" onclick="po.switchPersonTab('${t.id}')">${t.label}</button>`).join('')}
          </div>
          <div id="poPersonTabContent"></div>
        </div>`;
      renderPersonTab(_activeTab, p);
    }

    function switchPersonTab(tabId) {
      _activeTab = tabId;
      document.querySelectorAll('#poPersonTabsBar .po-tab').forEach(btn => {
        btn.classList.toggle('po-tab-active', btn.getAttribute('onclick').includes(`'${tabId}'`));
      });
      const p = _personMap[_selPerson]; if (!p) return;
      renderPersonTab(tabId, p);
    }

    function renderPersonTab(tab, p) {
      const el = document.getElementById('poPersonTabContent'); if (!el) return;
      if (tab === 'attendance') el.innerHTML = renderPersonAttHistory(p);
      else if (tab === 'surveys') el.innerHTML = renderPersonSurveys(p);
      else if (tab === 'flags')   el.innerHTML = renderPersonFlags(p);
    }

    function renderPersonAttHistory(p) {
      const rows = p.rows.sort((a,b) => new Date(b[ATT.SESS_DATE]) - new Date(a[ATT.SESS_DATE]));
      const histRows = rows.map(r => {
        const cls = classifyRecord(r);
        const clsColor = cls==='attended'?'var(--met)':cls==='absent'?'var(--notmet)':cls==='service_interruption'?'var(--partial)':'var(--muted)';
        const clsLabel = cls==='attended'?'Attended':cls==='absent'?'Absent':cls==='service_interruption'?'Interrupted':'â€”';
        const siFlag = cls === 'service_interruption' ? `<span class="po-severity-${getSISeverity(r[ATT.MISS_REASON])} " style="margin-left:.4rem">${getSISeverity(r[ATT.MISS_REASON])}</span>` : '';
        return `<div class="po-hist-row">
          <span style="color:var(--muted)">${r[ATT.SESS_DATE]||'â€”'}</span>
          <span style="color:var(--navy)">${r[ATT.SESSION]||'â€”'}</span>
          <span style="font-weight:700;color:${clsColor}">${clsLabel}${siFlag}</span>
          <span style="color:var(--muted);font-size:.75rem">${r[ATT.WEEK]||'â€”'}</span>
        </div>`;
      }).join('');
      return `<div>
        <div style="display:grid;grid-template-columns:100px 1fr 90px 80px;gap:.5rem;padding:.5rem 1.5rem;border-bottom:1px solid var(--border);font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)"><span>Date</span><span>Session</span><span>Status</span><span>Week</span></div>
        ${histRows || '<div style="text-align:center;padding:2rem;color:var(--muted)">No session history</div>'}
      </div>`;
    }

    function renderPersonSurveys(p) {
      const isInst = p.role === 'Instructor';
      const surveys = isInst ? p.instSurveys : p.stuSurveys;
      if (!surveys.length) return '<div style="text-align:center;padding:2rem;color:var(--muted)">No survey responses found</div>';

      const ratingCols = isInst
        ? [[INST_S.ENGAGEMENT,'Engagement'],[INST_S.ENJOYMENT,'Enjoyment'],[INST_S.LEARNING,'Scholar Learning'],[INST_S.OVERALL,'Overall']]
        : [[STU_S.CONFIDENCE,'Confidence'],[STU_S.ENJOYMENT,'Enjoyment'],[STU_S.LEARNING,'Learning'],[STU_S.OVERALL,'Overall']];

      const avgs = ratingCols.map(([col, lbl]) => {
        const scores = surveys.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
        const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
        const pct = avg/5*100;
        const color = avg>=4?'var(--met)':avg>=3?'var(--gold)':'var(--notmet)';
        return `<div style="margin-bottom:.625rem">
          <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:.25rem"><span>${lbl}</span><span style="font-weight:700;color:var(--navy)">${avg.toFixed(2)}/5 (${scores.length} responses)</span></div>
          <div class="po-survey-bar"><div class="po-survey-bar-fill" style="width:${pct}%;background:${color}"></div></div>
        </div>`;
      }).join('');

      const commentCol1 = isInst ? INST_S.COMMENT_ADMIN : STU_S.COMMENT;
      const commentCol2 = isInst ? INST_S.COMMENT_SELF  : null;
      const comments = surveys.filter(r => r[commentCol1] || (commentCol2 && r[commentCol2])).slice(0, 20);
      const commentHTML = comments.map(r => {
        const text = [r[commentCol1], commentCol2 ? r[commentCol2] : null].filter(Boolean).join(' | ');
        const bucket = categorizeComment(text);
        const b = COMMENT_BUCKETS[bucket] || { label:'Other', css:'other' };
        const week = isInst ? r[INST_S.WEEK] : r[STU_S.WEEK];
        return `<div class="po-comment-card cc-${bucket==='concern'?'concern':bucket==='positive'?'positive':'neutral'}">
          <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.3rem">
            <span class="po-comment-bucket po-bucket-${b.css}">${b.label}</span>
            <span style="font-size:.7rem;color:var(--muted)">${week||''}</span>
          </div>
          <div style="font-size:.8125rem;color:var(--text);line-height:1.5">"${text}"</div>
        </div>`;
      }).join('');

      return `<div style="padding:1.25rem 1.5rem">
        <div style="margin-bottom:1.25rem">${avgs}</div>
        ${comments.length > 0 ? `
          <div style="font-size:.75rem;font-weight:700;color:var(--navy);margin-bottom:.5rem">Comments (${comments.length})</div>
          ${commentHTML}` : ''}
      </div>`;
    }

    function renderPersonFlags(p) {
      if (!p.flags.length) return '<div style="text-align:center;padding:2rem;color:var(--muted)">âœ“ No HIT compliance flags for this individual</div>';
      return `<div>${p.flags.map(f => `
        <div class="po-flag-row" style="${f.severity==='critical'||f.severity==='high'?'background:#fff8f8':''}">
          <div class="po-flag-icon">${f.severity==='critical'?'ğŸš¨':f.severity==='high'?'ğŸ”´':f.severity==='medium'?'ğŸŸ¡':'ğŸ”µ'}</div>
          <div class="po-flag-text">
            <div class="po-flag-label">${flagTypeLabel(f.type)}</div>
            <div class="po-flag-sub">${f.msg}</div>
          </div>
          <span class="po-severity-${f.severity}">${f.severity.toUpperCase()}</span>
        </div>`).join('')}
      </div>`;
    }

    function flagTypeLabel(type) {
      const labels = {
        consecutive: '10+ Consecutive Sessions Missed',
        continuity:  'Tutor Continuity Concern',
        low_att:     'Low Attendance â€” ADP Review Needed',
        vacancy:     'Active Tutor Vacancy',
        declined:    'Scholar Declined Sessions â€” Program Team Follow-Up',
        frequency:   'Weekly Session Frequency Below HIT Minimum',
        inst_att:    'Instructor Attendance â€” ADP Review Needed',
        ratio:       'Session Ratio Exceeds 1:4 â€” Check MOU',
        critical_si: 'Critical Service Interruption â€” NJTC Internal',
        high_si:     'High Severity Service Interruptions',
      };
      return labels[type] || type;
    }

    // â”€â”€ FLAGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openFlagsModal(filter) {
      let overlay = document.getElementById('poFlagsModal');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'poFlagsModal';
        overlay.className = 'po-modal-overlay';
        overlay.onclick = e => { if (e.target === overlay) overlay.style.display = 'none'; };
        document.body.appendChild(overlay);
      }
      const allFlags = [];
      for (const [school, sc] of Object.entries(_schoolMap)) {
        for (const f of sc.flags) allFlags.push({...f, school, entity: school, isSchool: true});
      }
      const close = `<button class="po-modal-close" onclick="document.getElementById('poFlagsModal').style.display='none'">âœ•</button>`;
      const sevOrder = {critical:0,high:1,medium:2,low:3};
      const filtered = filter === 'critical' ? allFlags.filter(f => f.severity === 'critical') : allFlags;
      filtered.sort((a,b) => (sevOrder[a.severity]||2) - (sevOrder[b.severity]||2));

      const rows = filtered.map(f => `
        <div class="po-flag-row" style="${f.severity==='critical'?'background:#fef2f2':f.severity==='high'?'background:#fff8f8':''}">
          <div class="po-flag-icon">${f.severity==='critical'?'ğŸš¨':f.severity==='high'?'ğŸ”´':'ğŸŸ¡'}</div>
          <div class="po-flag-text">
            <div class="po-flag-label" style="cursor:pointer;color:var(--blue-mid)" onclick="po.drillSchool('${esc(f.school)}');document.getElementById('poFlagsModal').style.display='none'">${f.school}</div>
            <div class="po-flag-sub">${f.msg}</div>
          </div>
          <span class="po-severity-${f.severity}">${f.severity.toUpperCase()}</span>
        </div>`).join('');

      overlay.innerHTML = `<div class="po-modal">
        <div class="po-modal-hd">
          <div>
            <div class="po-modal-name">${filter==='critical'?'ğŸš¨ Critical Flags':'All HIT & Service Interruption Flags'}</div>
            <div class="po-modal-meta">${filtered.length} flags Â· Click a school name to drill down</div>
          </div>${close}
        </div>
        <div class="po-modal-body">${rows || '<div style="text-align:center;padding:2rem;color:var(--muted)">No flags found</div>'}</div>
        <div style="padding:1rem 1.5rem;border-top:1px solid var(--border);text-align:right"><button class="btn btn-secondary" onclick="document.getElementById('poFlagsModal').style.display='none'">Close</button></div>
      </div>`;
      overlay.style.display = 'flex';
    }

    // â”€â”€ SYNC STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setSyncState(state) {
      const dot = document.getElementById('poSyncDot');
      const txt = document.getElementById('poSyncText');
      if (!dot) return;
      if (state === 'loading') {
        dot.className = 'sync-dot loading';
        if (txt) txt.textContent = 'Loading Pearl dataâ€¦';
      } else if (state === 'live') {
        dot.className = 'sync-dot';
        const t = _lastFetch ? _lastFetch.toLocaleTimeString() : 'â€”';
        const totalRec = _attRows.length + _sessRows.length + _stuRows.length + _instRows.length;
        if (txt) txt.innerHTML = `<strong>Live Â· Pearl</strong> Â· ${totalRec.toLocaleString()} records Â· Updated ${t}`;
      } else {
        dot.className = 'sync-dot error';
        if (txt) txt.innerHTML = _lastFetch
          ? `<strong>âš ï¸ Unreachable</strong> Â· Last: ${_lastFetch.toLocaleTimeString()}`
          : '<strong>âš ï¸ Could not load Pearl data</strong> Â· Click â†º Refresh';
      }
    }

    // â”€â”€ PANEL OPEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function onPanelOpen() {
      if (!_inited) init();
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function init() {
      if (_inited) return; _inited = true;
      refresh(true);
      setInterval(() => {
        const p = document.getElementById('panel-pearl-ops');
        if (p && p.classList.contains('active')) refresh(false);
      }, REFRESH_MS);
    }

    // â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = v; }
    function esc(s) { return (s||'').replace(/'/g, "\\'"); }

    return {
      init, refresh, applyFilters, clearFilters,
      drillSchool, drillPerson, goBack,
      switchTab, switchPersonTab,
      openFlagsModal, onPanelOpen,
    };
  })();


  // â”€â”€ Patch showPanel: route SY + Pearl panel opens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function patchShowPanelModules() {
    const _orig = showPanel;
    window.showPanel = function(id, btn) {
      _orig(id, btn);
      if (id === 'sy-analytics') sya.onPanelOpen();
      if (id === 'pearl-ops')    po.onPanelOpen();
    };
  })();

  // Boot both modules after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { sya.init(); po.init(); });
  } else {
    sya.init(); po.init();
  }

</script>
</body>
</html>
