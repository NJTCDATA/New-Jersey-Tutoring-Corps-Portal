name: Rotate Access Code Hashes (Manual)

# Run this workflow manually from the GitHub Actions tab when codes need to be updated.
# Enter the plaintext codes in the inputs below — they are NEVER stored anywhere.
# Only the SHA-256 hashes get committed to auth/codes.json.

on:
  workflow_dispatch:
    inputs:
      CT_HR:
        description: 'Human Resources code'
        required: true
        default: 'NJTC-HR-2526'
      CT_FIN:
        description: 'Finance code'
        required: true
        default: 'NJTC-FIN-2526'
      CT_PRG:
        description: 'Programming code'
        required: true
        default: 'NJTC-PRG-2526'
      CT_DAT:
        description: 'Data & Evaluation code'
        required: true
        default: 'NJTC-DAT-2526'
      CT_TRN:
        description: 'Training & Development code'
        required: true
        default: 'NJTC-TRN-2526'
      CT_LDR:
        description: 'Leadership code'
        required: true
        default: 'NJTC-LDR-2526'
      OS_CODE:
        description: 'Onsite Staff code (all onsite staff use this one code)'
        required: true
        default: 'NJTC-ONSITE-2526'

jobs:
  update-hashes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate hash list and write auth/codes.json
        run: |
          node <<'EOF'
          const crypto = require('crypto');
          const fs     = require('fs');

          function sha256(s) {
            return crypto.createHash('sha256').update(s).digest('hex');
          }

          const inputs = {
            CT_HR:   process.env.CT_HR,
            CT_FIN:  process.env.CT_FIN,
            CT_PRG:  process.env.CT_PRG,
            CT_DAT:  process.env.CT_DAT,
            CT_TRN:  process.env.CT_TRN,
            CT_LDR:  process.env.CT_LDR,
            OS_CODE: process.env.OS_CODE,
          };

          const entries = [
            { key: 'CT_HR',  dept: 'hr' },
            { key: 'CT_FIN', dept: 'finance' },
            { key: 'CT_PRG', dept: 'programming' },
            { key: 'CT_DAT', dept: 'data' },
            { key: 'CT_TRN', dept: 'training' },
            { key: 'CT_LDR', dept: 'leadership' },
            { key: 'OS_CODE', dept: 'onsite' },
          ];

          const codes = entries
            .filter(e => inputs[e.key] && inputs[e.key].trim() !== '')
            .map(e => ({ h: sha256(inputs[e.key].trim()), d: e.dept }));

          const out = {
            _comment: 'SHA-256 hashes only. Plaintext codes entered via GitHub Actions and never stored here.',
            _depts: {
              hr:           'Human Resources',
              finance:      'Finance',
              programming:  'Programming',
              data:         'Data & Evaluation',
              training:     'Training & Development',
              leadership:   'Leadership',
              onsite:       'Onsite Staff'
            },
            codes
          };

          fs.writeFileSync('auth/codes.json', JSON.stringify(out, null, 2));
          console.log('✅ Wrote ' + codes.length + ' code hashes to auth/codes.json');
          console.log('Departments hashed: ' + entries.map(e => e.dept).join(', '));
          EOF
        env:
          CT_HR:   ${{ github.event.inputs.CT_HR }}
          CT_FIN:  ${{ github.event.inputs.CT_FIN }}
          CT_PRG:  ${{ github.event.inputs.CT_PRG }}
          CT_DAT:  ${{ github.event.inputs.CT_DAT }}
          CT_TRN:  ${{ github.event.inputs.CT_TRN }}
          CT_LDR:  ${{ github.event.inputs.CT_LDR }}
          OS_CODE: ${{ github.event.inputs.OS_CODE }}

      - name: Commit updated hash list
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add auth/codes.json
          git diff --staged --quiet || git commit -m "security: rotate access code hashes [skip ci]"
          git push
